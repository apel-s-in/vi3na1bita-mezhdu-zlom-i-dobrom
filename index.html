<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞ - –ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∞–ª—å–±–æ–º –≥—Ä—É–ø–ø—ã –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞. –°–ª—É—à–∞–π—Ç–µ –æ–Ω–ª–∞–π–Ω –∏ –æ—Ñ–ª–∞–π–Ω.">
  
  <!-- PWA –º–µ—Ç–∞—Ç–µ–≥–∏ -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#181818" />
  
  <!-- iOS —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –º–µ—Ç–∞—Ç–µ–≥–∏ -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="–í–∏—Ç—Ä–∏–Ω–∞">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  
  <!-- –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ -->
  <link rel="preload" href="img/logo.png" as="image">
  <link rel="preload" href="Cover.png" as="image">
  
  <style>
    :root {
      --primary-bg: #181818;
      --primary-color: #E80100;
      --secondary-color: #4daaff;
      --text-color: #f2f2f2;
      --modal-bg: #252d39;
      --border-color: #394866;
    }
    
    * { box-sizing: border-box; }
    
    html, body { height: 100%; }
    
    body {
      min-height: 100vh;
      background: var(--primary-bg);
      color: var(--text-color);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-width: 100vw;
      padding-top: env(safe-area-inset-top);
    }
    
    #promocode-block {
      position: fixed;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--primary-bg);
      z-index: 100;
    }
    
    .promo-inner {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: rgba(15,18,24,0.98);
      border-radius: 16px;
      box-shadow: 0 6px 24px #0008;
      padding: 36px 26px 32px 26px;
      min-width: 260px;
      min-height: 170px;
    }
    
    .promo-cover {
      width: 256px;
      height: 256px;
      object-fit: cover;
      border-radius: 12px;
      box-shadow: 0 4px 24px #000c;
      margin-bottom: 19px;
      display: block;
      background: var(--primary-bg);
    }
    
    #promo-inp {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: rgba(255,255,255,0.1);
      color: var(--text-color);
      margin: 10px 0;
      width: 100%;
      font-size: 16px;
    }
    
    #promo-btn {
      padding: 10px 20px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: opacity 0.2s;
    }
    
    #promo-btn:hover:not(:disabled) { opacity: 0.8; }
    #promo-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    #promo-error {
      color: #ff6b6b;
      margin-top: 10px;
      font-size: 14px;
    }
    
    .modal-bg {
      position: fixed;
      z-index: 99;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.62);
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    
    .modal-bg.active { display: flex; animation: fadeIn 0.3s; }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-feedback {
      background: var(--modal-bg);
      border-radius: 14px;
      padding: 34px 20px 21px 20px;
      min-width: 215px;
      box-shadow: 0 4px 32px #0009;
      max-width: 96vw;
      position: relative;
      animation: slideUp 0.3s;
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .modal-feedback .bigclose {
      background: none;
      border: none;
      position: absolute;
      top: 13px;
      right: 13px;
      cursor: pointer;
      color: #eee;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      transition: transform 0.2s;
    }
    
    .modal-feedback .bigclose:hover { transform: scale(1.1); }
    .modal-feedback .bigclose svg { width: 31px; height: 31px; }
    
    .hidden { display: none !important; }
    
    #main-block {
      max-width: 420px;
      margin: 0 auto;
      flex: 1 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      padding: 0 10px;
    }
    
    header {
      width: 100%;
      text-align: center;
      margin: 0 auto;
    }
    
    #cover-wrap {
      width: 100%;
      max-width: 400px;
      margin: 24px auto 0 auto;
      aspect-ratio: 1/1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .cover-gallery-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 2;
      border: none;
      cursor: pointer;
      background: none;
      padding: 0;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s;
    }
    
    .cover-gallery-arrow:hover { opacity: 0.8; }
    
    #cover-gallery-arrow-left { left: 7px; }
    #cover-gallery-arrow-right { right: 7px; }
    
    #cover {
      width: 100%;
      max-width: 100%;
      border-radius: 12px;
      aspect-ratio: 1/1;
      object-fit: cover;
      display: block;
      margin: 0;
      box-shadow: 0 4px 24px rgba(0,0,0,0.3);
    }
    
    .socials-under-cover {
      margin: 14px auto 0 auto;
      width: 100%;
      max-width: 398px;
      text-align: center;
      font-size: 1.03em;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
    }
    
    .socials-under-cover a {
      color: var(--secondary-color);
      text-decoration: none;
      transition: color 0.2s;
    }
    
    .socials-under-cover a:hover { color: var(--text-color); }
    
    .track-list {
      margin: 0 auto;
      max-width: 370px;
      width: 100%;
      font-size: 1.05em;
      color: #eee;
      background: none;
      padding: 0;
    }
    
    .track {
      display: flex;
      align-items: center;
      padding: 7px 8px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: background 0.13s;
      background: none;
    }
    
    .track:hover { background: rgba(255,255,255,0.05); }
    .track.current { background: #232b38; }
    
    .tnum {
      min-width: 27px;
      color: #8ab8fd;
    }
    
    .track-title {
      margin-left: 7px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
    }
    
    .like-star {
      margin-left: auto;
      width: 19px;
      height: 19px;
      cursor: pointer;
      opacity: 0.97;
      border: none;
      background: none;
      padding: 0;
      appearance: none;
      display: inline-block;
      transition: transform 0.2s, filter 0.13s, opacity 0.13s;
    }
    
    .like-star:hover {
      filter: brightness(1.13);
      opacity: 1;
      transform: scale(1.1);
    }
    
    .like-star.animating {
      animation: starPulse 0.3s;
    }
    
    @keyframes starPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.3); }
    }
    
    .lyrics-player-block {
      width: 100%;
      margin: 8px 0 3px 0;
    }
    
    #lyrics-window {
      width: 100%;
      background: rgba(34,34,34,0.98);
      border-radius: 12px;
      box-shadow: 0 8px 24px #0007;
      overflow: hidden;
      height: 8.5em;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: center;
      margin-bottom: 7px;
    }
    
    .lyrics-window-line {
      opacity: 0.57;
      font-size: 1.13em;
      transition: all 0.2s;
      line-height: 1.7em;
      text-align: center;
      min-height: 1.7em;
      max-width: 97%;
      margin: 0 auto;
      color: #eee;
      white-space: pre-line;
      user-select: none;
      word-break: break-word;
    }
    
    .lyrics-window-line.active {
      color: var(--primary-color);
      font-weight: bold;
      opacity: 1;
      text-shadow: 0 1px 7px #73161644;
      background: rgba(0,0,0,0.07);
      border-radius: 8px;
      font-size: 1.19em;
    }
    
    .audio-wrapper {
      width: 100%;
      max-width: 395px;
      margin: 0 auto;
    }
    
    #audio {
      width: 100%;
      margin: 6px auto 2px auto;
      display: block;
    }
    
    .player-buttons-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 9px;
      margin-bottom: 7px;
      margin-top: 3px;
    }
    
    .karaoke-btn, .player-download-btn {
      color: var(--secondary-color) !important;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1em;
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 0.02em;
      text-decoration: underline;
      transition: all 0.18s;
      padding: 4px 16px;
      min-width: 148px;
      text-align: center;
      border-radius: 7px;
      display: block;
      margin: 0 auto;
    }
    
    .karaoke-btn:hover, .player-download-btn:hover {
      color: #fff !important;
      background: #273050;
    }
    
    .bottom-controls-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 32px auto 0 auto;
      gap: 8px;
      width: 100%;
      max-width: 210px;
      padding-bottom: env(safe-area-inset-bottom);
    }
    
    .logo-bottom {
      max-width: 112px;
      width: 23vw;
      min-width: 66px;
      height: auto;
      display: block;
      margin: 0 auto 10px auto !important;
    }
    
    #install-pwa-btn, #download-album-main {
      color: #fff;
      background: var(--secondary-color);
      border: none;
      border-radius: 7px;
      font-size: 1.07em;
      font-weight: bold;
      letter-spacing: 0.02em;
      margin: 15px 0 5px 0;
      padding: 8px 13px;
      cursor: pointer;
      width: 98%;
      box-shadow: 0 4px 14px #0005;
      outline: none;
      transition: background 0.2s;
    }
    
    #download-album-main {
      background: var(--primary-color);
      font-size: 1.09em;
      margin-bottom: 8px;
    }
    
    #install-pwa-btn:hover { background: #3275c2; }
    #download-album-main:hover { background: #c60000; }
    
    .feedback-link, .support-link {
      color: var(--secondary-color) !important;
      text-decoration: underline !important;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      cursor: pointer;
      transition: color 0.18s;
      font-size: 1em;
      display: block;
      text-align: center;
      width: 100%;
      margin: 0;
    }
    
    .feedback-link:hover, .support-link:hover {
      color: #fff !important;
    }
    
    .offline-btn {
      min-width: 102px;
      height: 38px;
      font-size: 1.05em;
      font-weight: bold;
      border: none;
      border-radius: 9px;
      cursor: pointer;
      letter-spacing: 0.07em;
      box-shadow: 0 2px 8px #06000032;
      transition: background 0.2s, color 0.14s;
      display: block;
      margin: 0 auto;
    }
    
    .offline-btn.online { background: var(--primary-color); color: #fff; }
    .offline-btn.offline { background: #27b34c; color: #fff; }
    .offline-btn:active { opacity: 0.91; }
    .offline-btn:disabled { opacity: 0.7; cursor: not-allowed; }
    
    .offline-progress {
      margin-top: 11px;
      width: 100%;
      height: 8px;
      background: #222;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 1px 6px #222b;
    }
    
    .offline-progress-bar {
      height: 100%;
      background: #2fed54;
      transition: width 0.33s;
    }
    
    .offline-desc {
      text-align: center;
      font-size: 0.97em;
      margin-top: 5px;
      opacity: 0.85;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª–æ–∫ –∞—Ä—Ö–∏–≤–∞ */
    .download-modal-title {
      font-size: 1.12em;
      font-weight: 700;
      margin-bottom: 13px;
      text-align: center;
    }
    
    .checkbox-container {
      display: flex;
      align-items: center;
      margin: 12px 0;
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-left: 32px;
    }
    
    .checkbox-container input {
      position: absolute;
      opacity: 0;
      cursor: pointer;
      height: 0;
      width: 0;
    }
    
    .checkmark {
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      height: 20px;
      width: 20px;
      background-color: #2a2a2a;
      border: 2px solid #444;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .checkbox-container:hover input ~ .checkmark {
      background-color: #333;
      border-color: #555;
    }
    
    .checkbox-container input:checked ~ .checkmark {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }
    
    .checkmark:after {
      content: "";
      position: absolute;
      display: none;
      left: 6px;
      top: 2px;
      width: 5px;
      height: 10px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }
    
    .checkbox-container input:checked ~ .checkmark:after {
      display: block;
    }
    
    .checkbox-container input:disabled ~ .checkmark {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .progress-bar {
      width: 100%;
      height: 20px;
      background-color: #2a2a2a;
      border-radius: 10px;
      overflow: hidden;
      margin: 20px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), #ff4444);
      transition: width 0.3s ease;
      will-change: width;
    }
    
    .size-info {
      padding: 20px;
      background-color: #1f1f1f;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
    }
    
    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .btn-secondary, .btn-primary {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 7px;
      font-weight: bold;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    
    .btn-secondary {
      background: #444;
      color: #fff;
    }
    
    .btn-primary {
      background: var(--primary-color);
      color: #fff;
    }
    
    .btn-secondary:hover, .btn-primary:hover {
      opacity: 0.8;
    }
    
    /* –¢–æ—Å—Ç—ã –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #2a2a2a;
      border-radius: 12px;
      padding: 15px 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 9999;
      opacity: 0;
      transition: all 0.3s ease;
      max-width: 90%;
      word-wrap: break-word;
      pointer-events: none;
    }
    
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    
    .toast-content {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .toast-info { border-left: 4px solid var(--secondary-color); }
    .toast-success { border-left: 4px solid #27b34c; }
    .toast-error { border-left: 4px solid var(--primary-color); }
    .toast-warning { border-left: 4px solid #ff9800; }
    .toast-offline { border-left: 4px solid #666; }
    
    /* iOS –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ */
    .ios-install-prompt {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #1a1a1a;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      padding: 20px;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      z-index: 10000;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
    }
    
    .ios-install-prompt.show {
      transform: translateY(0);
    }
    
    .ios-prompt-content {
      max-width: 400px;
      margin: 0 auto;
      text-align: center;
    }
    
    .ios-prompt-icon {
      width: 60px;
      height: 60px;
      margin-bottom: 15px;
    }
    
    .ios-share-icon {
      width: 20px;
      height: 20px;
      display: inline-block;
      vertical-align: middle;
      color: #007AFF;
    }
    
    .ios-prompt-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: #666;
      font-size: 28px;
      cursor: pointer;
    }
    
    .ios-prompt-button {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      font-weight: bold;
      margin-top: 20px;
      cursor: pointer;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 600px) {
      .like-star { width: 16px; height: 16px; }
      .logo-bottom { max-width: 66vw; }
    }
    
    @media (max-width: 420px) {
      .modal-feedback { padding: 13px 3vw; }
    }
    
    /* PWA —Ä–µ–∂–∏–º */
    @media (display-mode: standalone) {
      body {
        padding-top: env(safe-area-inset-top);
      }
      
      .bottom-controls-center {
        padding-bottom: calc(env(safe-area-inset-bottom) + 10px);
      }
    }
    
    /* –£–ª—É—á—à–µ–Ω–∏—è –¥–ª—è textarea */
    .real-textarea {
      width: 100%;
      min-height: 120px;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
      color: var(--text-color);
      font-size: 14px;
      resize: vertical;
    }
    
    .fake-textarea {
      padding: 15px;
      border: 1px dashed var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      color: #888;
      transition: all 0.2s;
    }
    
    .fake-textarea:hover {
      border-color: var(--secondary-color);
      color: #aaa;
    }
    
    .err-msg { color: #ff6b6b; margin-top: 10px; }
    .success-msg { color: #27b34c; margin-top: 10px; }
  </style>
</head>
<body>
  <div id="promocode-block">
    <div class="promo-inner">
      <img class="promo-cover" src="Cover.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false"/>
      <h2>–í—Ö–æ–¥ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É</h2>
      <input id="promo-inp" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" autocomplete="off" autofocus disabled />
      <button id="promo-btn" onclick="checkPromo()" disabled>–í–æ–π—Ç–∏</button>
      <div id="promo-error"></div>
    </div>
  </div>
  
  <div id="main-block" class="hidden">
    <header>
      <div id="cover-wrap">
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-left" title="–ù–∞–∑–∞–¥" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è –æ–±–ª–æ–∂–∫–∞">
          <svg width="34" height="34" viewBox="0 0 34 34">
            <circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/>
            <polyline points="20,10 13,17 20,24" fill="none" stroke="#fff" stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <img id="cover" src="Cover.png" alt="–û–±–ª–æ–∂–∫–∞ –∞–ª—å–±–æ–º–∞" draggable="false"/>
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-right" title="–í–ø–µ—Ä—ë–¥" aria-label="–°–ª–µ–¥—É—é—â–∞—è –æ–±–ª–æ–∂–∫–∞">
          <svg width="34" height="34" viewBox="0 0 34 34">
            <circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/>
            <polyline points="14,10 21,17 14,24" fill="none" stroke="#fff" stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      <div id="social-links" class="socials-under-cover"></div>
    </header>
    
    <div class="track-list" id="track-list"></div>
    
    <div class="bottom-controls-center">
      <img class="logo-bottom" src="img/logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø"/>
      <button id="install-pwa-btn" style="display: none;">–£–°–¢–ê–ù–û–í–ò–¢–¨ –ö–ê–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–ï</button>
      <button id="download-album-main" onclick="openAlbumDownloadModal()">–°–ö–ê–ß–ê–¢–¨ –í–ï–°–¨ –ê–õ–¨–ë–û–ú</button>
      <span class="feedback-link" id="feedback-link">–û–ë–†–ê–¢–ù–ê–Ø –°–í–Ø–ó–¨</span>
      <a class="support-link" id="support-link" href="#" target="_blank">–ü–û–î–î–ï–†–ñ–ê–¢–¨</a>
      <button class="offline-btn online" id="offline-btn" onclick="offlineUIClick()">ONLINE</button>
    </div>
  </div>
  
  <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
  <div class="modal-bg" id="modal-feedback">
    <div class="modal-feedback">
      <button class="bigclose" onclick="closeFeedbackModal()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48">
          <line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          <line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
        </svg>
      </button>
      <div id="feedback-step">
        <div class="fake-textarea" onclick="showRealTextarea()">
          –û–ø–∏—à–∏—Ç–µ –∑–¥–µ—Å—å –ø—Ä–æ–±–ª–µ–º—É –∏–ª–∏ —Å–≤–æ—ë –ø–æ–∂–µ–ª–∞–Ω–∏–µ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è,<br>–º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Å–≤–æ–π –æ—Ç–∑—ã–≤...
        </div>
      </div>
      <div id="modal-feedback-error" class="err-msg"></div>
      <div id="modal-feedback-success" class="success-msg"></div>
      <button onclick="sendFeedbackMsg()" id="send-feedback-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
  
  <div class="modal-bg" id="modal-offline">
    <div class="modal-feedback" style="max-width:400px;">
      <button class="bigclose" onclick="closeOfflineModal()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48">
          <line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          <line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
        </svg>
      </button>
      <div id="offline-step"></div>
    </div>
  </div>
  
  <div class="modal-bg" id="install-modal">
    <div class="modal-feedback" style="max-width:400px;">
      <button class="bigclose" onclick="closeInstallModal()" title="–ó–∞–∫—Ä—ã—Ç—å">
  <svg viewBox="0 0 48 48">
    <line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
    <line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
  </svg>
</button>
      <div style="font-size:1.18em;font-weight:700;margin-bottom:13px;">
        –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ<br>¬´–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞¬ª?
      </div>
      <div style="margin-bottom:16px;font-size:1em;">
        –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ –≤–∞—à–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ, –∑–∞–π–º—ë—Ç ~1 –ú–ë.<br>
        –ï–≥–æ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç —É–¥–∞–ª–∏—Ç—å –∫–∞–∫ –æ–±—ã—á–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.<br>
        –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞.<br><br>
        <b>–î–ª—è –∑–∞—â–∏—Ç—ã –∑–∞–ø—É—Å—Ç–∏–º –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–µ —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤.</b>
      </div>
      <div id="install-modal-hash" style="font-size:.95em; color:#4daaff; margin-bottom:10px; display:none;">
        –•—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ...<br>
        <span id="install-hash-progress"></span>
      </div>
      <button class="offline-btn online" id="install-proceed-btn" style="width:99%;margin-bottom:7px;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
      <button class="offline-btn" style="width:99%;" onclick="closeInstallModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
  
  <div class="modal-bg" id="download-modal">
    <div class="modal-feedback" style="max-width:400px;">
      <div class="download-modal-title">–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å —Å —ç—Ç–∏–º —Ñ–∞–π–ª–æ–º?</div>
      <div style="margin-bottom:19px;font-size:.98em;" id="download-modal-filename"></div>
      <button class="offline-btn online" style="width:98%;margin-bottom:10px;" onclick="downloadCurrentTrack()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="shareCurrentTrack()">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –¥—Ä—É–∑—å—è–º–∏</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="openInAppCurrentTrack()">–û—Ç–∫—Ä—ã—Ç—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="copyLinkCurrentTrack()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="openAlbumDownloadModal()">–°–∫–∞—á–∞—Ç—å –≤–µ—Å—å –∞–ª—å–±–æ–º</button>
      <button class="offline-btn" style="width:98%;" onclick="closeDownloadModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
  
  <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∞–ª—å–±–æ–º–∞ -->
  <div class="modal-bg" id="albumDownloadModal">
    <div class="modal-feedback" style="max-width: 400px;">
      <h2 style="text-align: center; margin-bottom: 25px;">–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º</h2>
      
      <div class="download-options">
        <label class="checkbox-container">
          <input type="checkbox" id="includeCovers" checked>
          <span class="checkmark"></span>
          –û–±–ª–æ–∂–∫–∏ (–≥–∞–ª–µ—Ä–µ—è)
        </label>
        
        <label class="checkbox-container">
          <input type="checkbox" id="includeLyrics" checked>
          <span class="checkmark"></span>
          –¢–µ–∫—Å—Ç—ã –ø–µ—Å–µ–Ω
        </label>
        
        <hr style="margin: 15px 0; border-color: #333;">
        
        <label class="checkbox-container">
          <input type="checkbox" id="onlyFavorites">
          <span class="checkmark"></span>
          –¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –ø–µ—Å–Ω–∏
        </label>
        
        <label class="checkbox-container">
          <input type="checkbox" id="fullAlbum" checked>
          <span class="checkmark"></span>
          –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–ª—å–±–æ–º
        </label>
      </div>
      
      <div class="modal-buttons">
        <button onclick="closeAlbumDownloadModal()" class="btn-secondary">–û–¢–ú–ï–ù–ê</button>
        <button onclick="prepareDownload()" class="btn-primary">–°–ö–ê–ß–ê–¢–¨</button>
      </div>
    </div>
  </div>
  
  <div class="modal-bg" id="sizeConfirmModal">
    <div class="modal-feedback" style="max-width: 350px;">
      <h3 style="text-align: center;">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
      
      <div class="size-info">
        <div style="font-size: 48px; color: #E80100; margin-bottom: 15px;">üì¶</div>
        <p style="font-size: 18px; margin: 10px 0;">
          –†–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞: <strong id="archiveSize">0 –ú–ë</strong>
        </p>
        <p style="color: #888; font-size: 14px;">
          –§–∞–π–ª–æ–≤ –≤ –∞—Ä—Ö–∏–≤–µ: <span id="fileCount">0</span>
        </p>
      </div>
      
      <div class="modal-buttons">
        <button onclick="closeSizeConfirmModal()" class="btn-secondary">–û–¢–ú–ï–ù–ê</button>
        <button onclick="startDownload()" class="btn-primary">–°–ö–ê–ß–ê–¢–¨</button>
      </div>
    </div>
  </div>
  
  <div class="modal-bg" id="downloadProgressModal">
    <div class="modal-feedback" style="max-width: 400px;">
      <h3 style="text-align: center; margin-bottom: 20px;">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞</h3>
      
      <div class="progress-bar">
        <div id="progressFill" class="progress-fill" style="width: 0%"></div>
      </div>
      
      <p id="progressText" style="text-align: center; margin-top: 10px;">
        –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤: 0/0
      </p>
      
      <div id="errorsList" style="display: none; color: #ff6b6b; font-size: 14px; margin-top: 15px;">
        <p><strong>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å:</strong></p>
        <ul id="errorsListContent"></ul>
      </div>
    </div>
  </div>

<script>
// ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
const VERSION = '6.0.0';
const BUILD_DATE = '2024-01-15';

// –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ DOM —ç–ª–µ–º–µ–Ω—Ç—ã
const DOM = {};

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let config = null;
let promoPassed = false;
let configLoaded = false;
let coverGalleryArr = ['Cover.png', 'Cover01.png', 'Cover02.png', 'Cover03.png'];
let coverGalleryIdx = 0;
let coverAutoplay = null;
let currentTrack = -1;
let currentLyrics = [];
let autoPlayEnabled = false;
let offlineMode = false;
let offlineDownloading = false;
let deferredPrompt = null;
let downloadOptions = {
  includeCovers: true,
  includeLyrics: true,
  onlyFavorites: false,
  fullAlbum: true
};
let filesToDownload = [];

// ==================== SERVICE WORKER ====================
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js').then(async reg => {
    console.log('Service Worker registered', reg);
    
    // –ñ–¥—ë–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ SW
    await navigator.serviceWorker.ready;
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ offline
    syncOfflineState();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    reg.addEventListener('updatefound', () => {
      const newWorker = reg.installing;
      newWorker.addEventListener('statechange', () => {
        if (newWorker.state === 'activated') {
          syncOfflineState();
          NotificationSystem.info('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
        }
      });
    });
  });
  
  // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç SW
  navigator.serviceWorker.addEventListener('message', event => {
    if (event.data.type === 'CACHE_UPDATED') {
      console.log('Cache updated to version:', event.data.version);
    }
    if (event.data.type === 'REQUEST_OFFLINE_STATE') {
      syncOfflineState();
    }
  });
}

function syncOfflineState() {
  offlineMode = localStorage.getItem('offlineMode') === '1';
  if (navigator.serviceWorker && navigator.serviceWorker.controller) {
    navigator.serviceWorker.controller.postMessage({
      type: 'SET_OFFLINE_MODE',
      value: offlineMode
    });
  }
}

// ==================== –°–ò–°–¢–ï–ú–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô ====================
class NotificationSystem {
  static queue = [];
  static isShowing = false;
  
  static show(message, type = 'info', duration = 3000) {
    this.queue.push({ message, type, duration });
    if (!this.isShowing) {
      this.processQueue();
    }
  }
  
  static async processQueue() {
    if (this.queue.length === 0) {
      this.isShowing = false;
      return;
    }
    
    this.isShowing = true;
    const { message, type, duration } = this.queue.shift();
    
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
      <div class="toast-content">
        ${this.getIcon(type)}
        <span>${message}</span>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    await new Promise(r => setTimeout(r, 50));
    toast.classList.add('show');
    await new Promise(r => setTimeout(r, duration));
    toast.classList.remove('show');
    await new Promise(r => setTimeout(r, 300));
    toast.remove();
    
    this.processQueue();
  }
  
  static getIcon(type) {
    const icons = {
      info: 'üì¢',
      success: '‚úÖ',
      error: '‚ùå',
      warning: '‚ö†Ô∏è',
      offline: 'üì°'
    };
    return icons[type] || icons.info;
  }
  
  static info(msg) { this.show(msg, 'info'); }
  static success(msg) { this.show(msg, 'success'); }
  static error(msg) { this.show(msg, 'error', 5000); }
  static warning(msg) { this.show(msg, 'warning', 4000); }
  static offline(msg) { this.show(msg, 'offline'); }
}

// ==================== –°–û–•–†–ê–ù–ï–ù–ò–ï –°–û–°–¢–û–Ø–ù–ò–Ø ====================
class PlayerState {
  static save() {
    const audio = document.getElementById('audio');
    const state = {
      trackIndex: currentTrack,
      position: audio ? audio.currentTime : 0,
      volume: audio ? audio.volume : 1,
      liked: getLiked(),
      timestamp: Date.now()
    };
    localStorage.setItem('playerState', JSON.stringify(state));
  }
  
  static restore() {
    try {
      const saved = localStorage.getItem('playerState');
      if (!saved) return null;
      
      const state = JSON.parse(saved);
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ —Å–ª–∏—à–∫–æ–º –ª–∏ —Å—Ç–∞—Ä–æ–µ (24 —á–∞—Å–∞)
      if (Date.now() - state.timestamp > 24 * 60 * 60 * 1000) {
        return null;
      }
      return state;
    } catch (e) {
      return null;
    }
  }
  
  static apply(state) {
    if (!state || !config) return;
    
    if (state.liked) {
      saveLiked(state.liked);
    }
    
    if (state.trackIndex >= 0 && state.trackIndex < config.tracks.length) {
      showTrack(state.trackIndex, false);
      
      setTimeout(() => {
        const audio = document.getElementById('audio');
        if (audio && state.position > 0) {
          audio.currentTime = state.position;
          audio.volume = state.volume || 1;
        }
      }, 500);
    }
  }
}

// –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
setInterval(() => {
  const audio = document.getElementById('audio');
  if (audio && !audio.paused) {
    PlayerState.save();
  }
}, 5000);

window.addEventListener('beforeunload', () => {
  PlayerState.save();
});

// ==================== –ó–ê–ì–†–£–ó–ö–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò ====================
fetch('config.json')
  .then(r => r.json())
  .then(data => {
    config = data;
    configLoaded = true;
    document.getElementById('promo-inp').disabled = false;
    document.getElementById('promo-btn').disabled = false;
    
    if (localStorage.getItem('promoPassed') === '1') {
      promoPassed = true;
      document.getElementById('main-block').classList.remove('hidden');
      document.getElementById('promocode-block').classList.add('hidden');
      initializeMainUi();
      
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      const savedState = PlayerState.restore();
      if (savedState) {
        PlayerState.apply(savedState);
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º deep links
      parseDeepLink();
    }
  })
  .catch(err => {
    console.error('Failed to load config:', err);
    NotificationSystem.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏');
  });

// ==================== –ü–†–û–ú–û–ö–û–î ====================
function checkPromo() {
  const val = document.getElementById('promo-inp').value.trim();
  if (!configLoaded) {
    document.getElementById('promo-error').innerText = "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö... –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥.";
    return;
  }
  if (val && config && val.toUpperCase() === config.promoCode.toUpperCase()) {
    promoPassed = true;
    localStorage.setItem('promoPassed', '1');
    document.getElementById('main-block').classList.remove('hidden');
    document.getElementById('promocode-block').classList.add('hidden');
    initializeMainUi();
    setOfflineUIState(offlineMode ? 'offline' : 'online');
  } else {
    document.getElementById('promo-error').innerText = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë!";
  }
}

document.getElementById('promo-inp').addEventListener('keydown', function(e) {
  if (e.key === "Enter") checkPromo();
});

// ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø UI ====================
function initializeMainUi() {
  // –ö—ç—à–∏—Ä—É–µ–º DOM —ç–ª–µ–º–µ–Ω—Ç—ã
  DOM.cover = document.getElementById('cover');
  DOM.trackList = document.getElementById('track-list');
  DOM.socialLinks = document.getElementById('social-links');
  
  setCoverImage(coverGalleryIdx);
  buildSocials();
  document.getElementById('support-link').href = config.donateLink;
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–Ω
  if (config.background) {
    document.body.style.background = `url(${config.background}) center/cover fixed #111`;
  }
  
  buildTrackList();
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
  document.getElementById('feedback-link').onclick = openFeedbackModal;
  document.getElementById('modal-feedback').onclick = function(e) {
    if (e.target === this) closeFeedbackModal();
  };
  
  // –ì–∞–ª–µ—Ä–µ—è –æ–±–ª–æ–∂–µ–∫
  document.getElementById('cover-gallery-arrow-left').onclick = function() {
    setCoverImage(coverGalleryIdx - 1);
    startCoverAutoPlay();
  };
  
  document.getElementById('cover-gallery-arrow-right').onclick = function() {
    setCoverImage(coverGalleryIdx + 1);
    startCoverAutoPlay();
  };
  
  // –°–≤–∞–π–ø—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
  let startX = null;
  const el = document.getElementById('cover-wrap');
  
  el.addEventListener('touchstart', function(e) {
    startX = e.touches[0].clientX;
  });
  
  el.addEventListener('touchend', function(e) {
    if (startX === null) return;
    const dx = e.changedTouches[0].clientX - startX;
    if (Math.abs(dx) > 30) {
      if (dx > 0) {
        setCoverImage(coverGalleryIdx - 1);
      } else {
        setCoverImage(coverGalleryIdx + 1);
      }
      startCoverAutoPlay();
    }
    startX = null;
  });
  
  startCoverAutoPlay();
  initializeAlbumDownloadCheckboxes();
  detectIOSAndShowInstallGuide();
  setOfflineUIState(offlineMode ? 'offline' : 'online');
}

// ==================== –ì–ê–õ–ï–†–ï–Ø –û–ë–õ–û–ñ–ï–ö ====================
function setCoverImage(idx) {
  coverGalleryIdx = (idx + coverGalleryArr.length) % coverGalleryArr.length;
  if (DOM.cover) {
    DOM.cover.src = coverGalleryArr[coverGalleryIdx];
  }
}

function startCoverAutoPlay() {
  if (coverAutoplay) clearInterval(coverAutoplay);
  coverAutoplay = setInterval(function() {
    setCoverImage(coverGalleryIdx + 1);
  }, 5000);
}

// ==================== –°–û–¶–ò–ê–õ–¨–ù–´–ï –°–ï–¢–ò ====================
function buildSocials() {
  if (!config || !config.socials) return;
  const links = config.socials.map(x => 
    `<a href="${x.url}" target="_blank" rel="noopener">${x.title}</a>`
  ).join(" ");
  if (DOM.socialLinks) {
    DOM.socialLinks.innerHTML = links;
  }
}

// ==================== –ò–ó–ë–†–ê–ù–ù–û–ï ====================
function getLiked() {
  try {
    return JSON.parse(localStorage.getItem('likedTracks') || "[]");
  } catch(e) {
    return [];
  }
}

function saveLiked(arr) {
  localStorage.setItem('likedTracks', JSON.stringify(arr));
}

function isLiked(idx) {
  const liked = getLiked();
  return liked.indexOf(idx) !== -1;
}

// –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è toggleLike - –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
function toggleLike(idx, e) {
  if (e) {
    e.stopPropagation();
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
  let liked = getLiked();
  const wasLiked = liked.indexOf(idx) !== -1;
  
  if (wasLiked) {
    liked = liked.filter(i => i !== idx);
  } else {
    liked.push(idx);
  }
  
  saveLiked(liked);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∫–æ–Ω–∫—É –±–µ–∑ –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∏ DOM
  const star = e ? e.target : document.querySelector(`#trk${idx} .like-star`);
  if (star) {
    star.src = wasLiked ? 'img/star2.png' : 'img/star.png';
    star.title = wasLiked ? '–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è' : '–£–±—Ä–∞—Ç—å –∏–∑ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏—Ö—Å—è';
    
    // –ê–Ω–∏–º–∞—Ü–∏—è
    star.classList.add('animating');
    setTimeout(() => {
      star.classList.remove('animating');
    }, 300);
  }
  
  // –ù–ï –≤—ã–∑—ã–≤–∞–µ–º buildTrackList() - –ø–ª–µ–µ—Ä –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –∏–≥—Ä–∞—Ç—å
}

// ==================== –°–ü–ò–°–û–ö –¢–†–ï–ö–û–í ====================
function buildTrackList() {
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—è
  const audio = document.getElementById('audio');
  let audioState = null;
  if (audio && currentTrack >= 0) {
    audioState = {
      currentTime: audio.currentTime,
      paused: audio.paused,
      volume: audio.volume
    };
  }
  
  let html = "";
  for (let i = 0; i < config.tracks.length; i++) {
    html += `<div class="track${i === currentTrack ? ' current' : ''}" id="trk${i}" onclick="pickAndPlayTrack(${i})">
      <span class="tnum">${(i + 1).toString().padStart(2, '0')}.</span>
      <span class="track-title">${config.tracks[i].title}</span>
      <img src="${isLiked(i) ? 'img/star.png' : 'img/star2.png'}" 
        class="like-star"
        alt="–∑–≤–µ–∑–¥–∞" 
        title="${isLiked(i) ? '–£–±—Ä–∞—Ç—å –∏–∑ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏—Ö—Å—è' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è'}"
        onclick="toggleLike(${i}, event)"/>
    </div>`;
    
    if (i === currentTrack) {
      html += `<div class="lyrics-player-block" id="lyricsplayerblock"></div>`;
    }
  }
  
  if (DOM.trackList) {
    DOM.trackList.innerHTML = html;
  }
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–ª–µ–µ—Ä –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
  if (currentTrack >= 0) {
    renderLyricsBlock();
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
    if (audioState) {
      setTimeout(() => {
        const newAudio = document.getElementById('audio');
        if (newAudio) {
          newAudio.currentTime = audioState.currentTime;
          newAudio.volume = audioState.volume;
          if (!audioState.paused) {
            newAudio.play().catch(e => console.log('Autoplay prevented:', e));
          }
        }
      }, 100);
    }
  }
}

// ==================== –ü–†–û–ò–ì–†–´–í–ê–¢–ï–õ–¨ ====================
function pickAndPlayTrack(n) {
  showTrack(n, true);
  autoPlayEnabled = true;
}

function showTrack(n, doPlay) {
  currentTrack = n;
  buildTrackList();
  
  if (doPlay && document.getElementById("audio")) {
    setTimeout(() => {
      document.getElementById("audio").play();
    }, 140);
  }
}

function renderLyricsBlock() {
  const block = document.getElementById('lyricsplayerblock');
  if (!block) return;
  
  let lyricsDiv = `
    <div id="lyrics-window">
      <div class="lyrics-scroll" id="lyrics"></div>
    </div>
    <div class="audio-wrapper">
      <audio id="audio" controls preload="metadata"></audio>
    </div>
    <div class="player-buttons-center">
      <button class="karaoke-btn" onclick="copyLyrics()">–°–ö–û–ü–ò–†–û–í–ê–¢–¨ –¢–ï–ö–°–¢</button>
      <a class="player-download-btn" href="#" onclick="openDownloadModal(event)">–°–ö–ê–ß–ê–¢–¨ –ü–ï–°–ù–Æ</a>
    </div>`;
  
  block.innerHTML = lyricsDiv;
  
  const tr = config.tracks[currentTrack];
  const audioEl = document.getElementById('audio');
  audioEl.src = tr.audio;
  
  loadLyrics(tr.lyrics);
  setupMediaSession();
  
  audioEl.ontimeupdate = function() {
    renderLyrics(this.currentTime);
  };
  
  audioEl.onended = function() {
    if (autoPlayEnabled) {
      const next = (currentTrack + 1) % config.tracks.length;
      showTrack(next, true);
    }
  };
}

// ==================== MEDIA SESSION API ====================
function setupMediaSession() {
  if ('mediaSession' in navigator) {
    const track = config.tracks[currentTrack];
    
    navigator.mediaSession.metadata = new MediaMetadata({
      title: track.title,
      artist: config.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
      album: config.albumName || '–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º',
      artwork: [
        { src: 'Cover.png', sizes: '512x512', type: 'image/png' },
        { src: 'icons/icon-192.png', sizes: '192x192', type: 'image/png' },
        { src: 'icons/icon-512.png', sizes: '512x512', type: 'image/png' }
      ]
    });
    
    navigator.mediaSession.setActionHandler('play', () => {
      document.getElementById('audio')?.play();
    });
    
    navigator.mediaSession.setActionHandler('pause', () => {
      document.getElementById('audio')?.pause();
    });
    
    navigator.mediaSession.setActionHandler('previoustrack', () => {
      showTrack(Math.max(currentTrack - 1, 0), true);
    });
    
    navigator.mediaSession.setActionHandler('nexttrack', () => {
      showTrack((currentTrack + 1) % config.tracks.length, true);
    });
    
    navigator.mediaSession.setActionHandler('seekto', (details) => {
      const audio = document.getElementById('audio');
      if (audio) audio.currentTime = details.seekTime;
    });
  }
}

// ==================== –ö–ê–†–ê–û–ö–ï ====================
function loadLyrics(file) {
  fetch(file)
    .then(r => r.json())
    .then(js => {
      currentLyrics = js;
      renderLyrics(0);
    })
    .catch(err => {
      console.error('Failed to load lyrics:', err);
      currentLyrics = [];
    });
}

function renderLyrics(time) {
  if (!currentLyrics || !currentLyrics.length) {
    document.getElementById('lyrics').innerHTML = "";
    return;
  }
  
  let active = 0;
  for (let i = 0; i < currentLyrics.length; i++) {
    if (time >= currentLyrics[i].time) active = i;
  }
  
  const windowSize = 5;
  const start = active < 2 ? 0 : active - 2;
  const padTop = active < 2 ? 2 - active : 0;
  const rows = [];
  
  for (let p = 0; p < padTop; ++p) {
    rows.push('<div class="lyrics-window-line"></div>');
  }
  
  for (let i = start; i < Math.min(currentLyrics.length, start + windowSize - padTop); i++) {
    const cls = (i === active) ? 'lyrics-window-line active' : 'lyrics-window-line';
    rows.push(`<div class="${cls}">${currentLyrics[i] ? currentLyrics[i].line : ""}</div>`);
  }
  
  while (rows.length < windowSize) {
    rows.push('<div class="lyrics-window-line"></div>');
  }
  
  document.getElementById("lyrics").innerHTML = rows.join("");
}

function copyLyrics() {
  if (!config || currentTrack < 0 || !config.tracks[currentTrack].fulltext) {
    NotificationSystem.warning("–§–∞–π–ª —Å —Ç–µ–∫—Å—Ç–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω!");
    return;
  }
  
  fetch(config.tracks[currentTrack].fulltext)
    .then(r => {
      if (!r.ok) throw new Error("–ù–µ –Ω–∞–π–¥–µ–Ω");
      return r.text();
    })
    .then(txt => {
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(txt).then(
          () => NotificationSystem.success("–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!"),
          () => NotificationSystem.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å")
        );
      } else {
        const textarea = document.createElement("textarea");
        textarea.value = txt;
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
          NotificationSystem.success("–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!");
        } catch(e) {
          NotificationSystem.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
        }
        document.body.removeChild(textarea);
      }
    })
    .catch(() => {
      NotificationSystem.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç!");
    });
}

// ==================== DEEP LINKS ====================
function parseDeepLink() {
  const params = new URLSearchParams(window.location.search);
  
  const trackParam = params.get('track');
  if (trackParam) {
    const trackIndex = parseInt(trackParam, 10);
    if (trackIndex >= 0 && trackIndex < config.tracks.length) {
      showTrack(trackIndex, true);
      
      setTimeout(() => {
        document.getElementById(`trk${trackIndex}`)?.scrollIntoView({
          behavior: 'smooth',
          block: 'center'
        });
      }, 300);
    }
  }
  
  const timeParam = params.get('time');
  if (timeParam) {
    setTimeout(() => {
      const audio = document.getElementById('audio');
      if (audio) {
        audio.currentTime = parseInt(timeParam, 10);
      }
    }, 1000);
  }
}

function getShareLink(trackIndex) {
  const baseUrl = window.location.origin + window.location.pathname;
  const audio = document.getElementById('audio');
  const time = audio ? Math.floor(audio.currentTime) : 0;
  
  return `${baseUrl}?track=${trackIndex}${time > 10 ? `&time=${time}` : ''}`;
}

// ==================== –°–ö–ê–ß–ò–í–ê–ù–ò–ï –¢–†–ï–ö–û–í ====================
function getTrackFileName(track, idx, artist) {
  return `${(idx + 1).toString().padStart(2, '0')} - ${track.title} - ${artist}.mp3`
    .replace(/[\\/:"*?<>|]+/g, '_');
}

function openDownloadModal(e) {
  if (e) e.preventDefault();
  
  const tr = config.tracks[currentTrack];
  const fileName = getTrackFileName(tr, currentTrack, config.artist);
  document.getElementById('download-modal-filename').innerHTML = `<b>${fileName}</b>`;
  document.getElementById('download-modal').classList.add('active');
}

function closeDownloadModal() {
  document.getElementById('download-modal').classList.remove('active');
}

document.getElementById('download-modal').onclick = function(e) {
  if (e.target === this) closeDownloadModal();
};

function downloadCurrentTrack() {
  const tr = config.tracks[currentTrack];
  const fileName = getTrackFileName(tr, currentTrack, config.artist);
  const url = tr.audio;
  
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  window.setTimeout(() => {
    document.body.removeChild(a);
  }, 250);
  closeDownloadModal();
  NotificationSystem.success('–§–∞–π–ª –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω!');
}

async function shareCurrentTrack() {
  const track = config.tracks[currentTrack];
  const shareUrl = getShareLink(currentTrack);
  const shareText = `üéµ ${track.title} - ${config.artist}\nüéß –°–ª—É—à–∞–π –Ω–∞:`;
  
  if (navigator.share) {
    try {
      await navigator.share({
        title: track.title,
        text: shareText,
        url: shareUrl
      });
      NotificationSystem.success('–°—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
      closeDownloadModal();
    } catch (e) {
      // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª
    }
  } else {
    // Fallback - –∫–æ–ø–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É
    navigator.clipboard.writeText(`${shareText}\n${shareUrl}`);
    NotificationSystem.success('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
  }
}

async function openInAppCurrentTrack() {
  await shareCurrentTrack();
}

function copyLinkCurrentTrack() {
  const shareUrl = getShareLink(currentTrack);
  
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(shareUrl).then(
      () => NotificationSystem.success('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!'),
      () => NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É')
    );
  } else {
    const textarea = document.createElement("textarea");
    textarea.value = shareUrl;
    document.body.appendChild(textarea);
    textarea.select();
    try {
      document.execCommand('copy');
      NotificationSystem.success('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
    } catch(e) {
      NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É');
    }
    document.body.removeChild(textarea);
  }
  closeDownloadModal();
}

// ==================== –°–ö–ê–ß–ò–í–ê–ù–ò–ï –ê–õ–¨–ë–û–ú–ê ====================
// –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ JSZip
function loadJSZip() {
  if (window.JSZip) return Promise.resolve();
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

function initializeAlbumDownloadCheckboxes() {
  const onlyFavCheckbox = document.getElementById('onlyFavorites');
  const fullAlbumCheckbox = document.getElementById('fullAlbum');
  
  // –í–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞—é—â–∏–µ —á–µ–∫–±–æ–∫—Å—ã
  onlyFavCheckbox.addEventListener('change', function() {
    if (this.checked) {
      fullAlbumCheckbox.checked = false;
      const likedTracks = getLiked();
      if (likedTracks.length === 0) {
        this.checked = false;
        NotificationSystem.warning('–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è');
      }
    }
  });
  
  fullAlbumCheckbox.addEventListener('change', function() {
    if (this.checked) {
      onlyFavCheckbox.checked = false;
    }
  });
  
  checkFavoritesAvailable();
}

function checkFavoritesAvailable() {
  const favCheckbox = document.getElementById('onlyFavorites');
  const likedTracks = getLiked();
  
  if (likedTracks.length === 0) {
    favCheckbox.disabled = true;
    favCheckbox.parentElement.style.opacity = '0.5';
    favCheckbox.parentElement.title = '–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤';
  } else {
    favCheckbox.disabled = false;
    favCheckbox.parentElement.style.opacity = '1';
    favCheckbox.parentElement.title = `–ò–∑–±—Ä–∞–Ω–Ω—ã—Ö: ${likedTracks.length}`;
  }
}

function openAlbumDownloadModal() {
  closeDownloadModal();
  checkFavoritesAvailable();
  document.getElementById('albumDownloadModal').classList.add('active');
}

function closeAlbumDownloadModal() {
  document.getElementById('albumDownloadModal').classList.remove('active');
}

document.getElementById('albumDownloadModal').onclick = function(e) {
  if (e.target === this) closeAlbumDownloadModal();
};

// –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Ñ–∞–π–ª–æ–≤ - –±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
async function prepareFilesList() {
  filesToDownload = [];
  const addedFiles = new Set(); // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ç—Ä–µ–∫–æ–≤
  let trackIndices = [];
  const likedTracks = getLiked();
  
  // –í–∞–∂–Ω–æ: onlyFavorites –∏ fullAlbum –≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞—é—â–∏–µ
  if (downloadOptions.onlyFavorites && likedTracks.length > 0) {
    trackIndices = likedTracks;
  } else if (downloadOptions.fullAlbum) {
    trackIndices = config.tracks.map((_, i) => i);
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º MP3 –∏ —Ç–µ–∫—Å—Ç—ã
  for (let idx of trackIndices) {
    const track = config.tracks[idx];
    const num = String(idx + 1).padStart(2, '0');
    const mp3FileName = `${num} - ${track.title} - ${config.artist}.mp3`;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω
    if (!addedFiles.has(mp3FileName)) {
      addedFiles.add(mp3FileName);
      filesToDownload.push({
        url: track.audio,
        name: mp3FileName,
        type: 'audio'
      });
    }
    
    // –¢–µ–∫—Å—Ç—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if (downloadOptions.includeLyrics && track.fulltext) {
      const lyricsName = `${num} - ${track.title} - ${config.artist}.txt`;
      
      if (!addedFiles.has(lyricsName)) {
        addedFiles.add(lyricsName);
        try {
          const response = await fetch(track.fulltext);
          const text = await response.text();
          filesToDownload.push({
            content: text,
            name: lyricsName,
            type: 'text'
          });
        } catch(e) {
          console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç –¥–ª—è', track.title);
        }
      }
    }
  }
  
  // –û–±–ª–æ–∂–∫–∏ (—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑)
  if (downloadOptions.includeCovers) {
    coverGalleryArr.forEach(cover => {
      const coverName = cover.split('/').pop();
      if (!addedFiles.has(coverName)) {
        addedFiles.add(coverName);
        filesToDownload.push({
          url: cover,
          name: coverName,
          type: 'image'
        });
      }
    });
  }
  
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
  if (!addedFiles.has('logo.png')) {
    filesToDownload.push({
      url: 'img/logo.png',
      name: 'logo.png',
      type: 'image'
    });
  }
  
  if (!addedFiles.has('social.txt')) {
    filesToDownload.push({
      content: generateSocialText(),
      name: 'social.txt',
      type: 'text'
    });
  }
  
  console.log(`–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ ${filesToDownload.length} —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∞—Ä—Ö–∏–≤–∞`);
}

function generateSocialText() {
  const socials = config.socials || [];
  let socialLinks = '';
  
  socials.forEach(social => {
    socialLinks += `${social.title}: ${social.url}\n`;
  });
  
  return `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       –í–ò–¢–†–ò–ù–ê –†–ê–ó–ë–ò–¢–ê - –ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ç–µ—Ä–µ—Å –∫ –Ω–∞—à–µ–º—É —Ç–≤–æ—Ä—á–µ—Å—Ç–≤—É!
–í–∞—à–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—á–µ–Ω—å –≤–∞–∂–Ω–∞ –¥–ª—è –Ω–∞—Å.

–ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ –Ω–∞—à–∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏:

${socialLinks}
–î–µ–ª–∏—Ç–µ—Å—å –º—É–∑—ã–∫–æ–π —Å –¥—Ä—É–∑—å—è–º–∏!
–° –ª—é–±–æ–≤—å—é, –≥—Ä—É–ø–ø–∞ "–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞"

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;
}

async function prepareDownload() {
  // –°–æ–±–∏—Ä–∞–µ–º –æ–ø—Ü–∏–∏
  downloadOptions.includeCovers = document.getElementById('includeCovers').checked;
  downloadOptions.includeLyrics = document.getElementById('includeLyrics').checked;
  downloadOptions.onlyFavorites = document.getElementById('onlyFavorites').checked;
  downloadOptions.fullAlbum = document.getElementById('fullAlbum').checked;
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è
  if (!downloadOptions.onlyFavorites && !downloadOptions.fullAlbum) {
    NotificationSystem.warning('–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–∫–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è');
    return;
  }
  
  if (downloadOptions.onlyFavorites && getLiked().length === 0) {
    NotificationSystem.warning('–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è');
    return;
  }
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º JSZip –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
  await loadJSZip();
  
  // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
  await prepareFilesList();
  
  if (filesToDownload.length === 0) {
    NotificationSystem.error('–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä—Ö–∏–≤–∞');
    return;
  }
  
  // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä
  const sizeMB = await calculateArchiveSize();
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
  document.getElementById('archiveSize').textContent = sizeMB + ' –ú–ë';
  document.getElementById('fileCount').textContent = filesToDownload.length;
  
  closeAlbumDownloadModal();
  document.getElementById('sizeConfirmModal').classList.add('active');
}

async function calculateArchiveSize() {
  let totalSize = 0;
  const promises = [];
  
  for (let file of filesToDownload) {
    if (file.url) {
      promises.push(
        fetch(file.url, { method: 'HEAD' })
          .then(response => {
            const size = response.headers.get('content-length');
            if (size) totalSize += parseInt(size);
          })
          .catch(() => {
            // –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
            if (file.type === 'audio') totalSize += 5 * 1024 * 1024;
            if (file.type === 'image') totalSize += 500 * 1024;
          })
      );
    } else if (file.content) {
      totalSize += new Blob([file.content]).size;
    }
  }
  
  await Promise.all(promises);
  
  // +10% –Ω–∞ ZIP overhead
  totalSize = Math.ceil(totalSize * 1.1);
  
  return (totalSize / 1024 / 1024).toFixed(1);
}

function closeSizeConfirmModal() {
  document.getElementById('sizeConfirmModal').classList.remove('active');
}

document.getElementById('sizeConfirmModal').onclick = function(e) {
  if (e.target === this) closeSizeConfirmModal();
};

function startDownload() {
  closeSizeConfirmModal();
  createAndDownloadZip();
}

function showProgressModal() {
  document.getElementById('downloadProgressModal').classList.add('active');
  document.getElementById('progressFill').style.width = '0%';
  document.getElementById('progressText').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤: 0/' + filesToDownload.length;
  document.getElementById('errorsList').style.display = 'none';
}

function updateProgress(completed, total) {
  const percent = Math.round((completed / total) * 100);
  document.getElementById('progressFill').style.width = percent + '%';
  document.getElementById('progressText').textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤: ${completed}/${total}`;
}

function showErrors(errors) {
  if (errors.length > 0) {
    document.getElementById('errorsList').style.display = 'block';
    document.getElementById('errorsListContent').innerHTML = errors.map(e => `<li>${e}</li>`).join('');
  }
}

async function createAndDownloadZip() {
  if (!window.JSZip) {
    await loadJSZip();
  }
  
  const zip = new JSZip();
  const errors = [];
  let completed = 0;
  
  showProgressModal();
  
  for (let file of filesToDownload) {
    try {
      if (file.url) {
        const response = await fetch(file.url);
        const blob = await response.blob();
        zip.file(file.name, blob);
      } else if (file.content) {
        zip.file(file.name, file.content);
      }
      
      completed++;
      updateProgress(completed, filesToDownload.length);
      
    } catch (error) {
      errors.push(file.name);
      console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${file.name}:`, error);
    }
  }
  
  if (errors.length > 0) {
    showErrors(errors);
    await new Promise(resolve => setTimeout(resolve, 3000));
  }
  
  document.getElementById('progressText').textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞...';
  
  const content = await zip.generateAsync({
    type: "blob",
    compression: "DEFLATE",
    compressionOptions: { level: 6 }
  }, function updateCallback(metadata) {
    const progress = metadata.percent.toFixed(0);
    document.getElementById('progressText').textContent = `–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞: ${progress}%`;
    document.getElementById('progressFill').style.width = progress + '%';
  });
  
  const link = document.createElement('a');
  link.href = URL.createObjectURL(content);
  link.download = 'vitrina-razbita-mezhdu-zlom-i-dobrom.zip';
  link.click();
  
  setTimeout(() => {
    document.getElementById('downloadProgressModal').classList.remove('active');
    NotificationSystem.success('–ê—Ä—Ö–∏–≤ —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω!');
    URL.revokeObjectURL(link.href); // –û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏
  }, 1500);
}

// ==================== –û–§–õ–ê–ô–ù –†–ï–ñ–ò–ú ====================
function offlineUIClick() {
  if (offlineDownloading) return;
  
  if (!offlineMode) {
    document.getElementById('modal-offline').classList.add('active');
    document.getElementById('offline-step').innerHTML = `
      <div style="font-size:1.09em;font-weight:700;margin-bottom:10px;">–û—Ñ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º</div>
      <div style="margin-bottom:16px;">–î–ª—è —Ä–∞–±–æ—Ç—ã –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –Ω—É–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –º—É–∑—ã–∫—É –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.<br>
      –≠—Ç–æ –∑–∞–π–º—ë—Ç <b>–º–µ—Å—Ç–æ</b> –∏ –≤—Ä–µ–º—è.<br>
      <div style="color:#e80100;margin:5px 0 0 0;">
        ‚ö† –ù–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö (iOS Safari) —Ä–∞–∑–º–µ—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω (~50-150 –ú–ë).
      </div>
      <div style="margin:8px 0 0 0;opacity:.7;">
        –ü–æ—Å–ª–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤—ã —Å–º–æ–∂–µ—Ç–µ —Å–ª—É—à–∞—Ç—å OFFLINE-—Ñ–∞–π–ª—ã –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.
      </div>
      </div>
      <button class="offline-btn online" style="width:99%;margin-bottom:7px;" onclick="nextOfflineChoice()">–°–æ–≥–ª–∞—Å–µ–Ω</button>
      <button class="offline-btn" style="width:99%;" onclick="closeOfflineModal()">–û—Ç–º–µ–Ω–∞</button>`;
  } else {
    document.getElementById('modal-offline').classList.add('active');
    document.getElementById('offline-step').innerHTML = `
      <div style="font-size:1.10em;font-weight:700;margin-bottom:15px;">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ ONLINE?</div>
      <div style="margin-bottom:20px;">–í—Å–µ —Å–∫–∞—á–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.<br>
      –û—á–∏—â–∞–µ—Ç—Å—è –º–µ—Å—Ç–æ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.<br>
      –ü–µ—Å–Ω–∏ —Å–Ω–æ–≤–∞ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.
      </div>
      <button class="offline-btn online" style="width:99%;" onclick="confirmGoOnline()">–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª—ã –∏ –≤–æ–∑–≤—Ä–∞—Ç ONLINE</button>
      <button class="offline-btn" style="width:99%;margin-top:7px;" onclick="closeOfflineModal()">–û—Ç–º–µ–Ω–∞</button>`;
  }
}

function closeOfflineModal() {
  document.getElementById('modal-offline').classList.remove('active');
}

function nextOfflineChoice() {
  const d = getDownloadStats();
  document.getElementById('offline-step').innerHTML = `
    <div style="font-size:1.10em;font-weight:700;margin-bottom:13px;">–ß—Ç–æ —Å–∫–∞—á–∞—Ç—å?</div>
    <div style="text-align:left;">
      <label style="display:block;margin:8px 0;">
        <input type="radio" name="offline-mode" value="all" checked>
        –í–µ—Å—å –¥–∏—Å–∫ (${d.allCount} –ø–µ—Å–µ–Ω, ${d.allSizeMb} –ú–ë)
      </label>
      <label style="display:block;margin:8px 0;">
        <input type="radio" name="offline-mode" value="liked">
        –¢–æ–ª—å–∫–æ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è (${d.likedCount || 0} –ø–µ—Å–µ–Ω, ${d.likedSizeMb || 0} –ú–ë)
      </label>
    </div>
    <button class="offline-btn online" style="width:99%;margin-top:12px;" onclick="startOfflineDownload()">–°–∫–∞—á–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ</button>
    <button class="offline-btn" style="width:99%;margin-top:8px;" onclick="closeOfflineModal()">–û—Ç–º–µ–Ω–∞</button>`;
}

function getAudioSize(idx) {
  return config.tracks[idx].size || 4.7;
}

function getDownloadStats() {
  const liked = getLiked();
  const allCount = config.tracks.length;
  const likedCount = liked.length;
  
  let allMb = 0, likeMb = 0;
  for (let i = 0; i < allCount; ++i) {
    allMb += getAudioSize(i);
    if (liked.indexOf(i) !== -1) likeMb += getAudioSize(i);
  }
  
  return {
    allSizeMb: Math.round(allMb * 10) / 10,
    likedSizeMb: Math.round(likeMb * 10) / 10,
    likedCount,
    allCount
  };
}

function getAllAssetsForOffline(mode) {
  const all = ['index.html', 'config.json', 'img/logo.png', 'img/star.png', 'img/star2.png',
               'Cover.png', 'Cover01.png', 'Cover02.png', 'Cover03.png'];
  const liked = getLiked();
  
  for (let i = 0; i < config.tracks.length; ++i) {
    if (mode === 'all' || liked.indexOf(i) !== -1) {
      all.push(config.tracks[i].audio);
      all.push(config.tracks[i].lyrics);
      if (config.tracks[i].fulltext) all.push(config.tracks[i].fulltext);
    }
  }
  
  return [...new Set(all)];
}

function startOfflineDownload() {
  offlineDownloading = true;
  closeOfflineModal();
  setOfflineUIState('downloading');
  
  const mode = document.querySelector('input[name="offline-mode"]:checked').value;
  const files = getAllAssetsForOffline(mode);
  
  navigator.serviceWorker.ready.then(async sw => {
    sw.active.postMessage({
      type: 'CACHE_FILES',
      files,
      offlineMode: true // –Ø–≤–Ω–æ –ø–µ—Ä–µ–¥–∞—ë–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    });
    
    const stats = getDownloadStats();
    const needMb = (mode == 'all' ? stats.allSizeMb : stats.likedSizeMb);
    const max = files.length;
    
    const checkAll = setInterval(async () => {
      const cache = await caches.open('album-offline-v1');
      let ok = 0;
      
      for (let src of files) {
        const res = await cache.match(src);
        if (res) ok++;
      }
      
      setOfflineUIState('downloading', ok / max, needMb);
      
      if (ok >= max) {
        clearInterval(checkAll);
        offlineDownloading = false;
        offlineMode = true;
        localStorage.setItem('offlineMode', '1');
        setOfflineUIState('offline');
        offlineShowDone(needMb, mode);
        syncOfflineState(); // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å SW
      }
    }, 400);
  });
}

function setOfflineUIState(state, progress, needMb) {
  const btn = document.getElementById('offline-btn');
  
  if (state === 'downloading') {
    btn.disabled = true;
    btn.className = 'offline-btn offline';
    btn.innerHTML = 'OFFLINE';
    
    if (!document.getElementById('offline-progr-div')) {
      const div = document.createElement('div');
      div.id = 'offline-progr-div';
      div.innerHTML = `
        <div class="offline-progress">
          <div class="offline-progress-bar" id="offline-progress-bar" style="width:0%;"></div>
        </div>
        <div class="offline-desc" id="offline-desc"></div>`;
      btn.parentElement.insertBefore(div, btn.nextSibling);
    }
    
    document.getElementById('offline-progress-bar').style.width = Math.round((progress || 0) * 100) + '%';
    document.getElementById('offline-desc').innerText = "–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ " + (needMb || 0) + " –ú–ë ...";
  }
  
  if (state === 'offline') {
    btn.disabled = false;
    btn.className = 'offline-btn offline';
    btn.innerHTML = 'OFFLINE';
    const div = document.getElementById('offline-progr-div');
    if (div) div.remove();
  }
  
  if (state === 'online') {
    btn.disabled = false;
    btn.className = 'offline-btn online';
    btn.innerHTML = 'ONLINE';
    const div = document.getElementById('offline-progr-div');
    if (div) div.remove();
  }
}

function offlineShowDone(mb, mode) {
  document.getElementById('modal-offline').classList.add('active');
  document.getElementById('offline-step').innerHTML = `
    <div style="font-size:1.18em;font-weight:700;margin-bottom:12px;">–í—Å–µ —Ñ–∞–π–ª—ã —Å–∫–∞—á–∞–Ω—ã!</div>
    <div style="margin-bottom:13px;">
      <b>${mode == "all" ? "–í–µ—Å—å –¥–∏—Å–∫" : "–ü–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è —Ç—Ä–µ–∫–∏"}</b><br>
      –î–æ—Å—Ç—É–ø–Ω—ã –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞.<br>
      –ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–∏–º–µ—Ä–Ω–æ <b>${mb} –ú–ë</b>.<br>
      <div style="color:#888;font-size:.98em;margin:5px 0 0 0;">
        –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ: –µ—Å–ª–∏ –∫–µ—à –±—Ä–∞—É–∑–µ—Ä–∞<br>–±—É–¥–µ—Ç –æ—á–∏—â–µ–Ω ‚Äî –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —Å–∫–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ!
      </div>
    </div>
    <button class="offline-btn" style="width:99%;" onclick="closeOfflineModal()">OK</button>`;
}

function confirmGoOnline() {
  offlineMode = false;
  localStorage.removeItem('offlineMode');
  setOfflineUIState('online');
  closeOfflineModal();
  
  navigator.serviceWorker.ready.then(sw => {
    sw.active.postMessage({
      type: 'CLEAR_CACHE',
      offlineMode: false // –Ø–≤–Ω–æ –ø–µ—Ä–µ–¥–∞—ë–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    });
  });
}

// ==================== iOS –ü–û–î–î–ï–†–ñ–ö–ê ====================
function detectIOSAndShowInstallGuide() {
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
  const isInStandaloneMode = window.navigator.standalone === true;
  const isInPWA = window.matchMedia('(display-mode: standalone)').matches;
  
  if (isIOS && !isInStandaloneMode && !isInPWA) {
    if (!localStorage.getItem('ios-install-dismissed')) {
      setTimeout(showIOSInstallPrompt, 2000);
    }
  }
}

function showIOSInstallPrompt() {
  const prompt = document.createElement('div');
  prompt.className = 'ios-install-prompt';
  prompt.innerHTML = `
    <div class="ios-prompt-content">
      <button class="ios-prompt-close" onclick="dismissIOSPrompt()">√ó</button>
      <img src="img/logo.png" alt="Logo" class="ios-prompt-icon">
      <h3>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h3>
      <p>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —Å–≤–æ–π iPhone:</p>
      <ol style="text-align: left;">
        <li>–ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞</li>
        <li>–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ ¬´–ù–∞ —ç–∫—Ä–∞–Ω –î–æ–º–æ–π¬ª</li>
        <li>–ù–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å¬ª</li>
      </ol>
      <button onclick="dismissIOSPrompt()" class="ios-prompt-button">–ü–æ–Ω—è—Ç–Ω–æ</button>
    </div>
  `;
  document.body.appendChild(prompt);
  
  setTimeout(() => prompt.classList.add('show'), 100);
}

function dismissIOSPrompt() {
  const prompt = document.querySelector('.ios-install-prompt');
  if (prompt) {
    prompt.classList.remove('show');
    setTimeout(() => prompt.remove(), 300);
    localStorage.setItem('ios-install-dismissed', Date.now().toString());
  }
}

// ==================== PWA –£–°–¢–ê–ù–û–í–ö–ê ====================
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  const btn = document.getElementById('install-pwa-btn');
  if (btn) btn.style.display = '';
});

document.getElementById('install-pwa-btn').onclick = function() {
  document.getElementById('install-modal').classList.add('active');
  document.getElementById('install-modal-hash').style.display = 'none';
  document.getElementById('install-proceed-btn').disabled = false;
  document.getElementById('install-proceed-btn').innerText = '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
};

function closeInstallModal() {
  document.getElementById('install-modal').classList.remove('active');
}

document.getElementById('install-proceed-btn').onclick = async function() {
  const btn = this;
  btn.disabled = true;
  btn.innerText = '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞...';
  document.getElementById('install-modal-hash').style.display = '';
  document.getElementById('install-hash-progress').innerText = '';
  
  const hash = await hashManifest();
  document.getElementById('install-hash-progress').innerText = 'SHA-256: ' + hash;
  btn.innerText = '–£—Å—Ç–∞–Ω–æ–≤–∫–∞...';
  
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then((choiceResult) => {
      closeInstallModal();
      document.getElementById('install-pwa-btn').style.display = 'none';
      deferredPrompt = null;
    });
  } else {
    alert('–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫—É PWA.');
    closeInstallModal();
  }
};

async function hashManifest() {
  try {
    const resp = await fetch('manifest.json');
    const data = await resp.arrayBuffer();
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  } catch(e) {
    return '[–æ—à–∏–±–∫–∞ —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è]';
  }
}

document.getElementById('install-modal').onclick = function(e) {
  if (e.target === this) closeInstallModal();
};

// ==================== –û–ë–†–ê–¢–ù–ê–Ø –°–í–Ø–ó–¨ ====================
let isRealTextarea = false;

function openFeedbackModal() {
  document.getElementById('modal-feedback').classList.add('active');
  isRealTextarea = false;
  document.getElementById('feedback-step').innerHTML = `
    <div class="fake-textarea" id="fake-textarea" onclick="showRealTextarea()">
      –û–ø–∏—à–∏—Ç–µ –∑–¥–µ—Å—å –ø—Ä–æ–±–ª–µ–º—É –∏–ª–∏ —Å–≤–æ—ë –ø–æ–∂–µ–ª–∞–Ω–∏–µ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è,<br>–º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Å–≤–æ–π –æ—Ç–∑—ã–≤...
    </div>`;
  document.getElementById('modal-feedback-error').innerText = "";
  document.getElementById('modal-feedback-success').innerText = "";
  document.getElementById('send-feedback-btn').disabled = false;
}

function closeFeedbackModal() {
  document.getElementById('modal-feedback').classList.remove('active');
}

function showRealTextarea() {
  if (isRealTextarea) return;
  isRealTextarea = true;
  document.getElementById('feedback-step').innerHTML = 
    `<textarea class="real-textarea" id="feedback-text" maxlength="200" autofocus></textarea>`;
  
  setTimeout(() => {
    const ta = document.getElementById('feedback-text');
    ta.focus();
    ta.addEventListener('input', function() {
      if (this.value.length > 200) this.value = this.value.substr(0, 200);
    });
  }, 20);
}

function sendFeedbackMsg() {
  let msg = "";
  if (isRealTextarea) {
    const ta = document.getElementById('feedback-text');
    msg = ta.value.trim();
  } else return;
  
  const errorDiv = document.getElementById('modal-feedback-error');
  const successDiv = document.getElementById('modal-feedback-success');
  
  errorDiv.innerText = "";
  successDiv.innerText = "";
  
  if (msg.length < 5) {
    errorDiv.innerText = "–ù–∞–ø–∏—à–∏—Ç–µ —Ö–æ—Ç—è –±—ã –ø–∞—Ä—É —Å–ª–æ–≤!";
    return;
  }
  
  document.getElementById('send-feedback-btn').disabled = true;
  successDiv.innerText = "–°–ø–∞—Å–∏–±–æ! –í–∞—à –æ—Ç–∑—ã–≤ –ø—Ä–∏–Ω—è—Ç.";
  setTimeout(closeFeedbackModal, 2100);
}

// ==================== –ö–õ–ê–í–ò–ê–¢–£–†–ù–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø ====================
window.addEventListener('keydown', function(e) {
  // –ü—Ä–æ–±–µ–ª - play/pause
  if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
    e.preventDefault();
    const audio = document.getElementById('audio');
    if (audio) {
      if (audio.paused) {
        audio.play();
      } else {
        audio.pause();
      }
    }
  }
  
  // –°—Ç—Ä–µ–ª–∫–∏ - –ø—Ä–µ–¥—ã–¥—É—â–∏–π/—Å–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫
  if (e.code === 'ArrowLeft' && currentTrack > 0) {
    showTrack(currentTrack - 1, true);
  }
  if (e.code === 'ArrowRight' && currentTrack < config.tracks.length - 1) {
    showTrack(currentTrack + 1, true);
  }
  
  // L - –¥–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
  if (e.code === 'KeyL' && currentTrack >= 0) {
    toggleLike(currentTrack);
  }
});

// ==================== –ú–û–ù–ò–¢–û–†–ò–ù–ì –°–ï–¢–ò ====================
window.addEventListener('online', () => {
  NotificationSystem.success('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
});

window.addEventListener('offline', () => {
  NotificationSystem.offline('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º');
});

// ==================== –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö ====================
window.addEventListener('error', (event) => {
  console.error('Global error:', event);
  if (event.message && !event.message.includes('ResizeObserver')) {
    NotificationSystem.error(`–û—à–∏–±–∫–∞: ${event.message}`);
  }
});

window.addEventListener('unhandledrejection', (event) => {
  console.error('Unhandled promise rejection:', event);
  NotificationSystem.error(`–û—à–∏–±–∫–∞: ${event.reason}`);
});

// ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ====================
document.addEventListener('DOMContentLoaded', function() {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É PWA
  if ('serviceWorker' in navigator && 'caches' in window) {
    console.log('PWA features supported');
  } else {
    console.warn('PWA features not fully supported');
  }
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ offline —Ä–µ–∂–∏–º–∞
  offlineMode = localStorage.getItem('offlineMode') === '1';
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–º–Ω—É—é —Ç–µ–º—É —Å–∏—Å—Ç–µ–º—ã
  if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
    document.body.classList.add('dark-theme');
  }
});

// ==================== PERFORMANCE MONITORING ====================
if (window.performance && performance.mark) {
  performance.mark('app-start');
  
  window.addEventListener('load', () => {
    performance.mark('app-loaded');
    performance.measure('App Load Time', 'app-start', 'app-loaded');
    
    const measure = performance.getEntriesByName('App Load Time')[0];
    console.log(`App loaded in ${measure.duration.toFixed(2)}ms`);
  });
}
</script>

<!-- –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ JSZip —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ -->
<script>
// JSZip –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∞–ª—å–±–æ–º–∞
</script>

</body>
</html>
