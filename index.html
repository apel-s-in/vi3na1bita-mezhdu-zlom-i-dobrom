<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Витрина Разбита</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#181818" />
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    html, body {height: 100%;}
    body {
      min-height: 100vh;
      background: #181818;
      color: #f2f2f2;
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      display: flex; flex-direction: column;
      min-width: 100vw;
    }
    #promocode-block {position:fixed;left:0;top:0;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;background:#181818;z-index:100;}
    .promo-inner {display:flex;flex-direction:column;align-items:center;background:rgba(15,18,24,0.98);border-radius:16px;box-shadow:0 6px 24px #0008;padding:36px 26px 32px 26px;min-width:260px;min-height:170px;}
    .promo-cover {width:256px;height:256px;object-fit:cover;border-radius:12px;box-shadow:0 4px 24px #000c;margin-bottom:19px;display:block;background:#181818;}
    .modal-bg {position:fixed;z-index:99;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.62);display:none;align-items:center;justify-content:center;}
    .modal-bg.active {display:flex;}
    .modal-feedback {background:#252d39;border-radius:14px;padding:34px 20px 21px 20px;min-width:215px;box-shadow:0 4px 32px #0009;max-width:96vw;position:relative;}
    .modal-feedback .bigclose {background:none;border:none;position:absolute;top:13px;right:13px;cursor:pointer;color:#eee;border-radius:50%;width:32px;height:32px;}
    .modal-feedback .bigclose svg {width:31px;height:31px;}
    .hidden {display:none!important;}
    #main-block {max-width:420px;margin:0 auto;flex:1 0 auto;display:flex;flex-direction:column;align-items:center;}
    header {width:100%;text-align:center;margin:0 auto;}
    #cover-wrap {width:100%;max-width:400px;margin:24px auto 0 auto;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;position:relative;}
    .cover-gallery-arrow {
      position: absolute;
      top: 50%; transform: translateY(-50%);
      z-index: 2; border: none; cursor: pointer; background: none; padding: 0;
      width:44px; height:44px; display:flex;align-items:center;justify-content:center;
    }
    #cover-gallery-arrow-left {left:7px;}
    #cover-gallery-arrow-right {right:7px;}
    #cover {width:100%;max-width:100%;border-radius:12px;aspect-ratio:1/1;object-fit:cover;display:block;margin:0;}
    .socials-under-cover {margin:14px auto 0 auto;width:100%;max-width:398px;text-align:center;font-size:1.03em;display:flex;flex-wrap:wrap;justify-content:center;gap:12px;}
    .track-list {margin:0 auto;max-width:370px;width:100%;font-size:1.05em;color:#eee;background:none;padding:0;}
    .track {
      display: flex; align-items: center;
      padding: 7px 8px 7px 8px; border-bottom:1px solid #394866;
      cursor: pointer;transition:background .13s;background:none;
    }
    .track.current {background:#232b38;}
    .tnum {min-width:27px;color:#8ab8fd;}
    .track-title {margin-left:7px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .like-star {
      margin-left: auto; width:19px;height:19px;cursor:pointer;opacity:.97;border:none;background:none;padding:0;appearance:none;display:inline-block;transition:filter .13s, opacity .13s;
    }
    .like-star:hover {filter:brightness(1.13);opacity:1;}
    .lyrics-player-block {width:100%;margin:8px 0 3px 0;}
    #lyrics-window {width:100%;background:rgba(34,34,34,0.98);border-radius:12px;box-shadow:0 8px 24px #0007;overflow:hidden;height:8.5em;position:relative;display:flex;flex-direction:column;align-items:stretch;justify-content:center;margin-bottom:7px;box-sizing:border-box;}
    .lyrics-window-line {opacity:0.57;font-size:1.13em;transition:opacity 0.2s,color 0.2s;line-height:1.7em;text-align:center;min-height:1.7em;max-width:97%;margin:0 auto;color:#eee;white-space:pre-line;user-select:none;word-break:break-word;}
    .lyrics-window-line.active {color:#E80100;font-weight:bold;opacity:1;text-shadow:0 1px 7px #73161644,0 0 0 #fff;background:rgba(0,0,0,0.07);border-radius:8px;font-size:1.19em;}
    .audio-wrapper {width:100%;max-width:395px;margin:0 auto;}
    #audio {width:100%;margin:6px auto 2px auto;display:block;}
    .player-buttons-center {display:flex;flex-direction:column;align-items:center;gap:9px;margin-bottom:7px;margin-top:3px;}
    .karaoke-btn,.player-download-btn {
      color:#4daaff !important;background:none;border:none;cursor:pointer;
      font-size:1em;text-transform:uppercase;font-weight:700;letter-spacing:.02em;text-decoration:underline;transition:color .18s;
      padding:4px 16px;min-width:148px;text-align:center;border-radius:7px;display:block;margin:0 auto;}
    .player-download-btn {margin-top:0;}
    .karaoke-btn:focus,.karaoke-btn:hover,.player-download-btn:focus,.player-download-btn:hover{color: #fff !important; background:#273050;}
    .bottom-controls-center {display:flex;flex-direction:column;align-items:center;justify-content:center;margin:32px auto 0 auto;gap:8px;width:100%;max-width:210px;}
    .logo-bottom {max-width:112px;width:23vw;min-width:66px;height:auto;display:block;margin:0 auto 10px auto !important;}
    #install-pwa-btn {
      color: #fff; background: #4daaff; border: none; border-radius: 7px;
      font-size: 1.07em; font-weight: bold; letter-spacing: .02em;
      margin: 15px 0 5px 0; padding: 8px 13px; cursor:pointer; width: 98%;
      box-shadow: 0 4px 14px #0005; outline:none; transition: background .2s;
    }
    #install-pwa-btn:hover {background: #3275c2;}
    .feedback-link,.support-link{color:#4daaff !important;text-decoration:underline !important;font-weight:700;text-transform:uppercase;letter-spacing:.03em;cursor:pointer;transition:color .18s;font-size:1em;display:block;text-align:center;width:100%;margin:0;}
    .feedback-link:hover,.support-link:hover{color:#fff !important;}
    .offline-btn {min-width:102px;height:38px;font-size:1.05em;font-weight:bold;border:none;border-radius:9px;margin:0 6px;cursor:pointer;letter-spacing:0.07em;box-shadow:0 2px 8px #06000032;transition:background .2s,color .14s;display:block;margin:0 auto;}
    .offline-btn.online {background:#E80100;color:#fff;}
    .offline-btn.offline {background:#27b34c;color:#fff;}
    .offline-btn:active{opacity:0.91;}
    .offline-btn:disabled{opacity:.7;cursor:not-allowed;}
    .offline-progress{margin-top:11px;width:100%;height:8px;background:#222;border-radius:6px;overflow:hidden;box-shadow:0 1px 6px #222b;}
    .offline-progress-bar{height:100%;background:#2fed54;transition:width .33s;}
    .offline-desc{text-align:center;font-size:.97em;margin-top:5px;opacity:.85;}
    /* Новый стиль для центральной большой кнопки */
    .album-download-big-btn {
      background:#1c3050;color:#fff;border:none;border-radius:8px;
      font-size:1.09em;font-weight:bold;margin-bottom:13px;padding:11px 10px;box-shadow:0 2px 9px #0003;cursor:pointer;width:96%;max-width:360px;transition:background .13s;
    }
    .album-download-big-btn:active, .album-download-big-btn:hover { background:#384d6c; }
    .modal-album-title {font-size:1.18em;font-weight:bold;margin-bottom:11px;text-align:center;}
    .album-zip-progress-bar-wrap{width:100%;height:15px;background:#333;border-radius:7px;margin:17px 0 13px 0;box-shadow:0 2px 8px #0004;}
    .album-zip-progress-bar{height:100%;background:#4daaff;border-radius:7px;width:0%;transition:width .2s;}
  </style>
</head>
<body>
  <!-- Меню "Скачать весь альбом" (первое окно - галочки) -->
  <div class="modal-bg" id="album-download-modal">
    <div class="modal-feedback" style="max-width:410px;">
      <div class="modal-album-title" id="album-download-title"></div>
      <form id="album-download-form">
        <label style="display:block;margin:9px 0 4px 0;">
          <input type="checkbox" id="ad-covers" checked> Обложки альбома (галерея)
        </label>
        <label style="display:block;margin:9px 0 4px 0;">
          <input type="checkbox" id="ad-lyrics" checked> Тексты песен
        </label>
        <label style="display:block;margin:9px 0 4px 0;">
          <input type="checkbox" id="ad-liked"> Только избранные песни
        </label>
        <label style="display:block;margin:9px 0 18px 0;">
          <input type="checkbox" id="ad-all" checked> Полностью альбом
        </label>
        <div style="margin-top:6px;">
          <button type="button" class="offline-btn" style="width:48%;margin-right:3%" onclick="closeAlbumDownloadModal()">Отмена</button>
          <button type="button" class="offline-btn online" style="width:48%;" onclick="prepareAlbumZip()">Скачать</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Меню "Подтверждение размера архива" -->
  <div class="modal-bg" id="album-download-size-modal">
    <div class="modal-feedback" style="max-width:410px;text-align:center;">
      <div style="font-size:1.15em;font-weight:700;margin-bottom:12px;">Общий размер архива</div>
      <div id="album-download-size-info" style="margin-bottom:20px;font-size:1.07em;"></div>
      <div>
        <button type="button" class="offline-btn" style="width:48%;margin-right:3%" onclick="closeAlbumDownloadSizeModal()">Отмена</button>
        <button type="button" class="offline-btn online" style="width:48%;" onclick="startAlbumDownloadZip()">Скачать</button>
      </div>
    </div>
  </div>

  <!-- Меню "Прогресс формирования архива" -->
  <div class="modal-bg" id="album-download-progress-modal">
    <div class="modal-feedback" style="max-width:410px;text-align:center;">
      <div style="font-size:1.15em;font-weight:700;margin-bottom:14px;">Формируем архив...</div>
      <div class="album-zip-progress-bar-wrap">
        <div class="album-zip-progress-bar" id="album-zip-progress-bar"></div>
      </div>
      <div id="album-zip-progress-text" style="font-size:1.01em;color:#b3d3fe;margin-bottom:9px;"></div>
      <button type="button" class="offline-btn" id="album-zip-cancel-btn" onclick="cancelAlbumZip()" style="width:80%;margin:15px auto 0 auto;">Отмена</button>
    </div>
  </div>
  
  <!-- Меню "Результат формирования архива" -->
  <div class="modal-bg" id="album-download-result-modal">
    <div class="modal-feedback" style="max-width:410px;text-align:center;">
      <div id="album-zip-result-title" style="font-size:1.12em;font-weight:bold;margin-bottom:13px;">Архив готов</div>
      <div id="album-zip-result-info" style="margin-bottom:14px;font-size:1.07em;"></div>
      <a id="album-zip-result-link" class="offline-btn online" style="width:80%;margin-bottom:12px;" href="#" download>Скачать архив</a>
      <button type="button" class="offline-btn" style="width:80%;" onclick="closeAlbumDownloadResultModal()">OK</button>
    </div>
  </div>

  <script>
  // --- Кнопка "СКАЧАТЬ ВЕСЬ АЛЬБОМ" над обратной связью (ВНИМАНИЕ: вставляется строго перед .feedback-link/поддержать) ---
  window.addEventListener("DOMContentLoaded",function(){
    // Добавим кнопку в DOM!
    let ctr=document.querySelector('.bottom-controls-center');
    if(ctr && !document.getElementById('album-download-main-btn')){
      let btn=document.createElement('button');
      btn.className='album-download-big-btn';
      btn.id='album-download-main-btn';
      btn.innerText='СКАЧАТЬ ВЕСЬ АЛЬБОМ';
      btn.onclick=openAlbumDownloadModal;
      ctr.insertBefore(btn, ctr.querySelector('#install-pwa-btn'));
    }
  });

  // --- Методы для модалок альбома ---
  function openAlbumDownloadModal(fromMenu){
    // set checked: covers/lyrics=1, liked=0, all=1
    document.getElementById('ad-covers').checked = true;
    document.getElementById('ad-lyrics').checked = true;
    document.getElementById('ad-liked').checked = false;
    document.getElementById('ad-all').checked = true;
    // Название альбома центрировано
    document.getElementById('album-download-title').innerText = (config && config.album ? config.album : 'Альбом') + (config && config.artist ? ' — ' + config.artist : '');
    document.getElementById('album-download-modal').classList.add('active');
    // Де/активировать radio
    let adLiked = document.getElementById('ad-liked');
    let adAll = document.getElementById('ad-all');
    adLiked.onchange = function(){ if(this.checked){ adAll.checked = false; } };
    adAll.onchange = function(){ if(this.checked){ adLiked.checked = false; } };
  }
  function closeAlbumDownloadModal() { document.getElementById('album-download-modal').classList.remove('active'); }
  function closeAlbumDownloadSizeModal() { document.getElementById('album-download-size-modal').classList.remove('active'); }
  function closeAlbumDownloadProgressModal() { document.getElementById('album-download-progress-modal').classList.remove('active'); }
  function closeAlbumDownloadResultModal() { document.getElementById('album-download-result-modal').classList.remove('active'); }

  // --- ШАГ 1: сбор опций и подсчет размера ---
  let albumZipQueue = null, albumZipCancel = false;
  async function prepareAlbumZip() {
    closeAlbumDownloadModal();
    // Получаем опции
    let covers = document.getElementById('ad-covers').checked;
    let lyrics = document.getElementById('ad-lyrics').checked;
    let liked = document.getElementById('ad-liked').checked;
    let all = document.getElementById('ad-all').checked;
    let repoName = 'vi3na1bita-mezhdu-zlom-i-dobrom';
    // Список файлов
    let files = [];
    let songIndexes = [];
    let likedArr = getLiked();
    let trks = config.tracks;
    if(liked && likedArr.length===0) { songIndexes = []; } 
    else if(liked) { songIndexes = likedArr.slice(); } 
    else { songIndexes = Array.from({length: trks.length}, (_,i)=>i); }
    if(all) songIndexes = Array.from({length: trks.length}, (_,i)=>i);
    // Добавим mp3 (если выбрано)
    let mp3s = songIndexes.map(i => ({
      url: 'https://apel-s-in.github.io/vi3na1bita-mezhdu-zlom-i-dobrom/' + trks[i].audio.replace(/^\.?\//,''),
      name: getTrackFileName(trks[i], i, config.artist)
    }));
    for(let i=0;i<mp3s.length;i++) files.push(mp3s[i]);
    // Добавим тексты песен (если галочка)
    let txts = [];
    if(lyrics){
      txts = songIndexes
        .filter(i=>!!trks[i].fulltext)
        .map(i => ({
          url: 'https://apel-s-in.github.io/vi3na1bita-mezhdu-zlom-i-dobrom/' + trks[i].fulltext.replace(/^\.?\//,''),
          name: getTrackFileName(trks[i], i, config.artist).replace(/\.mp3$/i, '.txt')
        }));
      files = files.concat(txts);
    }
    // Обложки (все)
    if(covers){
      let added={};
      coverGalleryArr.forEach(name=>{
        let fname=name.replace(/^.*[\\\/]/,'');
        if(!added[fname]){ // no dupes
          files.push({url:'https://apel-s-in.github.io/vi3na1bita-mezhdu-zlom-i-dobrom/'+fname, name:fname});
          added[fname]=1;
        }
      });
    }
    // logo.png (must have)
    files.push({url:'https://apel-s-in.github.io/vi3na1bita-mezhdu-zlom-i-dobrom/img/logo.png', name:'logo.png'});
    // social.txt из config.socials
    files.push({type:'socialtxt', name:'social.txt'});
    // Подсчитать реальный размер
    let totalSize = 0, checkedFiles = [];
    for(let f of files){
      if(f.type === 'socialtxt') { totalSize += 1200; continue; }
      try {
        let head = await fetch(f.url, {method:'HEAD'});
        let sz = parseInt(head.headers.get('Content-Length')||'0');
        if(!Number.isFinite(sz)){ // если HEAD не поддерживается — fallback
          let resp=await fetch(f.url, {method:'GET'}); 
          let blob=await resp.blob(); sz=blob.size; 
        }
        totalSize += sz;
      } catch(e){ /* fail — не учитываем */ }
    }
    // Покажем окно с размером
    document.getElementById('album-download-size-info').innerHTML =
      `Файлов: <b>${files.length}</b><br>Ожидаемый размер: <b>${(totalSize/1024/1024).toFixed(2)} МБ</b>`;
    document.getElementById('album-download-size-modal').classList.add('active');
    albumZipQueue = files;
    albumZipCancel = false;
  }

  function cancelAlbumZip() { albumZipCancel = true; closeAlbumDownloadProgressModal(); closeAlbumDownloadResultModal();}
  // --- ШАГ 2: Сборка ZIP + прогресс ---
  async function startAlbumDownloadZip() {
    closeAlbumDownloadSizeModal();
    let files=albumZipQueue||[];
    let zip = new JSZip();
    let total = files.length, done = 0, fail = [];
    let pbar = document.getElementById('album-zip-progress-bar');
    let ptxt = document.getElementById('album-zip-progress-text');
    document.getElementById('album-download-progress-modal').classList.add('active');
    // Польский прогресс!
    for(let i=0;i<files.length;i++){
      if(albumZipCancel) return;
      let f=files[i];
      try{
        if(f.type==='socialtxt'){
          let txt='Спасибо за интерес к нашему творчеству!\n\nПодписывайтесь на нас в соцсетях:\n';
          if(config.socials && Array.isArray(config.socials)){
            config.socials.forEach(s=>txt+=`${s.title}: ${s.url}\n`);}
          zip.file(f.name, txt);
        }else{
          let resp = await fetch(f.url);
          if(!resp.ok) throw new Error('not ok');
          let blob = await resp.blob();
          zip.file(f.name, blob);
        }
      }catch(e){ fail.push(f.name); }
      done++;
      pbar.style.width = Math.round(done/total*100)+'%';
      ptxt.innerText = `Добавлено: ${done} / ${total}`;
    }
    // End, save
    pbar.style.width='100%';
    ptxt.innerText = 'Архив готов!';
    let content = await zip.generateAsync({type:'blob'}, function update(meta){
      pbar.style.width = Math.round(meta.percent)+'%';
    });
    // Результат
    closeAlbumDownloadProgressModal();
    let link = document.getElementById('album-zip-result-link');
    link.href = URL.createObjectURL(content);
    link.download = 'vi3na1bita-mezhdu-zlom-i-dobrom.zip';
    let info = `Архивный файл: <b>vi3na1bita-mezhdu-zlom-i-dobrom.zip</b>`;
    if(fail.length)
      info += `<br><br>Не удалось добавить ${fail.length} файла:<br><span style="font-size:.96em;color:#ff7b7b;">${fail.map(n=>n.replace(/</g,"&lt;")).join(', ')}</span>`;
    document.getElementById('album-zip-result-info').innerHTML = info;
    document.getElementById('album-download-result-modal').classList.add('active');
  }

  // --- Для кнопки из меню трека, добавим вызов ---
  // ДОБАВИТЬ кнопку в меню скачивания песни
  (function(){
    let orig=openDownloadModal;
    openDownloadModal=function(e){
      orig(e);
      // Уже есть? (чтобы не дублировать)
      if(!document.getElementById('album-download-in-download-modal')){
        let btn=document.createElement('button');
        btn.className='offline-btn';
        btn.style.cssText='width:98%;margin-bottom:10px;';
        btn.id='album-download-in-download-modal';
        btn.innerText='Скачать весь альбом';
        btn.onclick=function(){closeDownloadModal();openAlbumDownloadModal(true);};
        let modal=document.querySelector('#download-modal .modal-feedback');
        // Вставить после последней кнопки "копировать ссылку", до Отмена
        let links=modal.querySelectorAll('.offline-btn');
        if(links.length>0) modal.insertBefore(btn,links[links.length-1]);
      }
    }
  })();
  </script>
</body>
</html>
