<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Витрина Разбита</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#181818" />
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <style>
    /* Все ваши стили без изменений */
    html, body {height: 100%;}
    body {
      min-height: 100vh;
      background: #181818;
      color: #f2f2f2;
      font-family: sans-serif;
      margin: 0; padding: 0;
      display: flex; flex-direction: column;
      min-width: 100vw;
    }
    #promocode-block {position:fixed;left:0;top:0;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;background:#181818;z-index:100;}
    .promo-inner {display:flex;flex-direction:column;align-items:center;background:rgba(15,18,24,0.98);border-radius:16px;box-shadow:0 6px 24px #0008;padding:36px 26px 32px 26px;min-width:260px;min-height:170px;}
    .promo-cover {width:256px;height:256px;object-fit:cover;border-radius:12px;box-shadow:0 4px 24px #000c;margin-bottom:19px;display:block;background:#181818;}
    .modal-bg {position:fixed;z-index:99;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.62);display:none;align-items:center;justify-content:center;}
    .modal-bg.active {display:flex;}
    .modal-feedback {background:#252d39;border-radius:14px;padding:34px 20px 21px 20px;min-width:215px;box-shadow:0 4px 32px #0009;max-width:96vw;position:relative;}
    .modal-feedback .bigclose {background:none;border:none;position:absolute;top:13px;right:13px;cursor:pointer;color:#eee;border-radius:50%;width:32px;height:32px;}
    .modal-feedback .bigclose svg {width:31px;height:31px;}
    .hidden {display:none!important;}
    #main-block {max-width:420px;margin:0 auto;flex:1 0 auto;display:flex;flex-direction:column;align-items:center;}
    header {width:100%;text-align:center;margin:0 auto;}
    #cover-wrap {width:100%;max-width:400px;margin:24px auto 0 auto;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;position:relative;}
    .cover-gallery-arrow {
      position: absolute;
      top: 50%; transform: translateY(-50%);
      z-index: 2; border: none; cursor: pointer; background: none; padding: 0;
      width:44px; height:44px; display:flex;align-items:center;justify-content:center;
    }
    #cover-gallery-arrow-left {left:7px;}
    #cover-gallery-arrow-right {right:7px;}
    #cover {width:100%;max-width:100%;border-radius:12px;aspect-ratio:1/1;object-fit:cover;display:block;margin:0;}
    .socials-under-cover {margin:14px auto 0 auto;width:100%;max-width:398px;text-align:center;font-size:1.03em;display:flex;flex-wrap:wrap;justify-content:center;gap:12px;}
    .track-list {margin:0 auto;max-width:370px;width:100%;font-size:1.05em;color:#eee;background:none;padding:0;}
    .track {
      display: flex; align-items: center;
      padding: 7px 8px 7px 8px; border-bottom:1px solid #394866;
      cursor: pointer;transition:background .13s;background:none;
    }
    .track.current {background:#232b38;}
    .tnum {min-width:27px;color:#8ab8fd;}
    .track-title {margin-left:7px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .like-star {
      margin-left: auto; width:19px;height:19px;cursor:pointer;opacity:.97;border:none;background:none;padding:0;appearance:none;display:inline-block;transition:filter .13s, opacity .13s;
    }
    .like-star:hover {filter:brightness(1.13);opacity:1;}
    .lyrics-player-block {width:100%;margin:8px 0 3px 0;}
    #lyrics-window {width:100%;background:rgba(34,34,34,0.98);border-radius:12px;box-shadow:0 8px 24px #0007;overflow:hidden;height:8.5em;position:relative;display:flex;flex-direction:column;align-items:stretch;justify-content:center;margin-bottom:7px;box-sizing:border-box;}
    .lyrics-window-line {opacity:0.57;font-size:1.13em;transition:opacity 0.2s,color 0.2s;line-height:1.7em;text-align:center;min-height:1.7em;max-width:97%;margin:0 auto;color:#eee;white-space:pre-line;user-select:none;word-break:break-word;}
    .lyrics-window-line.active {color:#E80100;font-weight:bold;opacity:1;text-shadow:0 1px 7px #73161644,0 0 0 #fff;background:rgba(0,0,0,0.07);border-radius:8px;font-size:1.19em;}
    .audio-wrapper {width:100%;max-width:395px;margin:0 auto;}
    #audio {width:100%;margin:6px auto 2px auto;display:block;}
    .player-buttons-center {display:flex;flex-direction:column;align-items:center;gap:9px;margin-bottom:7px;margin-top:3px;}
    .karaoke-btn,.player-download-btn {
      color:#4daaff !important;background:none;border:none;cursor:pointer;
      font-size:1em;text-transform:uppercase;font-weight:700;letter-spacing:.02em;text-decoration:underline;transition:color .18s;
      padding:4px 16px;min-width:148px;text-align:center;border-radius:7px;display:block;margin:0 auto;}
    .player-download-btn {margin-top:0;}
    .karaoke-btn:focus,.karaoke-btn:hover,.player-download-btn:focus,.player-download-btn:hover{color: #fff !important; background:#273050;}
    .bottom-controls-center {display:flex;flex-direction:column;align-items:center;justify-content:center;margin:32px auto 0 auto;gap:8px;width:100%;max-width:210px;}
    .logo-bottom {max-width:112px;width:23vw;min-width:66px;height:auto;display:block;margin:0 auto 10px auto !important;}
    #install-pwa-btn {
      color: #fff; background: #4daaff; border: none; border-radius: 7px;
      font-size: 1.07em; font-weight: bold; letter-spacing: .02em;
      margin: 15px 0 5px 0; padding: 8px 13px; cursor:pointer; width: 98%;
      box-shadow: 0 4px 14px #0005; outline:none; transition: background .2s;
    }
    #install-pwa-btn:hover {background: #3275c2;}
    .feedback-link,.support-link{color:#4daaff !important;text-decoration:underline !important;font-weight:700;text-transform:uppercase;letter-spacing:.03em;cursor:pointer;transition:color .18s;font-size:1em;display:block;text-align:center;width:100%;margin:0;}
    .feedback-link:hover,.support-link:hover{color:#fff !important;}
    .offline-btn {min-width:102px;height:38px;font-size:1.05em;font-weight:bold;border:none;border-radius:9px;margin:0 6px;cursor:pointer;letter-spacing:0.07em;box-shadow:0 2px 8px #06000032;transition:background .2s,color .14s;display:block;margin:0 auto;}
    .offline-btn.online {background:#E80100;color:#fff;}
    .offline-btn.offline {background:#27b34c;color:#fff;}
    .offline-btn:active{opacity:0.91;}
    .offline-btn:disabled{opacity:.7;cursor:not-allowed;}
    .offline-progress{margin-top:11px;width:100%;height:8px;background:#222;border-radius:6px;overflow:hidden;box-shadow:0 1px 6px #222b;}
    .offline-progress-bar{height:100%;background:#2fed54;transition:width .33s;}
    .offline-desc{text-align:center;font-size:.97em;margin-top:5px;opacity:.85;}

    /* Модальные окна Zip */
    .modal-backdrop {
      position: fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.7);
      z-index:9999; display:none;align-items:center;justify-content:center;
    }
    .modal-window {
      background:#232b38; border-radius:15px;max-width:97vw;
      min-width:250px;box-shadow:0 10px 36px #0009; padding:26px 16px 15px 16px;
      margin:0 auto;text-align:left;
    }
    .modal-btn {background:#262b39;color:#fff;border:1px solid #444; border-radius:8px;padding:7px 18px;font-size:1em;margin:0;cursor:pointer;}
    .modal-btn-main {background:#E80100;color:#fff;border:none;}
    .modal-btn:active{opacity:0.8;}
    .modal-btn[disabled]{opacity:.44;}

    @media (max-width:600px){.like-star{width:16px;height:16px;}.logo-bottom{max-width:66vw;}}
    @media (max-width:420px){.modal-feedback{padding:13px 3vw;}}
  </style>
  <!-- JSZip -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
</head>
<body>
  <div id="promocode-block">
    <div class="promo-inner">
      <img class="promo-cover" src="Cover.png" alt="Обложка" draggable="false"/>
      <h2>Вход по промокоду</h2>
      <input id="promo-inp" type="text" placeholder="Введите промокод" autocomplete="off" autofocus />
      <button id="promo-btn" onclick="checkPromo()">Войти</button>
      <div id="promo-error"></div>
    </div>
  </div>
  <div id="main-block" class="hidden">
    <header>
      <div id="cover-wrap">
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-left" title="Назад">
          <svg width="34" height="34" viewBox="0 0 34 34"><circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/><polyline points="20,10 13,17 20,24" fill="none" stroke="#fff" stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <img id="cover" src="Cover.png" alt="Cover album" draggable="false"/>
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-right" title="Вперёд">
          <svg width="34" height="34" viewBox="0 0 34 34"><circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/><polyline points="14,10 21,17 14,24" fill="none" stroke="#fff" stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
      <div id="social-links" class="socials-under-cover"></div>
    </header>
    <div class="track-list" id="track-list"></div>
    <div class="bottom-controls-center">
      <img class="logo-bottom" src="img/logo.png" alt="Логотип"/>
      <!-- === ZIP-ALBUM КНОПКА НА ГЛАВНОЙ === -->
      <button id="download-album-main" style="width:100%;font-size:1.09em;font-weight:bold;margin-bottom:10px;">
        СКАЧАТЬ ВЕСЬ АЛЬБОМ
      </button>
      <button id="install-pwa-btn" style="margin: 15px 0 0 0; display: none;">
        УСТАНОВИТЬ КАК ПРИЛОЖЕНИЕ
      </button>
      <span class="feedback-link" id="feedback-link">ОБРАТНАЯ СВЯЗЬ</span>
      <a class="support-link" id="support-link" href="#" target="_blank">ПОДДЕРЖАТЬ</a>
      <button class="offline-btn online" id="offline-btn" onclick="offlineUIClick()">ONLINE</button>
    </div>
  </div>
  <div class="modal-bg" id="modal-feedback">
    <div class="modal-feedback">
      <button class="bigclose" onclick="closeFeedbackModal()" title="Закрыть">
        <svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg>
      </button>
      <div id="feedback-step">
        <div class="fake-textarea" id="fake-textarea" onclick="showRealTextarea()">
          Опишите здесь проблему или своё пожелание для улучшения, <br>можете просто оставить свой отзыв...
        </div>
      </div>
      <div id="modal-feedback-error" class="err-msg"></div>
      <div id="modal-feedback-success" class="success-msg"></div>
      <button onclick="sendFeedbackMsg()" id="send-feedback-btn" style="margin-bottom:8px;">Отправить</button>
    </div>
  </div>
  <div class="modal-bg" id="modal-offline">
    <div class="modal-feedback" style="max-width:400px;">
      <button class="bigclose" onclick="closeOfflineModal()" title="Закрыть">
        <svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg>
      </button>
      <div id="offline-step"></div>
    </div>
  </div>
  <div class="modal-bg" id="install-modal">
    <div class="modal-feedback" style="max-width:400px;">
      <button class="bigclose" onclick="closeInstallModal()" title="Закрыть">
        <svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg>
      </button>
      <div style="font-size:1.18em;font-weight:700;margin-bottom:13px;">
        Установить приложение<br>«Витрина Разбита»?
      </div>
      <div style="margin-bottom:16px;font-size:1em;">
        Приложение будет установлено на ваше устройство, займёт ~1 МБ.<br>
        Его можно будет удалить как обычное приложение.<br>
        Работает даже без интернета.<br><br>
        <b>Для защиты запустим контрольное хэширование ресурсов.</b>
      </div>
      <div id="install-modal-hash" style="font-size:.95em; color:#4daaff; margin-bottom:10px; display:none;">
        Хэширование...<br>
        <span id="install-hash-progress"></span>
      </div>
      <button class="offline-btn online" id="install-proceed-btn" style="width:99%;margin-bottom:7px;">Установить</button>
      <button class="offline-btn" style="width:99%;" onclick="closeInstallModal()">Отмена</button>
    </div>
  </div>
  <!-- === ЗАГРУЗИТЬ ПЕСНЮ/МЕНЮ ТРЕКА - ДОБАВЛЕНО КНОПКА ZIP === -->
  <div class="modal-bg" id="download-modal">
    <div class="modal-feedback" style="max-width:400px;">
      <div id="download-modal-title" style="font-size:1.12em;font-weight:700;margin-bottom:13px;"></div>
      <div style="margin-bottom:19px;font-size:.98em;" id="download-modal-filename"></div>
      <button class="offline-btn online" style="width:98%;margin-bottom:10px;" onclick="downloadCurrentTrack()">Сохранить на устройство</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="shareCurrentTrack()">Поделиться с друзьями</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="openInAppCurrentTrack()">Открыть в приложении</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="copyLinkCurrentTrack()">Скопировать ссылку</button>
      <button class="offline-btn online" id="download-album-menu" style="width:98%;margin-bottom:10px;">Скачать весь альбом</button>
      <button class="offline-btn" style="width:98%;" onclick="closeDownloadModal()">Отмена</button>
    </div>
  </div>
  <div id="copy-notify" style="display:none;position:fixed;left:50%;bottom:38px;transform:translateX(-50%);padding:14px 26px;background:#262b39;color:#fff;border-radius:12px;font-size:1.07em;box-shadow:0 3px 32px #0007;z-index:1999;transition:opacity .3s; opacity:0;">
    Текст скопирован!
  </div>
  <!-- === ZIP МОДАЛЬНОЕ МЕНЮ и ОКНО ПОДТВЕРЖДЕНИЯ === -->
  <div id="albumZipModal" class="modal-backdrop">
    <div class="modal-window">
      <div id="zip-album-title" style="text-align:center;font-weight:bold;font-size:1.12em;margin-bottom:11px;"></div>
      <label><input type="checkbox" id="zip-covers"> Обложки</label><br/>
      <label><input type="checkbox" id="zip-lyrics"> Тексты песен</label><br/>
      <label><input type="checkbox" id="zip-fav"> Только избранные песни</label><br/>
      <label><input type="checkbox" id="zip-full" checked> Полностью альбом</label>
      <div style="margin-top:18px;display:flex;justify-content:space-between;">
        <button id="zip-cancel" class="modal-btn">ОТМЕНА</button>
        <button id="zip-next" class="modal-btn modal-btn-main" style="margin-left:10px;">СКАЧАТЬ</button>
      </div>
    </div>
  </div>
  <div id="albumZipModal2" class="modal-backdrop">
    <div class="modal-window">
      <div style="font-size:1.1em;margin-bottom:1em;text-align:center;">
        Архив будет занимать <span id="zip-album-size">…</span><br/>Продолжить скачивание?
      </div>
      <div style="margin-top:8px;display:flex;justify-content:space-between;">
        <button id="zip2-cancel" class="modal-btn">ОТМЕНА</button>
        <button id="zip2-download" class="modal-btn modal-btn-main" style="margin-left:10px;">СКАЧАТЬ</button>
      </div>
      <div id="zip-album-progress" style="margin-top:10px;display:none;text-align:center;">
        <span id="zip-album-step">0 из 0</span>
        <div style="background:#eee;height:8px;width:100%;border-radius:5px;margin-top:6px;overflow:hidden;">
          <div id="zip-album-bar" style="background:#49a; width:0%; height:8px;"></div>
        </div>
      </div>
      <div id="zip-album-error" style="color:#900; font-size:0.95em; margin-top:.6em;"></div>
    </div>
  </div>
  <!-- === ВАШ ОСНОВНОЙ SCRIPT (НЕ МЕНЯТЬ/ДОПИСАТЬ ПОСЛЕ НЕГО ZIP-АЛЬБОМ-КОД) === -->
  <script>
  /* ...весь ваш основной скрипт — ОСТАЁТСЯ БЕЗ ИЗМЕНЕНИЙ до конца... */

  /* ========== СКРИПТ ДЛЯ ФУНКЦИИ "СКАЧАТЬ ВЕСЬ АЛЬБОМ" ========== */

  // 1. Открытие модалки (главная кнопка и меню "Что сделать с этим файлом?")
  function openZipAlbumModal() {
    document.getElementById('albumZipModal').style.display = '';
    document.getElementById('zip-album-title').textContent = config ? config.albumTitle : '';
    let liked = getLiked && config ? getLiked() : [];
    document.getElementById('zip-fav').disabled = !liked.length;
    document.getElementById('zip-fav').checked = false;
    document.getElementById('zip-full').checked = true;
    document.getElementById('zip-covers').checked = false;
    document.getElementById('zip-lyrics').checked = false;
    // Взаимоисключение
    document.getElementById('zip-fav').onchange = function() {
      if(this.checked) document.getElementById('zip-full').checked = false;
    };
    document.getElementById('zip-full').onchange = function() {
      if(this.checked) document.getElementById('zip-fav').checked = false;
    };
  }
  document.getElementById('download-album-main').onclick = openZipAlbumModal;
  document.getElementById('download-album-menu').onclick = function() {
    closeDownloadModal(); setTimeout(openZipAlbumModal, 200);
  };
  document.getElementById('zip-cancel').onclick = () => document.getElementById('albumZipModal').style.display='none';

  // 2. На "Скачать" — собираем опции, считаем размер
  document.getElementById('zip-next').onclick = async function(){
    document.getElementById('albumZipModal').style.display = 'none';
    const isFavOnly = document.getElementById('zip-fav').checked;
    const isFull = document.getElementById('zip-full').checked;
    let tracks = [];
    if(isFavOnly) tracks = getLiked().map(i=>config.tracks[i]);
    else if(isFull) tracks = config.tracks.slice();
    const addCovers = document.getElementById('zip-covers').checked;
    const addLyrics = document.getElementById('zip-lyrics').checked;
    let files = [];
    tracks.forEach((tr,i)=>{
      files.push({
        type:'mp3', url: tr.audio,
        saveAs: getZipFileName(tr, i, 'mp3')
      });
      if(addLyrics && tr.fulltext) files.push({
        type:'txt', url: tr.fulltext,
        saveAs: getZipFileName(tr,i,'txt')
      });
    });
    if(addCovers && window.coverGalleryArr && Array.isArray(coverGalleryArr)) {
      for(let url of coverGalleryArr) files.push({
        type: 'cover', url,
        saveAs: url.split('/').pop()
      });
    }
    files.push({type: 'logo', url: config.logo, saveAs: 'logo.png'});
    files.push({type: 'social', url: null, saveAs: 'social.txt'});
    // Размер HEAD
    let totalBytes=0,errFiles=[];
    for(let f of files) {
      if(f.type==='social'){continue;}
      try{
        let resp = await fetch(f.url, {method:'HEAD'});
        if(!resp.ok) throw 'no head';
        let sz = parseInt(resp.headers.get('content-length')||'0');
        f.size = sz; totalBytes += sz;
      }catch(e){ errFiles.push(f.saveAs);}
    }
    document.getElementById('zip-album-size').textContent =
        totalBytes>0 ? (totalBytes/1048576).toFixed(2)+" МБ" : 'менее 1 МБ';
    document.getElementById('albumZipModal2').style.display = '';
    document.getElementById('zip-album-bar').style.width = '0%';
    document.getElementById('zip-album-progress').style.display = 'none';
    document.getElementById('zip-album-error').textContent = errFiles.length ?
      'Не удалось проверить размер некоторых файлов.' : '';
    document.getElementById('zip2-cancel').onclick = () => document.getElementById('albumZipModal2').style.display='none';
    document.getElementById('zip2-download').onclick = async function() {
      this.disabled = true;
      document.getElementById('zip-album-progress').style.display = '';
      // Сборка архива
      let zip = new JSZip(), done=0, missed=[], steps=files.length;
      for(let f of files) {
        if(f.type==='social') {
          zip.file(f.saveAs, makeSocialFileText(config));
          done++;updateZipPb();
          continue;
        }
        try {
          let resp = await fetch(f.url);
          if(!resp.ok) throw 1;
          if(f.type==='txt') zip.file(f.saveAs, await resp.text());
          else zip.file(f.saveAs, await resp.blob());
        }catch(e){ missed.push(f.saveAs);}
        done++;updateZipPb();
      }
      let blob = await zip.generateAsync({type:"blob"});
      let link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = (config && config.repoName) || 'vi3na1bita-mezhdu-zlom-i-dobrom.zip';
      document.body.appendChild(link);
      link.click();
      setTimeout(()=>{document.body.removeChild(link)},300);
      document.getElementById('albumZipModal2').style.display='none';
      if(missed.length) setTimeout(()=>{
        alert('ВНИМАНИЕ: Не удалось добавить файлы:\n'+missed.join('\n'));
      },700);
      this.disabled = false;
      function updateZipPb() {
        document.getElementById('zip-album-step').textContent = `${done} из ${steps}`;
        document.getElementById('zip-album-bar').style.width = Math.round(done*100/steps)+'%';
      }
    };
  };
  function getZipFileName(tr, i, ext='mp3') {
    let num = (''+(i+1)).padStart(2,'0');
    let safeTitle = tr.title.replace(/[/\\?%*:|"<>]/g, '_');
    return `${num} - ${safeTitle} - ${config.artist}.${ext}`;
  }
  function makeSocialFileText(cfg) {
    let txt = `Спасибо за интерес к нашему творчеству!\nПодписывайтесь на нас:\n`;
    for (let s of (cfg.socials||[])) txt += `${s.title}: ${s.url}\n`;
    return txt;
  }
  /* ========== КОНЕЦ ZIP-АЛЬБОМ ФУНКЦИИ ========== */
  </script>
</body>
</html>
