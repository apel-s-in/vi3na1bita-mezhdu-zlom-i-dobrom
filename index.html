<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Между Злом и Добром — Витрина Разбита</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {background:#181818;color:#f2f2f2;font-family:sans-serif;margin:0;padding:0;}
    header {background:rgba(0,0,0,0.85);text-align:center;padding:24px;}
    #logo {max-height:80px;}
    .track-list {margin:32px auto 0 auto;max-width:400px;}
    .track {padding:12px 0;border-bottom:1px solid #444;cursor:pointer;}
    .current {background:#222;}
    /* Новый караоке-блок — ширина и стиль как треклист */
    .lyrics-player-block {
      width:100%;
      margin:10px 0 4px 0;
    }
    #lyrics-window {
      width: 100%;
      background: rgba(34,34,34,0.97);
      border-radius: 12px;
      box-shadow: 0 8px 24px #0007;
      overflow: hidden;
      height: 8.5em;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: center;
      margin-bottom: 6px;
      box-sizing: border-box;
    }
    .lyrics-scroll {
      width: 100%;
      transition: transform 0.4s cubic-bezier(.71,.21,.43,.9);
      will-change: transform;
    }
    .lyrics-window-line {
      opacity: 0.55;
      font-size: 1.14em;
      transition: opacity 0.24s,color 0.24s;
      line-height: 1.7em;
      text-align: center;
      min-height: 1.7em;
      max-width: 97%;
      margin: 0 auto;
      font-weight: 400;
      color: #eee;
      white-space: pre-line;
      user-select: none;
      letter-spacing: 0.02em;
    }
    .lyrics-window-line.active {
      color: #E80100;
      font-weight: bold;
      opacity: 1;
      text-shadow: 0 1px 7px #6e1818, 0 0 0 #fff;
      background: rgba(0,0,0,0.07);
      border-radius: 8px;
      font-size: 1.19em;
      z-index: 2;
    }
    .karaoke-controls {
      text-align: center;
      margin-top: 4px;
    }
    .karaoke-controls a, .karaoke-controls button {
      margin: 0 3px;
      display:inline-block;
    }
    #audio {width:100%;margin:6px auto 2px auto;display:block;max-width:398px;}
    #social-links, #donate-btn {margin:16px 10px;display:inline-block}
    #cover {max-width:320px;border-radius:14px;margin:20px auto 7px;display:block;}
    #promocode-block {text-align:center;margin:40px;}
    .hidden {display:none;}
    @media (max-width:430px) {
      .track-list, #lyrics-window {max-width:99vw;}
      .lyrics-window-line {font-size:1em;}
      #cover {max-width:90vw;}
      #audio {max-width:99vw;}
    }
  </style>
</head>
<body>
  <div id="promocode-block">
    <h2>Вход по промокоду</h2>
    <input id="promo-inp" type="text" placeholder="Введите промокод" autofocus />
    <button onclick="checkPromo()">Войти</button>
    <div id="promo-error" style="color:red;margin:10px;"></div>
  </div>

  <div id="main-block" class="hidden">
    <header>
      <img id="logo" src="" alt="Логотип"/>
      <h1 id="album-title"></h1>
      <h2 id="artist"></h2>
      <img id="cover" src="" alt="Обложка" />
    </header>
    <div class="track-list" id="track-list"></div>
    <div id="social-links" style="text-align:center;margin-top:16px"></div>
  </div>

  <script>
    // --- Глобальное ---
    let config, currentTrack = 0, currentLyrics = [], promoPassed = false;

    fetch('config.json').then(r => r.json()).then(data => {
      config = data;
      document.getElementById('logo').src = config.logo;
      document.getElementById('album-title').innerText = config.albumTitle;
      document.getElementById('artist').innerText = config.artist + " (" + config.year + ")";
      buildSocials();
      document.body.style.background = "url(" + config.background + ") center/cover fixed #111";
      buildTrackList();
      showTrack(0);
    });

    function checkPromo() {
      const val = document.getElementById('promo-inp').value.trim();
      if(val && config && val.toUpperCase() === config.promoCode.toUpperCase()) {
        document.getElementById('main-block').classList.remove('hidden');
        document.getElementById('promocode-block').classList.add('hidden');
        promoPassed = true;
      } else {
        document.getElementById('promo-error').innerText = "Неверный промокод. Попробуйте ещё!";
      }
    }

    function buildSocials() {
      const s = config.socials.map(x =>
        `<a style="margin:0 8px" href="${x.url}" target="_blank">${x.title}</a>`
      ).join(" ");
      document.getElementById('social-links').innerHTML = s;
    }

    function buildTrackList() {
      const list = document.createElement('div');
      list.className = "track-list";
      let html = "";
      for (let i = 0; i < config.tracks.length; i++) {
        html += `<div class="track${i===currentTrack?' current':''}" id="trk${i}" onclick="showTrack(${i})">${i+1}. ${config.tracks[i].title}</div>`;
        // Если это выбранный текущий трек — вставляем караоке_PLAYER_блок после него!
        if (i === currentTrack) html += `
    <div class="lyrics-player-block" id="lyricsplayerblock"></div>
        `;
      }
      document.getElementById('track-list').innerHTML = html;
      renderLyricsBlock();
    }

    // --- Основная функция: рендерит lyrics + плеер-блок ПОД активным треком
    function renderLyricsBlock() {
      const block = document.getElementById('lyricsplayerblock');
      if(!block) return;

      // --- караоке окно
      let lyricsDiv = `<div id="lyrics-window"><div class="lyrics-scroll" id="lyrics"></div></div>
<audio id="audio" controls preload="metadata"></audio>
<div class="karaoke-controls">
  <a id="download-link" href="#" download>Скачать mp3</a>
  <button onclick="copyLyrics()">Копировать текст</button>
  <a id="donate-btn" href="#" target="_blank">Поддержать</a>
</div>`;

      block.innerHTML = lyricsDiv;
      document.getElementById('donate-btn').href = config.donateLink;
      const tr = config.tracks[currentTrack];
      document.getElementById('audio').src = tr.audio;
      document.getElementById('download-link').href = tr.audio;
      // Загружаем лирику
      loadLyrics(tr.lyrics);
      // Вешаем ontimeupdate
      document.getElementById('audio').ontimeupdate = function () {
        renderLyrics(this.currentTime);
      };
    }

    // |-- Синхронизация lyrics (караоке)
    function loadLyrics(file) {
      fetch(file).then(r=>r.json()).then(js => {
        currentLyrics = js;
        renderLyrics(0);
      });
    }

    function renderLyrics(time) {
      if (!currentLyrics || !currentLyrics.length) {
        document.getElementById('lyrics').innerHTML = "";
        return;
      }
      let active = 0;
      for (let i = 0; i < currentLyrics.length; i++) {
        if (time >= currentLyrics[i].time) active = i;
      }
      let lines = "";
      for (let i = 0; i < currentLyrics.length; i++) {
        let cls = (i === active) ? "lyrics-window-line active" : "lyrics-window-line";
        lines += `<div class="${cls}">${currentLyrics[i].line || ""}</div>`;
      }
      document.getElementById("lyrics").innerHTML = lines;
      // Окно из 5 строк, активная всегда третья
      let lyricHeight = 1.7;
      let scrollYem = (active - 2 > 0 ? active - 2 : 0) * lyricHeight;
      document.querySelector(".lyrics-scroll").style.transform = `translateY(-${scrollYem}em)`;
    }

    function showTrack(n) {
      currentTrack = n;
      buildTrackList();
      // Смена обложки, если надо
      const tr = config.tracks[n];
      document.getElementById('cover').src = tr.cover ? tr.cover : config.background;
    }

    function copyLyrics() {
      if(!currentLyrics || !currentLyrics.length) return;
      const text = currentLyrics.map(x=>x.line).join('\n');
      navigator.clipboard.writeText(text);
      alert('Текст скопирован!');
    }

    // Переключение треков стрелками (лево/право)
    window.addEventListener('keydown', function(e){
      if(!promoPassed) return;
      if(e.key == 'ArrowRight') {showTrack(Math.min(currentTrack+1, config.tracks.length-1));}
      if(e.key == 'ArrowLeft') {showTrack(Math.max(currentTrack-1, 0));}
    });

    // --- for onclick on new block
    window.showTrack = showTrack;
  </script>
</body>
</html>
