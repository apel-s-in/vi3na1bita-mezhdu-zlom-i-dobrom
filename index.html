<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#181818" />
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    html, body {height: 100%;}
    body {
      min-height: 100vh;
      background: #181818;
      color: #f2f2f2;
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      display: flex; flex-direction: column;
      min-width: 100vw;
    }
    #promocode-block {position:fixed;left:0;top:0;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;background:#181818;z-index:100;}
    .promo-inner {display:flex;flex-direction:column;align-items:center;background:rgba(15,18,24,0.98);border-radius:16px;box-shadow:0 6px 24px #0008;padding:36px 26px 32px 26px;min-width:260px;min-height:170px;}
    .promo-cover {width:256px;height:256px;object-fit:cover;border-radius:12px;box-shadow:0 4px 24px #000c;margin-bottom:19px;display:block;background:#181818;}
    .modal-bg {position:fixed;z-index:99;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.62);display:none;align-items:center;justify-content:center;}
    .modal-bg.active {display:flex;}
    .modal-feedback {background:#252d39;border-radius:14px;padding:34px 20px 21px 20px;min-width:215px;box-shadow:0 4px 32px #0009;max-width:96vw;position:relative;}
    .modal-feedback .bigclose {background:none;border:none;position:absolute;top:13px;right:13px;cursor:pointer;color:#eee;border-radius:50%;width:32px;height:32px;}
    .modal-feedback .bigclose svg {width:31px;height:31px;}
    .hidden {display:none!important;}
    #main-block {max-width:420px;margin:0 auto;flex:1 0 auto;display:flex;flex-direction:column;align-items:center;}
    header {width:100%;text-align:center;margin:0 auto;}
    #cover-wrap {width:100%;max-width:400px;margin:24px auto 0 auto;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;position:relative;}
    .cover-gallery-arrow {
      position: absolute;
      top: 50%; transform: translateY(-50%);
      z-index: 2; border: none; cursor: pointer; background: none; padding: 0;
      width:44px; height:44px; display:flex;align-items:center;justify-content:center;
    }
    #cover-gallery-arrow-left {left:7px;}
    #cover-gallery-arrow-right {right:7px;}
    #cover {width:100%;max-width:100%;border-radius:12px;aspect-ratio:1/1;object-fit:cover;display:block;margin:0;}
    .socials-under-cover {margin:14px auto 0 auto;width:100%;max-width:398px;text-align:center;font-size:1.03em;display:flex;flex-wrap:wrap;justify-content:center;gap:12px;}
    .track-list {margin:0 auto;max-width:370px;width:100%;font-size:1.05em;color:#eee;background:none;padding:0;}
    .track {
      display: flex; align-items: center;
      padding: 7px 8px 7px 8px; border-bottom:1px solid #394866;
      cursor: pointer;transition:background .13s;background:none;
    }
    .track.current {background:#232b38;}
    .tnum {min-width:27px;color:#8ab8fd;}
    .track-title {margin-left:7px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .like-star {
      margin-left: auto; width:19px;height:19px;cursor:pointer;opacity:.97;border:none;background:none;padding:0;appearance:none;display:inline-block;transition:filter .13s, opacity .13s;
    }
    .like-star:hover {filter:brightness(1.13);opacity:1;}
    .lyrics-player-block {width:100%;margin:8px 0 3px 0;}
    #lyrics-window {width:100%;background:rgba(34,34,34,0.98);border-radius:12px;box-shadow:0 8px 24px #0007;overflow:hidden;height:8.5em;position:relative;display:flex;flex-direction:column;align-items:stretch;justify-content:center;margin-bottom:7px;box-sizing:border-box;}
    .lyrics-window-line {opacity:0.57;font-size:1.13em;transition:opacity 0.2s,color 0.2s;line-height:1.7em;text-align:center;min-height:1.7em;max-width:97%;margin:0 auto;color:#eee;white-space:pre-line;user-select:none;word-break:break-word;}
    .lyrics-window-line.active {color:#E80100;font-weight:bold;opacity:1;text-shadow:0 1px 7px #73161644,0 0 0 #fff;background:rgba(0,0,0,0.07);border-radius:8px;font-size:1.19em;}
    .audio-wrapper {width:100%;max-width:395px;margin:0 auto;}
    #audio {width:100%;margin:6px auto 2px auto;display:block;}
    .player-buttons-center {display:flex;flex-direction:column;align-items:center;gap:9px;margin-bottom:7px;margin-top:3px;}
    .karaoke-btn,.player-download-btn {
      color:#4daaff !important;background:none;border:none;cursor:pointer;
      font-size:1em;text-transform:uppercase;font-weight:700;letter-spacing:.02em;text-decoration:underline;transition:color .18s;
      padding:4px 16px;min-width:148px;text-align:center;border-radius:7px;display:block;margin:0 auto;}
    .player-download-btn {margin-top:0;}
    .karaoke-btn:focus,.karaoke-btn:hover,.player-download-btn:focus,.player-download-btn:hover{color: #fff !important; background:#273050;}
    .bottom-controls-center {display:flex;flex-direction:column;align-items:center;justify-content:center;margin:32px auto 0 auto;gap:8px;width:100%;max-width:210px;}
    .logo-bottom {max-width:112px;width:23vw;min-width:66px;height:auto;display:block;margin:0 auto 10px auto !important;}
    #install-pwa-btn, #download-album-main {
      color: #fff; background: #4daaff; border: none; border-radius: 7px;
      font-size: 1.07em; font-weight: bold; letter-spacing: .02em;
      margin: 15px 0 5px 0; padding: 8px 13px; cursor:pointer; width: 98%;
      box-shadow: 0 4px 14px #0005; outline:none; transition: background .2s;
    }
    #download-album-main { background: #E80100; font-size: 1.09em; margin-bottom: 8px; }
    #install-pwa-btn:hover, #download-album-main:hover {background: #3275c2;}
    #download-album-main:hover { background: #c60000; }
    .feedback-link,.support-link{color:#4daaff !important;text-decoration:underline !important;font-weight:700;text-transform:uppercase;letter-spacing:.03em;cursor:pointer;transition:color .18s;font-size:1em;display:block;text-align:center;width:100%;margin:0;}
    .feedback-link:hover,.support-link:hover{color:#fff !important;}
    .offline-btn {min-width:102px;height:38px;font-size:1.05em;font-weight:bold;border:none;border-radius:9px;margin:0 6px;cursor:pointer;letter-spacing:0.07em;box-shadow:0 2px 8px #06000032;transition:background .2s,color .14s;display:block;margin:0 auto;}
    .offline-btn.online {background:#E80100;color:#fff;}
    .offline-btn.offline {background:#27b34c;color:#fff;}
    .offline-btn:active{opacity:0.91;}
    .offline-btn:disabled{opacity:.7;cursor:not-allowed;}
    .offline-progress{margin-top:11px;width:100%;height:8px;background:#222;border-radius:6px;overflow:hidden;box-shadow:0 1px 6px #222b;}
    .offline-progress-bar{height:100%;background:#2fed54;transition:width .33s;}
    .offline-desc{text-align:center;font-size:.97em;margin-top:5px;opacity:.85;}
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ */
    .download-modal-title {
      font-size: 1.12em;
      font-weight: 700;
      margin-bottom: 13px;
      text-align: center;
    }
    .checkbox-container {
      display: flex;
      align-items: center;
      margin: 12px 0;
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-left: 32px;
    }
    .checkbox-container input {
      position: absolute;
      opacity: 0;
      cursor: pointer;
      height: 0;
      width: 0;
    }
    .checkmark {
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      height: 20px;
      width: 20px;
      background-color: #2a2a2a;
      border: 2px solid #444;
      border-radius: 4px;
    }
    .checkbox-container:hover input ~ .checkmark {
      background-color: #333;
    }
    .checkbox-container input:checked ~ .checkmark {
      background-color: #E80100;
      border-color: #E80100;
    }
    .checkmark:after {
      content: "";
      position: absolute;
      display: none;
      left: 6px;
      top: 2px;
      width: 5px;
      height: 10px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }
    .checkbox-container input:checked ~ .checkmark:after {
      display: block;
    }
    .checkbox-container input:disabled ~ .checkmark {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .progress-bar {
      width: 100%;
      height: 20px;
      background-color: #2a2a2a;
      border-radius: 10px;
      overflow: hidden;
      margin: 20px 0;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #E80100, #ff4444);
      transition: width 0.3s ease;
    }
    .size-info {
      padding: 20px;
      background-color: #1f1f1f;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
    }
    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .btn-secondary, .btn-primary {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 7px;
      font-weight: bold;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .btn-secondary {
      background: #444;
      color: #fff;
    }
    .btn-primary {
      background: #E80100;
      color: #fff;
    }
    .btn-secondary:hover, .btn-primary:hover {
      opacity: 0.8;
    }
    #errorsList {
      max-height: 100px;
      overflow-y: auto;
      margin-top: 10px;
    }
    #errorsListContent {
      list-style: none;
      padding-left: 0;
      margin: 5px 0;
    }
    
    @media (max-width:600px){.like-star{width:16px;height:16px;}.logo-bottom{max-width:66vw;}}
    @media (max-width:420px){.modal-feedback{padding:13px 3vw;}}
  </style>
</head>
<body>
  <div id="promocode-block">
    <div class="promo-inner">
      <img class="promo-cover" src="Cover.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false"/>
      <h2>–í—Ö–æ–¥ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É</h2>
      <input id="promo-inp" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" autocomplete="off" autofocus />
      <button id="promo-btn" onclick="checkPromo()">–í–æ–π—Ç–∏</button>
      <div id="promo-error"></div>
    </div>
  </div>
  <div id="main-block" class="hidden">
    <header>
      <div id="cover-wrap">
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-left" title="–ù–∞–∑–∞–¥">
          <svg width="34" height="34" viewBox="0 0 34 34"><circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/><polyline points="20,10 13,17 20,24" fill="none" stroke="#fff" stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <img id="cover" src="Cover.png" alt="Cover album" draggable="false"/>
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-right" title="–í–ø–µ—Ä—ë–¥">
          <svg width="34" height="34" viewBox="0 0 34 34"><circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/><polyline points="14,10 21,17 14,24" fill="none" stroke="#fff" stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
      <div id="social-links" class="socials-under-cover"></div>
    </header>
    <div class="track-list" id="track-list"></div>
    <div class="bottom-controls-center">
      <img class="logo-bottom" src="img/logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø"/>
      <button id="install-pwa-btn" style="margin: 15px 0 0 0; display: none;">
        –£–°–¢–ê–ù–û–í–ò–¢–¨ –ö–ê–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–ï
      </button>
      <button id="download-album-main" onclick="openAlbumDownloadModal()">–°–ö–ê–ß–ê–¢–¨ –í–ï–°–¨ –ê–õ–¨–ë–û–ú</button>
      <span class="feedback-link" id="feedback-link">–û–ë–†–ê–¢–ù–ê–Ø –°–í–Ø–ó–¨</span>
      <a class="support-link" id="support-link" href="#" target="_blank">–ü–û–î–î–ï–†–ñ–ê–¢–¨</a>
      <button class="offline-btn online" id="offline-btn" onclick="offlineUIClick()">ONLINE</button>
    </div>
  </div>
  <div class="modal-bg" id="modal-feedback">
    <div class="modal-feedback">
      <button class="bigclose" onclick="closeFeedbackModal()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg>
      </button>
      <div id="feedback-step">
        <div class="fake-textarea" id="fake-textarea" onclick="showRealTextarea()">
          –û–ø–∏—à–∏—Ç–µ –∑–¥–µ—Å—å –ø—Ä–æ–±–ª–µ–º—É –∏–ª–∏ —Å–≤–æ—ë –ø–æ–∂–µ–ª–∞–Ω–∏–µ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è, <br>–º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Å–≤–æ–π –æ—Ç–∑—ã–≤...
        </div>
      </div>
      <div id="modal-feedback-error" class="err-msg"></div>
      <div id="modal-feedback-success" class="success-msg"></div>
      <button onclick="sendFeedbackMsg()" id="send-feedback-btn" style="margin-bottom:8px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
  <div class="modal-bg" id="modal-offline">
    <div class="modal-feedback" style="max-width:400px;">
      <button class="bigclose" onclick="closeOfflineModal()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg>
      </button>
      <div id="offline-step"></div>
    </div>
  </div>
  <div class="modal-bg" id="install-modal">
    <div class="modal-feedback" style="max-width:400px;">
      <button class="bigclose" onclick="closeInstallModal()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg>
      </button>
      <div style="font-size:1.18em;font-weight:700;margin-bottom:13px;">
        –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ<br>¬´–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞¬ª?
      </div>
      <div style="margin-bottom:16px;font-size:1em;">
        –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ –≤–∞—à–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ, –∑–∞–π–º—ë—Ç ~1 –ú–ë.<br>
        –ï–≥–æ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç —É–¥–∞–ª–∏—Ç—å –∫–∞–∫ –æ–±—ã—á–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.<br>
        –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞.<br><br>
        <b>–î–ª—è –∑–∞—â–∏—Ç—ã –∑–∞–ø—É—Å—Ç–∏–º –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–µ —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤.</b>
      </div>
      <div id="install-modal-hash" style="font-size:.95em; color:#4daaff; margin-bottom:10px; display:none;">
        –•—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ...<br>
        <span id="install-hash-progress"></span>
      </div>
      <button class="offline-btn online" id="install-proceed-btn" style="width:99%;margin-bottom:7px;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
      <button class="offline-btn" style="width:99%;" onclick="closeInstallModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
  <div class="modal-bg" id="download-modal">
    <div class="modal-feedback" style="max-width:400px;">
      <div class="download-modal-title">–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å —Å —ç—Ç–∏–º —Ñ–∞–π–ª–æ–º?</div>
      <div style="margin-bottom:19px;font-size:.98em;" id="download-modal-filename"></div>
      <button class="offline-btn online" style="width:98%;margin-bottom:10px;" onclick="downloadCurrentTrack()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="shareCurrentTrack()">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –¥—Ä—É–∑—å—è–º–∏</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="openInAppCurrentTrack()">–û—Ç–∫—Ä—ã—Ç—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="copyLinkCurrentTrack()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="openAlbumDownloadModal()">–°–∫–∞—á–∞—Ç—å –≤–µ—Å—å –∞–ª—å–±–æ–º</button>
      <button class="offline-btn" style="width:98%;" onclick="closeDownloadModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
  
  <!-- –ù–æ–≤—ã–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∞–ª—å–±–æ–º–∞ -->
  <div class="modal-bg" id="albumDownloadModal">
    <div class="modal-feedback" style="max-width: 400px;">
      <h2 style="text-align: center; margin-bottom: 25px;">–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º</h2>
      
      <div class="download-options">
        <label class="checkbox-container">
          <input type="checkbox" id="includeCovers" checked>
          <span class="checkmark"></span>
          –û–±–ª–æ–∂–∫–∏ (–≥–∞–ª–µ—Ä–µ—è)
        </label>
        
        <label class="checkbox-container">
          <input type="checkbox" id="includeLyrics" checked>
          <span class="checkmark"></span>
          –¢–µ–∫—Å—Ç—ã –ø–µ—Å–µ–Ω
        </label>
        
        <hr style="margin: 15px 0; border-color: #333;">
        
        <label class="checkbox-container">
          <input type="checkbox" id="onlyFavorites">
          <span class="checkmark"></span>
          –¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –ø–µ—Å–Ω–∏
        </label>
        
        <label class="checkbox-container">
          <input type="checkbox" id="fullAlbum" checked>
          <span class="checkmark"></span>
          –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–ª—å–±–æ–º
        </label>
      </div>
      
      <div class="modal-buttons">
        <button onclick="closeAlbumDownloadModal()" class="btn-secondary">–û–¢–ú–ï–ù–ê</button>
        <button onclick="prepareDownload()" class="btn-primary">–°–ö–ê–ß–ê–¢–¨</button>
      </div>
    </div>
  </div>
  
  <div class="modal-bg" id="sizeConfirmModal">
    <div class="modal-feedback" style="max-width: 350px;">
      <h3 style="text-align: center;">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
      
      <div class="size-info">
        <div style="font-size: 48px; color: #E80100; margin-bottom: 15px;">üì¶</div>
        <p style="font-size: 18px; margin: 10px 0;">
          –†–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞: <strong id="archiveSize">0 –ú–ë</strong>
        </p>
        <p style="color: #888; font-size: 14px;">
          –§–∞–π–ª–æ–≤ –≤ –∞—Ä—Ö–∏–≤–µ: <span id="fileCount">0</span>
        </p>
      </div>
      
      <div class="modal-buttons">
        <button onclick="closeSizeConfirmModal()" class="btn-secondary">–û–¢–ú–ï–ù–ê</button>
        <button onclick="startDownload()" class="btn-primary">–°–ö–ê–ß–ê–¢–¨</button>
      </div>
    </div>
  </div>
  
  <div class="modal-bg" id="downloadProgressModal">
    <div class="modal-feedback" style="max-width: 400px;">
      <h3 style="text-align: center; margin-bottom: 20px;">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞</h3>
      
      <div class="progress-bar">
        <div id="progressFill" class="progress-fill" style="width: 0%"></div>
      </div>
      
      <p id="progressText" style="text-align: center; margin-top: 10px;">
        –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤: 0/0
      </p>
      
      <div id="errorsList" style="display: none; color: #ff6b6b; font-size: 14px; margin-top: 15px;">
        <p><strong>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å:</strong></p>
        <ul id="errorsListContent"></ul>
      </div>
    </div>
  </div>
  
  <div id="copy-notify" style="display:none;position:fixed;left:50%;bottom:38px;transform:translateX(-50%);padding:14px 26px;background:#262b39;color:#fff;border-radius:12px;font-size:1.07em;box-shadow:0 3px 32px #0007;z-index:1999;transition:opacity .3s; opacity:0;">
    –¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!
  </div>
  
<script>
if('serviceWorker' in navigator){navigator.serviceWorker.register('service-worker.js');}
let config=null, promoPassed=false, configLoaded=false;
let coverGalleryArr=['Cover.png','Cover01.png','Cover02.png','Cover03.png'];
let coverGalleryIdx=0, coverAutoplay=null, currentTrack=-1, currentLyrics=[], autoPlayEnabled=false;
let offlineMode = localStorage.getItem('offlineMode') === '1', offlineDownloading = false;

// –ù–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∞–ª—å–±–æ–º–∞
let downloadOptions = {
  includeCovers: true,
  includeLyrics: true,
  onlyFavorites: false,
  fullAlbum: true
};
let filesToDownload = [];
let totalSize = 0;

fetch('config.json').then(r=>r.json()).then(data=>{
  config=data;configLoaded=true;
  document.getElementById('promo-inp').disabled=false;
  document.getElementById('promo-btn').disabled=false;
  if(localStorage.getItem('promoPassed') === '1'){
    promoPassed = true;
    document.getElementById('main-block').classList.remove('hidden');
    document.getElementById('promocode-block').classList.add('hidden');
    initializeMainUi();
    setOfflineUIState(offlineMode ? 'offline' : 'online');
  }
});

function checkPromo() {
  const val = document.getElementById('promo-inp').value.trim();
  if (!configLoaded) {
    document.getElementById('promo-error').innerText = "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö... –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥.";
    return;
  }
  if (val && config && val.toUpperCase() === config.promoCode.toUpperCase()) {
    promoPassed = true;
    localStorage.setItem('promoPassed', '1');
    document.getElementById('main-block').classList.remove('hidden');
    document.getElementById('promocode-block').classList.add('hidden');
    initializeMainUi();
    setOfflineUIState(offlineMode ? 'offline' : 'online');
  } else {
    document.getElementById('promo-error').innerText = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë!";
  }
}

document.getElementById('promo-inp').addEventListener('keydown',function(e){if(e.key==="Enter")checkPromo();});

function initializeMainUi(){
  setCoverImage(coverGalleryIdx);buildSocials();
  document.getElementById('support-link').href = config.donateLink;
  document.body.style.background = "url(" + config.background + ") center/cover fixed #111";
  buildTrackList();
  document.getElementById('feedback-link').onclick = openFeedbackModal;
  document.getElementById('modal-feedback').onclick = function(e){if(e.target === this) closeFeedbackModal();};
  document.getElementById('cover-gallery-arrow-left').onclick = function(){setCoverImage(coverGalleryIdx-1);startCoverAutoPlay();};
  document.getElementById('cover-gallery-arrow-right').onclick = function(){setCoverImage(coverGalleryIdx+1);startCoverAutoPlay();};
  let startX=null,el=document.getElementById('cover-wrap');
  el.addEventListener('touchstart',function(e){startX=e.touches[0].clientX;});
  el.addEventListener('touchend',function(e){if(startX===null)return;let dx=e.changedTouches[0].clientX-startX;if(Math.abs(dx)>30){if(dx>0)setCoverImage(coverGalleryIdx-1);else setCoverImage(coverGalleryIdx+1);startCoverAutoPlay();}startX=null;});
  startCoverAutoPlay();
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∞–ª—å–±–æ–º–∞
  initializeAlbumDownloadCheckboxes();
}

function setCoverImage(idx){coverGalleryIdx=(idx+coverGalleryArr.length)%coverGalleryArr.length;document.getElementById('cover').src=coverGalleryArr[coverGalleryIdx];}
function startCoverAutoPlay(){if(coverAutoplay)clearInterval(coverAutoplay);coverAutoplay=setInterval(function(){setCoverImage(coverGalleryIdx+1);},5000);}
function buildSocials(){const s=config.socials.map(x=>`<a href="${x.url}" target="_blank">${x.title}</a>`).join(" ");document.getElementById('social-links').innerHTML=s;}
function getLiked(){try{return JSON.parse(localStorage.getItem('likedTracks')||"[]");}catch(e){return [];}}
function saveLiked(arr){localStorage.setItem('likedTracks',JSON.stringify(arr));}
function isLiked(idx){let liked=getLiked();return liked.indexOf(idx)!==-1;}
function toggleLike(idx, e){if(e){e.stopPropagation();}let liked=getLiked(),i=liked.indexOf(idx);if(i===-1)liked.push(idx);else liked.splice(i,1);saveLiked(liked);buildTrackList();}

function buildTrackList(){
  let html = "";
  for(let i=0;i<config.tracks.length;i++){
    html += `<div class="track${i===currentTrack?' current':''}" id="trk${i}" onclick="pickAndPlayTrack(${i})">
      <span class="tnum">${(i+1).toString().padStart(2,'0')}.</span>
      <span class="track-title">${config.tracks[i].title}</span>
      <img src="${isLiked(i)?'img/star.png':'img/star2.png'}" class="like-star"
        alt="–∑–≤–µ–∑–¥–∞" title="${isLiked(i)?'–£–±—Ä–∞—Ç—å –∏–∑ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏—Ö—Å—è':'–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è'}"
        onclick="toggleLike(${i},event)"/>
    </div>`;
    if(i===currentTrack) html+=`<div class="lyrics-player-block" id="lyricsplayerblock"></div>`;
  }
  document.getElementById('track-list').innerHTML = html;
  renderLyricsBlock();
}

function pickAndPlayTrack(n){showTrack(n,true);autoPlayEnabled=true;}
function showTrack(n,doPlay){currentTrack=n;buildTrackList();if(doPlay&&document.getElementById("audio"))setTimeout(()=>{document.getElementById("audio").play();},140);}

function renderLyricsBlock(){
  const block = document.getElementById('lyricsplayerblock'); if (!block) return;
  let lyricsDiv = `
    <div id="lyrics-window"><div class="lyrics-scroll" id="lyrics"></div></div>
    <div class="audio-wrapper">
      <audio id="audio" controls preload="metadata"></audio>
    </div>
    <div class="player-buttons-center">
      <button class="karaoke-btn" onclick="copyLyrics()">–°–ö–û–ü–ò–†–û–í–ê–¢–¨ –¢–ï–ö–°–¢</button>
      <a class="player-download-btn" id="download-link" href="#" onclick="openDownloadModal(event)">–°–ö–ê–ß–ê–¢–¨ –ü–ï–°–ù–Æ</a>
    </div>`;
  block.innerHTML = lyricsDiv;
  const tr = config.tracks[currentTrack];
  document.getElementById('audio').src = tr.audio;
  loadLyrics(tr.lyrics);
  document.getElementById('audio').ontimeupdate = function() { renderLyrics(this.currentTime); };
  document.getElementById('audio').onended = function() { if (autoPlayEnabled) { let next = (currentTrack + 1) % config.tracks.length; showTrack(next, true); } };
}

function loadLyrics(file){fetch(file).then(r=>r.json()).then(js=>{currentLyrics=js;renderLyrics(0);});}

function renderLyrics(time){
  if(!currentLyrics||!currentLyrics.length){document.getElementById('lyrics').innerHTML="";return;}
  let active=0;for(let i=0;i<currentLyrics.length;i++)if(time>=currentLyrics[i].time)active=i;
  let windowSize=5;let start=active<2?0:active-2;let padTop=active<2?2-active:0;let rows=[];
  for(let p=0;p<padTop;++p)rows.push('<div class="lyrics-window-line"></div>');
  for(let i=start;i<Math.min(currentLyrics.length,start+windowSize-padTop);i++){
    let cls=(i===active)?'lyrics-window-line active':'lyrics-window-line';
    rows.push(`<div class="${cls}">${currentLyrics[i]?currentLyrics[i].line:""}</div>`);
  }
  while(rows.length<windowSize)rows.push('<div class="lyrics-window-line"></div>');
  document.getElementById("lyrics").innerHTML=rows.join("");
}

function getTrackFileName(track, idx, artist) {
  return `${(idx + 1).toString().padStart(2, '0')} - ${track.title} - ${artist}.mp3`.replace(/[\\/:"*?<>|]+/g, '_');
}

function openDownloadModal(e) {
  if(e){ e.preventDefault(); }
  let tr = config.tracks[currentTrack];
  let fileName = getTrackFileName(tr, currentTrack, config.artist);
  document.getElementById('download-modal-filename').innerHTML = `<b>${fileName}</b>`;
  document.getElementById('download-modal').classList.add('active');
}

function closeDownloadModal(){ document.getElementById('download-modal').classList.remove('active'); }
document.getElementById('download-modal').onclick = function(e){ if(e.target === this) closeDownloadModal(); };

function downloadCurrentTrack() {
  let tr = config.tracks[currentTrack];
  let fileName = getTrackFileName(tr, currentTrack, config.artist);
  let url = 'https://apel-s-in.github.io/vi3na1bita-mezhdu-zlom-i-dobrom/' + tr.audio.replace(/^\.?\//,'');
  let a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  window.setTimeout(() => { document.body.removeChild(a); }, 250);
  closeDownloadModal();
  showCopyNotification('–§–∞–π–ª –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω!');
}

async function shareCurrentTrack() {
  let tr = config.tracks[currentTrack];
  let fileName = getTrackFileName(tr, currentTrack, config.artist);
  let url = 'https://apel-s-in.github.io/vi3na1bita-mezhdu-zlom-i-dobrom/' + tr.audio.replace(/^\.?\//,'');
  if (navigator.canShare && window.isSecureContext) {
    try {
      let resp = await fetch(url);
      let blob = await resp.blob();
      let file = new File([blob], fileName, {type:'audio/mpeg'});
      if(navigator.canShare({files:[file]})) {
        await navigator.share({ files: [file], title:fileName, text:fileName });
        showCopyNotification('–§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
        closeDownloadModal();
        return;
      }
    } catch(e){}
  }
  showCopyNotification('–§—É–Ω–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ');
}

async function openInAppCurrentTrack(){
  await shareCurrentTrack();
}

function copyLinkCurrentTrack(){
  let tr = config.tracks[currentTrack];
  let url = 'https://apel-s-in.github.io/vi3na1bita-mezhdu-zlom-i-dobrom/' + tr.audio.replace(/^\.?\//,'');
  if(navigator.clipboard && window.isSecureContext){
    navigator.clipboard.writeText(url).then(
      () => showCopyNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!'),
      () => showCopyNotification('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É')
    );
  }else{
    const textarea = document.createElement("textarea");
    textarea.value = url;
    document.body.appendChild(textarea);
    textarea.select();
    try { document.execCommand('copy');showCopyNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!'); }
    catch(e){ showCopyNotification('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É'); }
    document.body.removeChild(textarea);
  }
  closeDownloadModal();
}

function copyLyrics(){
  if (!config || currentTrack < 0 || !config.tracks[currentTrack].fulltext) {
    showCopyNotification("–§–∞–π–ª —Å —Ç–µ–∫—Å—Ç–æ–º –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω!");
    return;
  }
  fetch(config.tracks[currentTrack].fulltext).then(r => {
    if(!r.ok) throw new Error("–ù–µ –Ω–∞–π–¥–µ–Ω");
    return r.text();
  }).then(txt => {
    if (offlineMode) {
      hashString(txt).then(hash => {
        doCopyLyrics(txt, "–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!\n–•—ç—à —Ñ–∞–π–ª–∞: " + hash.substr(0,12) + "‚Ä¶");
      }).catch(() => {
        doCopyLyrics(txt, "–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!");
      });
    } else {
      doCopyLyrics(txt, "–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!");
    }
  }).catch(() => {
    showCopyNotification("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏/–∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç!");
  });
}

function doCopyLyrics(txt, notify){
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(txt).then(
      () => showCopyNotification(notify),
      () => showCopyNotification("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å :(")
    );
  } else {
    const textarea = document.createElement("textarea");
    textarea.value = txt;
    document.body.appendChild(textarea);
    textarea.select();
    try { document.execCommand('copy'); }
    catch(e){}
    document.body.removeChild(textarea);
    showCopyNotification(notify + " (—Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–±)");
  }
}

async function hashString(str) {
  const buf = new TextEncoder().encode(str);
  const hashBuffer = await crypto.subtle.digest('SHA-256', buf);
  return Array.from(new Uint8Array(hashBuffer)).map(x=>x.toString(16).padStart(2,"0")).join("");
}

function showCopyNotification(text){
  let n = document.getElementById('copy-notify');
  n.innerText = text;
  n.style.display = '';
  n.style.opacity = '1';
  setTimeout(() => { n.style.opacity = '0'; }, 1800);
  setTimeout(() => { n.style.display = 'none'; }, 2300);
}

// –ù–û–í–´–ô –ö–û–î –î–õ–Ø –§–£–ù–ö–¶–ò–ò –°–ö–ê–ß–ò–í–ê–ù–ò–Ø –ê–õ–¨–ë–û–ú–ê

function initializeAlbumDownloadCheckboxes() {
  // –í–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞—é—â–∏–µ —á–µ–∫–±–æ–∫—Å—ã
  document.getElementById('onlyFavorites').addEventListener('change', function() {
    if (this.checked) {
      document.getElementById('fullAlbum').checked = false;
    }
  });
  
  document.getElementById('fullAlbum').addEventListener('change', function() {
    if (this.checked) {
      document.getElementById('onlyFavorites').checked = false;
    }
  });
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö
  checkFavoritesAvailable();
}

function checkFavoritesAvailable() {
  const favCheckbox = document.getElementById('onlyFavorites');
  const likedTracks = getLiked();
  if (likedTracks.length === 0) {
    favCheckbox.disabled = true;
    favCheckbox.parentElement.style.opacity = '0.5';
    favCheckbox.parentElement.title = '–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤';
  } else {
    favCheckbox.disabled = false;
    favCheckbox.parentElement.style.opacity = '1';
    favCheckbox.parentElement.title = '';
  }
}

function openAlbumDownloadModal() {
  closeDownloadModal(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –æ–∫–Ω–æ –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ
  checkFavoritesAvailable(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö
  document.getElementById('albumDownloadModal').classList.add('active');
}

function closeAlbumDownloadModal() {
  document.getElementById('albumDownloadModal').classList.remove('active');
}

document.getElementById('albumDownloadModal').onclick = function(e) {
  if(e.target === this) closeAlbumDownloadModal();
};

function generateSocialText() {
  const socials = config.socials || [];
  let socialLinks = '';
  
  socials.forEach(social => {
    socialLinks += `${social.title}: ${social.url}\n`;
  });
  
  return `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       –í–ò–¢–†–ò–ù–ê –†–ê–ó–ë–ò–¢–ê - –ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ç–µ—Ä–µ—Å –∫ –Ω–∞—à–µ–º—É —Ç–≤–æ—Ä—á–µ—Å—Ç–≤—É!
–í–∞—à–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—á–µ–Ω—å –≤–∞–∂–Ω–∞ –¥–ª—è –Ω–∞—Å.

–ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ –Ω–∞—à–∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏:

${socialLinks}
–î–µ–ª–∏—Ç–µ—Å—å –º—É–∑—ã–∫–æ–π —Å –¥—Ä—É–∑—å—è–º–∏!
–° –ª—é–±–æ–≤—å—é, –≥—Ä—É–ø–ø–∞ "–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞"

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;
}

async function prepareDownload() {
  // –°–æ–±–∏—Ä–∞–µ–º –æ–ø—Ü–∏–∏
  downloadOptions.includeCovers = document.getElementById('includeCovers').checked;
  downloadOptions.includeLyrics = document.getElementById('includeLyrics').checked;
  downloadOptions.onlyFavorites = document.getElementById('onlyFavorites').checked;
  downloadOptions.fullAlbum = document.getElementById('fullAlbum').checked;
  
  // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
  await prepareFilesList();
  
  // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä
  const sizeMB = await calculateArchiveSize();
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
  document.getElementById('archiveSize').textContent = sizeMB + ' –ú–ë';
  document.getElementById('fileCount').textContent = filesToDownload.length;
  
  closeAlbumDownloadModal();
  document.getElementById('sizeConfirmModal').classList.add('active');
}

async function prepareFilesList() {
  filesToDownload = [];
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ç—Ä–µ–∫–æ–≤
  let trackIndices = [];
  const likedTracks = getLiked();
  
  if (downloadOptions.onlyFavorites) {
    trackIndices = likedTracks;
  } else if (downloadOptions.fullAlbum) {
    trackIndices = config.tracks.map((_, i) => i);
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º MP3 –∏ —Ç–µ–∫—Å—Ç—ã
  for (let idx of trackIndices) {
    const track = config.tracks[idx];
    const num = String(idx + 1).padStart(2, '0');
    const fileName = `${num} - ${track.title} - ${config.artist}.mp3`;
    
    filesToDownload.push({
      url: track.audio,
      name: fileName,
      type: 'audio'
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if (downloadOptions.includeLyrics && track.fulltext) {
      const lyricsName = `${num} - ${track.title} - ${config.artist}.txt`;
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –≤ –∞—Ä—Ö–∏–≤
      try {
        const response = await fetch(track.fulltext);
        const text = await response.text();
        filesToDownload.push({
          content: text,
          name: lyricsName,
          type: 'text'
        });
      } catch(e) {
        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç –¥–ª—è', track.title);
      }
    }
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±–ª–æ–∂–∫–∏
  if (downloadOptions.includeCovers) {
    coverGalleryArr.forEach(cover => {
      filesToDownload.push({
        url: cover,
        name: cover.split('/').pop(),
        type: 'image'
      });
    });
  }
  
  // –í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º
  filesToDownload.push({
    url: 'img/logo.png',
    name: 'logo.png',
    type: 'image'
  });
  
  filesToDownload.push({
    content: generateSocialText(),
    name: 'social.txt',
    type: 'text'
  });
}

async function calculateArchiveSize() {
  totalSize = 0;
  const promises = [];
  
  for (let file of filesToDownload) {
    if (file.url) {
      promises.push(
        fetch(file.url, { method: 'HEAD' })
          .then(response => {
            const size = response.headers.get('content-length');
            if (size) totalSize += parseInt(size);
          })
          .catch(() => {
            // –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å
            if (file.type === 'audio') totalSize += 5 * 1024 * 1024; // ~5MB
            if (file.type === 'image') totalSize += 500 * 1024; // ~500KB
          })
      );
    } else if (file.content) {
      totalSize += new Blob([file.content]).size;
    }
  }
  
  await Promise.all(promises);
  
  // –î–æ–±–∞–≤–ª—è–µ–º ~10% –Ω–∞ ZIP overhead
  totalSize = Math.ceil(totalSize * 1.1);
  
  return (totalSize / 1024 / 1024).toFixed(1); // –í –º–µ–≥–∞–±–∞–π—Ç–∞—Ö
}

function closeSizeConfirmModal() {
  document.getElementById('sizeConfirmModal').classList.remove('active');
}

document.getElementById('sizeConfirmModal').onclick = function(e) {
  if(e.target === this) closeSizeConfirmModal();
};

function startDownload() {
  closeSizeConfirmModal();
  createAndDownloadZip();
}

function showProgressModal() {
  document.getElementById('downloadProgressModal').classList.add('active');
  document.getElementById('progressFill').style.width = '0%';
  document.getElementById('progressText').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤: 0/' + filesToDownload.length;
  document.getElementById('errorsList').style.display = 'none';
}

function updateProgress(completed, total) {
  const percent = Math.round((completed / total) * 100);
  document.getElementById('progressFill').style.width = percent + '%';
  document.getElementById('progressText').textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤: ${completed}/${total}`;
}

function showErrors(errors) {
  if (errors.length > 0) {
    document.getElementById('errorsList').style.display = 'block';
    document.getElementById('errorsListContent').innerHTML = errors.map(e => `<li>${e}</li>`).join('');
  }
}

async function createAndDownloadZip() {
  const zip = new JSZip();
  const errors = [];
  let completed = 0;
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
  showProgressModal();
  
  for (let file of filesToDownload) {
    try {
      if (file.url) {
        const response = await fetch(file.url);
        const blob = await response.blob();
        zip.file(file.name, blob);
      } else if (file.content) {
        zip.file(file.name, file.content);
      }
      
      completed++;
      updateProgress(completed, filesToDownload.length);
      
    } catch (error) {
      errors.push(file.name);
      console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${file.name}:`, error);
    }
  }
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
  if (errors.length > 0) {
    showErrors(errors);
    await new Promise(resolve => setTimeout(resolve, 3000)); // –î–∞—ë–º –≤—Ä–µ–º—è —É–≤–∏–¥–µ—Ç—å –æ—à–∏–±–∫–∏
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞
  document.getElementById('progressText').textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞...';
  
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∞—Ä—Ö–∏–≤
  const content = await zip.generateAsync({
    type: "blob",
    compression: "DEFLATE",
    compressionOptions: { level: 6 }
  }, function updateCallback(metadata) {
    const progress = metadata.percent.toFixed(0);
    document.getElementById('progressText').textContent = `–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞: ${progress}%`;
    document.getElementById('progressFill').style.width = progress + '%';
  });
  
  // –°–∫–∞—á–∏–≤–∞–µ–º
  const link = document.createElement('a');
  link.href = URL.createObjectURL(content);
  link.download = 'vitrina-razbita-mezhdu-zlom-i-dobrom.zip';
  link.click();
  
  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–∞ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
  setTimeout(() => {
    document.getElementById('downloadProgressModal').classList.remove('active');
    showCopyNotification('–ê—Ä—Ö–∏–≤ —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω!');
  }, 1500);
}

document.getElementById('downloadProgressModal').onclick = function(e) {
  // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
};

// –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ö–û–î–ê

window.addEventListener('keydown',function(e){if(!promoPassed)return;if(e.key=='ArrowRight'){showTrack(Math.min(currentTrack+1,config.tracks.length-1),true);}if(e.key=='ArrowLeft'){showTrack(Math.max(currentTrack-1,0),true);}});
let isRealTextarea=false;

function openFeedbackModal(){document.getElementById('modal-feedback').classList.add('active');isRealTextarea=false;document.getElementById('feedback-step').innerHTML =`
  <div class="fake-textarea" id="fake-textarea" onclick="showRealTextarea()">
    –û–ø–∏—à–∏—Ç–µ –∑–¥–µ—Å—å –ø—Ä–æ–±–ª–µ–º—É –∏–ª–∏ —Å–≤–æ—ë –ø–æ–∂–µ–ª–∞–Ω–∏–µ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è,<br>–º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Å–≤–æ–π –æ—Ç–∑—ã–≤...
  </div>`;document.getElementById('modal-feedback-error').innerText="";document.getElementById('modal-feedback-success').innerText="";document.getElementById('send-feedback-btn').disabled=false;}

function closeFeedbackModal(){document.getElementById('modal-feedback').classList.remove('active');}

function showRealTextarea(){if(isRealTextarea)return;isRealTextarea=true;document.getElementById('feedback-step').innerHTML=
  `<textarea class="real-textarea" id="feedback-text" maxlength="200" autofocus></textarea>`;
  setTimeout(()=>{let ta=document.getElementById('feedback-text');ta.focus();ta.addEventListener('input',function(){if(this.value.length>200)this.value=this.value.substr(0,200);});},20);}

function sendFeedbackMsg(){
  let msg="";if(isRealTextarea){let ta=document.getElementById('feedback-text');msg=ta.value.trim();}else return;
  const errorDiv=document.getElementById('modal-feedback-error');
  const successDiv=document.getElementById('modal-feedback-success');
  errorDiv.innerText="";successDiv.innerText="";
  if(msg.length<5){errorDiv.innerText="–ù–∞–ø–∏—à–∏—Ç–µ —Ö–æ—Ç—è –±—ã –ø–∞—Ä—É —Å–ª–æ–≤!";return;}
  document.getElementById('send-feedback-btn').disabled=true;
  successDiv.innerText="–°–ø–∞—Å–∏–±–æ! (–û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)";
  setTimeout(closeFeedbackModal,2100);
  document.getElementById('send-feedback-btn').disabled=false;}

function getAudioSize(idx){return config.tracks[idx].size||4.7;}

function getDownloadStats(){
  let liked=getLiked();let allCount=config.tracks.length;let likedCount=liked.length;
  let allMb=0,likeMb=0;for(let i=0;i<allCount;++i){allMb+=getAudioSize(i);if(liked.indexOf(i)!==-1)likeMb+=getAudioSize(i);}
  return{allSizeMb:Math.round(allMb*10)/10,likedSizeMb:Math.round(likeMb*10)/10,likedCount,allCount};
}

function offlineUIClick(){
  if(offlineDownloading)return;
  if(!offlineMode){
    document.getElementById('modal-offline').classList.add('active');
    document.getElementById('offline-step').innerHTML=`
      <div style="font-size:1.09em;font-weight:700;margin-bottom:10px;">–û—Ñ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º</div>
      <div style="margin-bottom:16px;">–î–ª—è —Ä–∞–±–æ—Ç—ã –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –Ω—É–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –º—É–∑—ã–∫—É –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.<br>
      –≠—Ç–æ –∑–∞–π–º—ë—Ç <b>–º–µ—Å—Ç–æ</b> –∏ –≤—Ä–µ–º—è.<br><div style="color:#e80100;margin:5px 0 0 0;">
      ‚ö† –ù–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö (iOS Safari, —Å—Ç–∞—Ä—ã–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã) —Ä–∞–∑–º–µ—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω (~50-150 –ú–ë).
      </div><div style="margin:8px 0 0 0;opacity:.7;">–ü–æ—Å–ª–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤—ã —Å–º–æ–∂–µ—Ç–µ —Å–ª—É—à–∞—Ç—å —Ç–æ–ª—å–∫–æ OFFLINE-—Ñ–∞–π–ª—ã –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.</div></div>
      <button class="offline-btn online" style="width:99%;margin-bottom:7px;" onclick="nextOfflineChoice()">–°–æ–≥–ª–∞—Å–µ–Ω</button>
      <button class="offline-btn" style="width:99%;" onclick="closeOfflineModal()">–û—Ç–º–µ–Ω–∞</button>`;
  }else{
    document.getElementById('modal-offline').classList.add('active');
    document.getElementById('offline-step').innerHTML=`
      <div style="font-size:1.10em;font-weight:700;margin-bottom:15px;">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ ONLINE?</div>
      <div style="margin-bottom:20px;">–í—Å–µ —Å–∫–∞—á–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.<br>
      –û—á–∏—â–∞–µ—Ç—Å—è –º–µ—Å—Ç–æ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.<br>–ü–µ—Å–Ω–∏ —Å–Ω–æ–≤–∞ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.
      </div>
      <button class="offline-btn online" style="width:99%;" onclick="confirmGoOnline()">–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª—ã –∏ –≤–æ–∑–≤—Ä–∞—Ç ONLINE</button>
      <button class="offline-btn" style="width:99%;margin-top:7px;" onclick="closeOfflineModal()">–û—Ç–º–µ–Ω–∞</button>`;
  }
}

function closeOfflineModal(){document.getElementById('modal-offline').classList.remove('active');}

function nextOfflineChoice(){
  let d=getDownloadStats();
  document.getElementById('offline-step').innerHTML=`
    <div style="font-size:1.10em;font-weight:700;margin-bottom:13px;">–ß—Ç–æ —Å–∫–∞—á–∞—Ç—å?</div>
    <div style="text-align:left;">
      <label style="display:block;margin:8px 0;">
        <input type="radio" name="offline-mode" value="all" checked>
        –í–µ—Å—å –¥–∏—Å–∫ (${d.allCount} –ø–µ—Å–µ–Ω, ${d.allSizeMb} –ú–ë)
      </label>
      <label style="display:block;margin:8px 0;">
        <input type="radio" name="offline-mode" value="liked">
        –¢–æ–ª—å–∫–æ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è (${d.likedCount||0} –ø–µ—Å–µ–Ω, ${d.likedSizeMb||0} –ú–ë)
      </label>
    </div>
    <button class="offline-btn online" style="width:99%;margin-top:12px;" onclick="startOfflineDownload()">–°–∫–∞—á–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ</button>
    <button class="offline-btn" style="width:99%;margin-top:8px;" onclick="closeOfflineModal()">–û—Ç–º–µ–Ω–∞</button>`;
}

function getAllAssetsForOffline(mode){
  let all=['index.html','config.json','img/logo.png','img/star.png','img/star2.png','Cover.png','Cover01.png','Cover02.png','Cover03.png'];
  let liked=getLiked();
  for(let i=0;i<config.tracks.length;++i)
    if(mode==='all'||liked.indexOf(i)!==-1){
      all.push(config.tracks[i].audio);
      all.push(config.tracks[i].lyrics);
      if(config.tracks[i].fulltext) all.push(config.tracks[i].fulltext);
    }
  return[...new Set(all)];
}

function startOfflineDownload(){
  offlineDownloading=true;closeOfflineModal();setOfflineUIState('downloading');
  let mode=document.querySelector('input[name="offline-mode"]:checked').value;let files=getAllAssetsForOffline(mode);
  navigator.serviceWorker.ready.then(async sw=>{
    sw.active.postMessage({type:'CACHE_FILES',files});
    let stats=getDownloadStats(),needMb=(mode=='all'?stats.allSizeMb:stats.likedSizeMb),max=files.length;
    let checkAll=setInterval(async()=>{
      let cache=await caches.open('album-offline-v1');let ok=0;
      for(let src of files){let res=await cache.match(src);if(res)ok++;}
      setOfflineUIState('downloading',ok/max,needMb);
      if(ok>=max){
        clearInterval(checkAll);offlineDownloading=false;offlineMode=true;
        localStorage.setItem('offlineMode', '1');
        setOfflineUIState('offline');offlineShowDone(needMb,mode);
      }
    },400);
  });
}

function setOfflineUIState(state,progress,needMb){
  let btn=document.getElementById('offline-btn');
  if(state==='downloading'){
    btn.disabled=true;btn.className='offline-btn offline';btn.innerHTML='OFFLINE';
    if(!document.getElementById('offline-progr-div')){let div=document.createElement('div');div.id='offline-progr-div';
      div.innerHTML=`<div class="offline-progress">
          <div class="offline-progress-bar" id="offline-progress-bar" style="width:0%;"></div>
        </div>
        <div class="offline-desc" id="offline-desc"></div>`;
      btn.parentElement.insertBefore(div,btn.nextSibling);}
    document.getElementById('offline-progress-bar').style.width=Math.round((progress||0)*100)+'%';
    document.getElementById('offline-desc').innerText="–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ "+(needMb||0)+" –ú–ë ...";
  }
  if(state==='offline'){
    btn.disabled=false;btn.className='offline-btn offline';btn.innerHTML='OFFLINE';
    let div=document.getElementById('offline-progr-div');if(div)div.remove();
  }
  if(state==='online'){
    btn.disabled=false;btn.className='offline-btn online';btn.innerHTML='ONLINE';
    let div=document.getElementById('offline-progr-div');if(div)div.remove();
  }
}

function offlineShowDone(mb,mode){
  document.getElementById('modal-offline').classList.add('active');
  document.getElementById('offline-step').innerHTML=`
    <div style="font-size:1.18em;font-weight:700;margin-bottom:12px;">–í—Å–µ —Ñ–∞–π–ª—ã —Å–∫–∞—á–∞–Ω—ã!</div>
    <div style="margin-bottom:13px;">
      <b>${mode=="all"?"–í–µ—Å—å –¥–∏—Å–∫":"–ü–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è —Ç—Ä–µ–∫–∏"}</b><br>
      –î–æ—Å—Ç—É–ø–Ω—ã –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞.<br>
      –ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–∏–º–µ—Ä–Ω–æ <b>${mb} –ú–ë</b>.<br>
      <div style="color:#888;font-size:.98em;margin:5px 0 0 0;">
      –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ: –µ—Å–ª–∏ –∫–µ—à –±—Ä–∞—É–∑–µ—Ä–∞<br>–±—É–¥–µ—Ç –æ—á–∏—â–µ–Ω ‚Äî –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —Å–∫–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ!</div>
    </div>
        <button class="offline-btn" style="width:99%;" onclick="closeOfflineModal()">OK</button>`;
}

function confirmGoOnline(){
  offlineMode=false;
  localStorage.removeItem('offlineMode');
  setOfflineUIState('online');closeOfflineModal();
  navigator.serviceWorker.ready.then(sw=>{sw.active.postMessage({type: 'CLEAR_CACHE'});});
}

let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  let btn = document.getElementById('install-pwa-btn');
  if (btn) btn.style.display = '';
});

document.getElementById('install-pwa-btn').onclick = function() {
  document.getElementById('install-modal').classList.add('active');
  document.getElementById('install-modal-hash').style.display = 'none';
  document.getElementById('install-proceed-btn').disabled = false;
  document.getElementById('install-proceed-btn').innerText = '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
};

function closeInstallModal(){
  document.getElementById('install-modal').classList.remove('active');
}

document.getElementById('install-proceed-btn').onclick = async function(){
  let btn = this;
  btn.disabled = true;
  btn.innerText = '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞...';
  document.getElementById('install-modal-hash').style.display = '';
  document.getElementById('install-hash-progress').innerText = '';
  let hash = await hashManifest();
  document.getElementById('install-hash-progress').innerText = 'SHA-256: ' + hash;
  btn.innerText = '–£—Å—Ç–∞–Ω–æ–≤–∫–∞...';
  if(deferredPrompt){
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then((choiceResult) => {
      closeInstallModal();
      document.getElementById('install-pwa-btn').style.display = 'none';
      deferredPrompt = null;
    });
  }else{
    alert('–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫—É PWA.');
    closeInstallModal();
  }
};

async function hashManifest(){
  try{
    const resp = await fetch('manifest.json');
    const data = await resp.arrayBuffer();
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
  }catch(e){
    return '[–æ—à–∏–±–∫–∞ —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è]';
  }
}

document.getElementById('install-modal').onclick = function(e){
  if(e.target === this) closeInstallModal();
};
</script>
</body>
</html>

