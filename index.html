<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞ - –ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∞–ª—å–±–æ–º –≥—Ä—É–ø–ø—ã –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞. –°–ª—É—à–∞–π—Ç–µ –æ–Ω–ª–∞–π–Ω –∏ –æ—Ñ–ª–∞–π–Ω.">
  
  <!-- PWA –º–µ—Ç–∞—Ç–µ–≥–∏ -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#181818" />
  
  <!-- iOS —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –º–µ—Ç–∞—Ç –µ–≥–∏ -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="–í–∏—Ç—Ä–∏–Ω–∞">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  
  <!-- –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ -->
  <link rel="preload" href="img/logo.png" as="image">
  <link rel="preload" href="Cover.png" as="image">
  
  <style>
    :root {
      --primary-bg: #181818;
      --primary-color: #E80100;
      --secondary-color: #4daaff;
      --text-color: #f2f2f2;
      --modal-bg: #252d39;
      --border-color: #394866;
    }
    
    * { box-sizing: border-box; }
    
    html, body { height: 100%; }
    
    body {
      min-height: 100vh;
      background: var(--primary-bg);
      color: var(--text-color);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-width: 100vw;
      padding-top: env(safe-area-inset-top);
    }
    #promocode-block {
      position: fixed;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--primary-bg);
      z-index: 100;
    }
    
    .promo-inner {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: rgba(15,18,24,0.98);
      border-radius: 16px;
      box-shadow: 0 6px 24px #0008;
      padding: 36px 26px 32px 26px;
      min-width: 260px;
      min-height: 170px;
    }
    /* –ö–∞—Ä—Ç–æ—á–∫–∏ ¬´–ú–æ–∏ –∑–∞—è–≤–∫–∏¬ª */
    .claim-card {
      border:1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.25);
      border-radius: 10px;
      padding: 10px;
      margin: 8px 0;
    }
    .claim-head {
      font-weight: 800;
      color: #cfe3ff;
      margin-bottom: 6px;
    }
    .claim-img {
      width: 100%;
      max-width: 360px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      object-fit: cover;
      display:block;
      margin: 6px auto;
    }
    .claim-title { font-weight: 800; color: #fff; margin: 6px 0 2px 0; }
    .claim-sub   { color:#9aa8c4; font-size:.92em; margin-bottom: 6px; }
    .claim-tags { display:flex; gap:6px; flex-wrap:wrap; margin: 8px 0; }
    .claim-actions { display:flex; justify-content:center; margin-top: 8px; }

    .promo-cover {
      width: 256px;
      height: 256px;
      object-fit: cover;
      border-radius: 12px;
      box-shadow: 0 4px 24px #000c;
      margin-bottom: 19px;
      display: block;
      background: var(--primary-bg);
    }
    
    #promo-inp {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: rgba(255,255,255,0.1);
      color: var(--text-color);
      margin: 10px 0;
      width: 100%;
      font-size: 16px;
    }
    
    #promo-btn {
      padding: 10px 20px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: opacity 0.2s;
    }
    
    #promo-btn:hover:not(:disabled) { opacity: 0.8; }
    #promo-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    #promo-error {
      color: #ff6b6b;
      margin-top: 10px;
      font-size: 14px;
    }
    
    .modal-bg {
      position: fixed;
      z-index: 99;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.62);
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    
    .modal-bg.active { display: flex; animation: fadeIn 0.3s; }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-feedback {
      background: var(--modal-bg);
      border-radius: 14px;
      padding: 34px 20px 21px 20px;
      min-width: 215px;
      box-shadow: 0 4px 32px #0009;
      max-width: 96vw;
      position: relative;
      animation: slideUp 0.3s;
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .modal-feedback .bigclose {
      background: none;
      border: none;
      position: absolute;
      top: 13px;
      right: 13px;
      cursor: pointer;
      color: #eee;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      transition: transform 0.2s;
    }
    
    .modal-feedback .bigclose:hover { transform: scale(1.1); }
    .modal-feedback .bigclose svg { width: 31px; height: 31px; }
    
    .hidden { display: none !important; }
    
    #main-block {
      max-width: 420px;
      margin: 0 auto;
      flex: 1 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      padding: 0 10px;
    }
    
    header {
      width: 100%;
      text-align: center;
      margin: 0 auto;
    }
    
    #cover-wrap {
      width: 100%;
      max-width: 400px;
      margin: 24px auto 0 auto;
      aspect-ratio: 1/1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .cover-gallery-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 2;
      border: none;
      cursor: pointer;
      background: none;
      padding: 0;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s;
    }
    
    .cover-gallery-arrow:hover { opacity: 0.8; }
    
    #cover-gallery-arrow-left { left: 7px; }
    #cover-gallery-arrow-right { right: 7px; }
    
    #cover {
      width: 100%;
      max-width: 100%;
      border-radius: 12px;
      aspect-ratio: 1/1;
      object-fit: cover;
      display: block;
      margin: 0;
      box-shadow: 0 4px 24px rgba(0,0,0,0.3);
    }
    
        /* –ü—É–ª—å—Å–∏—Ä—É—é—â–∏–π –ª–æ–≥–æ—Ç–∏–ø */
    .logo-bottom {
      max-width: 112px;
      width: 23vw;
      min-width: 66px;
      height: auto;
      display: block;
      margin: 0 auto 15px auto !important;
      cursor: pointer;
      transition: transform 0.1s ease-out;
      will-change: transform;
      transform: translateZ(0);
      transform-origin: center center;
      isolation: isolate;
      z-index: 10;
      position: relative;
    }
        /* –ò–∑–æ–ª—è—Ü–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞ –æ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ */
    #logo-bottom {
      will-change: transform;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
    }
    
    .logo-pulsing {
      animation: none !important;
    }
    
    .socials-under-cover {
      margin: 14px auto 0 auto;
      width: 100%;
      max-width: 398px;
      text-align: center;
      font-size: 1.03em;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
    }
    
    .socials-under-cover a {
      color: var(--secondary-color);
      text-decoration: none;
      transition: color 0.2s;
    }
    
    .socials-under-cover a:hover { color: var(--text-color); }
    
    .track-list {
      margin: 0 auto;
      max-width: 370px;
      width: 100%;
      font-size: 1.05em;
      color: #eee;
      background: none;
      padding: 0;
    }
    
    /* –°–∫—Ä—ã—Ç–∏–µ —Ç—Ä–µ–∫–æ–≤ –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–µ */
    .track-list.filtered .track:not(.is-favorite) {
      display: none !important;
    }
    
    .track {
      display: flex;
      align-items: center;
      padding: 7px 8px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: background 0.13s;
      background: none;
    }
    
    .track:hover { background: rgba(255,255,255,0.05); }
    .track.current { background: #232b38; }
    
    .tnum {
      min-width: 27px;
      color: #8ab8fd;
    }
    
    .track-title {
      margin-left: 7px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
    }
    
    .like-star {
      margin-left: auto;
      width: 19px;
      height: 19px;
      cursor: pointer;
      opacity: 0.97;
      border: none;
      background: none;
      padding: 0;
      appearance: none;
      display: inline-block;
      transition: transform 0.2s, filter 0.13s, opacity 0.13s;
    }
    
    .like-star:hover {
      filter: brightness(1.13);
      opacity: 1;
      transform: scale(1.1);
    }
    
    .like-star.animating {
      animation: starPulse 0.3s;
    }
    
    @keyframes starPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.3); }
    }
    
    .lyrics-player-block {
      width: 100%;
      margin: 8px 0 3px 0;
    }
    
    #lyrics-window {
      width: 100%;
      background: rgba(34,34,34,0.98);
      border-radius: 12px;
      box-shadow: 0 8px 24px #0007;
      overflow: hidden;
      height: 8.5em;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: center;
      margin-bottom: 7px;
      transition: height 0.2s ease, opacity 0.2s ease, margin 0.2s ease;
      will-change: height, opacity;
    }
    
    #lyrics-window.lyrics-hidden {
      height: 0 !important;
      opacity: 0;
      margin: 0;
      overflow: hidden;
      pointer-events: none;
    }
    
    #lyrics-window.lyrics-normal {
      height: 8.5em;
    }
    
    #lyrics-window.lyrics-expanded {
      height: 15.3em;
    }
    
    .lyrics-scroll {
      position: relative;
      z-index: 1;
    }
    
    .lyrics-window-line {
      opacity: 0.57;
      font-size: 1.13em;
      transition: all 0.2s;
      line-height: 1.7em;
      text-align: center;
      min-height: 1.7em;
      max-width: 97%;
      margin: 0 auto;
      color: #eee;
      white-space: pre-line;
      user-select: none;
      word-break: break-word;
      position: relative;
      z-index: 1;
    }
    
    .lyrics-window-line.active {
      color: var(--primary-color);
      font-weight: bold;
      opacity: 1;
      text-shadow: 0 1px 7px #73161644;
      background: rgba(0,0,0,0.07);
      border-radius: 8px;
      font-size: 1.19em;
    }
         
    /* ==================== –ê–ù–ò–ú–ê–¶–ò–Ø –õ–ò–†–ò–ö–ò –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø ==================== */
    /* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω –ª–∏—Ä–∏–∫–∏ */
    .lyrics-animated-bg {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      opacity: 0;
      background: linear-gradient(45deg, 
        rgba(232,1,0,0.15), 
        rgba(77,170,255,0.15), 
        rgba(232,1,0,0.15));
      background-size: 400% 400%;
      animation: none;
      z-index: 0;
      pointer-events: none;
      transition: opacity 0.5s;
    }

    .lyrics-animated-bg.active {
      opacity: 1;
      animation: lyricsGradient 10s ease infinite;
    }

    @keyframes lyricsGradient {
      0% { 
        background-position: 0% 50%;
        filter: hue-rotate(0deg);
      }
      50% { 
        background-position: 100% 50%;
        filter: hue-rotate(30deg);
      }
      100% { 
        background-position: 0% 50%;
        filter: hue-rotate(0deg);
      }
    }

    /* –£–±—Ä–∞–Ω–∞ –∞–Ω–∏–º–∞—Ü–∏—è transform –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –ª–∏—Ä–∏–∫–∏ */
    #lyrics-window.animation-active .lyrics-window-line {
      transition: opacity 0.3s ease;
    }

    #lyrics-window.animation-active .lyrics-window-line.active {
      /* –¢–æ–ª—å–∫–æ —ç—Ñ—Ñ–µ–∫—Ç —Å–≤–µ—á–µ–Ω–∏—è, –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ */
      animation: lyricsGlow 2s ease-in-out infinite; /* –£–≤–µ–ª–∏—á–µ–Ω–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ */
    }

    @keyframes lyricsGlow {
      0%, 100% { 
        opacity: 1;
      }
      50% { 
        opacity: 1;
      }
    }
    /* ==================== –ö–û–ù–ï–¶ –ê–ù–ò–ú–ê–¶–ò–ò –õ–ò–†–ò–ö–ò ==================== */
    
    .audio-wrapper {
      width: 100%;
      max-width: 395px;
      margin: 0 auto;
    }
    
    /* –°–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π –ø–ª–µ–µ—Ä */
    #audio {
      position: absolute;
      width: 1px;
      height: 1px;
      opacity: 0;
      pointer-events: none;
    }
    
    /* –ö–æ–Ω—Ç—Ä–æ–ª—ã –ø–ª–µ–µ—Ä–∞ - –û–ë–ù–û–í–õ–ï–ù–û –î–õ–Ø 2 –†–Ø–î–û–í */
    .player-controls {
      display: flex;
      flex-direction: column;
      gap: 5px; /* –£–ú–ï–ù–¨–®–ï–ù–û: –±—ã–ª–æ 8px */
      margin: 5px 0; /* –£–ú–ï–ù–¨–®–ï–ù–û: –±—ã–ª–æ 10px 0 */
      padding: 8px 10px; /* –£–ú–ï–ù–¨–®–ï–ù–û: –±—ã–ª–æ 10px */
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
    }
    
    .player-controls-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    
    .player-control-btn {
      background: none;
      border: none;
      color: var(--secondary-color);
      cursor: pointer;
      padding: 4px; /* –£–ú–ï–ù–¨–®–ï–ù–û */
      border-radius: 50%;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px; /* –£–ú–ï–ù–¨–®–ï–ù–û –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ —Ä—è–¥–∞ */
      height: 32px; /* –£–ú–ï–ù–¨–®–ï–ù–û –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ —Ä—è–¥–∞ */
      font-weight: bold;
      font-size: 16px; /* –£–ú–ï–ù–¨–®–ï–ù–û */
      position: relative;
    }
    
    /* –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–≤–æ–≥–æ —Ä—è–¥–∞ - –∫—Ä—É–ø–Ω–µ–µ */
    .player-controls-row:first-child .player-control-btn {
      width: 48px; /* –ö—Ä—É–ø–Ω–µ–µ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —Ä—è–¥–∞ */
      height: 48px;
      padding: 8px;
    }
    
    .player-controls-row:first-child .player-control-btn svg {
      width: 28px;
      height: 28px;
    }
    
    /* –ö–Ω–æ–ø–∫–∏ –≤—Ç–æ—Ä–æ–≥–æ —Ä—è–¥–∞ - –º–µ–ª—å—á–µ */
    .player-controls-row:last-child .player-control-btn svg {
      width: 20px;
      height: 20px;
    }
    
    .player-controls-row:last-child .player-control-btn {
      font-size: 16px;
    }
    
    .player-control-btn:hover {
      background: rgba(77, 170, 255, 0.2);
      transform: scale(1.1);
    }
    
    .player-control-btn:active {
      transform: scale(0.95);
    }
    
    .player-control-btn.active {
      color: var(--primary-color);
      background: rgba(232, 1, 0, 0.2);
    }
    
    .player-control-btn.repeat-active {
      color: var(--primary-color);
      background: rgba(232, 1, 0, 0.2);
    }
    
    .player-control-btn.favorites-active {
      background: rgba(255, 215, 0, 0.3);
    }
    
    /* –ö–Ω–æ–ø–∫–∏ Animation –∏ Bit */
    .player-control-btn.animation-btn,
    .player-control-btn.bit-btn {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 22px;
      font-weight: bold;
    }
    
    .player-control-btn.animation-active,
    .player-control-btn.bit-active {
      color: var(--primary-color);
      background: rgba(232, 1, 0, 0.2);
    }
    
    .player-control-btn svg {
      width: 24px;
      height: 24px;
    }
    
    .player-control-btn.main {
      width: 54px;
      height: 54px;
    }
    
    .player-control-btn.main svg {
      width: 30px;
      height: 30px;
    }
    
    .player-control-btn img {
      width: 22px;
      height: 22px;
      filter: none;
    }
    
    .player-control-btn.favorites-active img {
      filter: drop-shadow(0 0 4px gold);
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .player-control-btn.repeat-active svg,
    .player-control-btn.favorites-active img {
      animation: pulse 2s infinite;
    }
    /* –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä –¥–ª—è —Ç—Ä–µ–∫–∞ */
    .player-progress-wrapper {
      width: 100%;
      margin: 3px 0 5px 0; /* –£–ú–ï–ù–¨–®–ï–ù–û: –±—ã–ª–æ 10px 0 */
      position: relative;
    }

    .player-progress-bar {
      width: 100%;
      height: 6px; /* –ò–°–ü–†–ê–í–õ–ï–ù–û: –±—ã–ª–æ 40px, —Ç–µ–ø–µ—Ä—å 6px –∫–∞–∫ —É –≥—Ä–æ–º–∫–æ—Å—Ç–∏ */
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px; /* –ò–°–ü–†–ê–í–õ–ï–ù–û: –±—ã–ª–æ 20px */
      position: relative;
      cursor: pointer;
      overflow: visible; /* –ò–∑–º–µ–Ω–µ–Ω–æ –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Ä—É—á–∫–∏ */
    }

    .player-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      width: 0%;
      transition: width 0.1s linear;
      border-radius: 3px;
      position: relative;
    }

    .player-progress-handle {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      background: #fff;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      right: -10px;
      z-index: 2;
    }

    /* –¢–∞–π–º–µ—Ä –≤—Ä–µ–º–µ–Ω–∏ - –£–ë–ò–†–ê–ï–ú –û–¢–î–ï–õ–¨–ù–£–Æ –°–¢–†–û–ö–£ */
    .player-time-display {
      display: none !important; /* –°–∫—Ä—ã–≤–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É –≤—Ä–µ–º–µ–Ω–∏ */
    }
    
    /* –í—Ä–µ–º—è –≤ –∫–æ–Ω—Ç—Ä–æ–ª–∞—Ö –ø–ª–µ–µ—Ä–∞ */
    .time-in-controls {
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 13px;
      color: var(--secondary-color);
      min-width: 45px;
      text-align: center;
      user-select: none;
    }

        /* –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≥—Ä–æ–º–∫–æ—Å—Ç–∏ */
    .volume-control-wrapper {
      width: 100%;
      margin: 5px 0;
      padding: 0 10px;
    }

    .volume-header {
      display: none !important;
    }

    .volume-icon {
      width: 24px;
      height: 24px;
      cursor: pointer;
      opacity: 0.8;
      transition: opacity 0.2s;
    }

    .volume-icon:hover {
      opacity: 1;
    }

    .volume-icon svg {
      width: 100%;
      height: 100%;
      fill: var(--secondary-color);
    }

    .volume-percentage {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      min-width: 35px;
      text-align: right;
    }

        .volume-slider-container {
      width: 100%;
      height: 20px;
      position: relative;
    }

    .volume-slider {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 20px;
      background: transparent;
      outline: none;
      cursor: pointer;
      position: relative;
      z-index: 2;
    }

        .volume-track {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
      pointer-events: none;
    }

    .volume-fill {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      height: 6px;
      background: var(--secondary-color);
      border-radius: 3px;
      pointer-events: none;
      transition: width 0.1s;
    }

    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: #fff;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .volume-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: #fff;
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    /* Sleep —Ç–∞–π–º–µ—Ä */
    .sleep-timer-btn {
      background: none;
      border: none;
      color: var(--secondary-color);
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      position: relative;
    }

    .sleep-timer-btn:hover {
      background: rgba(77, 170, 255, 0.2);
      transform: scale(1.1);
    }

    .sleep-timer-btn.active {
      color: var(--primary-color);
      background: rgba(232, 1, 0, 0.2);
    }

    .sleep-timer-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      background: var(--primary-color);
      color: white;
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 10px;
      font-weight: bold;
      min-width: 20px;
      text-align: center;
    }

    /* Sleep –º–µ–Ω—é */
    .sleep-menu {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--modal-bg);
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 100;
      min-width: 150px;
      display: none;
    }

    .sleep-menu.active {
      display: block;
      animation: slideUp 0.2s;
    }

    .sleep-menu-item {
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 6px;
      transition: background 0.2s;
      white-space: nowrap;
      color: var(--text-color);
    }

    .sleep-menu-item:hover {
      background: rgba(255,255,255,0.1);
    }

    .sleep-menu-item.active {
      background: var(--primary-color);
      color: white;
    }

    /* Sleep –æ–≤–µ—Ä–ª–µ–π */
    .sleep-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .sleep-overlay.active {
      display: flex;
      animation: fadeIn 0.5s;
    }

    .sleep-content {
      text-align: center;
      padding: 40px;
      max-width: 400px;
    }

    .sleep-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .sleep-title {
      font-size: 24px;
      margin-bottom: 10px;
      color: var(--text-color);
    }

    .sleep-message {
      color: rgba(255,255,255,0.6);
      margin-bottom: 30px;
    }

    .sleep-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .sleep-btn {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: opacity 0.2s;
    }

    .sleep-btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .sleep-btn-secondary {
      background: rgba(255,255,255,0.1);
      color: var(--text-color);
    }

    .sleep-btn:hover {
      opacity: 0.8;
    }

    /* –ö–Ω–æ–ø–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–∏—Ä–∏–∫–æ–π */
    .lyrics-toggle-btn {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 44px;
      height: 44px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: bold;
      transition: all 0.2s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      z-index: 5;
    }

    /* –í–∏–∑—É–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å –∫–Ω–æ–ø–∫–∏ */
    .lyrics-toggle-btn-visual {
      font-size: 36px;
      line-height: 1;
      transition: all 0.2s ease;
      pointer-events: none;
    }

    /* –°–æ—Å—Ç–æ—è–Ω–∏–µ normal - —Å–∏–Ω—è—è, –±–æ–ª—å—à–∞—è */
    .lyrics-toggle-btn.lyrics-normal .lyrics-toggle-btn-visual {
      color: var(--secondary-color);
      font-size: 36px;
    }

    /* –°–æ—Å—Ç–æ—è–Ω–∏–µ hidden - –∫—Ä–∞—Å–Ω–∞—è, –±–æ–ª—å—à–∞—è */
    .lyrics-toggle-btn.lyrics-hidden .lyrics-toggle-btn-visual {
      color: var(--primary-color);
      font-size: 36px;
    }

    /* –°–æ—Å—Ç–æ—è–Ω–∏–µ expanded - —Å–∏–Ω—è—è, –º–∞–ª–µ–Ω—å–∫–∞—è */
    .lyrics-toggle-btn.lyrics-expanded .lyrics-toggle-btn-visual {
      color: var(--secondary-color);
      font-size: 20px;
    }

    /* Hover —ç—Ñ—Ñ–µ–∫—Ç—ã */
    .lyrics-toggle-btn:hover .lyrics-toggle-btn-visual {
      transform: scale(1.1);
    }

    .lyrics-toggle-btn:active .lyrics-toggle-btn-visual {
      transform: scale(0.95);
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Å –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º */
    .player-buttons-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 9px;
      margin-top: 10px;
      width: 100%;
      position: relative;
    }
    
    .karaoke-btn, .player-download-btn {
      color: var(--secondary-color) !important;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1em;
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 0.02em;
      text-decoration: underline;
      transition: all 0.18s;
      padding: 4px 16px;
      min-width: 148px;
      text-align: center;
      border-radius: 7px;
      display: block;
      margin: 0 auto;
    }
    
    .karaoke-btn:hover, .player-download-btn:hover {
      color: #fff !important;
      background: #273050;
    }
    
    .bottom-controls-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 32px auto 0 auto;
      gap: 8px;
      width: 100%;
      max-width: 280px;
      padding-bottom: env(safe-area-inset-bottom);
    }
    
    /* –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ö–Ω–æ–ø–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö */
    .filter-favorites-btn {
      display: block;
      margin: 0 auto 15px auto;
      padding: 10px 20px;
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      color: var(--secondary-color);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      font-size: 0.95em; /* –ò–°–ü–†–ê–í–õ–ï–ù–û: —É–º–µ–Ω—å—à–µ–Ω —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      min-width: 100%; /* –ò–°–ü–†–ê–í–õ–ï–ù–û: —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
      white-space: nowrap; /* –ò–°–ü–†–ê–í–õ–ï–ù–û: –∑–∞–ø—Ä–µ—â–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å */
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .filter-favorites-btn:hover {
      background: linear-gradient(135deg, #3a3a3a, #2a2a2a);
      border-color: var(--secondary-color);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    
    .filter-favorites-btn.filtered {
      background: linear-gradient(135deg, #4a1a1a, #2a0a0a);
      border-color: var(--primary-color);
      color: #fff;
      animation: pulseRed 20s infinite;
    }
    
    @keyframes pulseRed {
      0%, 94.5% { 
        border-color: var(--primary-color);
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        background: linear-gradient(135deg, #4a1a1a, #2a0a0a);
      }
      95%, 95.5%, 96%, 96.5%, 97%, 97.5% { 
        border-color: #ff0000;
        box-shadow: 0 0 25px rgba(232,1,0,1);
        transform: scale(1.05);
        background: linear-gradient(135deg, #ff0000, #8a0000);
      }
      95.25%, 95.75%, 96.25%, 96.75%, 97.25%, 97.75% {
        border-color: var(--primary-color);
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        transform: scale(1);
        background: linear-gradient(135deg, #4a1a1a, #2a0a0a);
      }
      100% {
        border-color: var(--primary-color);
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        background: linear-gradient(135deg, #4a1a1a, #2a0a0a);
      }
    }
    
    /* –°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–≥–¥–∞ –Ω–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö */
    .no-favorites-message {
      text-align: center;
      padding: 30px;
      color: #888;
      font-size: 1.1em;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      margin: 20px;
    }
    
    .no-favorites-message .star-icon {
      font-size: 3em;
      margin-bottom: 10px;
      opacity: 0.5;
    }

    /* –ö–Ω–æ–ø–∫–∞ –ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò */
    .hotkeys-btn {
      color: var(--secondary-color) !important;
      text-decoration: underline !important;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      cursor: pointer;
      transition: color 0.18s;
      font-size: 1em;
      display: block;
      text-align: center;
      width: 100%;
      margin: 0;
      background: none;
      border: none;
      padding: 8px;
    }
    
    .hotkeys-btn:hover {
      color: #fff !important;
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à */
    .hotkeys-modal {
      background: var(--modal-bg);
      border-radius: 14px;
      padding: 24px 20px;
      max-width: 450px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 32px #0009;
      position: relative;
      animation: slideUp 0.3s;
    }

    .hotkeys-modal h2 {
      font-size: 1.3em;
      margin-bottom: 20px;
      color: var(--primary-color);
      text-align: center;
    }

    .hotkeys-section {
      margin-bottom: 20px;
    }

    .hotkeys-section h3 {
      color: var(--secondary-color);
      font-size: 1.1em;
      margin-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 5px;
    }

    .hotkey-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      font-size: 0.95em;
    }

    .hotkey-combo {
      color: #fff;
      background: rgba(255,255,255,0.1);
      padding: 2px 8px;
      border-radius: 4px;
      font-family: 'SF Mono', Monaco, monospace;
      font-weight: bold;
      min-width: 50px;
      text-align: center;
    }

    .hotkey-desc {
      flex: 1;
      margin-left: 15px;
      color: rgba(255,255,255,0.8);
    }
    #install-pwa-btn, #download-album-main {
      color: #fff;
      background: var(--secondary-color);
      border: none;
      border-radius: 7px;
      font-size: 1.07em;
      font-weight: bold;
      letter-spacing: 0.02em;
      margin: 15px 0 5px 0;
      padding: 8px 13px;
      cursor: pointer;
      width: 98%;
      box-shadow: 0 4px 14px #0005;
      outline: none;
      transition: background 0.2s;
    }
    
    #download-album-main {
      background: var(--primary-color);
      font-size: 1.09em;
      margin-bottom: 8px;
    }
    
    #install-pwa-btn:hover { background: #3275c2; }
    #download-album-main:hover { background: #c60000; }
    
    .feedback-link, .support-link {
      color: var(--secondary-color) !important;
      text-decoration: underline !important;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      cursor: pointer;
      transition: color 0.18s;
      font-size: 1em;
      display: block;
      text-align: center;
      width: 100%;
      margin: 0;
    }
    
    .feedback-link:hover, .support-link:hover {
      color: #fff !important;
    }
    
    .offline-btn {
      min-width: 102px;
      height: 38px;
      font-size: 1.05em;
      font-weight: bold;
      border: none;
      border-radius: 9px;
      cursor: pointer;
      letter-spacing: 0.07em;
      box-shadow: 0 2px 8px #06000032;
      transition: background 0.2s, color 0.14s;
      display: block;
      margin: 0 auto;
    }
    
    .offline-btn.online { background: var(--primary-color); color: #fff; }
    .offline-btn.offline { background: #27b34c; color: #fff; }
    .offline-btn:active { opacity: 0.91; }
    .offline-btn:disabled { opacity: 0.7; cursor: not-allowed; }
    
    .offline-progress {
      margin-top: 11px;
      width: 100%;
      height: 8px;
      background: #222;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 1px 6px #222b;
    }
    
    .offline-progress-bar {
      height: 100%;
      background: #2fed54;
      transition: width 0.33s;
    }
    
    .offline-desc {
      text-align: center;
      font-size: 0.97em;
      margin-top: 5px;
      opacity: 0.85;
    }
    
    /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª–æ–∫ –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
    .download-modal-title {
      font-size: 1.12em;
      font-weight: 700;
      margin-bottom: 13px;
      text-align: center;
    }
    
    .checkbox-container {
      display: flex;
      align-items: center;
      margin: 12px 0;
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-left: 32px;
    }
    
    .checkbox-container input {
      position: absolute;
      opacity: 0;
      cursor: pointer;
      height: 0;
      width: 0;
    }
    
    .checkmark {
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      height: 20px;
      width: 20px;
      background-color: #2a2a2a;
      border: 2px solid #444;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .checkbox-container:hover input ~ .checkmark {
      background-color: #333;
      border-color: #555;
    }
    
    .checkbox-container input:checked ~ .checkmark {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }
    
    .checkmark:after {
      content: "";
      position: absolute;
      display: none;
      left: 6px;
      top: 2px;
      width: 5px;
      height: 10px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }
    
    .checkbox-container input:checked ~ .checkmark:after {
      display: block;
    }
    
    .checkbox-container input:disabled ~ .checkmark {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .progress-bar {
      width: 100%;
      height: 20px;
      background-color: #2a2a2a;
      border-radius: 10px;
      overflow: hidden;
      margin: 20px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), #ff4444);
      transition: width 0.3s ease;
      will-change: width;
    }
    
    .size-info {
      padding: 20px;
      background-color: #1f1f1f;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
    }
    
    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .btn-secondary, .btn-primary {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 7px;
      font-weight: bold;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    
    .btn-secondary {
      background: #444;
      color: #fff;
    }
    
    .btn-primary {
      background: var(--primary-color);
      color: #fff;
    }
    
    .btn-secondary:hover, .btn-primary:hover {
      opacity: 0.8;
    }
    
    /* –¢–æ—Å—Ç—ã –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #2a2a2a;
      border-radius: 12px;
      padding: 15px 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 9999;
      opacity: 0;
      transition: all 0.3s ease;
      max-width: 90%;
      word-wrap: break-word;
      pointer-events: none;
    }
    
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    
    .toast-content {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .toast-emoji {
      width: 24px;
      height: 24px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .toast-emoji img, .toast-emoji svg, .toast-emoji canvas {
      width: 24px;
      height: 24px;
      display: block;
      object-fit: contain;
    }

    .toast-info { border-left: 4px solid var(--secondary-color); }
    .toast-success { border-left: 4px solid #27b34c; }
    .toast-error { border-left: 4px solid var(--primary-color); }
    .toast-warning { border-left: 4px solid #ff9800; }
    .toast-offline { border-left: 4px solid #666; }
    
    /* iOS –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ */
    .ios-install-prompt {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #1a1a1a;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      padding: 20px;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      z-index: 10000;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
    }
    
    .ios-install-prompt.show {
      transform: translateY(0);
    }
    
    .ios-prompt-content {
      max-width: 400px;
      margin: 0 auto;
      text-align: center;
    }
    
    .ios-prompt-icon {
      width: 60px;
      height: 60px;
      margin-bottom: 15px;
    }
    
    .ios-share-icon {
      width: 20px;
      height: 20px;
      display: inline-block;
      vertical-align: middle;
      color: #007AFF;
    }
    
    .ios-prompt-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: #666;
      font-size: 28px;
      cursor: pointer;
    }
    
    .ios-prompt-button {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      font-weight: bold;
      margin-top: 20px;
      cursor: pointer;
    }
    
    /* iOS –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ */
    .ios-volume-notice {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 12px 20px;
      border-radius: 20px;
      font-size: 14px;
      z-index: 1000;
      display: none;
      max-width: 90%;
      text-align: center;
    }
    
    .ios-volume-notice.show {
      display: block;
      animation: slideUp 0.3s;
    }
    
    /* –£–ª—É—á—à–µ–Ω–∏–µ textarea */
    .real-textarea {
      width: 100%;
      min-height: 120px;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
      color: var(--text-color);
      font-size: 14px;
      resize: vertical;
    }
    
    .fake-textarea {
      padding: 15px;
      border: 1px dashed var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      color: #888;
      transition: all 0.2s;
    }
    
    .fake-textarea:hover {
      border-color: var(--secondary-color);
      color: #aaa;
    }
    
    .err-msg { color: #ff6b6b; margin-top: 10px; }
    .success-msg { color: #27b34c; margin-top: 10px; }

    /* Tooltip –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
    .tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      margin-bottom: 5px;
      z-index: 1000;
    }

    .player-control-btn:hover .tooltip {
      opacity: 1;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 600px) {
      .like-star { width: 16px; height: 16px; }
      .logo-bottom { max-width: 66vw; }
      .player-time-display { font-size: 12px; }
      .volume-control-wrapper { padding: 0 5px; }
      .sleep-menu {
        bottom: auto;
        top: 100%;
        margin-bottom: 0;
        margin-top: 10px;
      }
      .lyrics-toggle-btn {
        width: 48px;
        min-height: 48px;
      }
      .hotkeys-btn {
        display: none !important;
      }
    }
    
    @media (max-width: 420px) {
      .modal-feedback { padding: 13px 3vw; }
    }
    
    /* PWA —Ä–µ–∂–∏–º */
    @media (display-mode: standalone) {
      body {
        padding-top: env(safe-area-inset-top);
      }
      
      .bottom-controls-center {
        padding-bottom: calc(env(safe-area-inset-bottom) + 10px);
      }
    }

    /* –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    @media (hover: none) {
      .tooltip {
        display: none;
      }
    }

    /* ==== –ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π (–≠—Ç–∞–ø 1) ==== */
    /* ==== –ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π ‚Äî –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è ==== */

    /* —à–∏—Ä–∏–Ω–∞ –≤ –ª–∏–Ω–∏—é —Å lyrics –∏ –ø–ª–µ–µ—Ä–æ–º */
    .ach-progress-root{
      width:100%;
      max-width:395px;             /* –∫–∞–∫ .audio-wrapper */
      margin:12px auto 8px auto;
      padding:10px 12px;
      background: rgba(0,0,0,0.30);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.25);
      position: relative;
    }

    /* –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
    .ach-progress-header{
      display:flex;
      justify-content:center;      /* —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º */
      align-items:center;
      margin-bottom:8px;
    }
    .ach-progress-header.ach-center { justify-content:center; }

    .ach-progress-title{
      color:#fff;
      font-weight:800;
      letter-spacing:.06em;
      text-transform: uppercase;   /* –ö–ê–ü–° */
      font-size: .98em;
    }

    /* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–¥ —à–∫–∞–ª—É –∏ –ø–æ–¥–ø–∏—Å—å */
    .ach-progress-bars{ position:relative; padding-top:4px; }

    /* –æ–¥–Ω–∞ —à–∫–∞–ª–∞ */
    .ach-bar{
      position:relative;
      width:100%;
      background: rgba(255,255,255,0.10);
      border-radius:3px;
      overflow:hidden;
    }
    .ach-bar-single{ height:6px; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05); }

    /* –∑–∞–ª–∏–≤–∫–∞ */
    .ach-bar-fill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      transition: width 0.3s ease;
    }

    /* –ø–æ–¥–ø–∏—Å—å –í–´–ü–û–õ–ù–ï–ù–û: X / Y */
    .ach-done-label{
      margin-top:8px;
      width:100%;
      text-align:center;
      font-size:.88em;
      color: rgba(255,255,255,0.9);
      font-weight:800;
      letter-spacing:.04em;
      text-transform: uppercase;
    }
    /* –ö–Ω–æ–ø–∫–∏ –±—ç–∫–∞–ø–∞ –ø–æ–¥ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º */
    .ach-backup-controls{
      margin-top:10px;
      display:flex;
      gap:8px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .backup-btn{
      color:#fff;
      background: var(--secondary-color);
      border:none;
      border-radius:8px;
      font-weight:700;
      letter-spacing:.02em;
      padding:8px 12px;
      cursor:pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .backup-btn.secondary{
      background: #2a2a2a;
      color: rgba(255,255,255,0.9);
      border:1px solid var(--border-color);
    }
    .backup-btn:hover{ opacity:.9; }

    /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∏–¥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∞–≤—Ç–æ—Å–µ–π–≤–∞ –≤ –æ–±–ª–∞–∫–æ */
    .ach-progress-root.cloud-saved { 
      padding-bottom: 8px; 
      margin-bottom: 8px;
    }
    .ach-progress-root.cloud-saved .ach-backup-controls {
      display: none !important;
    }

    /* Anti‚Äëtamper –±–∞–Ω–Ω–µ—Ä –ø–æ–¥ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º */
    .tamper-banner{
      margin-top:10px;
      padding:10px 12px;
      background:#3a2424;
      border:1px solid #8a2a2a;
      border-radius:10px;
      color:#ffb3b3;
    }
    .tamper-banner .actions{
      display:flex;
      gap:8px;
      margin-top:8px;
      flex-wrap:wrap;
    }
    .tamper-banner button{
      border:none;
      border-radius:8px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:700;
    }
    .tamper-banner .primary{ background:#E80100; color:#fff; }
    .tamper-banner .secondary{
      background:#2a2a2a; color:#fff; border:1px solid #555;
    }

    /* bubble-–ø–æ–¥—Å–∫–∞–∑–∫–∞ ‚Äî –æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –±—ã–ª–æ */
    .socials-under-cover{ margin: 14px auto 8px auto; }
    .ach-hint-bubble{
      position: relative;
      right: auto; top: auto; transform: none;
      background: #1f2533;
      border:1px solid var(--border-color);
      color:#e9f0ff;
      padding:8px 10px;
      border-radius:10px;
      box-shadow:0 4px 20px rgba(0,0,0,0.35);
      font-size:.92em;
      max-width: 100%;
      margin-bottom: 10px;
      z-index: 1;
    }
    /* –ò–∫–æ–Ω–∫–∞ ‚ú®/üèÜ –≤ –ø–æ–¥—Å–∫–∞–∑–∫–µ bubble */
    .ach-hint-emoji {
      display: inline-block;
      width: 1.4em;
      height: 1.4em;
      vertical-align: middle;
      margin-right: .2em;
      margin-bottom: -.15em;
      animation: hint-emoji-bounce 1.5s cubic-bezier(.58,1.9,.3,1) infinite;
      will-change: transform;
    }
    @media (prefers-reduced-motion: reduce) {
      .ach-hint-emoji { animation: none; }
    }
    @keyframes hint-emoji-bounce {
      0%, 100% { transform: translateY(0) scale(1); filter: brightness(1);}
      28%  { transform: translateY(-8px) scale(1.08); filter: brightness(1.1);}
      35%  { filter: brightness(1.45);}
      55%  { filter: brightness(1.13);}
    }
    /* –ö–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç—å bubble –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–ø–∏—Å–∫–∞ –∞—á–∏–≤–æ–∫ */
    .ach-hint-bubble {
      cursor: pointer;
    }
    .ach-hint-bubble:hover {
      border-color: var(--secondary-color);
      box-shadow: 0 4px 24px rgba(77,170,255,0.25);
    }

    /* === –ú–æ–¥–∞–ª–∫–∞ ‚Äú–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π‚Äù === */
    .ach-modal { max-width: 420px; width: 96vw; max-height: 80vh; overflow: hidden; padding-bottom: 10px; }
    .ach-modal h2 { font-size: 1.12em; margin: 0 0 10px 0; text-align: center; color: var(--secondary-color); }

    .ach-tabs {
      display: flex; gap: 6px; justify-content: center; margin: 6px 0 10px 0; flex-wrap: wrap;
    }
    .ach-tab {
      border: 1px solid var(--border-color);
      background: #1e2431;
      color: #cfe3ff;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: .9em;
      cursor: pointer;
      user-select: none;
    }
    .ach-tab.active {
      background: var(--secondary-color);
      color: #fff;
      border-color: var(--secondary-color);
    }

    .ach-list-wrap {
      max-height: 60vh; overflow: auto;
      border-top: 1px solid rgba(255,255,255,0.06);
      padding-top: 6px;
    }
    .ach-group-title {
      font-weight: 800; letter-spacing: .04em; color: #9fc3ff; font-size: .9em;
      margin: 10px 4px 6px 4px; text-transform: uppercase;
    }

    .ach-item {
      display: grid; grid-template-columns: 28px 1fr auto; gap: 8px;
      padding: 10px 8px; margin: 4px 0;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      background: rgba(0,0,0,0.25);
    }
    .ach-item:hover { background: rgba(255,255,255,0.06); }
    .ach-item.done { opacity: .8; }
    .ach-status {
      width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center;
      font-size: 18px;
    }
    .ach-main { min-width: 0; }
    .ach-title { font-weight: 700; color:#fff; }
    .ach-sub { font-size: .86em; color: #9aa8c4; margin-top: 2px; }
    .ach-right { display: flex; align-items: center; gap: 6px; }

    .ach-mini-bar {
      width: 110px; height: 6px; background: rgba(255,255,255,0.10); border-radius: 3px; overflow: hidden;
    }
    .ach-mini-fill {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    }

    .ach-lock { color:#9aa8c4; font-size: .92em; }

    /* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É —É–∂–µ –µ—Å—Ç—å (.bigclose). –°–¥–µ–ª–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ª–∏–ø–∫–∏–º */
    .ach-modal .sticky-head {
      position: sticky; top: 0; background: var(--modal-bg); padding-top: 10px; z-index: 1;
    }

    /* === –ü–†–ò–ó–´ (–ø–∞–Ω–µ–ª—å) === */
    .prize-root{
      width:100%;
      max-width:395px;
      margin:8px auto 0 auto;
      background: rgba(0,0,0,0.30);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.25);
      overflow: hidden;
    }
    .prize-header{
      width: 100%;
      background: #1f2533;
      color: #e9f0ff;
      border: none;
      text-align: center;
      font-weight: 800;
      letter-spacing: .06em;
      text-transform: uppercase;
      font-size: .98em;
      padding: 10px 12px;
      display:flex; align-items:center; justify-content:center; gap:8px;
    }
    .prize-body{ padding: 10px 12px 12px 12px; }
    .prize-row{ display:flex; gap:8px; align-items:center; margin:6px 0; }
    .prize-row .ok{ color:#27b34c; }
    .prize-row .warn{ color:#ff9800; }
    .prize-row .err{ color:#E80100; }
    .prize-actions{ display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:10px; }
    .prize-btn{
      color:#fff; background: var(--secondary-color); border:none; border-radius:8px; font-weight:700;
      letter-spacing:.02em; padding:8px 12px; cursor:pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .prize-btn.primary{ background: var(--primary-color); }
    .prize-btn:disabled{ opacity:.6; cursor:not-allowed; }
    .tg-holder{ display:flex; justify-content:center; margin:10px 0; }
    .prize-status{
      margin-top:10px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08);
      border-radius:10px; padding:10px;
    }
    .prize-status h4{ margin:0 0 8px 0; font-size: .98em; color:#9fc3ff; text-transform:uppercase; }
    .prize-status ul{ list-style:none; padding:0; margin:0; }
    .prize-status li{ display:flex; justify-content:space-between; gap:10px; padding:6px 0;
      border-bottom: 1px dashed rgba(255,255,255,0.08); font-size:.96em; }
    .prize-status li:last-child{ border-bottom:none; }
    .prize-note{ font-size:.88em; color:#9aa8c4; margin-top:8px; text-align:center; }
    .prize-ready{ text-align:center; font-weight:800; color:#27b34c; margin-top:6px; }
    .prize-not-ready{ text-align:center; font-weight:800; color:#E80100; margin-top:6px; }
    .pill{
      display:inline-block; padding:2px 8px; border-radius:999px;
      border:1px solid #2b3955; background:#1e2638; color:#cfe3ff;
      font-size:.85em; margin-left:6px;
    }
    /* === –ì–∞–ª–µ—Ä–µ—è –ø—Ä–∏–∑–æ–≤ (4 –∏–∫–æ–Ω–∫–∏ –≤ —Ä—è–¥, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ø–æ –∫–ª–∏–∫—É) === */
    .prize-gallery {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr)); /* –í—Å–µ–≥–¥–∞ 4 –∫–æ–ª–æ–Ω–∫–∏ */
      gap: 6px;
      margin-bottom: 6px;
    }
    /* –£–¥–∞–ª—è–µ–º –º–µ–¥–∏–∞–ø—Ä–∞–≤–∏–ª–æ –Ω–∞ 3 –∫–æ–ª–æ–Ω–∫–∏ ‚Äî –≤—Å–µ–≥–¥–∞ 4, –∏–∫–æ–Ω–∫–∏ –ø—Ä–æ—Å—Ç–æ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –º–µ–Ω—å—à–µ */
    .prize-thumb {
      width: 100%;
      aspect-ratio: 1/1;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: rgba(255,255,255,0.06);
      object-fit: cover;
      cursor: pointer;
      transition: transform .15s ease;
    }
    .prize-thumb:hover { transform: scale(1.03); }
    .prize-thumb.expanded {
      grid-column: 1 / -1;
      width: 100%;
      max-width: 395px;     /* —à–∏—Ä–∏–Ω–∞ –∫–∞–∫ —É –ø–ª–µ–µ—Ä–∞ */
      justify-self: center;
    }

    /* –°–ø–∏—Å–æ–∫ –ø—Ä–∏–∑–æ–≤ –≤ –º–æ–¥–∞–ª–∫–µ */
    .prize-list-card { display: grid; gap: 8px; }
    .prize-card {
      display: grid; grid-template-columns: 72px 1fr auto; gap: 10px;
      padding: 8px; border:1px solid rgba(255,255,255,0.08);
      border-radius: 10px; background: rgba(0,0,0,0.25);
      align-items: center;
    }
    .prize-card img { width: 72px; height: 72px; border-radius: 8px; object-fit: cover; }
    .prize-card .title { font-weight: 800; color: #fff; }
    .prize-card .sub   { font-size: .9em; color: #9aa8c4; }
    .prize-card .choose { white-space: nowrap; }

    /* –î–µ—Ç–∞–ª–∏ –ø—Ä–∏–∑–∞ –≤ –º–æ–¥–∞–ª–∫–µ */
    .prize-detail-img {
      width: 100%; max-width: 395px; border-radius: 10px; margin-bottom: 10px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    /* –ü–æ–ª—è —Ñ–æ—Ä–º –¥–æ—Å—Ç–∞–≤–∫–∏ */
    .form-row { display: grid; gap: 6px; margin: 8px 0; }
    .form-row label { font-size: .9em; color:#9aa8c4; }

    /* === –ú–û–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê === */
    .my-stats-root {
      width: 100%;
      max-width: 395px;
      margin: 4px auto 0 auto;
      background: rgba(0,0,0,0.30);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.25);
      overflow: hidden;
    }
    .my-stats-header {
      width: 100%;
      background: #1f2533;
      color: #e9f0ff;
      border: none;
      text-align: center;
      font-weight: 800;
      letter-spacing: .06em;
      text-transform: uppercase;
      font-size: .98em;
      padding: 10px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .my-stats-header .chev { transition: transform .2s ease; }
    .my-stats-header[aria-expanded="true"] .chev { transform: rotate(180deg); }

    .my-stats-body {
      padding: 10px 12px 12px 12px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 10px;
    }
    @media (max-width: 380px) { .stats-grid { grid-template-columns: 1fr; } }

    .stat-card {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 10px;
    }
    .stat-title {
      font-size: .86em;
      color: #9aa8c4;
      margin-bottom: 6px;
    }
    .stat-value {
      font-weight: 800;
      color: #fff;
      font-size: 1.1em;
    }

    .stat-list {
      margin: 8px 0 12px 0;
      padding: 0;
      list-style: none;
    }
    .stat-list li {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      padding: 6px 0;
      border-bottom: 1px dashed rgba(255,255,255,0.08);
      font-size: .96em;
    }
    .stat-list li:last-child { border-bottom: none; }

    .chart-block { margin: 12px 0; }
    .chart-title {
      font-weight: 800;
      font-size: .92em;
      color: #9fc3ff;
      text-transform: uppercase;
      margin-bottom: 6px;
    }
    .chart-bars {
      display: grid;
      gap: 4px;
    }
    .chart-row {
      display: grid;
      grid-template-columns: 26px 1fr 40px;
      align-items: center;
      gap: 6px;
    }
    .chart-row .label {
      color: #9aa8c4;
      font-size: .86em;
      text-align: right;
    }
    .chart-row .bar {
      height: 8px;
      background: rgba(255,255,255,0.10);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    .chart-row .fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    }
    .chart-row .val {
      color: rgba(255,255,255,0.8);
      font-size: .86em;
      text-align: right;
    }

    /* –æ–±—â–∏–π –º–µ–ª–∫–∏–π —Ñ–∏–∫—Å */
    .track .track-title { text-align: left; }
    .ach-last-earn{ margin-top:8px; display:flex; gap:8px; min-height:0; }
    @media (max-width:600px){ .ach-hint-bubble{ font-size:.86em; } }
  </style>
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
</head>
<body>
  <div id="promocode-block">
    <div class="promo-inner">
      <img class="promo-cover" src="Cover.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false"/>
      <h2>–í—Ö–æ–¥ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É</h2>
      <input id="promo-inp" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" autocomplete="off" autofocus disabled />
      <button id="promo-btn" onclick="checkPromo()" disabled>–í–æ–π—Ç–∏</button>
      <div id="promo-error"></div>
    </div>
  </div>
  
  <div id="main-block" class="hidden">
    <header>
      <div id="cover-wrap">
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-left" title="–ù–∞–∑–∞–¥" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è –æ–±–ª–æ–∂–∫–∞">
          <svg width="34" height="34" viewBox="0 0 34 34">
            <circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/>
            <polyline points="20,10 13,17 20,24" fill="none" stroke="#fff" stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <img id="cover" src="Cover.png" alt="–û–±–ª–æ–∂–∫–∞ –∞–ª—å–±–æ–º–∞" draggable="false"/>
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-right" title="–í–ø–µ—Ä—ë–¥" aria-label="–°–ª–µ–¥—É—é—â–∞—è –æ–±–ª–æ–∂–∫–∞">
          <svg width="34" height="34" viewBox="0 0 34 34">
            <circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/>
            <polyline points="14,10 21,17 14,24" fill="none" stroke="#fff" stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      <div id="social-links" class="socials-under-cover"></div>

      <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π -->
      <div id="ach-progress-root" class="ach-progress-root" aria-live="polite">
        <!-- –ø–æ–¥—Å–∫–∞–∑–∫–∞ —Å—Ä–∞–∑—É –ø–æ–¥ —Å–æ—Ü–±–ª–æ–∫–æ–º -->
        <!-- –û–°–¢–ê–í–ò–¢–¨ bubble —Å—Ä–∞–∑—É –ø–æ–¥ —Å–æ—Ü–±–ª–æ–∫–æ–º (–Ω–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è—Ç—å, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –µ—Å—Ç—å) -->
        <div class="ach-hint-bubble" id="ach-hint-bubble" role="status">
          ‚ú® –ú—ã –≥–æ—Ç–æ–≤–∏–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è. –°–ª—É—à–∞–π—Ç–µ ‚Äî –ø—Ä–æ–≥—Ä–µ—Å—Å —É–∂–µ –∫–æ–ø–∏—Ç—Å—è.
        </div>

        <!-- –ù–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ —Ü–µ–Ω—Ç—Ä—É –∏ –ö–ê–ü–°–û–ú -->
        <div class="ach-progress-header ach-center">
          <span class="ach-progress-title">–ü–†–û–ì–†–ï–°–° –î–û–°–¢–ò–ñ–ï–ù–ò–ô</span>
        </div>

        <!-- –û–î–ù–ê —à–∫–∞–ª–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ + –ø–æ–¥–ø–∏—Å—å –í–´–ü–û–õ–ù–ï–ù–û: X / Y -->
        <div class="ach-progress-bars">
          <div class="ach-bar ach-bar-single">
            <div class="ach-bar-fill" id="ach-one-fill" style="width:0%"></div>
          </div>
          <div class="ach-done-label" id="ach-done-label">–í–´–ü–û–õ–ù–ï–ù–û: 0 / 34</div>
          <!-- –ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞-—Å—á—ë—Ç—á–∏–∫ —Å–µ–∫—Ä–µ—Ç–Ω—ã—Ö (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ —ç—Ç–∞–ø–∞) -->
          <div class="ach-done-label" id="ach-secret-label" style="display:none;">–°–ï–ö–†–ï–¢–ù–´–ï: 0 / 0</div>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ -->
        <div class="ach-backup-controls" id="ach-backup-controls">
          <button class="backup-btn" id="backup-export-btn" type="button">–°–û–•–†–ê–ù–ò–¢–¨ –î–û–°–¢–ò–ñ–ï–ù–ò–Ø</button>
          <input type="file" id="backup-file-input" accept="application/json" hidden />
        </div>

        <!-- Anti‚Äëtamper –±–∞–Ω–Ω–µ—Ä (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div id="tamper-banner" class="tamper-banner hidden" role="alert" aria-live="assertive">
          <div style="font-weight:800; letter-spacing:.04em; text-transform:uppercase;">–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö</div>
          <div style="margin-top:6px; color:#ffd1d1;">
            –î–ª—è —É—á–∞—Å—Ç–∏—è –≤ –ø—Ä–∏–∑–∞—Ö –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤–∞–ª–∏–¥–Ω—ã–π –±—ç–∫–∞–ø, –∏–Ω–∞—á–µ –ø—Ä–æ–≥—Ä–µ—Å—Å –º–æ–∂–µ—Ç –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—Ç—å—Å—è.
          </div>
          <div class="actions">
            <button class="primary" type="button" onclick="openBackupActions()">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</button>
            <button class="secondary" type="button" onclick="NotificationSystem.info('–û—Ç–∫—Ä–æ–π—Ç–µ –º–µ–Ω—é ¬´–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π¬ª, —á—Ç–æ–±—ã –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∞—à —Ñ–∞–π–ª –±—ç–∫–∞–ø–∞');">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
          </div>
        </div>

        <div class="ach-last-earn" id="ach-last-earn" aria-hidden="true"></div>

      </div>
    </header>

  <div class="track-list" id="track-list"></div>
    
    <div class="bottom-controls-center">
      <!-- –ö–ù–û–ü–ö–ê –§–ò–õ–¨–¢–†–ê –ù–ê–î –õ–û–ì–û–¢–ò–ü–û–ú -->
      <button class="filter-favorites-btn" id="filter-favorites-btn" onclick="toggleFavoritesFilter()">
        –°–∫—Ä—ã—Ç—å –Ω–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ ‚≠ê –ø–µ—Å–Ω–∏
      </button>
      
      <!-- –õ–û–ì–û–¢–ò–ü –ü–û–î –ö–ù–û–ü–ö–û–ô -->
      <img class="logo-bottom" id="logo-bottom" src="img/logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø" onclick="handleLogoClick()"/>
      
      <!-- –û–°–¢–ê–õ–¨–ù–´–ï –ö–ù–û–ü–ö–ò -->
      <button id="install-pwa-btn" style="display: none;">–£–°–¢–ê–ù–û–í–ò–¢–¨ –ö–ê–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–ï</button>
      <button id="download-album-main" onclick="openAlbumDownloadModal()">–°–ö–ê–ß–ê–¢–¨ –í–ï–°–¨ –ê–õ–¨–ë–û–ú</button>

      <!-- –ú–û–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
      <div id="my-stats-root" class="my-stats-root">
        <button class="my-stats-header" id="my-stats-toggle" type="button" aria-expanded="false">
          –ú–û–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê
          <span class="chev" aria-hidden="true">‚ñº</span>
        </button>
        <div class="my-stats-body" id="my-stats-body" hidden>
          <!-- –°—é–¥–∞ –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç—Å—è –∫–æ–Ω—Ç–µ–Ω—Ç -->
        </div>
      </div>

      <!-- –ü–†–ò–ó–´ -->
      <div id="prize-root" class="prize-root">
        <div class="prize-header">–ü–†–ò–ó–´</div>
        <div class="prize-body" id="prize-body">
          <!-- –ó–¥–µ—Å—å –æ—Ç—Ä–∏—Å—É–µ—Ç—Å—è –ø–∞–Ω–µ–ª—å: –≤—Ö–æ–¥, —á–µ–∫-–ª–∏—Å—Ç, –∑–∞—è–≤–∫–∞, —Å—Ç–∞—Ç—É—Å—ã -->
        </div>
      </div>

      <!-- –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
      <div id="global-stats-root" class="my-stats-root" style="margin-top:8px;">
        <button class="my-stats-header" id="global-stats-toggle" type="button" aria-expanded="false">
          –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê
          <span class="chev" aria-hidden="true">‚ñº</span>
        </button>
        <div class="my-stats-body" id="global-stats-body" hidden>
          <div class="ach-group-title" style="margin:4px;">–ü–µ—Ä–∏–æ–¥</div>
          <div class="ach-tabs" style="margin-top:2px;">
            <button class="ach-tab active" data-period="all" id="gs-tab-all">–í—Å–µ–≥–æ</button>
            <button class="ach-tab" data-period="today" id="gs-tab-today">–°–µ–≥–æ–¥–Ω—è</button>
            <button class="ach-tab" data-period="week" id="gs-tab-week">–ù–µ–¥–µ–ª—è</button>
            <button class="ach-tab" data-period="month" id="gs-tab-month">–ú–µ—Å—è—Ü</button>
          </div>

          <div class="stat-card" id="gs-error" style="display:none; border-color:#8a2a2a; color:#ffb3b3;">
            –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.
          </div>

          <div class="stat-card">
            <div class="stat-title">–¢–æ–ø‚Äë5 —Ç—Ä–µ–∫–æ–≤ –ø–æ —á–∏—Å–ª—É —Å–ª—É—à–∞—Ç–µ–ª–µ–π</div>
            <ul class="stat-list" id="gs-top-listens"></ul>
          </div>

          <div class="stat-card">
            <div class="stat-title">–¢–æ–ø‚Äë5 –ø–æ —Å—É–º–º–∞—Ä–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ (–º–∏–Ω)</div>
            <ul class="stat-list" id="gs-top-time"></ul>
          </div>

          <div class="stat-card">
            <div class="stat-title">–¢–æ–ø –≥–æ—Ä–æ–¥–æ–≤ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)</div>
            <ul class="stat-list" id="gs-top-cities"></ul>
          </div>

          <div class="stat-card">
            <div class="stat-title">–¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ø–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è–º)</div>
            <ul class="stat-list" id="gs-top-users"></ul>
          </div>

          <div class="chart-block" id="gs-hours">
            <div class="chart-title" style="cursor:pointer;" id="gs-hours-toggle">–ü–æ —á–∞—Å–∞–º —Å—É—Ç–æ–∫</div>
            <div class="chart-bars" id="gs-hours-bars" style="display:none;"></div>
          </div>

          <div class="chart-block" id="gs-week">
            <div class="chart-title" style="cursor:pointer;" id="gs-week-toggle">–ü–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</div>
            <div class="chart-bars" id="gs-week-bars" style="display:none;"></div>
          </div>

          <div class="chart-block">
            <div class="chart-title">–û–±–Ω–æ–≤–ª–µ–Ω–æ</div>
            <div id="gs-updated" style="color:#9aa8c4; font-size:.9em;">‚Äî</div>
          </div>
        </div>
      </div>

      <!-- –ö–ù–û–ü–ö–ò –ù–ò–ñ–ï –í–ù–ï –ì–õ–û–ë–ê–õ–¨–ù–û–ô –°–¢–ê–¢–ò–°–¢–ò–ö–ò -->
      <button class="hotkeys-btn" id="hotkeys-btn" style="display:none;" onclick="showHotkeysModal()">–ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò</button>
      <span class="feedback-link" id="feedback-link">–û–ë–†–ê–¢–ù–ê–Ø –°–í–Ø–ó–¨</span>
      <a class="support-link" id="support-link" href="#" target="_blank">–ü–û–î–î–ï–†–ñ–ê–¢–¨</a>
      <button class="offline-btn online" id="offline-btn" onclick="offlineUIClick()">ONLINE</button>
    </div>
  </div>
  <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
  <div class="modal-bg" id="modal-feedback">
    <div class="modal-feedback" style="max-width:420px;">
      <button class="bigclose" onclick="closeFeedbackModal()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48">
          <line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          <line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
        </svg>
      </button>
      <div class="download-modal-title">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</div>
      <div id="fb-list" style="height:260px;overflow:auto;background:rgba(0,0,0,.2);border:1px solid #333;border-radius:8px;padding:8px;"></div>
      <div id="fb-code" style="margin:6px 0;color:#9aa8c4;font-size:.9em;"></div>
      <div style="display:flex;gap:6px;margin-top:6px;">
        <input id="fb-input" type="text" placeholder="–í–∞—à –≤–æ–ø—Ä–æ—Å..." style="flex:1;padding:8px;border-radius:8px;border:1px solid #444;background:#111;color:#fff;">
        <button class="offline-btn online" onclick="fbSend()" style="white-space:nowrap;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>
  <!-- –ú–æ–¥–∞–ª–∫–∞: –°–ø–∏—Å–æ–∫ –ø—Ä–∏–∑–æ–≤ -->
  <div class="modal-bg" id="modal-prizes">
    <div class="modal-feedback" style="max-width:420px;">
      <button class="bigclose" onclick="Prize.closePrizesModal()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48">
          <line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          <line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
        </svg>
      </button>
      <div class="download-modal-title">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–∑</div>
      <div id="prize-list" class="prize-list-card"></div>
      <div class="modal-buttons">
        <button class="btn-secondary" onclick="Prize.closePrizesModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞: –î–µ—Ç–∞–ª–∏ –ø—Ä–∏–∑–∞ -->
  <div class="modal-bg" id="modal-prize-detail">
    <div class="modal-feedback" style="max-width:420px;">
      <button class="bigclose" onclick="Prize.closePrizeDetail()" title="–ù–∞–∑–∞–¥">
        <svg viewBox="0 0 48 48">
          <line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          <line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
        </svg>
      </button>
      <div id="prize-detail-body"></div>
      <div class="modal-buttons">
        <button class="btn-secondary" onclick="Prize.backToPrizes()">–ù–∞–∑–∞–¥</button>
        <button class="btn-primary" id="prize-detail-get-btn" onclick="Prize.openShipping()">–ü–æ–ª—É—á–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞: –°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏ -->
  <div class="modal-bg" id="modal-shipping">
    <div class="modal-feedback" style="max-width:420px;">
      <button class="bigclose" onclick="Prize.closeShipping()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48">
          <line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          <line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
        </svg>
      </button>
      <div class="download-modal-title">–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
        <button class="prize-btn" id="ship-btn-pickup" onclick="Prize.selectShipping('pickup')">–ü–í–ó –°–î–ï–ö (–±–µ–∑ –∞–¥—Ä–µ—Å–∞)</button>
        <button class="prize-btn" id="ship-btn-courier" onclick="Prize.selectShipping('courier')">–û–±—ã—á–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ (–∞–¥—Ä–µ—Å)</button>
      </div>

      <!-- –§–æ—Ä–º–∞ pickup -->
      <div id="form-pickup" style="display:none;">
        <div class="form-row">
          <label>–ì–æ—Ä–æ–¥</label>
          <input id="ship-city" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞">
        </div>
        <div class="form-row">
          <label>–ü–í–ó –∏–ª–∏ –∫–æ–¥ –ü–í–ó</label>
          <input id="ship-pvz" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–í–ó CDEK-123 (—É–ª–∏—Ü–∞/–∫–æ–¥)">
        </div>
        <div class="form-row">
          <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <input id="ship-note" placeholder="–í–∞—à–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ –≤—ã–¥–∞—á–µ">
        </div>
      </div>

      <!-- –§–æ—Ä–º–∞ courier -->
      <div id="form-courier" style="display:none;">
        <div class="form-row">
          <label>–§–ò–û</label>
          <input id="ship-fio" placeholder="–ö–∞–∫ –Ω–∞ –ø–æ—Å—ã–ª–∫–µ">
        </div>
        <div class="form-row">
          <label>–ü–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å</label>
          <textarea id="ship-address" class="real-textarea" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞"></textarea>
        </div>
        <div class="form-row">
          <label>–ü–æ—á—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å</label>
          <input id="ship-zip" placeholder="–ò–Ω–¥–µ–∫—Å">
        </div>
      </div>

      <div class="modal-buttons">
        <button class="btn-secondary" onclick="Prize.closeShipping()">–ù–∞–∑–∞–¥</button>
        <button class="btn-primary" id="ship-submit" onclick="Prize.submitClaim()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="modal-bg" id="modal-offline">
    <div class="modal-feedback" style="max-width:400px;">
      <button class="bigclose" onclick="closeOfflineModal()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48">
          <line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          <line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
        </svg>
      </button>
      <div id="offline-step"></div>
    </div>
  </div>
  
  <div class="modal-bg" id="install-modal">
    <div class="modal-feedback" style="max-width:400px;">
      <button class="bigclose" onclick="closeInstallModal()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48">
          <line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          <line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
        </svg>
      </button>
      <div style="font-size:1.18em;font-weight:700;margin-bottom:13px;">
        –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ<br>¬´–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞¬ª?
      </div>
      <div style="margin-bottom:16px;font-size:1em;">
        –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ –≤–∞—à–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ, –∑–∞–π–º—ë—Ç ~1 –ú–ë.<br>
        –ï–≥–æ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç —É–¥–∞–ª–∏—Ç—å –∫–∞–∫ –æ–±—ã—á–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.<br>
        –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞.<br><br>
        <b>–î–ª—è –∑–∞—â–∏—Ç—ã –∑–∞–ø—É—Å—Ç–∏–º –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–µ —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤.</b>
      </div>
      <div id="install-modal-hash" style="font-size:.95em; color:#4daaff; margin-bottom:10px; display:none;">
        –•—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ...<br>
        <span id="install-hash-progress"></span>
      </div>
      <button class="offline-btn online" id="install-proceed-btn" style="width:99%;margin-bottom:7px;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
      <button class="offline-btn" style="width:99%;" onclick="closeInstallModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
  
  <div class="modal-bg" id="download-modal">
    <div class="modal-feedback" style="max-width:400px;">
      <div class="download-modal-title">–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å —Å —ç—Ç–∏–º —Ñ–∞–π–ª–æ–º?</div>
      <div style="margin-bottom:19px;font-size:.98em;" id="download-modal-filename"></div>
      <button class="offline-btn online" style="width:98%;margin-bottom:10px;" onclick="downloadCurrentTrack()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="shareCurrentTrack()">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –¥—Ä—É–∑—å—è–º–∏</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="openInAppCurrentTrack()">–û—Ç–∫—Ä—ã—Ç—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="copyLinkCurrentTrack()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="openAlbumDownloadModal()">–°–∫–∞—á–∞—Ç—å –≤–µ—Å—å –∞–ª—å–±–æ–º</button>
      <button class="offline-btn" style="width:98%;" onclick="closeDownloadModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
  <!-- –ú–æ–¥–∞–ª–∫–∞: –°–æ–∑–¥–∞–Ω–∏–µ –∏–º–µ–Ω–∏ –∏ –ø—Ä–∏–≤—è–∑–∫–∞ Telegram -->
  <div class="modal-bg" id="identity-modal">
    <div class="modal-feedback" style="max-width:420px;">
      <button class="bigclose" onclick="Prize.closeIdentityWizard()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48">
          <line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          <line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
        </svg>
      </button>

      <!-- –®–∞–≥ 1: –≤—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ -->
      <div id="idw-step-choose">
        <div class="download-modal-title">–°–æ–∑–¥–∞–Ω–∏–µ –∏–º–µ–Ω–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</div>
        <div style="color:#cfe3ff;margin-bottom:10px;">
          –£–∫–∞–∂–∏—Ç–µ, –∫–∞–∫ –ø—Ä–∏–≤—è–∑–∞—Ç—å Telegram:
        </div>
        <div class="stat-card" style="margin-bottom:10px;">
          <div style="font-weight:700;margin-bottom:6px;">–í—Ä—É—á–Ω—É—é (–±–µ–∑ –≤—Ö–æ–¥–∞ –≤ Telegram)</div>
          <div style="font-size:.92em;color:#9aa8c4;margin-bottom:8px;">
            –í–∞–º –Ω—É–∂–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑ —É–∫–∞–∑–∞—Ç—å –≤–∞—à @username –∏ –≤–∞—à Id –∏–∑ Telegram. –ö–∞–∫ —É–∑–Ω–∞—Ç—å ‚Äî —É –±–æ—Ç–∞ <b>@userinfobot</b> (–Ω–∞–ø–∏—à–∏—Ç–µ –µ–º—É ‚Äú/start‚Äù).
          </div>
          <button class="prize-btn" onclick="Prize.startManualIdentity()">–£–∫–∞–∑–∞—Ç—å @ –∏ Id</button>
        </div>
        <div class="stat-card" style="margin-bottom:10px;">
          <div style="font-weight:700;margin-bottom:6px;">–ß–µ—Ä–µ–∑ –±–æ—Ç–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</div>
          <div style="font-size:.92em;color:#9aa8c4;margin-bottom:8px;">
            –ù–∞–∂–º–∏—Ç–µ ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –Ω–∞—à Telegram‚Äë–±–æ—Ç. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤—Ö–æ–¥ –∏ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∏–º —Å–æ –≤–≤–æ–¥–æ–º –∏–º–µ–Ω–∏.
          </div>
          <button class="prize-btn" onclick="Prize.startBotIdentity()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤ –±–æ—Ç–µ</button>
        </div>
      </div>

      <!-- –®–∞–≥ 2: —Ñ–æ—Ä–º–∞ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ username/id -->
      <div id="idw-step-manual" style="display:none;">
        <div class="download-modal-title">–†—É—á–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞</div>
        <div style="font-size:.92em;color:#9aa8c4;margin-bottom:10px;">
          –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ <b>@userinfobot</b>, –Ω–∞–∂–º–∏—Ç–µ ‚ÄúStart‚Äù –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ:
        </div>
        <div class="form-row">
          <label>@username (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)</label>
          <input id="idw-man-username" placeholder="@–≤–∞—à_–Ω–∏–∫">
        </div>
        <div class="form-row">
          <label>Id (—á–∏—Å–ª–æ)</label>
          <input id="idw-man-id" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 123456789" inputmode="numeric" pattern="[0-9]*">
        </div>
        <div class="modal-buttons">
          <button class="btn-secondary" onclick="Prize.backToIdentityChoose()">–ù–∞–∑–∞–¥</button>
          <button class="btn-primary" onclick="Prize.submitManualIdentity()">–î–∞–ª–µ–µ</button>
        </div>
      </div>

      <!-- –ù–û–í–û–ï: –®–∞–≥ 3b: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ -->
      <div id="idw-step-bot" style="display:none;">
        <div class="download-modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤ Telegram‚Äë–±–æ—Ç–µ</div>
        <div class="stat-card" style="margin-bottom:10px;">
          <div style="font-size:.92em;color:#9aa8c4;">
            –ù–∞–∂–º–∏—Ç–µ ¬´–û—Ç–∫—Ä—ã—Ç—å Telegram¬ª, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤—Ö–æ–¥ —É –±–æ—Ç–∞, –∑–∞—Ç–µ–º –≤–µ—Ä–Ω–∏—Ç–µ—Å—å —Å—é–¥–∞ ‚Äî –º—ã –≤—Å—ë –ø–æ–¥—Ö–≤–∞—Ç–∏–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
          </div>
        </div>
        <div id="idw-bot-code" class="prize-note" style="text-align:center; margin-bottom:8px;"></div>
        <div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
          <a id="idw-bot-link" class="prize-btn" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å Telegram</a>
          <button class="prize-btn" onclick="Prize.cancelBotIdentity()">–û—Ç–º–µ–Ω–∞</button>
        </div>
        <div id="idw-bot-qr-wrap" style="display:flex;justify-content:center;margin-top:6px;">
          <img id="idw-bot-qr" alt="QR" style="width:180px;height:180px;border-radius:8px;display:none;"/>
        </div>
        <div class="prize-note" id="idw-bot-status" style="text-align:center; margin-top:10px;">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è‚Ä¶</div>
      </div>

      <!-- –®–∞–≥ 4: –≤–≤–æ–¥ –∏–º–µ–Ω–∏ -->
      <div id="idw-step-name" style="display:none;">
        <div class="download-modal-title">–ò–º—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</div>
        <div class="form-row">
          <label>–ö–∞–∫ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤–∞—Å –ø–æ–¥ –∏–∫–æ–Ω–∫–∞–º–∏ –ø—Ä–∏–∑–æ–≤</label>
          <input id="idw-display-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–∞—Å–∏–ª–∏—Å–∞ –∏–ª–∏ @username">
        </div>
        <div class="modal-buttons">
          <button class="btn-secondary" onclick="Prize.backToIdentityChoose()">–ù–∞–∑–∞–¥</button>
          <button class="btn-primary" onclick="Prize.saveDisplayName()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∞–ª—å–±–æ–º–∞ -->
  <div class="modal-bg" id="albumDownloadModal">
    <div class="modal-feedback" style="max-width: 400px;">
      <h2 style="text-align: center; margin-bottom: 25px;">–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º</h2>
      
      <div class="download-options">
        <label class="checkbox-container">
          <input type="checkbox" id="includeCovers" checked>
          <span class="checkmark"></span>
          –û–±–ª–æ–∂–∫–∏ (–≥–∞–ª–µ—Ä–µ—è)
        </label>
        
        <label class="checkbox-container">
          <input type="checkbox" id="includeLyrics" checked>
          <span class="checkmark"></span>
          –¢–µ–∫—Å—Ç—ã –ø–µ—Å–µ–Ω
        </label>
        
        <hr style="margin: 15px 0; border-color: #333;">
        
        <label class="checkbox-container">
          <input type="checkbox" id="onlyFavorites">
          <span class="checkmark"></span>
          –¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –ø–µ—Å–Ω–∏
        </label>
        
        <label class="checkbox-container">
          <input type="checkbox" id="fullAlbum" checked>
          <span class="checkmark"></span>
          –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–ª—å–±–æ–º
        </label>
      </div>
      
      <div class="modal-buttons">
        <button onclick="closeAlbumDownloadModal()" class="btn-secondary">–û–¢–ú–ï–ù–ê</button>
        <button onclick="prepareDownload()" class="btn-primary">–°–ö–ê–ß–ê–¢–¨</button>
      </div>
    </div>
  </div>
  <!-- –ú–æ–¥–∞–ª–∫–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –±—ç–∫–∞–ø–∞ (–æ—Ç–¥–µ–ª—å–Ω–∞—è, –Ω–µ –≤–Ω—É—Ç—Ä–∏ –¥—Ä—É–≥–∏—Ö –º–æ–¥–∞–ª–æ–∫) -->
  <div class="modal-bg" id="modal-backup-prompt">
    <div class="modal-feedback" style="max-width:400px;">
      <button class="bigclose" onclick="closeBackupPrompt()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48">...</svg>
      </button>
      <div style="font-size:1.12em;font-weight:700;margin-bottom:10px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –≤–∞—à–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
      <div style="color:#bbb;line-height:1.5;margin-bottom:10px;">
        –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å. –ü—Ä–∏ —É—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–∑ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω –±–µ–∑ —Ñ–∞–π–ª–∞.
      </div>

      <!-- –ì–∞–ª–æ—á–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π -->
      <label class="checkbox-container" style="margin-top:6px;">
        <input type="checkbox" id="backup-opt-never">
        <span class="checkmark"></span>
        –ù–µ –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å –±–æ–ª—å—à–µ
      </label>
      <label class="checkbox-container" style="margin-top:6px;">
        <input type="checkbox" id="backup-opt-5">
        <span class="checkmark"></span>
        –ù–∞–ø–æ–º–Ω–∏—Ç—å —á–µ—Ä–µ–∑ 5 –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
      </label>

      <div style="display:flex;gap:8px;justify-content:center;margin-top:12px;">
        <button class="btn-secondary" onclick="closeBackupPromptWithChoice()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn-primary" onclick="backupExportWithLevel()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å‚Ä¶</button>
      </div>
    </div>
  </div>
  <div class="modal-bg" id="reset-modal">
    <div class="modal-feedback" style="max-width:320px;">
      <button class="bigclose" onclick="closeResetModal()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48">
          <line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          <line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
        </svg>
      </button>
      <div style="font-size:1.12em;font-weight:700;margin-bottom:10px;">–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö</div>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="closeResetModal();promptReset('stats')">–û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="closeResetModal();promptReset('ach')">–û—á–∏—Å—Ç–∏—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</button>
      <button class="offline-btn online" style="width:98%;" onclick="closeResetModal();promptReset('all')">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
    </div>
  </div>
  <div class="modal-bg" id="backup-actions-modal">
    <div class="modal-feedback" style="max-width:360px;">
      <button class="bigclose" onclick="closeBackupActions()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48">
          <line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          <line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
        </svg>
      </button>
      <div class="download-modal-title">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</div>
      <button class="offline-btn online" style="width:98%;margin-bottom:10px;" onclick="closeBackupActions();backupExportWithLevel()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="closeBackupActions();backupShare()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="closeBackupActions();document.getElementById('backup-file-input').click()">–ò–º–ø–æ—Ä—Ç</button>
      <!-- –ù–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ –æ–±–ª–∞–∫–∞ -->
      <hr style="border-color:#333;margin:12px 0;">
      <button class="offline-btn online" style="width:98%;margin-bottom:10px;" onclick="closeBackupActions();backupSaveToCloud()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ</button>
      <button class="offline-btn" style="width:98%;" onclick="closeBackupActions();backupImportFromCloud()">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞</button>
    </div>
  </div>
  
  <div class="modal-bg" id="sizeConfirmModal">
    <div class="modal-feedback" style="max-width: 350px;">
      <h3 style="text-align: center;">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
      
      <div class="size-info">
        <div style="font-size: 48px; color: #E80100; margin-bottom: 15px;">üì¶</div>
        <p style="font-size: 18px; margin: 10px 0;">
          –†–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞: <strong id="archiveSize">0 –ú–ë</strong>
        </p>
        <p style="color: #888; font-size: 14px;">
          –§–∞–π–ª–æ–≤ –≤ –∞—Ä—Ö–∏–≤–µ: <span id="fileCount">0</span>
        </p>
      </div>
      
      <div class="modal-buttons">
        <button onclick="closeSizeConfirmModal()" class="btn-secondary">–û–¢–ú–ï–ù–ê</button>
        <button onclick="startDownload()" class="btn-primary">–°–ö–ê–ß–ê–¢–¨</button>
      </div>
    </div>
  </div>
  
  <div class="modal-bg" id="downloadProgressModal">
    <div class="modal-feedback" style="max-width: 400px;">
      <h3 style="text-align: center; margin-bottom: 20px;">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞</h3>
      
      <div class="progress-bar">
        <div id="progressFill" class="progress-fill" style="width: 0%"></div>
      </div>
      
      <p id="progressText" style="text-align: center; margin-top: 10px;">
        –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤: 0/0
      </p>
      
      <div id="errorsList" style="display: none; color: #ff6b6b; font-size: 14px; margin-top: 15px;">
        <p><strong>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å:</strong></p>
        <ul id="errorsListContent"></ul>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à -->
  <div class="modal-bg" id="hotkeys-modal">
    <div class="hotkeys-modal">
      <button class="bigclose" onclick="closeHotkeysModal()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48">
          <line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          <line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
        </svg>
      </button>
      
      <h2>üìå –ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò</h2>
      
      <div class="hotkeys-section">
        <h3>‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ</h3>
        <div class="hotkey-item">
          <span class="hotkey-combo">K / –ü—Ä–æ–±–µ–ª</span>
          <span class="hotkey-desc">–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ/–ü–∞—É–∑–∞</span>
        </div>
        <div class="hotkey-item">
          <span class="hotkey-combo">X</span>
          <span class="hotkey-desc">–°—Ç–æ–ø</span>
        </div>
        <div class="hotkey-item">
          <span class="hotkey-combo">N</span>
          <span class="hotkey-desc">–°–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫</span>
        </div>
        <div class="hotkey-item">
          <span class="hotkey-combo">P</span>
          <span class="hotkey-desc">–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—Ä–µ–∫</span>
        </div>
        <div class="hotkey-item">
          <span class="hotkey-combo">J / L</span>
          <span class="hotkey-desc">–ü–µ—Ä–µ–º–æ—Ç–∫–∞ ‚Üê10—Å–µ–∫ / 10—Å–µ–∫‚Üí</span>
        </div>
        <div class="hotkey-item">
          <span class="hotkey-combo">+ / -</span>
          <span class="hotkey-desc">–ì—Ä–æ–º–∫–æ—Å—Ç—å ¬±10%</span>
        </div>
      </div>
      
      <div class="hotkeys-section">
        <h3>üéµ –†–µ–∂–∏–º—ã</h3>
        <div class="hotkey-item">
          <span class="hotkey-combo">R</span>
          <span class="hotkey-desc">–ü–æ–≤—Ç–æ—Ä</span>
        </div>
        <div class="hotkey-item">
          <span class="hotkey-combo">U</span>
          <span class="hotkey-desc">–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</span>
        </div>
        <div class="hotkey-item">
          <span class="hotkey-combo">F</span>
          <span class="hotkey-desc">–ò–∑–±—Ä–∞–Ω–Ω—ã–µ</span>
        </div>
        <div class="hotkey-item">
          <span class="hotkey-combo">M</span>
          <span class="hotkey-desc">–ë–µ–∑ –∑–≤—É–∫–∞</span>
        </div>
        <div class="hotkey-item">
          <span class="hotkey-combo">T</span>
          <span class="hotkey-desc">–¢–∞–π–º–µ—Ä —Å–Ω–∞</span>
        </div>
      </div>
      
      <div class="hotkeys-section">
        <h3>‚ú® –≠—Ñ—Ñ–µ–∫—Ç—ã</h3>
        <div class="hotkey-item">
          <span class="hotkey-combo">A</span>
          <span class="hotkey-desc">–ê–Ω–∏–º–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏</span>
        </div>
        <div class="hotkey-item">
          <span class="hotkey-combo">B</span>
          <span class="hotkey-desc">–ü—É–ª—å—Å–∞—Ü–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞</span>
        </div>
        <div class="hotkey-item">
          <span class="hotkey-combo">1 / 2 / 3</span>
          <span class="hotkey-desc">–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å (100%/50%/15%)</span>
        </div>
      </div>
      
      <div class="hotkeys-section">
        <h3>üì± –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</h3>
        <div class="hotkey-item">
          <span class="hotkey-combo">Y</span>
          <span class="hotkey-desc">–ü–æ–∫–∞–∑–∞—Ç—å –ª–∏—Ä–∏–∫—É</span>
        </div>
        <div class="hotkey-item">
          <span class="hotkey-combo">W</span>
          <span class="hotkey-desc">–ü–æ–∫–∞–∑–∞—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç</span>
        </div>
        <div class="hotkey-item">
          <span class="hotkey-combo">D</span>
          <span class="hotkey-desc">–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
        </div>
        <div class="hotkey-item">
          <span class="hotkey-combo">/</span>
          <span class="hotkey-desc">–ü–æ–∏—Å–∫</span>
        </div>
        <div class="hotkey-item">
          <span class="hotkey-combo">?</span>
          <span class="hotkey-desc">–≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞</span>
        </div>
        <div class="hotkey-item">
          <span class="hotkey-combo">Esc</span>
          <span class="hotkey-desc">–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ</span>
        </div>
      </div>
      
      <div class="hotkeys-section">
        <h3>üí° –ö–æ–º–±–∏–Ω–∞—Ü–∏–∏</h3>
        <div class="hotkey-item">
          <span class="hotkey-combo">Shift + F</span>
          <span class="hotkey-desc">–§–∏–ª—å—Ç—Ä –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö</span>
        </div>
        <div class="hotkey-item">
          <span class="hotkey-combo">Shift + V</span>
          <span class="hotkey-desc">–ì—Ä–æ–º–∫–æ—Å—Ç—å 50%</span>
        </div>
        <div class="hotkey-item">
          <span class="hotkey-combo">0</span>
          <span class="hotkey-desc">–í—ã–∫–ª—é—á–∏—Ç—å/–≤–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π -->
  <div class="modal-bg" id="achievements-modal">
    <div class="modal-feedback ach-modal">
      <button class="bigclose" onclick="closeAchievementsModal()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48">
          <line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          <line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
        </svg>
      </button>

      <div class="sticky-head">
        <h2>–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</h2>
        <div class="ach-tabs">
          <button class="ach-tab active" data-filter="all">–í—Å–µ</button>
          <button class="ach-tab" data-filter="available">–î–æ—Å—Ç—É–ø–Ω—ã–µ</button>
          <button class="ach-tab" data-filter="done">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
          <button class="ach-tab" data-filter="secret">–°–µ–∫—Ä–µ—Ç–Ω—ã–µ</button>
        </div>
      </div>

      <div class="ach-list-wrap" id="ach-list-container"></div>
    </div>
  </div>

<script>
// ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
const VERSION = '6.3.1';
const BUILD_DATE = '2025-01-17';
const BUILD_INFO = {
  version: VERSION,
  date: BUILD_DATE,
  author: '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
  repository: 'https://github.com/apel-s-in/vi3na1bita-mezhdu-zlom-i-dobrom'
};
// ==== –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ URL –≤–∞—à–µ–≥–æ Cloudflare Worker) ====
// –ü–æ—Å—Ç–∞–≤—å—Ç–µ URL –≤–∞—à–µ–≥–æ endpoint (–ø—Ä–∏–º–µ—Ä: 'https://vr-stats.example.workers.dev')
// –ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º '', –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–∫–ª—é—á–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
const GLOBAL_STATS_URL = 'https://vr-backend.apel-s-in.workers.dev';
window.GLOBAL_STATS_URL = GLOBAL_STATS_URL; // –¥–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É
function apiAuthHeaders() {
  const h = {};
  const sid = localStorage.getItem('vr_sid');
  if (sid) h['X-Session'] = sid;
  return h;
}
// –°—Ç—Ä–∞—Ö–æ–≤–∫–∞: –µ—Å–ª–∏ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É –ø–æ–ª—è –µ—â—ë –≤—ã–∫–ª—é—á–µ–Ω—ã ‚Äî –≤–∫–ª—é—á–∏–º –∏—Ö
setTimeout(() => {
  try {
    const inp = document.getElementById('promo-inp');
    const btn = document.getElementById('promo-btn');
    if (inp && btn && (inp.disabled || btn.disabled)) {
      inp.disabled = false; btn.disabled = false;
      const err = document.getElementById('promo-error');
      if (err && !configLoaded) {
        err.textContent = '–ö–æ–Ω—Ñ–∏–≥ –µ—â—ë –≥—Ä—É–∑–∏—Ç—Å—è... –ú–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥';
        err.style.color = '#9aa8c4';
      }
    }
  } catch(e){}
}, 1000);

// Cloudflare Turnstile ...
const TURNSTILE_SITE_KEY = '0x4AAAAAAB6y4Jw_0uezz1RN';

// Telegram bot username –¥–ª—è Login Widget ‚Äî –í–°–¢–ê–í–¨–¢–ï –∏–º—è –±–æ—Ç–∞
const TG_BOT_USERNAME = 'vi3na1bita_feedback_bot';

// –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –ø–æ—Ä–æ–≥ –¥–ª—è —á–µ–∫-–ª–∏—Å—Ç–∞ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ (—Å–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–∞–º env.MIN_CLAIM_LEVEL)
const FRONT_MIN_CLAIM_LEVEL = 1;

// –•–µ–ª–ø–µ—Ä: –ø–æ–ª—É—á–∏—Ç—å –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π —Ç–æ–∫–µ–Ω Turnstile (–Ω–µ–≤–∏–¥–∏–º—ã–π, –±–µ–∑ UI)
async function getTurnstileToken(action = 'send_event') {
  // –∂–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ turnstile
  if (typeof turnstile === 'undefined') {
    await new Promise(resolve => {
      const t = setInterval(() => {
        if (typeof turnstile !== 'undefined') { clearInterval(t); resolve(); }
      }, 50);
    });
  }
  return await turnstile.execute(TURNSTILE_SITE_KEY, { action });
}

// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
console.log(`%cüéµ –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞ PWA v${VERSION}`, 'color: #E80100; font-size: 16px; font-weight: bold;');
console.log(`%cBuild: ${BUILD_DATE}`, 'color: #4daaff; font-size: 12px;');

// ==== Feature flags (–≠—Ç–∞–ø 1) ====
const FeatureFlags = {
  achievementsUI:   (localStorage.getItem('ff_achievements_ui') ?? '1') === '1',
  statsCollect:     (localStorage.getItem('ff_stats_collect') ?? '1') === '1',
  achievementsLogic:(localStorage.getItem('ff_achievements_logic') ?? '0') === '1',
  globalStatsSend:  (localStorage.getItem('ff_global_stats_send') ?? '0') === '1', // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∫–ª, –≤–∫–ª –∫–æ–≥–¥–∞ –ø–æ—Å—Ç–∞–≤–∏—Ç–µ URL
  globalStatsUI:    (localStorage.getItem('ff_global_stats_ui') ?? '1') === '1'
};
// ... –ø–æ—Å–ª–µ –±–ª–æ–∫–∞ FeatureFlags
if (GLOBAL_STATS_URL && localStorage.getItem('ff_global_stats_send') === null) {
  localStorage.setItem('ff_global_stats_send', '1'); // –≤–∫–ª—é—á–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑
}

// –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ DOM —ç–ª–µ–º–µ–Ω—Ç—ã
const DOM = {};

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let config = null;
let promoPassed = false;
let configLoaded = false;
let coverGalleryArr = ['Cover.png', 'Cover01.png', 'Cover02.png', 'Cover03.png'];
let coverGalleryIdx = 0;
let coverAutoplay = null;
let currentTrack = -1;
let currentLyrics = [];
let autoPlayEnabled = true; // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é true
let offlineMode = false;
let offlineDownloading = false;
let deferredPrompt = null;

// –ù–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–ª–µ–µ—Ä–∞
let shuffleMode = false;
let shuffledPlaylist = [];
let shuffleIndex = 0;
let repeatMode = false;
let favoritesOnlyMode = false;
let availableTracks = [];
let favoritesFilterActive = false;

// –ù–û–í–´–ï –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π
let animationEnabled = false;
let bitEnabled = false;
let bitIntensity = 100; // 100, 50 –∏–ª–∏ 15
let audioContext = null;
let analyser = null;
let audioSource = null;
let animationFrame = null;
let hasShownAnimationWarning = false;
let hasShownBitWarning = false;

let downloadOptions = {
  includeCovers: true,
  includeLyrics: true,
  onlyFavorites: false,
  fullAlbum: true
};
let filesToDownload = [];

// ==================== SERVICE WORKER ====================
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js').then(async reg => {
    console.log('Service Worker registered', reg);

    await navigator.serviceWorker.ready;
    syncOfflineState();
    // –∑–∞–ø—Ä–æ—Å–∏–º —É SW —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ offline-—Ä–µ–∂–∏–º–∞
    try { reg.active && reg.active.postMessage({ type: 'REQUEST_OFFLINE_STATE' }); } catch(e){}

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ä–∞–∑—É –∏ –∑–∞—Ç–µ–º —Ä–∞–∑ –≤ —á–∞—Å
    try { reg.update(); } catch(e) {}
    setInterval(async () => {
      try {
        const r = await navigator.serviceWorker.getRegistration();
        if (r) r.update();
      } catch(e) {}
    }, 60 * 60 * 1000);

    reg.addEventListener('updatefound', () => {
      const newWorker = reg.installing;
      newWorker.addEventListener('statechange', () => {
        if (newWorker.state === 'activated') {
          NotificationSystem.info('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
        }
      });
    });
  });

  // –û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞, –∫–æ–≥–¥–∞ –Ω–æ–≤—ã–π SW –±–µ—Ä—ë—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
  let __swReloaded = false;
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    if (__swReloaded) return;
    __swReloaded = true;
    try { NotificationSystem.info('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞...'); } catch(e){}
    setTimeout(() => location.reload(), 300);
  });

  navigator.serviceWorker.addEventListener('message', event => {
    const msg = event.data || {};
    if (msg.type === 'CACHE_UPDATED') {
      console.log('Cache updated to version:', msg.version);
    }
    if (msg.type === 'OFFLINE_STATE') {
      offlineMode = !!msg.value;
      setOfflineUIState(offlineMode ? 'offline' : 'online');
    }
    if (msg.type === 'CLEAR_ALL_POSITIONS') {
      PositionManager.clearAll();
    }
  });
}

function syncOfflineState() {
  offlineMode = localStorage.getItem('offlineMode') === '1';
  if (navigator.serviceWorker && navigator.serviceWorker.controller) {
    navigator.serviceWorker.controller.postMessage({
      type: 'SET_OFFLINE_MODE',
      value: offlineMode
    });
  }
}

// ==================== –°–ò–°–¢–ï–ú–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô ====================
class NotificationSystem {
  static queue = [];
  static isShowing = false;
  
  static show(message, type = 'info', duration = 3000) {
    this.queue.push({ message, type, duration });
    if (!this.isShowing) {
      this.processQueue();
    }
  }
  
  static async processQueue() {
    if (this.queue.length === 0) {
      this.isShowing = false;
      return;
    }
    
    this.isShowing = true;
    const { message, type, duration } = this.queue.shift();
    
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
      <div class="toast-content">
        <span class="toast-emoji" aria-hidden="true"></span>
        <span class="toast-text">${message}</span>
      </div>
    `;

    document.body.appendChild(toast);
    // –í—Å—Ç–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —ç–º–æ–¥–∑–∏ (–∏–ª–∏ fallback)
    try {
      const emojiEl = toast.querySelector('.toast-emoji');
      AnimatedEmoji.mount(emojiEl, type, message, 24);
    } catch(e) {}

    await new Promise(r => setTimeout(r, 50));
    toast.classList.add('show');
    await new Promise(r => setTimeout(r, duration));
    toast.classList.remove('show');
    await new Promise(r => setTimeout(r, 300));
    toast.remove();
    
    this.processQueue();
  }
  
  static getIcon(type) {
    const icons = {
      info: 'üì¢',
      success: '‚úÖ',
      error: '‚ùå',
      warning: '‚ö†Ô∏è',
      offline: 'üì°'
    };
    return icons[type] || icons.info;
  }
  
  static info(msg) { this.show(msg, 'info'); }
  static success(msg) { this.show(msg, 'success'); }
  static error(msg) { this.show(msg, 'error', 5000); }
  static warning(msg) { this.show(msg, 'warning', 4000); }
  static offline(msg) { this.show(msg, 'offline'); }
}

// ==== Device hash ====
function getDeviceHash() {
  let h = localStorage.getItem('device_hash');
  if (h) return h;
  const buf = new Uint8Array(16);
  crypto.getRandomValues(buf);
  h = 'dev_' + Array.from(buf).map(b=>b.toString(16).padStart(2,'0')).join('');
  localStorage.setItem('device_hash', h);
  return h;
}
// ==== Integrity / Anti‚Äëtamper ====
const CRC_LS_KEY = 'vr_crc_v1';

const Integrity = {
  async compute() {
    const base = {
      deviceHash: getDeviceHash(),
      stats: StatsStore.s ? {
        totals: StatsStore.s.totals,
        perTrack: StatsStore.s.perTrack,
        unique: StatsStore.s.uniqueTracksPlayed,
        byDay: StatsStore.s.byDay,
        streak: StatsStore.s.streak,
        likedCount: StatsStore.s.likedCount
      } : null,
      achievements: StatsStore.s ? StatsStore.s.achievements : null
    };
    const raw = JSON.stringify(base);
    const buf = new TextEncoder().encode(raw);
    const hash = await crypto.subtle.digest('SHA-256', buf);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
  },
  async update() {
    try {
      const crc = await this.compute();
      localStorage.setItem(CRC_LS_KEY, crc);
    } catch(e){ console.warn('Integrity update failed', e); }
  },
  async verifyOnBoot() {
    try {
      const saved = localStorage.getItem(CRC_LS_KEY);
      const crc = await this.compute();
      if (saved && saved !== crc) {
        localStorage.setItem('tamper_detected', '1');
        NotificationSystem.error('–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö. –î–ª—è –ø—Ä–∏–∑–æ–≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏–∑ –±—ç–∫–∞–ø–∞.');
        console.warn('Anti‚Äëtamper: mismatch', { saved, crc });
        return false;
      }
      // –≤—Å—ë –æ–∫ ‚Äî —Å–Ω–∏–º–∞–µ–º —Ñ–ª–∞–≥, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –æ—Å—Ç–∞–≤–∞–ª—Å—è —Ä–∞–Ω–µ–µ
      localStorage.removeItem('tamper_detected');
      return true;
    } catch(e){ return true; }
  }
};
// ==== Stats store (–≠—Ç–∞–ø 1+2) ====
const STATS_LS_KEY = 'vr_stats_v1';
const StatsStore = {
  s: null,
  init() {
    try {
      const raw = localStorage.getItem(STATS_LS_KEY);
      if (raw) {
        this.s = JSON.parse(raw);
        if (Array.isArray(this.s.uniqueTracksPlayed)) {
          this.s.uniqueTracksPlayed = Array.from(new Set(this.s.uniqueTracksPlayed));
        }
        // –º–∏–≥—Ä–∞—Ü–∏–∏ –≠—Ç–∞–ø 2
        if (!this.s.achievements) this.s.achievements = {};         // id -> { unlockedAt, tier }
        if (typeof this.s.lastMajorAchAt !== 'number') this.s.lastMajorAchAt = 0;
        // –º–∏–≥—Ä–∞—Ü–∏–∏ –≠—Ç–∞–ø 4
        if (!this.s.backups) this.s.backups = { dates: [] };
        if (!this.s.socialsVisited) this.s.socialsVisited = {};
        if (typeof this.s.sleepTimerStops !== 'number') this.s.sleepTimerStops = 0;
        // –º–∏–≥—Ä–∞—Ü–∏—è –≠—Ç–∞–ø 5: –º–∞—Å—Å–∏–≤—ã –ø–æ —á–∞—Å–∞–º/–¥–Ω—è–º –Ω–µ–¥–µ–ª–∏ –Ω–∞ —Ç—Ä–µ–∫–∞—Ö
        if (Array.isArray(this.s.perTrack)) {
          for (let i = 0; i < this.s.perTrack.length; i++) {
            const pt = this.s.perTrack[i] || {};
            if (!Array.isArray(pt.byHour)) pt.byHour = Array(24).fill(0);
            if (!Array.isArray(pt.byWeekday)) pt.byWeekday = Array(7).fill(0); // 0=–ü–Ω .. 6=–í—Å
            this.s.perTrack[i] = pt;
          }
        }
      } else {
        this.s = this._fresh();
      }
    } catch {
      this.s = this._fresh();
    }
  },
  _fresh() {
    return {
      schema: 2,
      deviceHash: getDeviceHash(),
      createdAt: Date.now(),
      totals: { totalSeconds: 0, totalValidPlays: 0, totalFullPlays: 0 },
      perTrack: Array.from({length: 16}, ()=>({
        validPlays:0, fullPlays:0, totalSeconds:0, lastPlayedAt:0,
        byHour: Array(24).fill(0),
        byWeekday: Array(7).fill(0) // 0=–ü–Ω .. 6=–í—Å
      })),
      uniqueTracksPlayed: [],
      byDay: {},            // YYYY-MM-DD -> { valid:n, seconds:s }
      streak: { current: 0, max: 0, lastDay: null },
      likedCount: (JSON.parse(localStorage.getItem('likedTracks')||'[]')||[]).length,
      achievements: {},     // id -> { unlockedAt, tier }
      lastMajorAchAt: 0,
      backups: { dates: [] },     // –¥–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π –±—ç–∫–∞–ø–∞ YYYY-MM-DD
      socialsVisited: {},         // title -> true
      sleepTimerStops: 0          // —á–∏—Å–ª–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π —Ç–∞–π–º–µ—Ä–∞ —Å–Ω–∞
    };
  },
  save() {
    const clone = structuredClone(this.s);
    localStorage.setItem(STATS_LS_KEY, JSON.stringify(clone));
    // –æ–±–Ω–æ–≤–∏–º checksum –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    Integrity.update();
  }
};

// ==== –ü—Ä–∞–≤–∏–ª–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ ====
function isValidListen(listenedMs, ended) {
  return listenedMs >= 13_000 || ended === true;
}
function isFullListen(listenedMs, durationMs, ended) {
  if (!durationMs) return false;
  return ended === true || listenedMs >= 0.9 * durationMs;
}
function localDayKey(ts) {
  const d = new Date(ts);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
// ==== –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ (–ª–æ–∫–∞–ª—å–Ω–æ–µ) ====
// –í—Ö–æ–¥–∏—Ç –ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è ts –≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª [fromHHMMSS .. toHHMMSS]
function isBetweenLocalTime(ts, fromHHMMSS, toHHMMSS) {
  const t = new Date(ts).toTimeString().slice(0,8); // "HH:MM:SS"
  return t >= fromHHMMSS && t <= toHHMMSS;
}
// ISO-–Ω–µ–¥–µ–ª—è –≤–∏–¥–∞ YYYY-Www
function getISOWeekId(ts) {
  const d = new Date(ts);
  const dayNr = (d.getDay() + 6) % 7;
  d.setDate(d.getDate() - dayNr + 3);
  const firstThursday = new Date(d.getFullYear(), 0, 4);
  const firstDayNr = (firstThursday.getDay() + 6) % 7;
  firstThursday.setDate(firstThursday.getDate() - firstDayNr + 3);
  const week = 1 + Math.round((d - firstThursday) / 604800000);
  const year = d.getFullYear();
  return `${year}-W${String(week).padStart(2,'0')}`;
}
// –í—ã—Ö–æ–¥–Ω–æ–π –ª–∏ –¥–µ–Ω—å (–ª–æ–∫–∞–ª—å–Ω–æ)
function isWeekendLocal(ts) {
  const w = new Date(ts).getDay(); // 0 Sun, 6 Sat
  return w === 0 || w === 6;
}

// ==== –¢–∏—Ö–∏–π —Å–±–æ—Ä —Å—Ç–∞—Ç—ã (–≠—Ç–∞–ø 1) ====
const Stats = {
  active: FeatureFlags.statsCollect,
  lastStart: null,       // { ts, trackIndex, startPosMs }
  onStart(trackIndex) {
    if (!this.active) return;
    const audio = document.getElementById('audio');
    if (!audio) return;
    this.lastStart = {
      ts: Date.now(),
      trackIndex,
      startPosMs: Math.floor((audio.currentTime||0)*1000)
    };
  },
  onPauseOrStop(opts={ ended:false }) {
    if (!this.active || !this.lastStart) return;
    const audio = document.getElementById('audio');
    if (!audio) return;

    const now = Date.now();
    const durationMs = Math.floor((audio.duration||0)*1000);
    const posMs = opts.ended ? Math.floor(durationMs) : Math.floor((audio.currentTime||0)*1000);
    const listenedMs = Math.max(0, posMs - (this.lastStart.startPosMs||0));
    const valid = isValidListen(listenedMs, opts.ended);
    const full  = isFullListen(listenedMs, durationMs, opts.ended);

    // use_shuffle_5 ‚Äî —É—á—ë—Ç –≤–∞–ª–∏–¥–Ω–æ–≥–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –≤ shuffle‚Äë—Ä–µ–∂–∏–º–µ
    if (valid && shuffleMode === true) {
      Ach.incShuffleValid();
    }

    if (valid || full) {
      const s = StatsStore.s;
      const idx = this.lastStart.trackIndex;
  
      // –°–Ω–∞—á–∞–ª–∞ ‚Äî –¥–µ—Ä–≥–∞–µ–º SessionManager –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∞—á–∏–≤–æ–∫ (–æ–Ω —Å–∞–º –ø—Ä–æ–≤–µ—Ä–∏—Ç valid/full)
      Session.onListenStop({
        trackIndex: idx,
        ts: now,
        listenedMs,
        durationMs,
        ended: opts.ended,
        flags: {
          favoritesOnly: !!favoritesOnlyMode,
          shuffle: !!shuffleMode,
          isFavoriteNow: isLiked(idx)
        }
      });

      // totals
      if (valid) {
        s.totals.totalValidPlays += 1;
        s.totals.totalSeconds += listenedMs/1000;
        if (!s.uniqueTracksPlayed.includes(idx)) s.uniqueTracksPlayed.push(idx);
      }
      if (full) s.totals.totalFullPlays += 1;

      // per-track
      const pt = s.perTrack[idx];
      if (valid) pt.validPlays += 1;
      if (full) pt.fullPlays += 1;
      pt.totalSeconds += listenedMs/1000;
      pt.lastPlayedAt = now;

      // —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —á–∞—Å–∞–º/–¥–Ω—è–º –Ω–µ–¥–µ–ª–∏ –¥–ª—è –≤–∞–ª–∏–¥–Ω—ã—Ö –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π
      if (valid) {
        try {
          const d = new Date(now);
          const hour = d.getHours();                      // 0..23
          const weekday = (d.getDay() + 6) % 7;           // 0=–ü–Ω .. 6=–í—Å
          if (Array.isArray(pt.byHour)) pt.byHour[hour] = (pt.byHour[hour]||0) + 1;
          if (Array.isArray(pt.byWeekday)) pt.byWeekday[weekday] = (pt.byWeekday[weekday]||0) + 1;
        } catch(e) {}
      }

      // byDay + streak
      if (valid) {
        const key = localDayKey(now);
        s.byDay[key] = s.byDay[key] || { valid:0, seconds:0 };
        s.byDay[key].valid += 1;
        s.byDay[key].seconds += listenedMs/1000;

        if (!s.streak.lastDay) {
          s.streak.current = 1;
        } else if (key !== s.streak.lastDay) {
          const prev = new Date(s.streak.lastDay+'T00:00:00');
          const cur  = new Date(key+'T00:00:00');
          const diff = Math.round((cur - prev)/86400000);
          s.streak.current = (diff === 1) ? (s.streak.current+1) : 1;
        }
        s.streak.lastDay = key;
        s.streak.max = Math.max(s.streak.max, s.streak.current);
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Å—Ç—ã–µ –∞—á–∏–≤–∫–∏ (—ç—Ç–æ –≠—Ç–∞–ø 2 –ª–æ–≥–∏–∫–∞)
      StatsStore.save();
      AchProgress.updateFromStats();
      Ach.evaluateAfterListen({ ts: now });
      // –û–±–Ω–æ–≤–∏–º —Ä–∞–∑–¥–µ–ª "–ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
      MyStats.update();
      // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –≤ –æ—á–µ—Ä–µ–¥—å
      GlobalStats.enqueueEvent({
        ts: now,
        trackIndex: idx,
        listenedMs,
        ended: !!opts.ended,
        durationMs
      });

      // –ü–æ–ø—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ä–∞–∑—É:
      // - –µ—Å–ª–∏ —Ç—Ä–µ–∫ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è, –∏–ª–∏
      // - –µ—Å–ª–∏ —Å–ª—É—à–∞–ª–∏ ‚â• 15 —Å–µ–∫—É–Ω–¥ –∑–∞ —Ä–∞–∑
      try {
        if (opts.ended || listenedMs >= 15000) {
          GlobalStats.flush();
        }
      } catch(e){}

      // –ù–µ–≤–∏–¥–∏–º—ã–π –∞–≤—Ç–æ—Å–µ–π–≤ –≤ –æ–±–ª–∞–∫–æ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è
      if (full) {
        try { backupSaveToCloudOverwriteSilent(); } catch(e){}
      }
    }

    if (opts.ended) this.lastStart = null;
  },

  onLikedCountChanged(cnt) {
    if (!this.active) return;
    StatsStore.s.likedCount = cnt;
    StatsStore.save();
  }
};
// ==== SessionManager (–≠—Ç–∞–ø 3) ====
// –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ ‚Äú—Å–µ—Å—Å–∏—é‚Äù (—Ä–∞–∑—Ä—ã–≤ >30 –º–∏–Ω—É—Ç), –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –æ–∫–Ω–∞ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∞—á–∏–≤–æ–∫.
const SESSION_GAP_MS = 30 * 60 * 1000;
const FAVORITES_WINDOW_MS = 2 * 60 * 60 * 1000;  // 2 —á–∞—Å–∞
const ALBUM_SESSION_LIMIT_MS = 4 * 60 * 60 * 1000; // 4 —á–∞—Å–∞

const Session = {
  id: null,
  startedAt: 0,
  lastActiveAt: 0,
  // ‚Äú–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ‚Äî –ø–æ –ø–æ—Ä—è–¥–∫—É‚Äù
  favOrderedRun: [],        // –º–∞—Å—Å–∏–≤ –∏–Ω–¥–µ–∫—Å–æ–≤ –ø–æ–¥—Ä—è–¥
  // ‚Äú–ê–ª—å–±–æ–º –ø–æ –ø–æ—Ä—è–¥–∫—É –≤ –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏‚Äù
  albumExpected: 0,         // –∂–¥—ë–º 0..15
  albumFirstAt: 0,          // –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  // ‚Äú–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ‚Äî –≤–ø–µ—Ä–µ–º–µ—à–∫—É‚Äù (–æ–∫–Ω–æ 2 —á–∞—Å–∞)
  favShuffleEvents: [],     // [{ts, trackIndex}]
  favShuffleWindowStart: 0,
  // ‚Äú–ü–æ–ª–Ω–æ—á–Ω—ã–π —Ü–∏–∫–ª‚Äù
  midnightTriple: { trackIndex: null, count: 0 },

  reset(now = Date.now()) {
    this.id = crypto.randomUUID();
    this.startedAt = now;
    this.lastActiveAt = now;

    this.favOrderedRun = [];
    this.albumExpected = 0;
    this.albumFirstAt = now;

    this.favShuffleEvents = [];
    this.favShuffleWindowStart = 0;

    this.midnightTriple = { trackIndex: null, count: 0 };
  },

  ensureSession(now) {
    if (!this.id) this.reset(now);
    if (now - this.lastActiveAt > SESSION_GAP_MS) this.reset(now);
  },

  onStart({ trackIndex, ts }) {
    this.ensureSession(ts);
    this.lastActiveAt = ts;

    // –°–µ–∫—Ä–µ—Ç–∫–∞ 11:11 (—Å—Ç–∞—Ä—Ç)
    if (isBetweenLocalTime(ts, '11:11:00', '11:11:30')) {
      Ach.unlock('exact_time_11_11');
    }
    // –ü–æ–ª–Ω–æ—á–Ω–æ–µ –æ–∫–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º/—Å–±—Ä–∞—Å—ã–≤–∞–µ–º
    if (!isBetweenLocalTime(ts, '00:00:00', '00:30:00')) {
      this.midnightTriple = { trackIndex: null, count: 0 };
    }
  },

  onListenStop({ trackIndex, ts, listenedMs, durationMs, ended, flags }) {
    this.ensureSession(ts);
    this.lastActiveAt = ts;

    const valid = isValidListen(listenedMs, ended);
    const full  = isFullListen(listenedMs, durationMs, ended);
    if (!valid && !full) return;

    const S = StatsStore.s;

    // ===== –°–ª–æ–∂–Ω—ã–µ –∞—á–∏–≤–∫–∏ =====

    // 1) –¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ‚Äî –ø–æ –ø–æ—Ä—è–¥–∫—É (–≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏)
    // –£—Å–ª–æ–≤–∏—è: favoritesOnly=true, shuffle=false, full=true, —Ç—Ä–µ–∫–∏ –∏–¥—É—Ç –≤ –∞–ª—å–±–æ–º–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ –±–µ–∑ –∏–Ω—ã—Ö –º–µ–∂–¥—É.
    if (flags.favoritesOnly && !flags.shuffle && full && flags.isFavoriteNow) {
      if (this.favOrderedRun.length === 0) {
        // –Ω–∞—á–∏–Ω–∞–µ–º —Å —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞: –¥–æ–ø—É—Å–∫–∞–µ–º —Å—Ç–∞—Ä—Ç –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å 0 ‚Äî –Ω–æ –Ω—É–∂–µ–Ω —Å—Ç—Ä–æ–≥–∏–π —Ä–æ—Å—Ç
        this.favOrderedRun = [trackIndex];
      } else {
        const last = this.favOrderedRun[this.favOrderedRun.length - 1];
        if (trackIndex === last + 1) {
          this.favOrderedRun.push(trackIndex);
        } else {
          // —Å–±—Ä–æ—Å, –µ—Å–ª–∏ –Ω–∞—Ä—É—à–µ–Ω–æ
          this.favOrderedRun = [trackIndex];
        }
      }
      if (this.favOrderedRun.length >= 5) {
        Ach.unlock('favorites_order_5_full');
      }
    } else {
      // –µ—Å–ª–∏ –≤—ã—à–ª–∏ –∏–∑ —Ä–µ–∂–∏–º–∞ ‚Äî —Å–±—Ä–æ—Å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
      if (!flags.favoritesOnly || flags.shuffle || !flags.isFavoriteNow) {
        this.favOrderedRun = [];
      }
    }

    // 2) –¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ‚Äî –≤–ø–µ—Ä–µ–º–µ—à–∫—É (–æ–∫–Ω–æ 2 —á–∞—Å–∞, –±–µ–∑ –æ–±—ã—á–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤)
    // –£—Å–ª–æ–≤–∏—è: favoritesOnly=true, shuffle=true, full=true, >=5 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –∑–∞ 2 —á–∞—Å–∞.
    if (flags.favoritesOnly && flags.shuffle) {
      const cutoff = ts - FAVORITES_WINDOW_MS;

      // –µ—Å–ª–∏ –≤ –æ–∫–Ω–µ —Å–ª—É—á–∏–ª—Å—è –≤–∞–ª–∏–¥–Ω—ã–π –ù–ï –∏–∑–±—Ä–∞–Ω–Ω—ã–π ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –æ–∫–Ω–æ
      if (valid && !flags.isFavoriteNow) {
        this.favShuffleEvents = [];
        this.favShuffleWindowStart = 0;
      } else if (full && flags.isFavoriteNow) {
        // –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ
        this.favShuffleEvents.push({ ts, trackIndex });
        // —á–∏—Å—Ç–∏–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ
        this.favShuffleEvents = this.favShuffleEvents.filter(e => e.ts >= cutoff);
        // –º–µ—Ç–∫–∞ —Å—Ç–∞—Ä—Ç–∞ –æ–∫–Ω–∞
        if (!this.favShuffleWindowStart || this.favShuffleWindowStart < cutoff) {
          this.favShuffleWindowStart = ts;
        }
        // —Å—á–∏—Ç–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ
        const uniq = new Set(this.favShuffleEvents.map(e => e.trackIndex));
        if (uniq.size >= 5) {
          Ach.unlock('favorites_shuffle_5_full');
        }
      }
    } else {
      // –≤—ã—à–ª–∏ –∏–∑ —Ä–µ–∂–∏–º–∞ ‚Äî –æ–∫–Ω–æ —Å—Ç–∏—Ä–∞–µ–º
      this.favShuffleEvents = [];
      this.favShuffleWindowStart = 0;
    }

    // 3) –ê–ª—å–±–æ–º –ø–æ –ø–æ—Ä—è–¥–∫—É –≤ –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏ (–∫–∞–∂–¥—ã–π ‚â•60%), –æ–±—â–µ–µ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ‚â§4 —á–∞—Å–∞
    if (durationMs > 0 && listenedMs >= 0.6 * durationMs) {
      // –µ—Å–ª–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–∞—Å—å ‚Äî –ø–æ—Å—Ç–∞–≤–∏–º ‚Äú–ø–µ—Ä–≤—ã–π –º–æ–º–µ–Ω—Ç‚Äù
      if (this.albumExpected === 0) {
        this.albumFirstAt = ts;
      }
      const withinLimit = (ts - this.albumFirstAt) <= ALBUM_SESSION_LIMIT_MS;
      if (trackIndex === this.albumExpected && withinLimit) {
        this.albumExpected += 1;
        if (this.albumExpected === 16) {
          Ach.unlock('album_in_order_session');
          // –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è ‚Äî —Å–±—Ä–æ—Å, —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—å —Å–Ω–æ–≤–∞ —Å–ª—É—á–∞–π–Ω–æ
          this.albumExpected = 0;
          this.albumFirstAt = ts;
        }
      } else {
        // —Å–±—Ä–æ—Å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏; –Ω–∞—á–Ω—ë–º –∑–∞–Ω–æ–≤–æ, –µ—Å–ª–∏ —ç—Ç–æ—Ç —Ç—Ä–µ–∫ ‚Äî 0‚Äë–π
        this.albumExpected = (trackIndex === 0) ? 1 : 0;
        this.albumFirstAt = ts;
      }
    }

    // 4) –ü–æ–ª–Ω–æ—á–Ω—ã–π —Ü–∏–∫–ª (00:00‚Äì00:30): –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Ç—Ä–µ–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é 3 —Ä–∞–∑–∞ –ø–æ–¥—Ä—è–¥
    if (full && isBetweenLocalTime(ts, '00:00:00', '00:30:00')) {
      if (this.midnightTriple.trackIndex === null || this.midnightTriple.trackIndex === trackIndex) {
        this.midnightTriple.trackIndex = trackIndex;
        this.midnightTriple.count += 1;
        if (this.midnightTriple.count >= 3) {
          Ach.unlock('midnight_triple');
        }
      } else {
        // –¥—Ä—É–≥–æ–π —Ç—Ä–µ–∫ ‚Äî –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–Ω–æ–≤–æ —Å 1
        this.midnightTriple = { trackIndex, count: 1 };
      }
    }

    // 5) ‚Äú–í–µ—Å—å –∞–ª—å–±–æ–º‚Äù –∑–∞ 7√ó24—á (–ª—é–±–æ–π –ø–æ—Ä—è–¥–æ–∫, –≤–∞–ª–∏–¥–Ω—ã–µ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è)
    if (valid) {
      S._last7 = S._last7 || [];
      S._last7.push({ ts, trackIndex });
      const cutoff7 = ts - 7*24*60*60*1000;
      S._last7 = S._last7.filter(e => e.ts >= cutoff7);
      const set = new Set(S._last7.map(e => e.trackIndex));
      if (set.size === 16) {
        Ach.unlock('album_any_order_7d');
      }
    }

    // 6) Weekend Warrior: –≤–∞–ª–∏–¥–Ω—ã–µ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –∏ –≤ —Å—É–±–±–æ—Ç—É, –∏ –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –æ–¥–Ω–æ–π ISO‚Äë–Ω–µ–¥–µ–ª–∏
    if (valid && isWeekendLocal(ts)) {
      S._weeks = S._weeks || {}; // id -> {sat:bool, sun:bool}
      const id = getISOWeekId(ts);
      const wd = new Date(ts).getDay(); // 6=Sat, 0=Sun
      S._weeks[id] = S._weeks[id] || { sat:false, sun:false };
      if (wd === 6) S._weeks[id].sat = true;
      if (wd === 0) S._weeks[id].sun = true;
      if (S._weeks[id].sat && S._weeks[id].sun) {
        Ach.unlock('weekend_warrior');
      }
    }

    // 7) Weekend Album: –≤—Å–µ 16 –≤–∞–ª–∏–¥–Ω—ã—Ö –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ–¥–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è
    if (valid && isWeekendLocal(ts)) {
      const dayKey = localDayKey(ts);
      S._weekendDay = S._weekendDay || {}; // YYYY-MM-DD -> Set
      if (!S._weekendDay[dayKey]) S._weekendDay[dayKey] = new Set();
      S._weekendDay[dayKey].add(trackIndex);
      if (S._weekendDay[dayKey].size === 16) {
        Ach.unlock('weekend_album');
      }
    }
  }
};

// ==== –†–µ–µ—Å—Ç—Ä –∞—á–∏–≤–æ–∫ (–≠—Ç–∞–ø 2) ====
const ACH_META = {
  // Tier 1
  play_first:{
    tier:1, core:true,  title:'–ü–µ—Ä–≤–æ–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ',
    short:'–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ª—é–±–æ–π —Ç—Ä–µ–∫.',
    desc:'–ü–µ—Ä–≤—ã–π –≤–∞–ª–∏–¥–Ω—ã–π –∑–∞–ø—É—Å–∫ –ª—é–±–æ–≥–æ —Ç—Ä–µ–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.',
    howTo:'–ù–∞–∂–º–∏—Ç–µ Play –∏ –¥–æ—Å–ª—É—à–∞–π—Ç–µ —Ö–æ—Ç—è –±—ã 13 —Å–µ–∫—É–Ω–¥ (–∏–ª–∏ –¥–æ –∫–æ–Ω—Ü–∞).'
  },
  unique_5_tracks:{
    tier:1, core:true, title:'–†–∞–∑–Ω—ã–π –≤–∫—É—Å',
    short:'–ü–æ—Å–ª—É—à–∞–π—Ç–µ 5 —Ä–∞–∑–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤.',
    desc:'–ó–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω–æ–µ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ 5 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤.',
    howTo:'–í–∫–ª—é—á–∞–π—Ç–µ —Ä–∞–∑–Ω—ã–µ —Ç—Ä–µ–∫–∏ –∏ —Å–ª—É—à–∞–π—Ç–µ ‚â•13 —Å–µ–∫ –∫–∞–∂–¥—ã–π (–∏–ª–∏ –¥–æ –∫–æ–Ω—Ü–∞).'
  },
  fav_3:{
    tier:1, core:false, title:'–ü–µ—Ä–≤—ã–µ –ª—é–±–∏–º—á–∏–∫–∏',
    short:'–î–æ–±–∞–≤—å—Ç–µ 3 —Ç—Ä–µ–∫–∞ –≤ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ.',
    desc:'–ß–µ–º –±–æ–ª—å—à–µ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö ‚Äî —Ç–µ–º –±–æ–≥–∞—á–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.',
    howTo:'–ù–∞–∂–∏–º–∞–π—Ç–µ –Ω–∞ –∑–≤—ë–∑–¥–æ—á–∫—É —Å–ø—Ä–∞–≤–∞ –æ—Ç —Ç—Ä–µ–∫–∞, –ø–æ–∫–∞ –∏—Ö –Ω–µ —Å—Ç–∞–Ω–µ—Ç 3.'
  },
  early_bird:{
    tier:1, core:false, title:'–†–∞–Ω–Ω—è—è –ø—Ç–∞—à–∫–∞',
    short:'–°–ª—É—à–∞–π—Ç–µ —É—Ç—Ä–æ–º.',
    desc:'–í–∞–ª–∏–¥–Ω–æ–µ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –≤ –æ–∫–Ω–µ 05:00‚Äì07:00 (–ø–æ –≤–∞—à–µ–º—É –≤—Ä–µ–º–µ–Ω–∏).',
    howTo:'–ó–∞–ø–ª–∞–Ω–∏—Ä—É–π—Ç–µ —É—Ç—Ä–µ–Ω–Ω–µ–µ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –∏ –≤–∫–ª—é—á–∏—Ç–µ –ª—é–±–æ–π —Ç—Ä–µ–∫.'
  },
  night_listener:{
    tier:1, core:false, title:'–ù–æ—á–Ω–æ–π —Å–ª—É—à–∞—Ç–µ–ª—å',
    short:'–°–ª—É—à–∞–π—Ç–µ –Ω–æ—á—å—é.',
    desc:'–í–∞–ª–∏–¥–Ω–æ–µ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –≤ –æ–∫–Ω–µ 02:00‚Äì04:30.',
    howTo:'–í–∫–ª—é—á–∏—Ç–µ —Ç—Ä–µ–∫ –ø–æ–∑–¥–Ω–æ –Ω–æ—á—å—é –∏ —Å–ª—É—à–∞–π—Ç–µ ‚â•13 —Å–µ–∫.'
  },
  backup_first:{
    tier:1, core:true, title:'–ë–µ—Ä–µ–∂—ë–Ω–æ–≥–æ –±–µ—Ä–µ–∂—ë—Ç',
    short:'–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –±—ç–∫–∞–ø –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π.',
    desc:'–ü–µ—Ä–≤–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏.',
    howTo:'–ù–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π¬ª –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ JSON –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.'
  },

  // Tier 2
  time_listened_1h:{
    tier:2, core:true, title:'–ß–∞—Å –≤ –Ω–∞—É—à–Ω–∏–∫–∞—Ö',
    short:'–ù–∞–∫–æ–ø–∏—Ç–µ 60 –º–∏–Ω—É—Ç –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è.',
    desc:'–°—É–º–º–∞—Ä–Ω–æ–µ –≤–∞–ª–∏–¥–Ω–æ–µ –≤—Ä–µ–º—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è ‚Äî 3600 —Å–µ–∫—É–Ω–¥.',
    howTo:'–°–ª—É—à–∞–π—Ç–µ –∞–ª—å–±–æ–º, –≤—Ä–µ–º—è —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –≤–∞–ª–∏–¥–Ω—ã—Ö –æ—Å—Ç–∞–Ω–æ–≤–∫–∞—Ö.'
  },
  play_25_total:{
    tier:2, core:true, title:'–ù–∞ –ø–æ–≤—Ç–æ—Ä–µ',
    short:'–°–æ–±–µ—Ä–∏—Ç–µ 25 –≤–∞–ª–∏–¥–Ω—ã—Ö –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π.',
    desc:'–õ—é–±—ã–µ —Ç—Ä–µ–∫–∏, –≥–ª–∞–≤–Ω–æ–µ ‚Äî –≤–∞–ª–∏–¥–Ω—ã–µ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è.',
    howTo:'–ù–µ –ø—Ä–æ–∫–ª–∏–∫–∏–≤–∞–π—Ç–µ –±—ã—Å—Ç—Ä–æ. –ó–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è ‚â•13 —Å–µ–∫ –∏–ª–∏ –∫–æ–Ω–µ—Ü —Ç—Ä–µ–∫–∞.'
  },
  full_play_first:{
    tier:2, core:true, title:'–î–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –Ω–æ—Ç—ã',
    short:'–î–æ—Å–ª—É—à–∞–π—Ç–µ —Ç—Ä–µ–∫ –¥–æ –∫–æ–Ω—Ü–∞.',
    desc:'–ü–µ—Ä–≤–æ–µ –ø–æ–ª–Ω–æ–µ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ (–∏–ª–∏ ‚â•90% –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏).',
    howTo:'–í–∫–ª—é—á–∏—Ç–µ —Ç—Ä–µ–∫ –∏ –¥–æ—Å–ª—É—à–∞–π—Ç–µ –¥–æ –∫–æ–Ω—Ü–∞ ‚Äî –±—É–¥–µ—Ç –∑–∞—Å—á–∏—Ç–∞–Ω–æ.'
  },
  streak_3:{
    tier:2, core:true, title:'3 –¥–Ω—è –ø–æ–¥—Ä—è–¥',
    short:'–°–ª—É—à–∞–π—Ç–µ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å 3 –¥–Ω—è –ø–æ–¥—Ä—è–¥.',
    desc:'–•–æ—Ç—è –±—ã –æ–¥–Ω–æ –≤–∞–ª–∏–¥–Ω–æ–µ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –≤ —Å—É—Ç–∫–∏, 3 –¥–Ω—è –ø–æ–¥—Ä—è–¥.',
    howTo:'–û—Ç–∫—Ä—ã–≤–∞–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ —Å–ª—É—à–∞–π—Ç–µ –ø–æ –æ–¥–Ω–æ–º—É —Ç—Ä–µ–∫—É –≤ –¥–µ–Ω—å.'
  },
  fav_5:{
    tier:2, core:true, title:'–ú–æ–π –ø–ª–µ–π–ª–∏—Å—Ç',
    short:'–î–æ–±–∞–≤—å—Ç–µ 5 —Ç—Ä–µ–∫–æ–≤ –≤ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ.',
    desc:'–ò–∑–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–º–æ–≥–∞—é—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å ¬´—Ç–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª —á–µ–ª–ª–µ–Ω–¥–∂–∏.',
    howTo:'–û—Ç–º–µ—Ç—å—Ç–µ –∑–≤—ë–∑–¥–æ—á–∫–æ–π –µ—â—ë —Ç—Ä–µ–∫–∏ –¥–æ 5 —à—Ç—É–∫ –º–∏–Ω–∏–º—É–º.'
  },
  use_shuffle_5:{
    tier:2, core:false, title:'–í —Å–ª—É—á–∞–π–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ',
    short:'5 –≤–∞–ª–∏–¥–Ω—ã—Ö –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π –≤ —Ä–µ–∂–∏–º–µ Shuffle.',
    desc:'–°–ª—É—à–∞–π—Ç–µ —Å –≤–∫–ª—é—á—ë–Ω–Ω—ã–º —Å–ª—É—á–∞–π–Ω—ã–º –ø–æ—Ä—è–¥–∫–æ–º.',
    howTo:'–ù–∞–∂–º–∏—Ç–µ ¬´U¬ª –∏–ª–∏ –∫–Ω–æ–ø–∫—É Shuffle –∏ —Å–ª—É—à–∞–π—Ç–µ —Ç—Ä–µ–∫–∏.'
  },

  // Tier 3
  unique_10_tracks:{
    tier:3, core:true, title:'–ü–æ–ª–æ–≤–∏–Ω–∞ –∞–ª—å–±–æ–º–∞',
    short:'–ü–æ—Å–ª—É—à–∞–π—Ç–µ 10 —Ä–∞–∑–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤.',
    desc:'10 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ —Å –≤–∞–ª–∏–¥–Ω—ã–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ–º.',
    howTo:'–û—Ç–∫—Ä–æ–π—Ç–µ –∏ —Å–ª—É—à–∞–π—Ç–µ —Ä–∞–∑–Ω—ã–µ —Ç—Ä–µ–∫–∏, –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—è—Å—å.'
  },
  full_10_total:{
    tier:3, core:true, title:'–í–µ—Ä–Ω–æ–µ —É—Ö–æ',
    short:'10 –ø–æ–ª–Ω—ã—Ö –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π –ª—é–±—ã—Ö —Ç—Ä–µ–∫–æ–≤.',
    desc:'–ü–æ–ª–Ω–æ–µ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ ‚Äî –¥–æ –∫–æ–Ω—Ü–∞ –∏–ª–∏ ‚â•90% –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.',
    howTo:'–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é –∏ –¥–æ—Å–ª—É—à–∏–≤–∞–π—Ç–µ —Ç—Ä–µ–∫–∏.'
  },
  streak_7:{
    tier:3, core:true, title:'–ù–µ–¥–µ–ª—å–Ω—ã–π —Å—Ç—Ä–∏–∫',
    short:'–°–ª—É—à–∞–π—Ç–µ 7 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥.',
    desc:'–ö–∞–∂–¥—ã–π –¥–µ–Ω—å ‚Äî —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –≤–∞–ª–∏–¥–Ω–æ–µ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ.',
    howTo:'–ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤–∫–ª—é—á–∞–π—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç—Ä–µ–∫.'
  },
  favorites_order_5_full:{
    tier:3, core:true, title:'–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ‚Äî –ø–æ –ø–æ—Ä—è–¥–∫—É',
    short:'5 –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–¥—Ä—è–¥, –∫–∞–∂–¥—ã–π –ø–æ–ª–Ω–æ—Å—Ç—å—é, –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤.',
    desc:'–í–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º ¬´—Ç–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ¬ª, –±–µ–∑ Shuffle.',
    howTo:'–û—Ç–º–µ—Ç—å—Ç–µ ‚â•5 —Ç—Ä–µ–∫–æ–≤ –∑–≤—ë–∑–¥–æ—á–∫–æ–π, –≤–∫–ª—é—á–∏—Ç–µ ¬´—Ç–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ¬ª –∏ —Å–ª—É—à–∞–π—Ç–µ 5 –ø–æ–¥—Ä—è–¥ –≤ –∞–ª—å–±–æ–º–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.'
  },
  favorites_shuffle_5_full:{
    tier:3, core:true, title:'–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ‚Äî –≤–ø–µ—Ä–µ–º–µ—à–∫—É',
    short:'5 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞ 2 —á–∞—Å–∞.',
    desc:'–†–µ–∂–∏–º ¬´—Ç–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ¬ª + Shuffle. –ë–µ–∑ –æ–±—ã—á–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ –≤ –æ–∫–Ω–µ.',
    howTo:'–í–∫–ª—é—á–∏—Ç–µ ¬´—Ç–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ¬ª –∏ Shuffle. –°–ª—É—à–∞–π—Ç–µ 5 —Ä–∞–∑–Ω—ã—Ö –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ —Ç–µ—á–µ–Ω–∏–µ 2 —á–∞—Å–æ–≤.'
  },
  weekend_warrior:{
    tier:3, core:false, title:'–í—ã—Ö–æ–¥–Ω—ã–µ —Å –º—É–∑—ã–∫–æ–π',
    short:'–í–∞–ª–∏–¥–Ω–æ –ø–æ—Å–ª—É—à–∞–π—Ç–µ –≤ —Å—É–±–±–æ—Ç—É –∏ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –æ–¥–Ω–æ–π –Ω–µ–¥–µ–ª–∏.',
    desc:'–í –æ–∫–Ω–µ –æ–¥–Ω–æ–π ISO‚Äë–Ω–µ–¥–µ–ª–∏ –¥–æ–±–∏—Ç—å—Å—è activity –≤ –æ–±–∞ –≤—ã—Ö–æ–¥–Ω—ã—Ö.',
    howTo:'–°–ª—É—à–∞–π—Ç–µ –≤ —Å—É–±–±–æ—Ç—É –∏ –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ. –õ—é–±—ã–µ —Ç—Ä–µ–∫–∏.'
  },

  // Tier 4
  album_any_order_7d:{
    tier:4, core:true, title:'–í–µ—Å—å –∞–ª—å–±–æ–º',
    short:'–í—Å–µ 16 —Ç—Ä–µ–∫–æ–≤ –∑–∞ 7 –¥–Ω–µ–π (–ª—é–±–æ–π –ø–æ—Ä—è–¥–æ–∫).',
    desc:'–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–æ–ø–∏—Ç—Å—è –≤ —Å–∫–æ–ª—å–∑—è—â–µ–º –æ–∫–Ω–µ 7√ó24—á.',
    howTo:'–ó–∞ –Ω–µ–¥–µ–ª—é –ø–æ—Å–ª—É—à–∞–π—Ç–µ –≤–∞–ª–∏–¥–Ω–æ –∫–∞–∂–¥—ã–π —Ç—Ä–µ–∫ —Ö–æ—Ç—è –±—ã —Ä–∞–∑.'
  },
  album_in_order_session:{
    tier:4, core:true, title:'–û—Ç –ø–µ—Ä–≤–æ–π –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π',
    short:'–í—Å–µ 16 –ø–æ –ø–æ—Ä—è–¥–∫—É, –≤ –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏, –∫–∞–∂–¥—ã–π ‚â•60%.',
    desc:'–û–±—â–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ‚â§4 —á–∞—Å–∞.',
    howTo:'–ù–∞—á–Ω–∏—Ç–µ —Å 1 —Ç—Ä–µ–∫–∞ –∏ –¥–≤–∏–≥–∞–π—Ç–µ—Å—å –ø–æ –ø–æ—Ä—è–¥–∫—É. –ù–µ –¥–µ–ª–∞–π—Ç–µ –±–æ–ª—å—à–∏–µ –ø–∞—É–∑—ã.'
  },
  time_listened_5h:{
    tier:4, core:false, title:'5 —á–∞—Å–æ–≤ –º—É–∑—ã–∫–∏',
    short:'–ù–∞–∫–æ–ø–∏—Ç–µ 5 —á–∞—Å–æ–≤ –≤–∞–ª–∏–¥–Ω–æ–≥–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è.',
    desc:'–°—É–º–º–∞ —Å–µ–∫—É–Ω–¥ –ø–æ –≤—Å–µ–º —Ç—Ä–µ–∫–∞–º.',
    howTo:'–°–ª—É—à–∞–π—Ç–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ, –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—è —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ.'
  },
  play_100_total:{
    tier:4, core:false, title:'–í –ø–æ—Ç–æ–∫–µ',
    short:'100 –≤–∞–ª–∏–¥–Ω—ã—Ö –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π.',
    desc:'–õ—é–±—ã–µ —Ç—Ä–µ–∫–∏ ‚Äî –≥–ª–∞–≤–Ω–æ–µ –≤–∞–ª–∏–¥–Ω–æ–µ –≤—Ä–µ–º—è.',
    howTo:'–ò–≥—Ä–∞–π—Ç–µ –ø–ª–µ–π–ª–∏—Å—Ç, –º–æ–∂–Ω–æ —Å Shuffle.'
  },
  fav_8:{
    tier:4, core:false, title:'–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä',
    short:'–û—Ç–º–µ—Ç—å—Ç–µ 8 –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö.',
    desc:'–®–∏—Ä–æ–∫–∏–π –ø—É–ª –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –±–æ–ª—å—à–µ —á–µ–ª–ª–µ–Ω–¥–∂–µ–π.',
    howTo:'–ü–æ—Å—Ç–∞–≤—å—Ç–µ –∑–≤—ë–∑–¥–æ—á–∫—É –Ω–∞ 8 —Ç—Ä–µ–∫–∞—Ö.'
  },
  socials_all_visited:{
    tier:4, core:false, title:'–ü–æ–¥–ø–∏—Å—á–∏–∫ –≤—Å–µ–≥–æ',
    short:'–û—Ç–∫—Ä–æ–π—Ç–µ –≤—Å–µ —Å–æ—Ü—Å–µ—Ç–∏ –∏–∑ —à–∞–ø–∫–∏.',
    desc:'–û–¥–Ω–∞–∂–¥—ã –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞–∂–¥–æ–º—É –∏–∑ —Å—Å—ã–ª–æ–∫ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π.',
    howTo:'–ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ –≤—Å–µ–º —Å—Å—ã–ª–∫–∞–º –≤ –±–ª–æ–∫–µ –ø–æ–¥ –æ–±–ª–æ–∂–∫–æ–π.'
  },
  sleep_timer_5:{
    tier:4, core:false, title:'–ë–µ—Ä–µ–∂–Ω—ã–π —Å–æ–Ω',
    short:'–¢–∞–π–º–µ—Ä —Å–Ω–∞ —Å—Ä–∞–±–æ—Ç–∞–ª 5 —Ä–∞–∑.',
    desc:'–£—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —É—Å–ø–µ—à–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è sleep‚Äë—Ç–∞–π–º–µ—Ä–∞.',
    howTo:'–ó–∞–¥–∞–π—Ç–µ —Ç–∞–π–º–µ—Ä –≤ –∫–æ–Ω—Ç—Ä–æ–ª–∞—Ö –ø–ª–µ–µ—Ä–∞ –∏ –¥–æ–∂–¥–∏—Ç–µ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.'
  },
  pwa_installed:{
    tier:4, core:false, title:'–ù–∞ –º–æ—ë–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ',
    short:'–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–∞–∫ PWA.',
    desc:'–°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ —Å–æ–±—ã—Ç–∏–∏ appinstalled.',
    howTo:'–ù–∞–∂–º–∏—Ç–µ ‚Äú–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ‚Äù –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É.'
  },

  // Tier 5
  full_50_total:{
    tier:5, core:false, title:'–£–≤–∞–∂–µ–Ω–∏–µ –∫ –¥–µ—Ç–∞–ª—è–º',
    short:'50 –ø–æ–ª–Ω—ã—Ö –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π.',
    desc:'–õ—é–±—ã–µ —Ç—Ä–µ–∫–∏, –¥–æ—Å–ª—É—à–∞–Ω–Ω—ã–µ –¥–æ –∫–æ–Ω—Ü–∞.',
    howTo:'–î–æ—Å–ª—É—à–∏–≤–∞–π—Ç–µ —Ç—Ä–µ–∫–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é ‚Äî —ç—Ç–æ –∑–∞—á—Ç—ë—Ç—Å—è.'
  },
  play_500_total:{
    tier:5, core:false, title:'–ü–æ–ª—Ç—ã—Å—è—á–∏',
    short:'500 –≤–∞–ª–∏–¥–Ω—ã—Ö –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π.',
    desc:'–î–æ–ª–≥–∏–π –ø—É—Ç—å ‚Äî –Ω–æ –≤—ã–ø–æ–ª–Ω–∏–º—ã–π!',
    howTo:'–°–ª—É—à–∞–π—Ç–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Shuffle.'
  },
  one_track_full_25:{
    tier:5, core:false, title:'–õ—é–±–∏–º–µ–π—à–∏–π',
    short:'–û–¥–∏–Ω —Ç—Ä–µ–∫ 25 —Ä–∞–∑ –ø–æ–ª–Ω–æ—Å—Ç—å—é.',
    desc:'–ü–æ–¥—á—ë—Ä–∫–∏–≤–∞–µ—Ç ¬´—Å—É–ø–µ—Ä‚Äë–ª—é–±–∏–º–æ–≥–æ¬ª.',
    howTo:'–í—ã–±–µ—Ä–∏—Ç–µ –ª—é–±–∏–º—ã–π —Ç—Ä–µ–∫ –∏ –≤–∫–ª—é—á–∞–π—Ç–µ –µ–≥–æ –¥–æ –∫–æ–Ω—Ü–∞ 25 —Ä–∞–∑.'
  },
  one_track_full_100:{
    tier:5, core:false, title:'–ê–±—Å–æ–ª—é—Ç–Ω—ã–π —Ñ–∞–≤–æ—Ä–∏—Ç',
    short:'–û–¥–∏–Ω —Ç—Ä–µ–∫ 100 —Ä–∞–∑ –ø–æ–ª–Ω–æ—Å—Ç—å—é.',
    desc:'–í—ã—Å—à–∞—è –ø—Ä–µ–¥–∞–Ω–Ω–æ—Å—Ç—å –æ–¥–Ω–æ–º—É —Ç—Ä–µ–∫—É.',
    howTo:'–¢–æ –∂–µ, —á—Ç–æ –≤—ã—à–µ, –Ω–æ –¥–æ 100.'
  },
  streak_14:{
    tier:5, core:false, title:'–î–≤–µ –Ω–µ–¥–µ–ª–∏ –ø–æ–¥—Ä—è–¥',
    short:'14 –ø–æ–¥—Ä—è–¥ –¥–Ω–µ–π —Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é.',
    desc:'–ö–∞–∂–¥—ã–π –¥–µ–Ω—å ‚Äî —Å–ª—É—à–∞–π—Ç–µ —Ö–æ—Ç—è –±—ã –ø–æ –æ–¥–Ω–æ–º—É —Ç—Ä–µ–∫—É.',
    howTo:'–ù–µ –ø—Ä–µ—Ä—ã–≤–∞–π—Ç–µ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Ä–∏—Ç–º.'
  },
  streak_30:{
    tier:5, core:false, title:'–ú–µ—Å—è—Ü –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤',
    short:'30 –ø–æ–¥—Ä—è–¥ –¥–Ω–µ–π.',
    desc:'–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π ¬´—Å—Ç—Ä–∏–∫¬ª –∏–∑ —Ç–∏–ø–æ–≤—ã—Ö.',
    howTo:'–ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤–∫–ª—é—á–∞–π—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç—Ä–µ–∫.'
  },

  // Tier 6 (—Å–µ–∫—Ä–µ—Ç–Ω—ã–µ)
  exact_time_11_11:{
    tier:6, core:false, hidden:true, title:'11:11',
    short:'–ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤ 11:11.',
    desc:'–°–µ–∫—Ä–µ—Ç–Ω–∞—è –æ—Ç—Å—ã–ª–∫–∞.',
    howTo:'–í–∫–ª—é—á–∏—Ç–µ —Ç—Ä–µ–∫ –≤ –ø—Ä–æ–º–µ–∂—É—Ç–∫–µ 11:11:00‚Äì11:11:30.'
  },
  midnight_triple:{
    tier:6, core:false, hidden:true, title:'–ü–æ–ª–Ω–æ—á–Ω—ã–π —Ü–∏–∫–ª',
    short:'–û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Ç—Ä–µ–∫ —Ç—Ä–∏ —Ä–∞–∑–∞ –ø–æ–¥—Ä—è–¥ –≤ 00:00‚Äì00:30.',
    desc:'–°–ª–æ–∂–Ω—ã–π –Ω–æ—á–Ω–æ–π —á–µ–ª–ª–µ–Ω–¥–∂.',
    howTo:'–ó–∞–ø—É—Å–∫–∞–π—Ç–µ –æ–¥–∏–Ω —Ç—Ä–µ–∫ —Ç—Ä–∏ —Ä–∞–∑–∞ –¥–æ –∫–æ–Ω—Ü–∞ –≤ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø—Ä–æ–º–µ–∂—É—Ç–æ–∫.'
  },
  weekend_album:{
    tier:6, core:false, hidden:true, title:'–í—ã—Ö–æ–¥–Ω–æ–π –º–∞—Ä–∞—Ñ–æ–Ω',
    short:'–í—Å–µ 16 –∑–∞ –æ–¥–∏–Ω –≤—ã—Ö–æ–¥–Ω–æ–π.',
    desc:'–õ—é–±–æ–π –ø–æ—Ä—è–¥–æ–∫, –Ω–æ –æ–¥–∏–Ω –¥–µ–Ω—å: –°–± –∏–ª–∏ –í—Å.',
    howTo:'–í —Ç–µ—á–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è –≤–∞–ª–∏–¥–Ω–æ –ø–æ—Å–ª—É—à–∞–π—Ç–µ –≤—Å–µ —Ç—Ä–µ–∫–∏.'
  },

  // Backup
  backup_3_days:{
    tier:4, core:false, title:'–ó–∞–ø–∞—Å–ª–∏–≤—ã–π',
    short:'–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –±—ç–∫–∞–ø –≤ 3 —Ä–∞–∑–Ω—ã–µ –¥–∞—Ç—ã.',
    desc:'–î–∞—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ, —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –¥–Ω—è.',
    howTo:'–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ñ–∞–π–ª –±—ç–∫–∞–ø–∞.'
  },
  backup_after_major:{
    tier:4, core:false, title:'–°–æ—Ö—Ä–∞–Ω–∏–ª –ø–æ—Å–ª–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞',
    short:'–°–æ–∑–¥–∞–π—Ç–µ –±—ç–∫–∞–ø –≤ —Ç–µ—á–µ–Ω–∏–µ —Å—É—Ç–æ–∫ –ø–æ—Å–ª–µ ¬´–±–æ–ª—å—à–æ–π¬ª –∞—á–∏–≤–∫–∏ (Tier‚â•3).',
    desc:'–§–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.',
    howTo:'–û—Ç–∫—Ä–æ–π—Ç–µ –∫—Ä—É–ø–Ω—É—é –∞—á–∏–≤–∫—É –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –±—ç–∫–∞–ø –≤ —ç—Ç–æ—Ç –∂–µ –¥–µ–Ω—å.'
  }
};

// ==== –î–≤–∏–∂–æ–∫ –∞—á–∏–≤–æ–∫ (–≠—Ç–∞–ø 2) ====
const Ach = {
  has(id){ return !!StatsStore.s.achievements[id]; },
  unlock(id){
    if (this.has(id)) return false;
    const meta = ACH_META[id]||{};
    StatsStore.s.achievements[id] = { unlockedAt: Date.now(), tier: meta.tier||0 };
    // –µ—Å–ª–∏ Tier >=3 ‚Äî –æ—Ç–º–µ—Ç–∏–º ‚Äúmajor‚Äù
    if ((meta.tier||0) >= 3) StatsStore.s.lastMajorAchAt = Date.now();
    StatsStore.save();
    // —Ç–æ—Å—Ç
    NotificationSystem.success(`üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: ${meta.title||id}`);
    // –æ–±–Ω–æ–≤–∏–º —à–∫–∞–ª—ã –∏ –ø–æ–¥—Å–∫–∞–∑–∫—É
    AchProgress.updateFromStats();
    // –º–∏–Ω–∏‚Äë–≤–∏–¥–∂–µ—Ç "–ø–æ—Å–ª–µ–¥–Ω—è—è –Ω–∞–≥—Ä–∞–¥–∞" –ø–æ–¥ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
    try {
      const el = document.getElementById('ach-last-earn');
      if (el) {
        el.setAttribute('aria-hidden', 'false');
        const when = new Date().toLocaleTimeString();
        el.innerHTML = `
          <div style="display:flex;align-items:center;gap:8px;">
            <span>üèÜ</span>
            <span><b>${meta.title||id}</b></span>
            <span style="color:#9aa8c4;font-size:.86em;">${when}</span>
          </div>`;
      }
    } catch(e){}
    // –∞–≤—Ç–æ–ø–æ–¥—Å–∫–∞–∑–∫–∞ –±—ç–∫–∞–ø–∞:
    // –ø–µ—Ä–≤—ã–π —Ä–∞–∑ ‚Äî –Ω–∞ 10‚Äë–º; –¥–∞–ª–µ–µ ‚Äî –Ω–∞ –∫–∞–∂–¥–æ–º >=13, —Å —É—á—ë—Ç–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è;
    // –ø–µ—Ä–µ–¥ –ø–æ—Å–ª–µ–¥–Ω–∏–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ–º ‚Äî –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑–∞—Ç—å.
    try {
      const visibleCount = getVisibleAchievementsCount();
      const allowByLevel = (visibleCount === 10 || visibleCount >= 13);
      if (allowByLevel && shouldShowBackupPrompt(visibleCount)) {
        setTimeout(openBackupPrompt, 150);
      } else {
        // –¥–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–µ—Ç–∏–ª ‚Äî –ø–µ—Ä–µ–¥ –ø–æ—Å–ª–µ–¥–Ω–∏–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ–º –≤—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å
        const totalVisible = Object.keys(ACH_META).filter(id => !ACH_META[id]?.hidden).length;
        if (visibleCount === totalVisible - 1) {
          setTimeout(openBackupPrompt, 150);
        }
      }
    } catch(e){}

    // –ù–µ–≤–∏–¥–∏–º—ã–π –∞–≤—Ç–æ—Å–µ–π–≤ –≤ –æ–±–ª–∞–∫–æ (–ø–µ—Ä–µ–∑–∞–ø–∏—Å—å)
    backupAutoSaveIfNeeded();
    try { Prize.updateLocalReadiness(); } catch(e){}

    return true;
  },
  
  // –ë—ã—Å—Ç—Ä–∞—è –≤—ã–¥–∞—á–∞ ‚Äú—Å–æ–±—ã—Ç–∏–π–Ω—ã—Ö‚Äù
  event(id){ this.unlock(id); },

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ ‚Äú–ø—Ä–æ—Å—Ç—ã—Ö‚Äù –ø–æ—Ä–æ–≥–æ–≤ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è
  evaluateAfterListen({ts}){
    const S = StatsStore.s;
    const uniq = (S.uniqueTracksPlayed||[]).length;
    const tot = S.totals || {};
    const liked = S.likedCount || 0;

    // Tier 1
    if (tot.totalValidPlays >= 1) this.unlock('play_first');
    if (uniq >= 5) this.unlock('unique_5_tracks');
    if (liked >= 3) this.unlock('fav_3');

    // —Ä–∞–Ω–Ω–∏–µ/–Ω–æ—á–Ω—ã–µ –æ–∫–Ω–∞ ‚Äî —Å—á–∏—Ç–∞–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –≤–∞–ª–∏–¥–Ω–æ–≥–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è
    const d = new Date(ts);
    const t = d.toTimeString().slice(0,8);
    if (t >= '05:00:00' && t <= '07:00:00') this.unlock('early_bird');
    if (t >= '02:00:00' && t <= '04:30:00') this.unlock('night_listener');

    // Tier 2
    if (tot.totalSeconds >= 3600) this.unlock('time_listened_1h');
    if (tot.totalValidPlays >= 25) this.unlock('play_25_total');
    if (tot.totalFullPlays >= 1) this.unlock('full_play_first');
    if ((StatsStore.s.streak?.max||0) >= 3) this.unlock('streak_3');
    if (liked >= 5) this.unlock('fav_5');
    if ((S._shuffleValid||0) >= 5) this.unlock('use_shuffle_5');

    // Tier 3
    if (uniq >= 10) this.unlock('unique_10_tracks');
    if (tot.totalFullPlays >= 10) this.unlock('full_10_total');
    if ((StatsStore.s.streak?.max||0) >= 7) this.unlock('streak_7');

    // Tier 4
    if (tot.totalSeconds >= 18_000) this.unlock('time_listened_5h');
    if (tot.totalValidPlays >= 100) this.unlock('play_100_total');
    if (liked >= 8) this.unlock('fav_8');

    // Tier 5
    if (tot.totalFullPlays >= 50) this.unlock('full_50_total');
    if (tot.totalValidPlays >= 500) this.unlock('play_500_total');

    // one_track_full_25/100 ‚Äî –ø—Ä–æ–≤–µ—Ä–∏–º –ø–µ—Ä‚Äë—Ç—Ä–µ–∫
    const pt = StatsStore.s.perTrack || [];
    for (let i=0;i<pt.length;i++){
      const f = pt[i]?.fullPlays||0;
      if (f >= 25) this.unlock('one_track_full_25');
      if (f >= 100) this.unlock('one_track_full_100');
    }

    // –í–ù–ò–ú–ê–ù–ò–ï: —Å–ª–æ–∂–Ω—ã–µ –∞—á–∏–≤–∫–∏ (favorites_order_5_full, favorites_shuffle_5_full,
    // album_in_order_session) –ø–æ–¥–∫–ª—é—á–∏–º –Ω–∞ –≠—Ç–∞–ø–µ 3 (SessionManager).
    // album_any_order_7d, weekend_warrior, weekend_album ‚Äî –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ –≠—Ç–∞–ø 3 (–æ–∫–Ω–∞/–Ω–µ–¥–µ–ª–∏).
  },

  evaluateFromLikes(){
    const liked = StatsStore.s.likedCount || 0;
    if (liked >= 3) this.unlock('fav_3');
    if (liked >= 5) this.unlock('fav_5');
    if (liked >= 8) this.unlock('fav_8');
  },

  // —É—á—ë—Ç shuffle-–≤–∞–ª–∏–¥–Ω—ã—Ö –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π (–¥–ª—è use_shuffle_5)
  incShuffleValid(){
    StatsStore.s._shuffleValid = (StatsStore.s._shuffleValid||0)+1;
    StatsStore.save();
  }
};
  
// ==== –ü—Ä–æ–≥—Ä–µ—Å—Å‚Äë–ø–∞–Ω–µ–ª—å ‚Äî –æ–¥–Ω–∞ —à–∫–∞–ª–∞ + –ø–æ–¥–ø–∏—Å—å –í–´–ü–û–õ–ù–ï–ù–û: X / Y ====
const AchProgress = {
  // —Å—á–∏—Ç–∞–µ–º ‚Äú–≤–∏–¥–∏–º—ã–µ‚Äù –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è (–±–µ–∑ —Å–∫—Ä—ã—Ç—ã—Ö)
  totalVisible: Object.keys(ACH_META).filter(id => !ACH_META[id]?.hidden).length,

  init() {
    if (!FeatureFlags.achievementsUI) return;
    this.oneFill   = document.getElementById('ach-one-fill');
    this.doneLabel = document.getElementById('ach-done-label');
    this.bubble    = document.getElementById('ach-hint-bubble');
    this.render(0, this.totalVisible);
    this.updateFromStats();
  },

  // –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ–¥–Ω–æ–π —à–∫–∞–ª—ã –∏ –ø–æ–¥–ø–∏—Å–∏
  render(done, total) {
    const pct = total > 0 ? Math.max(0, Math.min(100, Math.round((done/total)*100))) : 0;
    if (this.oneFill)   this.oneFill.style.width = pct + '%';
    if (this.doneLabel) this.doneLabel.textContent = `–í–´–ü–û–õ–ù–ï–ù–û: ${done} / ${total}`;
  },

  updateFromStats() {
    const ach = StatsStore.s.achievements || {};
    const doneVisible = Object.keys(ach).filter(id => !ACH_META[id]?.hidden).length;
    const total = this.totalVisible;
    this.render(doneVisible, total);

    // –°–ï–ö–†–ï–¢–ù–´–ï: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —ç—Ç–∞–ø –Ω–∞—á–∞—Ç
    try {
      const secretLabel = document.getElementById('ach-secret-label');
      const secretStartAtStr = localStorage.getItem('secret_start_at');
      const secretStartAt = secretStartAtStr ? parseInt(secretStartAtStr, 10) : null;
      const secretTotal = Object.keys(ACH_META).filter(id => !!ACH_META[id]?.hidden).length;
      let secretDoneFromStart = 0;

      if (secretStartAt && Number.isFinite(secretStartAt)) {
        for (const [id, info] of Object.entries(ach)) {
          if (ACH_META[id]?.hidden) {
            const t = Number(info?.unlockedAt || 0);
            if (t && t >= secretStartAt) secretDoneFromStart++;
          }
        }
        if (secretLabel) {
          secretLabel.style.display = '';
          secretLabel.textContent = `–°–ï–ö–†–ï–¢–ù–´–ï: ${secretDoneFromStart} / ${secretTotal}`;
        }
        // –ø–æ–∫–∞–∑–∞—Ç—å –≤—Ç–æ—Ä–æ–π —Ä—è–¥ –ø—Ä–∏–∑–æ–≤
        const secRow = document.getElementById('prize-gallery-secret');
        if (secRow) secRow.style.display = '';
      } else {
        if (secretLabel) {
          secretLabel.style.display = 'none';
          secretLabel.textContent = `–°–ï–ö–†–ï–¢–ù–´–ï: 0 / ${secretTotal}`;
        }
      }
    } catch(e){}

    // –ø–æ–¥–≥–æ—Ç–æ–≤–∏–º —Å–ø–∏—Å–æ–∫ –∏–∑ 5 –±–ª–∏–∂–∞–π—à–∏—Ö —Ü–µ–ª–µ–π
    this._bubbleItems = this.computeGoalsList().slice(0, 5);
    this._bubbleIdx = 0;
    this.updateBubble();

    // —Ä–æ—Ç–∞—Ü–∏—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø–æ 10 —Å–µ–∫
    if (this._bubbleTimer) clearInterval(this._bubbleTimer);
    if (this._bubbleItems.length > 1) {
      this._bubbleTimer = setInterval(() => {
        this._bubbleIdx = (this._bubbleIdx + 1) % this._bubbleItems.length;
        this.updateBubble();
      }, 10000);
    }
  },
  
  // ‚Äú–±–ª–∏–∂–∞–π—à–∞—è —Ü–µ–ª—å‚Äù ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
  computeNearestGoal() {
    const S = StatsStore.s, T = S.totals||{};
    const uniq = (S.uniqueTracksPlayed||[]).length;
    const liked = S.likedCount||0;
    const streak = S.streak?.current||0;

    const list = [];
    const push = (id, need, have, unit, title) => {
      if (Ach.has(id)) return;
      const left = Math.max(0, need - have);
      const pct = Math.max(0, Math.min(100, Math.round((have/need)*100)));
      list.push({ id, left, pct, unit, title });
    };

    push('play_25_total', 25, T.totalValidPlays||0, '–ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π', ACH_META.play_25_total.title);
    push('time_listened_1h', 3600, Math.floor(T.totalSeconds||0), '—Å–µ–∫—É–Ω–¥', ACH_META.time_listened_1h.title);
    if (uniq < 10) push('unique_10_tracks', 10, uniq, '—Ç—Ä–µ–∫–∞', ACH_META.unique_10_tracks.title);
    push('full_10_total', 10, T.totalFullPlays||0, '–ø–æ–ª–Ω—ã—Ö', ACH_META.full_10_total.title);
    if (streak < 7) push('streak_7', 7, streak, '–¥–Ω–µ–π –ø–æ–¥—Ä—è–¥', ACH_META.streak_7.title);
    if (liked < 5) push('fav_5', 5, liked, '—Ç—Ä–µ–∫–æ–≤ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º', ACH_META.fav_5.title);
    push('play_100_total', 100, T.totalValidPlays||0, '–ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π', ACH_META.play_100_total.title);
    push('time_listened_5h', 18000, Math.floor(T.totalSeconds||0), '—Å–µ–∫—É–Ω–¥', ACH_META.time_listened_5h.title);

    if (!list.length) return null;
    list.sort((a,b)=> (a.left - b.left) || (b.pct - a.pct));
    const best = list[0];
    if (!best) return null;

    const units = (u, n) => (u === '—Å–µ–∫—É–Ω–¥')
      ? (n >= 60 ? `${Math.ceil(n/60)} –º–∏–Ω` : `${n} —Å–µ–∫`)
      : `${n} ${u}`;

    return `‚ú® –î–æ ¬´${best.title}¬ª: ${units(best.unit, best.left)}`;
  },

  computeGoalsList() {
    const S = StatsStore.s, T = S.totals||{};
    const uniq = (S.uniqueTracksPlayed||[]).length;
    const liked = S.likedCount||0;
    const streak = S.streak?.current||0;

    const list = [];
    const push = (id, need, have, unit, title) => {
      if (Ach.has(id)) return;
      const left = Math.max(0, need - have);
      const pct = Math.max(0, Math.min(100, Math.round((have/need)*100)));
      list.push({ id, left, pct, unit, title });
    };

    push('play_25_total', 25, T.totalValidPlays||0, '–ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π', ACH_META.play_25_total.title);
    push('time_listened_1h', 3600, Math.floor(T.totalSeconds||0), '—Å–µ–∫—É–Ω–¥', ACH_META.time_listened_1h.title);
    if (uniq < 10) push('unique_10_tracks', 10, uniq, '—Ç—Ä–µ–∫–∞', ACH_META.unique_10_tracks.title);
    push('full_10_total', 10, T.totalFullPlays||0, '–ø–æ–ª–Ω—ã—Ö', ACH_META.full_10_total.title);
    if (streak < 7) push('streak_7', 7, streak, '–¥–Ω–µ–π –ø–æ–¥—Ä—è–¥', ACH_META.streak_7.title);
    if (liked < 5) push('fav_5', 5, liked, '—Ç—Ä–µ–∫–æ–≤ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º', ACH_META.fav_5.title);
    push('play_100_total', 100, T.totalValidPlays||0, '–ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π', ACH_META.play_100_total.title);
    push('time_listened_5h', 18000, Math.floor(T.totalSeconds||0), '—Å–µ–∫—É–Ω–¥', ACH_META.time_listened_5h.title);

    if (!list.length) return [];
    list.sort((a,b)=> (a.left - b.left) || (b.pct - a.pct));

    const units = (u, n) => (u === '—Å–µ–∫—É–Ω–¥')
      ? (n >= 60 ? `${Math.ceil(n/60)} –º–∏–Ω` : `${n} —Å–µ–∫`)
      : `${n} ${u}`;

    return list.slice(0, 5).map(it => `‚ú® –î–æ ¬´${it.title}¬ª: ${units(it.unit, it.left)}`);
  },

  async updateBubble() {
    if (!this.bubble) return;
    const items = this._bubbleItems || [];
    const text = items.length ? items[this._bubbleIdx || 0] : '–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Å–ª—É—à–∞—Ç—å ‚Äî –ø—Ä–æ–≥—Ä–µ—Å—Å –∏–¥—ë—Ç.';
    const clean = text.replace(/^‚ú®\s?/, '');
    this.bubble.innerHTML = `<span class="ach-hint-emoji" id="ach-hint-emoji"></span>${clean}`;

    const emojiEl = document.getElementById('ach-hint-emoji');
    if (emojiEl && typeof AnimatedEmoji !== 'undefined') {
      const sid = /–î–æ ¬´.+¬ª:/.test(text) ? 'trophy' : 'sparkles';
      AnimatedEmoji.mount(emojiEl, sid === 'trophy' ? 'achievement' : 'info', text, 24, sid);
    }
  }
};

// ==== –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π (–º–æ–¥–∞–ª–∫–∞) ====

// –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –ø–æ–ø—É–ª—è—Ä–Ω—ã–º –ø–æ—Ä–æ–≥–∞–º –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞—á–∏–≤–æ–∫
function getAchievementProgressMeta() {
  const S = StatsStore.s;
  const T = S.totals || {};
  return {
    play_25_total:     { need: 25,    have: T.totalValidPlays || 0,             label: '–ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π' },
    play_100_total:    { need: 100,   have: T.totalValidPlays || 0,             label: '–ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π' },
    time_listened_1h:  { need: 3600,  have: Math.floor(T.totalSeconds||0),      label: '—Å–µ–∫—É–Ω–¥' },
    time_listened_5h:  { need: 18000, have: Math.floor(T.totalSeconds||0),      label: '—Å–µ–∫—É–Ω–¥' },
    unique_10_tracks:  { need: 10,    have: (S.uniqueTracksPlayed||[]).length,  label: '—Ç—Ä–µ–∫–∞' },
    full_10_total:     { need: 10,    have: T.totalFullPlays || 0,              label: '–ø–æ–ª–Ω—ã—Ö' },
    fav_5:             { need: 5,     have: S.likedCount || 0,                   label: '–∏–∑–±—Ä–∞–Ω–Ω—ã—Ö' },
    fav_8:             { need: 8,     have: S.likedCount || 0,                   label: '–∏–∑–±—Ä–∞–Ω–Ω—ã—Ö' },
    streak_7:          { need: 7,     have: (S.streak?.max||0),                  label: '–¥–Ω–µ–π –ø–æ–¥—Ä—è–¥' },
    streak_3:          { need: 3,     have: (S.streak?.max||0),                  label: '–¥–Ω–µ–π –ø–æ–¥—Ä—è–¥' }
  };
}
function formatUnits(u, n) {
  if (u === '—Å–µ–∫—É–Ω–¥') return (n >= 60 ? `${Math.floor(n/60)} –º–∏–Ω` : `${n} —Å–µ–∫`);
  return `${n} ${u}`;
}
function getAchievementProgress(id) {
  const mp = getAchievementProgressMeta()[id];
  if (!mp) return null;
  const have = Math.max(0, mp.have);
  const need = Math.max(1, mp.need);
  const pct = Math.max(0, Math.min(100, Math.round((have/need)*100)));
  const left = Math.max(0, need - have);
  return { have, need, pct, left, label: mp.label, text: `–û—Å—Ç–∞–ª–æ—Å—å: ${formatUnits(mp.label, left)}` };
}

function openAchievementsModal(filter='all') {
  try {
    buildAchievementsList(filter);
    document.getElementById('achievements-modal')?.classList.add('active');
  } catch(e) {
    console.error('Achievements modal error:', e);
    NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π');
  }
}
function closeAchievementsModal() {
  document.getElementById('achievements-modal')?.classList.remove('active');
}

function buildAchievementsList(activeFilter='all') {
  const container = document.getElementById('ach-list-container');
  if (!container) return;

  const s = StatsStore.s || { achievements:{} };
  const doneSet = new Set(Object.keys(s.achievements||{}));

  const all = Object.keys(ACH_META).map(id => {
    const meta = ACH_META[id] || {};
    const hidden = !!meta.hidden;
    const done = doneSet.has(id);
    const unlockedAt = done ? (s.achievements[id]?.unlockedAt || 0) : 0;
    const core = !!meta.core;
    const tier = meta.tier || 0;
    return { id, title: meta.title || id, hidden, done, unlockedAt, core, tier, meta };
  });

  const filterFn = {
    all:       (a)=>true,
    available: (a)=> !a.done && !a.hidden,
    done:      (a)=> a.done,
    secret:    (a)=> a.hidden && !a.done
  }[activeFilter] || ((a)=>true);

  const groupCore  = all.filter(a=>!a.hidden && a.core).filter(filterFn);
  const groupOther = all.filter(a=>!a.hidden && !a.core).filter(filterFn);
  const groupSecret= all.filter(a=> a.hidden).filter(filterFn);

  const byStatus = (a,b)=> (Number(a.done)-Number(b.done)) || (a.tier - b.tier) || a.title.localeCompare(b.title,'ru');
  groupCore.sort(byStatus);
  groupOther.sort(byStatus);
  groupSecret.sort((a,b)=> a.title.localeCompare(b.title,'ru'));

  function renderGroup(title, arr) {
    if (!arr.length) return '';
    let out = `<div class="ach-group-title">${title}</div>`;
    arr.forEach(a=>{
      const progress = (!a.done && !a.hidden) ? getAchievementProgress(a.id) : null;
      const statusIcon = a.done ? '‚úÖ' : (a.hidden ? 'üîí' : 'üî∏');
      const doneClass = a.done ? ' done' : '';
      const right = a.done
        ? `<span class="ach-done-date">${a.unlockedAt ? new Date(a.unlockedAt).toLocaleDateString() : ''}</span>`
        : (a.hidden ? `<span class="ach-lock">–°–µ–∫—Ä–µ—Ç–Ω–æ–µ</span>`
                    : (progress ? `<div class="ach-mini-bar"><div class="ach-mini-fill" style="width:${progress.pct}%"></div></div>` : ''));

      const sub = a.done
        ? `–û—Ç–∫—Ä—ã—Ç–æ: ${a.unlockedAt ? new Date(a.unlockedAt).toLocaleString() : ''}`
        : (a.hidden ? `–û—Ç–∫—Ä–æ–µ—Ç—Å—è –ø—Ä–∏ –æ—Å–æ–±—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö` 
                    : (progress ? `${progress.text}` : (a.meta.short || '–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è')));

      // –î–µ—Ç–∞–ª–∏ (—Å–∫—Ä—ã—Ç—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
      const details = (!a.hidden) ? `
        <div class="ach-details" style="display:none; grid-column: 1 / -1; padding:8px; border-top:1px dashed rgba(255,255,255,0.1); margin-top:6px;">
          <div style="color:#cfe3ff; font-weight:700; margin-bottom:6px;">–ö–∞–∫ –≤—ã–ø–æ–ª–Ω–∏—Ç—å</div>
          <div style="color:#eaeffb; margin-bottom:6px;">${a.meta.howTo || '–í—ã–ø–æ–ª–Ω–∏—Ç–µ —É—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è.'}</div>
          ${a.meta.desc ? `<div style="color:#9aa8c4; font-size:.9em;">${a.meta.desc}</div>` : ''}
          ${(!a.done && !a.hidden && progress) ? `
            <div style="margin-top:8px;">
              <div class="ach-mini-bar" style="width:100%"><div class="ach-mini-fill" style="width:${progress.pct}%"></div></div>
              <div style="color:#9aa8c4; font-size:.86em; margin-top:4px;">${progress.text}</div>
            </div>` : ''}
        </div>` : '';

      out += `
      <div class="ach-item${doneClass}" data-ach="${a.id}">
        <div class="ach-status">${statusIcon}</div>
        <div class="ach-main">
          <div class="ach-title">${a.title}</div>
          <div class="ach-sub">${sub}</div>
        </div>
        <div class="ach-right">
          ${right||''}
          ${!a.hidden ? `<button class="backup-btn secondary ach-more" type="button" style="padding:4px 8px;">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>` : ''}
        </div>
        ${details}
      </div>`;
    });
    return out;
  }

  let html = '';
  html += renderGroup('Core', groupCore);
  html += renderGroup('–û—Å—Ç–∞–ª—å–Ω—ã–µ', groupOther);
  html += renderGroup('–°–µ–∫—Ä–µ—Ç–Ω—ã–µ', groupSecret);

  container.innerHTML = html || `<div class="ach-lock" style="text-align:center; padding:16px;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ —Ñ–∏–ª—å—Ç—Ä—É</div>`;

  // –ù–∞–≤–µ—Å–∏–º —Ç–∞–±—ã
  const tabs = document.querySelectorAll('#achievements-modal .ach-tab');
  tabs.forEach(btn=>{
    btn.classList.toggle('active', btn.dataset.filter === activeFilter);
    btn.onclick = () => {
      tabs.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      buildAchievementsList(btn.dataset.filter);
    };
  });

  // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ "–ü–æ–¥—Ä–æ–±–Ω–µ–µ"
  container.querySelectorAll('.ach-item').forEach(item=>{
    const moreBtn = item.querySelector('.ach-more');
    const details = item.querySelector('.ach-details');
    if (moreBtn && details) {
      moreBtn.addEventListener('click', (e)=>{
        e.stopPropagation();
        const vis = details.style.display !== 'none';
        details.style.display = vis ? 'none' : '';
        moreBtn.textContent = vis ? '–ü–æ–¥—Ä–æ–±–Ω–µ–µ' : '–°–≤–µ—Ä–Ω—É—Ç—å';
      });
      // –ö–ª–∏–∫ –ø–æ –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Å—Ç–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–∂–µ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç
      item.querySelector('.ach-main')?.addEventListener('click', ()=>{
        const vis = details.style.display !== 'none';
        details.style.display = vis ? 'none' : '';
        moreBtn.textContent = vis ? '–ü–æ–¥—Ä–æ–±–Ω–µ–µ' : '–°–≤–µ—Ä–Ω—É—Ç—å';
      });
    }
  });
}

// ==== –ú–û–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê (—Ä–∞–∑–¥–µ–ª –ø–æ–¥ –∫–Ω–æ–ø–∫–æ–π —Å–∫–∞—á–∏–≤–∞–Ω–∏—è) ====
const MyStats = {
  root: null, body: null, toggleBtn: null,

  init() {
    this.root = document.getElementById('my-stats-root');
    this.body = document.getElementById('my-stats-body');
    this.toggleBtn = document.getElementById('my-stats-toggle');
    if (!this.root || !this.body || !this.toggleBtn) return;

    // —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç/–∑–∞–∫—Ä—ã—Ç
    const open = localStorage.getItem('myStatsOpen') === '1';
    this.toggleBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
    this.body.hidden = !open;

    this.toggleBtn.addEventListener('click', () => {
      const expanded = this.toggleBtn.getAttribute('aria-expanded') === 'true';
      const next = !expanded;
      this.toggleBtn.setAttribute('aria-expanded', next ? 'true' : 'false');
      this.body.hidden = !next;
      localStorage.setItem('myStatsOpen', next ? '1' : '0');
      if (next) this.render();
    });

    if (open) this.render();
  },

  update() {
    // –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–µ–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞
    if (this.body && !this.body.hidden) {
      this.render();
    }
  },

  insights() {
    const S = StatsStore.s;
    const P = S.perTrack || [];
    const totals = S.totals || { totalSeconds:0, totalValidPlays:0, totalFullPlays:0 };
    const unique = (S.uniqueTracksPlayed||[]).length;
    const liked = S.likedCount || 0;
    const streakCur = S.streak?.current || 0;
    const streakMax = S.streak?.max || 0;

    // —Ç–æ–ø—ã
    const topValid = P
      .map((pt, idx)=>({ idx, cnt: pt.validPlays||0 }))
      .sort((a,b)=> b.cnt - a.cnt).slice(0,5);

    const topTime = P
      .map((pt, idx)=>({ idx, secs: pt.totalSeconds||0 }))
      .sort((a,b)=> b.secs - a.secs).slice(0,5);

    // –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã
    const byHour = Array(24).fill(0);
    const byWeekday = Array(7).fill(0); // 0=–ü–Ω .. 6=–í—Å
    for (let i=0;i<P.length;i++){
      const pt = P[i];
      if (Array.isArray(pt.byHour)) {
        for (let h=0;h<24;h++) byHour[h] += pt.byHour[h]||0;
      }
      if (Array.isArray(pt.byWeekday)) {
        for (let d=0;d<7;d++) byWeekday[d] += pt.byWeekday[d]||0;
      }
    }

    // today / 7 –¥–Ω–µ–π
    const todayKey = localDayKey(Date.now());
    const today = S.byDay?.[todayKey] || { valid:0, seconds:0 };
    const cutoff = Date.now() - 7*24*60*60*1000;
    let weekValid = 0, weekSeconds = 0;
    Object.keys(S.byDay||{}).forEach(k=>{
      const d = new Date(k+'T00:00:00').getTime();
      if (d >= cutoff) {
        weekValid += S.byDay[k]?.valid||0;
        weekSeconds += S.byDay[k]?.seconds||0;
      }
    });

    return {
      totals, unique, liked, streakCur, streakMax,
      topValid, topTime, byHour, byWeekday,
      today, weekValid, weekSeconds
    };
  },

  render() {
    if (!config) return;
    const I = this.insights();

    const fmtTime = (sec)=>{
      const h = Math.floor(sec/3600);
      const m = Math.floor((sec%3600)/60);
      return h>0 ? `${h}—á ${m}–º` : `${m}–º`;
    };
    const trackTitle = (idx)=> (config?.tracks?.[idx]?.title || `–¢—Ä–µ–∫ ${(idx+1)}`);

    const topValidHtml = I.topValid.length
      ? `<ul class="stat-list">` + I.topValid.map(x=>(
          `<li><span>${trackTitle(x.idx)}</span><span>${x.cnt}</span></li>`
        )).join('') + `</ul>`
      : `<div class="stat-sub">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö</div>`;

    const topTimeHtml = I.topTime.length
      ? `<ul class="stat-list">` + I.topTime.map(x=>(
          `<li><span>${trackTitle(x.idx)}</span><span>${fmtTime(x.secs)}</span></li>`
        )).join('') + `</ul>`
      : `<div class="stat-sub">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö</div>`;

    const maxHour = Math.max(1, ...I.byHour);
    const maxW = Math.max(1, ...I.byWeekday);
    const weekdayLabels = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];

    const hoursOpen = localStorage.getItem('myStatsHoursOpen') !== '0';
    const weekOpen  = localStorage.getItem('myStatsWeekOpen')  !== '0';

    const byHourHtml = I.byHour.map((v,h)=>(
      `<div class="chart-row">
        <div class="label">${String(h).padStart(2,'0')}</div>
        <div class="bar"><div class="fill" style="width:${Math.round((v/maxHour)*100)}%"></div></div>
        <div class="val">${v}</div>
      </div>`
    )).join('');

    const byWeekHtml = I.byWeekday.map((v,d)=>(
      `<div class="chart-row">
        <div class="label">${weekdayLabels[d]}</div>
        <div class="bar"><div class="fill" style="width:${Math.round((v/maxW)*100)}%"></div></div>
        <div class="val">${v}</div>
      </div>`
    )).join('');

    this.body.innerHTML = `
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-title">–í—Å–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏</div>
          <div class="stat-value">${fmtTime(I.totals.totalSeconds||0)}</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏</div>
          <div class="stat-value">${I.unique}</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">–í–∞–ª–∏–¥–Ω—ã—Ö –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π</div>
          <div class="stat-value">${I.totals.totalValidPlays||0}</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">–ü–æ–ª–Ω—ã—Ö –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π</div>
          <div class="stat-value">${I.totals.totalFullPlays||0}</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">–°—Ç—Ä–∏–∫ (—Ç–µ–∫—É—â–∏–π/–º–∞–∫—Å.)</div>
          <div class="stat-value">${I.streakCur} / ${I.streakMax}</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º</div>
          <div class="stat-value">${I.liked}</div>
        </div>
      </div>

      <div class="chart-block" id="chart-hours">
        <div class="chart-title" style="cursor:pointer;" id="chart-hours-toggle">–ü–æ —á–∞—Å–∞–º —Å—É—Ç–æ–∫</div>
        <div class="chart-bars" id="chart-hours-bars" ${hoursOpen ? '' : 'style="display:none;"'}>
          ${byHourHtml}
        </div>
      </div>

      <div class="chart-block" id="chart-week">
        <div class="chart-title" style="cursor:pointer;" id="chart-week-toggle">–ü–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</div>
        <div class="chart-bars" id="chart-week-bars" ${weekOpen ? '' : 'style="display:none;"'}>
          ${byWeekHtml}
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-title">–°–µ–≥–æ–¥–Ω—è</div>
          <div class="stat-value">${I.today.valid||0} –ø—Ä–æ—Å–ª. ¬∑ ${fmtTime(I.today.seconds||0)}</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">7 –¥–Ω–µ–π</div>
          <div class="stat-value">${I.weekValid} –ø—Ä–æ—Å–ª. ¬∑ ${fmtTime(I.weekSeconds)}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-title">–¢–æ–ø‚Äë5 –ø–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è–º</div>
        ${topValidHtml}
      </div>

      <div class="stat-card">
        <div class="stat-title">–¢–æ–ø‚Äë5 –ø–æ –≤—Ä–µ–º–µ–Ω–∏</div>
        ${topTimeHtml}
      </div>

      <div style="display:flex; justify-content:center; margin-top:8px;">
        <button class="backup-btn" id="stats-reset-open-btn" type="button">–û–ß–ò–°–¢–ò–¢–¨</button>
      </div>
    `;
    // –ø—Ä–∏–≤—è–∑–∫–∞ –∫–Ω–æ–ø–∫–∏ "–û–ß–ò–°–¢–ò–¢–¨"
    const rst = document.getElementById('stats-reset-open-btn');
    if (rst) rst.onclick = openResetModal;
    const hoursT = document.getElementById('chart-hours-toggle');
    const hoursBars = document.getElementById('chart-hours-bars');
    if (hoursT && hoursBars) {
      hoursT.onclick = () => {
        const vis = hoursBars.style.display !== 'none';
        hoursBars.style.display = vis ? 'none' : '';
        localStorage.setItem('myStatsHoursOpen', vis ? '0' : '1');
      };
    }
    const weekT = document.getElementById('chart-week-toggle');
    const weekBars = document.getElementById('chart-week-bars');
    if (weekT && weekBars) {
      weekT.onclick = () => {
        const vis = weekBars.style.display !== 'none';
        weekBars.style.display = vis ? 'none' : '';
        localStorage.setItem('myStatsWeekOpen', vis ? '0' : '1');
      };
    }
  }
};
// ==== –ü–†–ò–ó–´: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–ü–û–õ–ù–ê–Ø –í–ï–†–°–ò–Ø) ====
const Prize = {
  root: null, body: null,
  state: {
    authed: false,
    user: null,
    claims: [],
    busy: false,
    readiness: { achCount: 0, need: FRONT_MIN_CLAIM_LEVEL, cloud: false, tamper: false },
    prizes: [],
    selectedPrize: null,
    shippingMethod: null
  },

  init() {
    this.root = document.getElementById('prize-root');
    this.body = document.getElementById('prize-body');
    if (!this.root || !this.body) return;

    // 0) ‚Äú–õ–∏–ø–∫–∞—è‚Äù –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: –µ—Å–ª–∏ –µ—Å—Ç—å sid ‚Äî —Å—á–∏—Ç–∞–µ–º –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º
    const lsSid = localStorage.getItem('vr_sid');
    if (lsSid) {
      const un = localStorage.getItem('tg_username');
      const fn = localStorage.getItem('tg_first_name');
      const tgId = localStorage.getItem('tg_id');
      this.state.authed = true;
      this.state.user = {
        display_name: un || fn || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
        tg_id: tgId || null,
        tg_username: un || null
      };
    }

    this.renderSkeleton();
    this.updateLocalReadiness();
    this.loadPrizes().catch(()=>{});
    // 1) –¢–∏—Ö–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–ø–æ–ª—É—á–∏–º —Å–≤–µ–∂–∏–π sid), –Ω–æ UI –Ω–µ –¥–∞—É–Ω–≥—Ä–µ–π–¥–∏–º
    this.attemptSilentAuth().then(() => {
      this.fetchStatus();
    });

    setInterval(() => this.fetchStatus(), 30000);
  },

  async attemptSilentAuth() {
    try {
      const tgId = localStorage.getItem('tg_id');
      const username = localStorage.getItem('tg_username');
      if (!tgId) { this.state.authed = false; this.paintChecklist(); return; }

      const res = await fetch(`${GLOBAL_STATS_URL}/auth/silent`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        mode: 'cors',
        credentials: 'include',
        body: JSON.stringify({ tgId, username, deviceHash: getDeviceHash() })
      });
      const data = await res.json().catch(() => ({}));

      if (res.ok && data?.ok) {
        if (data?.sid) localStorage.setItem('vr_sid', data.sid);

        // –ú–ì–ù–û–í–ï–ù–ù–û –≤–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –≤ UI
        this.state.authed = true;
        this.state.user = {
          display_name: username || localStorage.getItem('tg_first_name') || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
          tg_id: tgId,
          tg_username: username || null
        };
        this.paintChecklist();

        // NEW: —Å—Ä–∞–∑—É –ø—Ä–æ–±—É–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ tg_id (user-latest)
        await this.recoverFromUserLatestIfAny();

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –±—ç–∫–∞–ø –∏ –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å —Ñ–æ–Ω–æ–º
        await backupSaveToCloudOverwriteSilent();
        await this.fetchMe(true);
        this.updateLocalReadiness();
      } else {
        this.state.authed = false;
        this.paintChecklist();
        // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–¥—Ç—è–Ω—É—Ç—å user-latest (–µ—Å–ª–∏ –µ—Å—Ç—å)
        await this.recoverFromUserLatestIfAny();
      }
    } catch (e) {
      this.state.authed = false;
      this.paintChecklist();
    }
  },

  renderSkeleton() {
    this.body.innerHTML = `
        <div class="prize-gallery" id="prize-gallery">
          ${['prize-01.png','prize-02.png','prize-03.png','prize-04.png'].map(src=>`
            <img class="prize-thumb" src="img/${src}" alt="Prize" onclick="Prize.toggleThumb(this)">
          `).join('')}
        </div>
        <!-- –í—Ç–æ—Ä–æ–π —Ä—è–¥ –ø—Ä–∏–∑–æ–≤ ‚Äî –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ —ç—Ç–∞–ø–∞ -->
        <div class="prize-gallery" id="prize-gallery-secret" style="display:none;">
          ${['prize-21.png','prize-22.png','prize-23.png','prize-24.png'].map(src=>`
            <img class="prize-thumb" src="img/${src}" alt="Secret Prize" onclick="Prize.toggleThumb(this)">
          `).join('')}
        </div>

        <div id="prize-auth-block" style="text-align:center; margin:10px 0;">
          <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞ –º–∞—Å—Ç–µ—Ä–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–º–µ–Ω–∏ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –ø–æ—Ä–∞ –∏ –∏–º–µ–Ω–∏ –Ω–µ—Ç) -->
          <div id="create-name-block" style="display:none;">
            <div style="font-size:0.9em; color:#9aa8c4; margin-bottom:8px;">
              –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∏–∑–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∏–º—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∏ –ø—Ä–∏–≤—è–∂–∏—Ç–µ Telegram
            </div>
            <button class="prize-btn" onclick="Prize.openIdentityWizard()">–°–æ–∑–¥–∞—Ç—å –∏–º—è</button>
          </div>

          <!-- –ü—Ä–æ—Å–º–æ—Ç—Ä –∏–º–µ–Ω–∏, –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å -->
          <div class="prize-note" id="prize-name-view" style="display:none;text-align:center;font-weight:800;"></div>
        </div>

        <div id="prize-checklist" style="margin-top:8px;">
          <div class="prize-row" id="row-ach"><span>üèÜ</span><span>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è: <b id="ach-count">0</b> / –º–∏–Ω–∏–º—É–º <b id="ach-need">${FRONT_MIN_CLAIM_LEVEL}</b></span></div>
          <div class="prize-row" id="row-cloud"><span>‚òÅÔ∏è</span><span>–û–±–ª–∞—á–Ω—ã–π –±—ç–∫–∞–ø: <b id="cloud-state">–Ω–µ—Ç</b></span></div>
          <div class="prize-row" id="row-tamper"><span>üõ°Ô∏è</span><span>–ß–µ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö: <b id="tamper-state">–ø—Ä–æ–≤–µ—Ä–∫–∞‚Ä¶</b></span></div>
          <div id="prize-ready-flag" class="prize-not-ready">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —É—Å–ª–æ–≤–∏–π –¥–ª—è –∑–∞—è–≤–∫–∏</div>
        </div>

        <div class="prize-actions" style="margin-top:10px;">
          <button class="prize-btn primary" id="claim-btn" type="button" disabled>–ü–û–õ–£–ß–ò–¢–¨ –ü–†–ò–ó</button>
        </div>

        <div class="prize-status" id="prize-status" style="margin-top:10px; display:none;">
          <h4>–ú–æ–∏ –∑–∞—è–≤–∫–∏</h4>
          <div id="claim-cards"></div>
        </div>
      `;

    const claimBtn = document.getElementById('claim-btn');
    if (claimBtn) claimBtn.onclick = () => this.openPrizes();
  },

  paintChecklist() {
    const { achCount, need, cloud, tamper, nameSet } = this.state.readiness;
    const achEl = document.getElementById('ach-count');
    const cloudEl = document.getElementById('cloud-state');
    const tamperEl = document.getElementById('tamper-state');
    const rowAch = document.getElementById('row-ach');
    const rowCloud = document.getElementById('row-cloud');
    const rowTamper = document.getElementById('row-tamper');
    const flag = document.getElementById('prize-ready-flag');
    const claimBtn = document.getElementById('claim-btn');
    const nameView = document.getElementById('prize-name-view');
    const createNameBlock = document.getElementById('create-name-block');

    if (achEl) achEl.textContent = String(achCount);
    if (cloudEl) cloudEl.textContent = cloud ? '–µ—Å—Ç—å' : '–Ω–µ—Ç';
    if (tamperEl) tamperEl.textContent = tamper ? '–æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø–æ–¥–º–µ–Ω–∞' : 'OK';

    rowAch.classList.remove('ok','warn','err');
    rowCloud.classList.remove('ok','warn','err');
    rowTamper.classList.remove('ok','warn','err');
    rowAch.classList.add(achCount >= need ? 'ok' : 'warn');
    rowCloud.classList.add(cloud ? 'ok' : 'warn');
    rowTamper.classList.add(tamper ? 'err' : 'ok');

    const ready = (!tamper) && cloud && (achCount >= need);

    // –ò–º—è –ø–æ–¥ –∏–∫–æ–Ω–∫–∞–º–∏ ‚Äî –≥–ª–∞–≤–Ω—ã–π –ø—Ä–∏–∑–Ω–∞–∫ "—Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" (–ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –ø—Ä–∏–≤—è–∑–∫–∏ Telegram)
    const hasName = !!nameSet || this.hasProfileName();

    if (nameView) {
      const nm = this.currentProfileName();
      if (nm) {
        nameView.style.display = '';
        nameView.textContent = `${nm}`;
      } else {
        nameView.style.display = 'none';
      }
    }

    // –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–æ–∑–¥–∞—Ç—å –∏–º—è:
    // - –∫–∞–∫ —Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ ‚â•5 –≤–∏–¥–∏–º—ã—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –∏ –∏–º–µ–Ω–∏ –Ω–µ—Ç
    // - –∏–ª–∏ –µ—Å–ª–∏ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –≤—Å–µ —É—Å–ª–æ–≤–∏—è –∏ –∏–º–µ–Ω–∏ –Ω–µ—Ç
    if (createNameBlock) {
      const enoughForName = (achCount >= 5);
      createNameBlock.style.display = (!hasName && (enoughForName || ready)) ? '' : 'none';
    }

    if (flag) {
      // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∑–∞—è–≤–∫–∞ ‚Äî —Ñ–ª–∞–≥ —Å–∫—Ä—ã–≤–∞–µ–º
      const hasClaims = Array.isArray(this.state.claims) && this.state.claims.length > 0;
      if (hasClaims) {
        flag.style.display = 'none';
      } else {
        flag.style.display = '';
        if (!ready) {
          flag.className = 'prize-not-ready';
          flag.textContent = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —É—Å–ª–æ–≤–∏–π –¥–ª—è –∑–∞—è–≤–∫–∏';
        } else if (!hasName) {
          flag.className = 'prize-not-ready';
          flag.textContent = '–°–æ–∑–¥–∞–π—Ç–µ –∏–º—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏';
        } else {
          flag.className = 'prize-ready';
          flag.textContent = '–ì–æ—Ç–æ–≤–æ: –º–æ–∂–Ω–æ –ø–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É';
        }
      }
    }

    if (claimBtn) {
      const canClaim = ready && hasName && !this.state.busy;
      claimBtn.disabled = !canClaim;
    }

    // –¢–∏—Ö–∞—è —Å–µ—Å—Å–∏—è (–±–µ–∑ –≤–Ω–µ—à–Ω–µ–≥–æ –≤—Ö–æ–¥–∞) ‚Äî —á—Ç–æ–±—ã /profile/set-name –∏ /claim —Ä–∞–±–æ—Ç–∞–ª–∏ –±–µ–∑ —Ñ—Ä–∏–∫—Ü–∏–π
    if (ready && !this.state.authed) {
      this.ensureSessionActive().then(ok => {
        if (ok) this.paintChecklist();
      });
    }
  },

  hasProfileName() {
    return !!(this.state?.user?.display_name || localStorage.getItem('profile_name'));
  },
  currentProfileName() {
    return this.state?.user?.display_name || localStorage.getItem('profile_name') || null;
  },

  openIdentityWizard() {
    try {
      // –°–±—Ä–æ—Å —à–∞–≥–æ–≤ (–±–µ–∑ auto)
      ['idw-step-choose','idw-step-manual','idw-step-name','idw-step-bot'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });
      const step = document.getElementById('idw-step-choose');
      if (step) step.style.display = '';
      document.getElementById('identity-modal')?.classList.add('active');
    } catch(e) {
      console.error('openIdentityWizard error:', e);
    }
  },
  closeIdentityWizard() {
    document.getElementById('identity-modal')?.classList.remove('active');
  },
  backToIdentityChoose() {
    ['idw-step-manual','idw-step-name','idw-step-bot'].forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.style.display = 'none';
    });
    const choose = document.getElementById('idw-step-choose');
    if (choose) choose.style.display = '';
  },

  startManualIdentity() {
    const choose = document.getElementById('idw-step-choose');
    const man = document.getElementById('idw-step-manual');
    if (choose) choose.style.display = 'none';
    if (man) man.style.display = '';
    NotificationSystem.info('–£–∫–∞–∂–∏—Ç–µ @username –∏ Id –∏–∑ @userinfobot');
  },

  async submitManualIdentity() {
    try {
      const usernameRaw = (document.getElementById('idw-man-username')?.value || '').trim();
      const idRaw = (document.getElementById('idw-man-id')?.value || '').trim();
      const username = usernameRaw.replace(/^@+/, '');
      const tgId = String(parseInt(idRaw, 10));
      if (!username || !/^\d+$/.test(tgId)) {
        NotificationSystem.warning('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ @username –∏ —á–∏—Å–ª–æ–≤–æ–π Id');
        return;
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ ‚Äî –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è –¥–ª—è /auth/silent –∏ –±—ç–∫–∞–ø–∞
      localStorage.setItem('tg_username', username);
      localStorage.setItem('tg_id', tgId);

      // –°–æ–∑–¥–∞–¥–∏–º/–æ–±–Ω–æ–≤–∏–º —Å–µ—Å—Å–∏—é –±–µ–∑ –≤–Ω–µ—à–Ω–µ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
      this.setBusy(true);
      const res = await fetch(`${GLOBAL_STATS_URL}/auth/silent`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        mode: 'cors',
        credentials: 'include',
        body: JSON.stringify({ tgId, username, deviceHash: getDeviceHash() })
      });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok || !data?.ok) {
        NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–≤—è–∑–∞—Ç—å Telegram (—Ä—É—á–Ω–æ–π —Å–ø–æ—Å–æ–±)');
        this.setBusy(false);
        return;
      }
      if (data?.sid) localStorage.setItem('vr_sid', data.sid);
      this.state.authed = true;

      // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —à–∞–≥ –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏
      const man = document.getElementById('idw-step-manual');
      const nm = document.getElementById('idw-step-name');
      if (man) man.style.display = 'none';
      if (nm) nm.style.display = '';
      document.getElementById('idw-display-name').value = localStorage.getItem('profile_name') || `@${username}`;
      this.setBusy(false);
    } catch (e) {
      console.error('submitManualIdentity error:', e);
      this.setBusy(false);
      NotificationSystem.error('–û—à–∏–±–∫–∞ —Ä—É—á–Ω–æ–π –ø—Ä–∏–≤—è–∑–∫–∏');
    }
  },
  // –ù–û–í–û–ï: –°–ø–æ—Å–æ–± "–ß–µ—Ä–µ–∑ –±–æ—Ç–∞ (deep-link)"
  _botPollTimer: null,
  _botPollCode: null,

  async startBotIdentity() {
    try {
      const choose = document.getElementById('idw-step-choose');
      const bot = document.getElementById('idw-step-bot');
      if (choose) choose.style.display = 'none';
      if (bot) bot.style.display = '';

      // 1) –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É –±—ç–∫–µ–Ω–¥–∞ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –∫–æ–¥ –∏ deep-link
      const res = await fetch(`${GLOBAL_STATS_URL}/auth/bot/start`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        mode:'cors',
        credentials:'include',
        body: JSON.stringify({ deviceHash: getDeviceHash() })
      });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok || !data?.ok || !data?.code) {
        NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞');
        this.backToIdentityChoose();
        return;
      }

      this._botPollCode = data.code;

      // 2) –õ–∏–Ω–∫ –Ω–∞ –±–æ—Ç–∞ ‚Äî –µ—Å–ª–∏ –±—ç–∫ –Ω–µ –≤–µ—Ä–Ω—É–ª username, —Å—Ç—Ä–æ–∏–º –ø–æ —Ñ—Ä–æ–Ω—Ç-–∫–æ–Ω—Å—Ç–∞–Ω—Ç–µ TG_BOT_USERNAME
      let link = data.link;
      if (!link) {
        const botU = (typeof TG_BOT_USERNAME !== 'undefined' ? String(TG_BOT_USERNAME) : '').replace(/^@+/, '');
        if (botU) link = `https://t.me/${botU}?start=BL_${data.code}`;
      }

      // 3) –û–±–Ω–æ–≤–ª—è–µ–º UI: –∫–æ–¥, —Å—Å—ã–ª–∫–∞, QR (–¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞)
      const codeEl = document.getElementById('idw-bot-code');
      if (codeEl) codeEl.innerHTML = `–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: <b>${data.code}</b>`;
      const a = document.getElementById('idw-bot-link');
      if (a) {
        a.href = link || '#';
        a.textContent = '–û—Ç–∫—Ä—ã—Ç—å Telegram';
      }
      const isDesktop = !/Android|webOS|iPhone|iPad|iPod/i.test(navigator.userAgent);
      const qrImg = document.getElementById('idw-bot-qr');
      if (qrImg) {
        if (isDesktop && link) {
          const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(link)}`;
          qrImg.src = qrUrl; qrImg.style.display = '';
        } else {
          qrImg.style.display = 'none';
        }
      }

      // –ê–≤—Ç–æ‚Äë–æ—Ç–∫—Ä—ã—Ç–∏–µ Telegram –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
      if (!isDesktop && link) {
        setTimeout(() => { try { window.open(link, '_blank'); } catch(e){} }, 300);
      }

      // 4) –ó–∞–ø—É—Å–∫–∞–µ–º —É—Å–∫–æ—Ä–µ–Ω–Ω—ã–π –æ–ø—Ä–æ—Å: –ø–µ—Ä–≤—ã–µ ~12 —Å–µ–∫ —á–∞—Å—Ç–æ, –∑–∞—Ç–µ–º —Ä–µ–∂–µ
      this._botPollStartedAt = Date.now();
      this._botPollActive = true;
      const fastLoop = async () => {
        if (!this._botPollActive) return;
        await this._pollBotCode(true);
        const elapsed = Date.now() - this._botPollStartedAt;
        const nextDelay = elapsed < 12000 ? 350 : 1000; // –ø–µ—Ä–≤—ã–µ 12—Å ~3 –æ–ø—Ä–æ—Å–∞ –≤ —Å–µ–∫, –ø–æ—Ç–æ–º ~1/—Å
        this._botPollTimer = setTimeout(fastLoop, nextDelay);
      };
      fastLoop();

      // –ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –æ–∫–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Äî —Å—Ä–∞–∑—É –ø—Ä–æ–±—É–µ–º –µ—â—ë —Ä–∞–∑
      this._onVis = () => { if (this._botPollActive) this._pollBotCode(true); };
      document.addEventListener('visibilitychange', this._onVis);

      document.getElementById('idw-bot-status').textContent = '–û–∂–∏–¥–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É –±–æ—Ç–∞‚Ä¶';
    } catch (e) {
      console.error('startBotIdentity error:', e);
      NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞');
      this.backToIdentityChoose();
    }
  },

  async _pollBotCode(noCache=false) {
    if (!this._botPollCode) return;
    try {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), 5000); // fail‚Äëfast
      const url = `${GLOBAL_STATS_URL}/auth/bot/poll?code=${encodeURIComponent(this._botPollCode)}&ts=${Date.now()}`;
      const res = await fetch(url, {
        method:'GET',
        mode:'cors',
        credentials:'include',
        signal: ctrl.signal,
        headers: noCache ? { 'Cache-Control': 'no-cache', 'Pragma':'no-cache' } : {}
      });
      clearTimeout(t);
      const data = await res.json().catch(()=> ({}));
      if (!res.ok || !data?.ok) return;

      if (data.ready) {
        // –£—Å–ø–µ—Ö
        this._botPollActive = false;
        if (this._botPollTimer) { clearTimeout(this._botPollTimer); this._botPollTimer = null; }
        if (this._onVis) { document.removeEventListener('visibilitychange', this._onVis); this._onVis = null; }

        const st = document.getElementById('idw-bot-status');
        if (st) st.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º‚Ä¶';

        try {
          if (data.sid) localStorage.setItem('vr_sid', data.sid);
          if (data.tgId) localStorage.setItem('tg_id', String(data.tgId));
          if (data.username) localStorage.setItem('tg_username', String(data.username));
        } catch(e){}

        this.state.authed = true;

        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —à–∞–≥—É –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏
        const botStep = document.getElementById('idw-step-bot');
        const nm = document.getElementById('idw-step-name');
        if (botStep) botStep.style.display = 'none';
        if (nm) nm.style.display = '';

        const prefill = localStorage.getItem('profile_name') || (data.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
        const inp = document.getElementById('idw-display-name');
        if (inp) inp.value = prefill;

        // –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å, –æ–±–Ω–æ–≤–ª—è–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å
        this.fetchMe(true).then(async () => {
          await this.recoverFromUserLatestIfAny();
          this.updateLocalReadiness();
        });
      }
    } catch(e) {
      // —Ç–∏—Ö–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º ‚Äî —Å–ª–µ–¥—É—é—â–∞—è –ø–æ–ø—ã—Ç–∫–∞ –≤ —Ü–∏–∫–ª–µ
    }
  },

  cancelBotIdentity() {
    this._botPollActive = false;
    if (this._botPollTimer) { clearTimeout(this._botPollTimer); this._botPollTimer = null; }
    if (this._onVis) { document.removeEventListener('visibilitychange', this._onVis); this._onVis = null; }
    this._botPollCode = null;
    this.backToIdentityChoose();
  },

  async saveDisplayName() {
    try {
      const name = (document.getElementById('idw-display-name')?.value || '').trim();
      if (!name) { NotificationSystem.warning('–í–≤–µ–¥–∏—Ç–µ –∏–º—è'); return; }

      // –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è (–±–µ—Ä—ë–º —á–µ—Ä–µ–∑ ensureSessionActive)
      const okSess = await this.ensureSessionActive();
      if (!okSess) {
        NotificationSystem.error('–ù–µ—Ç —Å–µ—Å—Å–∏–∏. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –≤—Ö–æ–¥.');
        return;
      }

      this.setBusy(true);
      // 1) –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
      const res = await fetch(`${GLOBAL_STATS_URL}/profile/set-name`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...apiAuthHeaders() },
        mode: 'cors',
        credentials: 'include',
        body: JSON.stringify({ displayName: name })
      });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok || !data?.ok) {
        NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–º—è');
        this.setBusy(false);
        return;
      }

      // 2) –õ–æ–∫–∞–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è, –æ–±–Ω–æ–≤–ª—è–µ–º UI
      localStorage.setItem('profile_name', name);
      this.state.user = this.state.user || {};
      this.state.user.display_name = name;

      // 3) –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –±—ç–∫–∞–ø –≤ –æ–±–ª–∞–∫–æ (overwrite) –∏ –∂–¥—ë–º –µ–≥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
      await backupSaveToCloudOverwriteSilent();
      const ok = await ensureCloudBackupReady(4000);
      if (!ok) {
        NotificationSystem.warning('–ò–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ, –Ω–æ –æ–±–ª–∞—á–Ω—ã–π –±—ç–∫–∞–ø –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª—Å—è. –ü–æ–≤—Ç–æ—Ä–∏–º –ø–æ–∑–∂–µ.');
      }

      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–∞—Å—Ç–µ—Ä –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å
      this.closeIdentityWizard();
      this.updateLocalReadiness();
      this.paintChecklist();
      NotificationSystem.success('–ò–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');

    } catch (e) {
      console.error('saveDisplayName error:', e);
      NotificationSystem.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–º–µ–Ω–∏');
    } finally {
      this.setBusy(false);
    }
  },
  
  setBusy(v) { 
    this.state.busy = !!v; 
    console.log('[Prize] setBusy:', v);
    this.paintChecklist(); 
  },
  
  toggleThumb(imgEl) {
    const expanded = imgEl.classList.contains('expanded');
    document.querySelectorAll('.prize-thumb').forEach(x => x.classList.remove('expanded'));
    if (!expanded) imgEl.classList.add('expanded');
  },

  updateLocalReadiness() {
    const achCount = getVisibleAchievementsCount();
    const cloud = localStorage.getItem('CLOUD_SAVED_OK') === '1';
    const tamper = localStorage.getItem('tamper_detected') === '1';
    const nameSet = !!(this.state?.user?.display_name || localStorage.getItem('profile_name'));
    const needAll = (typeof AchProgress?.totalVisible === 'number') ? AchProgress.totalVisible : FRONT_MIN_CLAIM_LEVEL;
    this.state.readiness = { achCount, need: needAll, cloud, tamper, nameSet };
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Ç–æ—Ä–æ–π —Ä—è–¥ –ø—Ä–∏–∑–æ–≤, –µ—Å–ª–∏ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —ç—Ç–∞–ø —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
    try {
      const secStart = localStorage.getItem('secret_start_at');
      const secRow = document.getElementById('prize-gallery-secret');
      if (secStart && secRow) secRow.style.display = '';
    } catch(e){}

    this.paintChecklist();
  },
  async ensureSessionActive() {
    try {
      // –ë—ã—Å—Ç—Ä—ã–π /me
      const r = await fetch(`${GLOBAL_STATS_URL}/me`, {
        method:'GET', mode:'cors', credentials:'include',
        headers: { ...apiAuthHeaders() }
      });
      const d = await r.json().catch(()=> ({}));
      if (r.ok && d?.ok && d?.auth) { this.state.authed = true; this.state.user = d.user || this.state.user; return true; }

      // –§–æ–ª–±—ç–∫: /auth/silent –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ tg_id
      const tgId = localStorage.getItem('tg_id');
      const username = localStorage.getItem('tg_username') || localStorage.getItem('tg_first_name') || null;
      if (!tgId) return false;

      const r2 = await fetch(`${GLOBAL_STATS_URL}/auth/silent`, {
        method:'POST',
        headers: { 'Content-Type':'application/json' },
        mode:'cors',
        credentials:'include',
        body: JSON.stringify({ tgId, username, deviceHash: getDeviceHash() })
      });
      const d2 = await r2.json().catch(()=> ({}));
      if (r2.ok && d2?.ok) {
        if (d2.sid) localStorage.setItem('vr_sid', d2.sid);
        this.state.authed = true;
        return true;
      }
      return false;
    } catch { return false; }
  },
  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å user-latest (–ø–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø –ø–æ tg_id)
  async recoverFromUserLatestIfAny() {
    try {
      const tgId = localStorage.getItem('tg_id');
      if (!tgId || !GLOBAL_STATS_URL) return;

      let url = `${GLOBAL_STATS_URL}/backup/user-latest`;
      const sid = localStorage.getItem('vr_sid');
      if (!sid) url += `?tg=${encodeURIComponent(tgId)}`;

      const res = await fetch(url, { method:'GET', mode:'cors', credentials:'include', headers: { ...apiAuthHeaders() }});
      const data = await res.json().catch(()=> ({}));
      if (!res.ok || !data?.ok || !data?.backup?.payload) return;

      const incoming = data.backup.payload;
      const calc = await sha256String(JSON.stringify(incoming));
      if (calc !== data.backup.checksum) return;
      if (incoming.deviceHash === getDeviceHash()) return;

      const curDone = getVisibleAchievementsCount();
      const incDone = incoming.achOverview?.normalDone || Object.keys(incoming.stats?.achievements||{}).filter(id => !ACH_META[id]?.hidden).length;
      if (incDone > curDone) {
        StatsStore.s = incoming.stats;
        if (!StatsStore.s.backups) StatsStore.s.backups = { dates: [] };
        if (!StatsStore.s.socialsVisited) StatsStore.s.socialsVisited = {};
        if (typeof StatsStore.s.sleepTimerStops !== 'number') StatsStore.s.sleepTimerStops = 0;
        if (Array.isArray(StatsStore.s.perTrack)) {
          for (let i = 0; i < StatsStore.s.perTrack.length; i++) {
            const pt = StatsStore.s.perTrack[i] || {};
            if (!Array.isArray(pt.byHour)) pt.byHour = Array(24).fill(0);
            if (!Array.isArray(pt.byWeekday)) pt.byWeekday = Array(7).fill(0);
            StatsStore.s.perTrack[i] = pt;
          }
        }
        StatsStore.save();
        AchProgress.updateFromStats();
        localStorage.removeItem('tamper_detected');
        hideTamperBanner();

        // –°—Ä–∞–∑—É –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ–º –±—ç–∫–∞–ø –ø–æ–¥ —Ç–µ–∫—É—â–∏–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º
        await backupSaveToCloudOverwriteSilent();
        this.updateLocalReadiness();
        NotificationSystem.success('–ü—Ä–æ–≥—Ä–µ—Å—Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞');
      }
    } catch(e) {
      // —Ç–∏—Ö–æ
    }
  },

  async fetchMe(silent=false) {
    try {
      if (!GLOBAL_STATS_URL) return;
      const res = await fetch(`${GLOBAL_STATS_URL}/me`, {
        method:'GET', mode:'cors', credentials:'include',
        headers: { ...apiAuthHeaders() }
      });
      const data = await res.json().catch(()=> ({}));

      if (res.ok && data?.ok && data?.auth) {
        this.state.authed = true;
        this.state.user = data.user || this.state.user;
        try {
          if (this.state.user?.display_name) {
            localStorage.setItem('profile_name', this.state.user.display_name);
          }
          if (this.state.user?.tg_id) {
            localStorage.setItem('tg_id', String(this.state.user.tg_id));
          }
          if (this.state.user?.tg_username) {
            localStorage.setItem('tg_username', String(this.state.user.tg_username));
          }
          // –°–æ—Ö—Ä–∞–Ω–∏–º –ø–µ—Ä–µ—á–µ–Ω—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –¥–ª—è knownDevices
          if (Array.isArray(data.devices)) {
            const arr = (data.devices || []).map(d => d.device_hash).filter(Boolean);
            localStorage.setItem('me_devices', JSON.stringify(arr.slice(0, 50)));
          }
        } catch(e){}
      } else {

        // –ù–ï –¥–∞—É–Ω–≥—Ä–µ–π–¥–∏–º, –µ—Å–ª–∏ –µ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π sid (–ª–∏–ø–∫–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è)
        if (localStorage.getItem('vr_sid')) {
          this.state.authed = true;
          // user –º–æ–≥–ª–∏ –Ω–µ –≤–µ—Ä–Ω—É—Ç—å ‚Äî –æ—Å—Ç–∞–≤–∏–º –ø—Ä–µ–∂–Ω–∏–π
        } else {
          this.state.authed = false;
          this.state.user = null;
        }
      }
      this.paintChecklist();
    } catch (e) {
      // –ü—Ä–∏ —Å–µ—Ç–µ–≤–æ–π –æ—à–∏–±–∫–µ ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å sid, –æ—Å—Ç–∞–≤–ª—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –≤–∫–ª—é—á–µ–Ω–Ω–æ–π
      if (localStorage.getItem('vr_sid')) {
        this.state.authed = true;
        this.paintChecklist();
      } else if (!silent) {
        NotificationSystem.warning('–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
      }
    }
  },

  async fetchStatus() {
    try {
      if (!GLOBAL_STATS_URL) return;
      const res = await fetch(`${GLOBAL_STATS_URL}/claim/status`, {
        method:'GET', mode:'cors', credentials:'include',
        headers: { ...apiAuthHeaders() }
      });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok || !data?.ok) { this.renderClaims([]); return; }
      this.renderClaims(data.claims || []);
    } catch { this.renderClaims([]); }
  },

  async renderClaims(claims) {
    this.state.claims = claims;
    const box = document.getElementById('prize-status');
    const wrap = document.getElementById('claim-cards');
    if (!box || !wrap) return;

    // –ï—Å–ª–∏ –∫–∞—Ç–∞–ª–æ–≥ –µ—â—ë –Ω–µ –ø–æ–¥–≥—Ä—É–∂–µ–Ω ‚Äî –ø–æ–¥–≥—Ä—É–∑–∏–º –∏ –ø–æ–≤—Ç–æ—Ä–∏–º —Ä–µ–Ω–¥–µ—Ä
    if ((!this.state.prizes || this.state.prizes.length === 0) && GLOBAL_STATS_URL) {
      this.loadPrizes().then(()=> this.renderClaims(claims)).catch(()=>{});
    }

    if (!claims.length) {
      box.style.display = 'none';
      wrap.innerHTML = '';
      // –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∑–∞—è–≤–æ–∫ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∑–µ–ª—ë–Ω–æ–≥–æ —Ñ–ª–∞–≥–∞
      const flag = document.getElementById('prize-ready-flag');
      if (flag) flag.style.display = '';
      return;
    }
    box.style.display = '';

    const ruStatus = (s) => ({
      pending:   '–Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏',
      approved:  '–æ–¥–æ–±—Ä–µ–Ω–æ',
      shipped:   '–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',
      delivered: '–ø–æ–ª—É—á–µ–Ω–æ',
      rejected:  '–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ'
    }[s] || s);

    wrap.innerHTML = claims.map(c=>{
      const p = (this.state.prizes || []).find(x => x.id === c.prize_id);
      const img = p?.img || 'img/prize-01.png';
      const title = c.prize_title || p?.title || '–ü—Ä–∏–∑';
      const sub = p?.long || p?.short || '';

      // –¢—ç–≥–∏ —Å—Ç–∞—Ç—É—Å–∞
      const tags = [
        `<span class="pill">${ruStatus(c.status)}</span>`
      ];
      if (c.status === 'shipped' && c.tracking_code) {
        tags.push(`<span class="pill">—Ç—Ä–µ–∫: ${c.tracking_code}</span>`);
      }
      const tagsHtml = `<div class="claim-tags">${tags.join(' ')}</div>`;

      // –ö–Ω–æ–ø–∫–∞ –≤–Ω–∏–∑—É
      let actions = '';
      if (['pending','approved'].includes(c.status)) {
        actions = `<div class="claim-actions">
          <button class="prize-btn" style="background:#8a2a2a;" onclick="Prize.cancelClaim('${c.id}')">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>`;
      } else if (c.status === 'shipped') {
        const tr = c.tracking_code || '';
        const copyBtn = tr ? `<button class="prize-btn" onclick="Prize.copyTracking('${tr}')">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>` : '';
        const openBtn = tr ? `<button class="prize-btn" onclick="Prize.openTracking('${tr}')">–û—Ç–∫—Ä—ã—Ç—å</button>` : '';
        actions = `<div class="claim-actions" style="gap:8px; flex-wrap:wrap;">
          ${copyBtn} ${openBtn}
          <button class="prize-btn" onclick="Prize.markReceived('${c.id}')">–Ø –ø–æ–ª—É—á–∏–ª</button>
        </div>`;
      } else if (c.status === 'rejected') {
        actions = `<div class="claim-actions">
          <button class="prize-btn" onclick="openFeedbackModal()">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</button>
        </div>`;
      } else if (c.status === 'delivered') {
        actions = `<div class="claim-actions"><span class="prize-note" style="font-weight:800;color:#27b34c;">–°–ø–∞—Å–∏–±–æ!</span></div>`;
      }

      return `
        <div class="claim-card">
          <div class="claim-head">#${c.id.slice(0,8)}</div>
          <img class="claim-img" src="${img}" alt="">
          <div class="claim-title">${title}</div>
          <div class="claim-sub">${sub}</div>
          ${tagsHtml}
          ${actions}
        </div>`;
    }).join('');

    // –ï—Å–ª–∏ –∏–º–µ–µ—Ç—Å—è –ª—é–±–∞—è –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–∞—è –∑–∞—è–≤–∫–∞ –∏ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —ç—Ç–∞–ø –µ—â—ë –Ω–µ –Ω–∞—á–∞—Ç ‚Äî –Ω–∞—á–Ω—ë–º –µ–≥–æ
    try {
      const hasDelivered = claims.some(c => c.status === 'delivered');
      const secretStartAt = localStorage.getItem('secret_start_at');
      if (hasDelivered && !secretStartAt) {
        // –ï—Å–ª–∏ –µ—Å—Ç—å delivered_at —É –∫–∞–∫–æ–π-—Ç–æ –∑–∞—è–≤–∫–∏ ‚Äî –≤–æ–∑—å–º—ë–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π, –∏–Ω–∞—á–µ now
        const deliveredTs = Math.max(0, ...claims
          .filter(c=>c.status==='delivered')
          .map(c=>Number(c.delivered_at||0))
          .filter(Number.isFinite));
        const ts = deliveredTs > 0 ? deliveredTs : Date.now();
        localStorage.setItem('secret_start_at', String(ts));
        const secRow = document.getElementById('prize-gallery-secret');
        if (secRow) secRow.style.display = '';
        AchProgress.updateFromStats();
        await backupSaveToCloudOverwriteSilent();
        NotificationSystem.info('–°–µ–∫—Ä–µ—Ç–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã');
      }
    } catch(e){}

    // –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∑–∞—è–≤–∫–∞ ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º –∑–µ–ª—ë–Ω—ã–π —Ñ–ª–∞–≥ (–¥–µ–ª–∞–µ–º –∏ –∑–¥–µ—Å—å –Ω–∞ –≤—Å—è–∫–∏–π)
    const flag = document.getElementById('prize-ready-flag');
    if (flag) flag.style.display = 'none';
  },

  copyTracking(code) {
    if (!code) return;
    navigator.clipboard?.writeText(code).then(
      ()=> NotificationSystem.success('–¢—Ä–µ–∫‚Äë–Ω–æ–º–µ—Ä —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω'),
      ()=> NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å')
    );
  },

  openTracking(code) {
    if (!code) return;
    const isPochta = /^[0-9]{14}$/.test(code);
    const url = isPochta
      ? `https://www.pochta.ru/tracking#${encodeURIComponent(code)}`
      : `https://track24.ru/?code=${encodeURIComponent(code)}`;
    window.open(url, '_blank');
  },

  openPrizes() {
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –º–≥–Ω–æ–≤–µ–Ω–Ω–æ: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–µ–ª–µ—Ç–æ–Ω –∏ –≥—Ä—É–∑–∏–º –≤ —Ñ–æ–Ω–µ
    const list = document.getElementById('prize-list');
    if (list) {
      list.innerHTML = `
        <div class="stat-card" style="text-align:center; padding:16px;">
          –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏–∑—ã‚Ä¶
        </div>`;
    }
    document.getElementById('modal-prizes')?.classList.add('active');

    // –í —Ñ–æ–Ω–µ –≤–∞–ª–∏–¥–∏—Ä—É–µ–º —Å–µ—Å—Å–∏—é (–µ—Å–ª–∏ –Ω–∞–¥–æ) –∏ –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥
    this.ensureSessionActive().catch(()=>{}).finally(()=>{
      this.loadPrizes().then(()=>{
        const L = document.getElementById('prize-list');
        if (L) {
          L.innerHTML = (this.state.prizes || []).map(p => `
            <div class="prize-card">
              <img src="${p.img}" alt="">
              <div><div class="title">${p.title}</div><div class="sub">${p.short}</div></div>
              <button class="prize-btn choose" onclick="Prize.openPrizeDetail('${p.id}')">–í—ã–±—Ä–∞—Ç—å</button>
            </div>
          `).join('');
        }
      }).catch(()=> {
        const L2 = document.getElementById('prize-list');
        if (L2) L2.innerHTML = `<div class="stat-card" style="text-align:center; padding:16px;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–∑—ã</div>`;
      });
    });
  },

  closePrizesModal(){ document.getElementById('modal-prizes')?.classList.remove('active'); },
  backToPrizes(){ document.getElementById('modal-prize-detail')?.classList.remove('active'); this.openPrizes(); },

  async loadPrizes() {
    if (!GLOBAL_STATS_URL) throw new Error('no api');
    if (this.state.prizes.length) return;
    const res = await fetch(`${GLOBAL_STATS_URL}/prizes`);
    const data = await res.json().catch(()=> ({}));
    if (!res.ok || !data?.ok) throw new Error('bad');
    this.state.prizes = data.items || [];
  },

  openPrizeDetail(id) {
    const p = (this.state.prizes || []).find(x => x.id === id);
    if (!p) return;
    this.state.selectedPrize = p;
    const body = document.getElementById('prize-detail-body');
    if (body) {
      body.innerHTML = `
        <img src="${p.img}" class="prize-detail-img" alt="">
        <div style="font-weight:800; margin-bottom:6px;">${p.title}</div>
        <div style="color:#cfe3ff;">${p.long}</div>
      `;
    }
    this.closePrizesModal();
    document.getElementById('modal-prize-detail')?.classList.add('active');
  },

  closePrizeDetail(){ document.getElementById('modal-prize-detail')?.classList.remove('active'); },

  openShipping() {
    if (!this.state.selectedPrize) return;
    document.getElementById('modal-prize-detail')?.classList.remove('active');
    this.state.shippingMethod = null;
    document.getElementById('form-pickup').style.display = 'none';
    document.getElementById('form-courier').style.display = 'none';
    document.getElementById('modal-shipping')?.classList.add('active');
  },

  closeShipping(){ document.getElementById('modal-shipping')?.classList.remove('active'); },

  selectShipping(kind) {
    this.state.shippingMethod = kind;
    document.getElementById('form-pickup').style.display = (kind==='pickup') ? '' : 'none';
    document.getElementById('form-courier').style.display = (kind==='courier') ? '' : 'none';
  },

  async submitClaim() {
    if (!GLOBAL_STATS_URL) return;
    if (!this.state.selectedPrize) { NotificationSystem.warning('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–∑'); return; }
    if (!this.state.shippingMethod) { NotificationSystem.warning('–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è'); return; }

    let shipping = {};
    if (this.state.shippingMethod === 'pickup') {
      const city = document.getElementById('ship-city').value.trim();
      const pvz  = document.getElementById('ship-pvz').value.trim();
      const note = document.getElementById('ship-note').value.trim();
      if (!city || !pvz) { NotificationSystem.warning('–£–∫–∞–∂–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏ –ü–í–ó/–∫–æ–¥ –ü–í–ó'); return; }
      shipping = { city, pvz, note };
    } else {
      const fio = document.getElementById('ship-fio').value.trim();
      const addr= document.getElementById('ship-address').value.trim();
      const zip = document.getElementById('ship-zip').value.trim();
      if (!fio || !addr || !zip) { NotificationSystem.warning('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –§–ò–û, –∞–¥—Ä–µ—Å –∏ –∏–Ω–¥–µ–∫—Å'); return; }
      shipping = { fullName: fio, address: addr, zip };
    }
    // –°—Ç—Ä–∞—Ö—É–µ–º—Å—è: –µ—Å–ª–∏ —Å–µ—Å—Å–∏–∏ –Ω–µ—Ç ‚Äî —Ç–∏—Ö–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º —á–µ—Ä–µ–∑ /auth/silent
    const okSess = await this.ensureSessionActive();
    if (!okSess) {
      NotificationSystem.error('–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram');
      this.paintChecklist();
      return;
    }
    try {
      this.setBusy(true);
      await ensureCloudBackupReady(3000);

      const body = {
        deviceHash: getDeviceHash(),
        prizeId: this.state.selectedPrize.id,
        prizeTitle: this.state.selectedPrize.title,
        shippingMethod: this.state.shippingMethod,
        shipping
      };

      const res = await fetch(`${GLOBAL_STATS_URL}/claim`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', ...apiAuthHeaders() },
        mode:'cors',
        credentials:'include',
        body: JSON.stringify(body)
      });

      const data = await res.json().catch(()=> ({}));
      if (!res.ok || !data?.ok) {
        const err = data?.error || `HTTP_${res.status}`;
        if (err === 'no_cloud_backup') {
          await backupSaveToCloudOverwriteSilent();
          NotificationSystem.error('–ù–µ—Ç –æ–±–ª–∞—á–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥ –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ.');
        } else if (err === 'level_too_low') {
          NotificationSystem.error(`–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º ${data.need} –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π (—Å–µ–π—á–∞—Å ${data.level})`);
        } else if (err === 'duplicate') {
          NotificationSystem.warning('–ó–∞—è–≤–∫–∞ —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞');
        } else if (err === 'active_exists') {
          NotificationSystem.warning('–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –∑–∞—è–≤–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–¥–µ–ª ¬´–ú–æ–∏ –∑–∞—è–≤–∫–∏¬ª.');
          // –û—Ç–∫—Ä–æ–µ–º —Å—Ç–∞—Ç—É—Å —Å—Ä–∞–∑—É
          this.closeShipping();
          await this.fetchStatus();
        } else {
          NotificationSystem.error(`–û—à–∏–±–∫–∞ –∑–∞—è–≤–∫–∏: ${err}`);
        }
        return;
      }

      NotificationSystem.success('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
      this.closeShipping();
      await this.fetchStatus();
    } catch (e) {
      NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É');
    } finally {
      this.setBusy(false);
    }
  },

  async cancelClaim(id) {
    if (!GLOBAL_STATS_URL) return;
    if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?')) return;
    try{
      const res = await fetch(`${GLOBAL_STATS_URL}/claim/cancel`, {
        method:'POST', mode:'cors', credentials:'include',
        headers:{ 'Content-Type':'application/json', ...apiAuthHeaders() },
        body: JSON.stringify({ id })
      });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok || !data?.ok) { NotificationSystem.error(`–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å (${data?.error||res.status})`); return; }
      NotificationSystem.success('–ó–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞');

      // –û–±–Ω–æ–≤–∏–º —Å—Ç–∞—Ç—É—Å –∏ –µ—Å–ª–∏ –∑–∞—è–≤–æ–∫ –Ω–µ—Ç ‚Äî —Å—Ä–∞–∑—É –≤–µ—Ä–Ω—ë–º –Ω–∞ —ç—Ç–∞–ø –≤—ã–±–æ—Ä–∞ –ø—Ä–∏–∑–∞
      await this.fetchStatus();
      const noClaims = !this.state.claims || this.state.claims.length === 0;
      if (noClaims) {
        // –≤–µ—Ä–Ω—ë–º –∑–µ–ª—ë–Ω—ã–π —Ñ–ª–∞–≥/–∫–Ω–æ–ø–∫—É –∏ –æ—Ç–∫—Ä–æ–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–∑–æ–≤
        this.updateLocalReadiness();
        this.paintChecklist();
        setTimeout(()=> this.openPrizes(), 200);
      }
    } catch { 
      NotificationSystem.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã'); 
    }
  },

  async markReceived(id) {
    if (!GLOBAL_STATS_URL) return;
    if (!confirm('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ?')) return;
    try{
      const res = await fetch(`${GLOBAL_STATS_URL}/claim/received`, {
        method:'POST', mode:'cors', credentials:'include',
        headers:{ 'Content-Type':'application/json', ...apiAuthHeaders() },
        body: JSON.stringify({ id })
      });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok || !data?.ok) { NotificationSystem.error(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å (${data?.error||res.status})`); return; }

      // –°–ï–ö–†–ï–¢–ù–´–ô –≠–¢–ê–ü: —Å—Ç–∞—Ä—Ç—É–µ–º —Å–µ–π—á–∞—Å (–µ—Å–ª–∏ –µ—â—ë –Ω–µ –Ω–∞—á–∏–Ω–∞–ª–∏)
      const exist = localStorage.getItem('secret_start_at');
      if (!exist) {
        localStorage.setItem('secret_start_at', String(Date.now()));
        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Ç–æ—Ä–æ–π —Ä—è–¥ –ø—Ä–∏–∑–æ–≤
        const secRow = document.getElementById('prize-gallery-secret');
        if (secRow) secRow.style.display = '';
        // –û–±–Ω–æ–≤–∏—Ç—å —à–∫–∞–ª—ã (—Å–µ–∫—Ä–µ—Ç–Ω—ã–µ)
        AchProgress.updateFromStats();
        NotificationSystem.success('üéâ –û—Ç–∫—Ä—ã—Ç—ã —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ —É—Ä–æ–≤–Ω–∏');
        // –°—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω–∏–º –≤ –æ–±–ª–∞–∫–æ (overwrite)
        await backupSaveToCloudOverwriteSilent();
      }

      // –û–±–Ω–æ–≤–∏–º –∫–∞—Ä—Ç–æ—á–∫–∏ –∑–∞—è–≤–æ–∫ –∏ –ª–æ–∫–∞–ª—å–Ω—É—é –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å
      await this.fetchStatus();
      this.updateLocalReadiness();
    } catch { NotificationSystem.error('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è'); }
  },
};

// ==== –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê (Cloudflare Workers) ====
const GS_Q_KEY = 'vr_gs_queue_v1';

const GlobalStats = {
  period: 'all',
  sending: false,
  errorOnce: false,
  _retryAt: 0,
  _failCount: 0,

  async fetchConfig() {
    if (!GLOBAL_STATS_URL) return { masterEnabled:true, sendEnabled:false, showUI:true, requireTurnstile:true };
    const res = await fetch(`${GLOBAL_STATS_URL}/gs/config`, { mode:'cors' });
    const data = await res.json().catch(()=> ({}));
    if (!res.ok || !data?.ok) return { masterEnabled:true, sendEnabled:true, showUI:true, requireTurnstile:true };
    return data.config || { masterEnabled:true, sendEnabled:true, showUI:true, requireTurnstile:true };
  },

  init() {
    if (!FeatureFlags.globalStatsUI) return;
    this.root = document.getElementById('global-stats-root');
    this.body = document.getElementById('global-stats-body');
    this.toggleBtn = document.getElementById('global-stats-toggle');
    if (!this.root || !this.body || !this.toggleBtn) return;

    const open = localStorage.getItem('globalStatsOpen') === '1';
    this.toggleBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
    this.body.hidden = !open;

    this.toggleBtn.addEventListener('click', () => {
      const expanded = this.toggleBtn.getAttribute('aria-expanded') === 'true';
      const next = !expanded;
      this.toggleBtn.setAttribute('aria-expanded', next ? 'true' : 'false');
      this.body.hidden = !next;
      localStorage.setItem('globalStatsOpen', next ? '1' : '0');
      if (next) this.fetchAndRender();
    });

    // –ü–µ—Ä–∏–æ–¥: –í—Å–µ–≥–æ/–°–µ–≥–æ–¥–Ω—è/–ù–µ–¥–µ–ª—è/–ú–µ—Å—è—Ü
    ['all','today','week','month'].forEach(p=>{
      const el = document.getElementById('gs-tab-'+p);
      if (el) el.onclick = ()=>{
        this.period = p;
        ['all','today','week','month'].forEach(pp=>{
          const btn = document.getElementById('gs-tab-'+pp);
          if (btn) btn.classList.toggle('active', pp===p);
        });
        this.fetchAndRender(true);
      };
    });

    // –°–≤—ë—Ä—Ç–∫–∏
    const hT = document.getElementById('gs-hours-toggle');
    const hB = document.getElementById('gs-hours-bars');
    if (hT && hB) hT.onclick = ()=> hB.style.display = (hB.style.display==='none') ? '' : 'none';
    const wT = document.getElementById('gs-week-toggle');
    const wB = document.getElementById('gs-week-bars');
    if (wT && wB) wT.onclick = ()=> wB.style.display = (wB.style.display==='none') ? '' : 'none';

    // –£–¥–∞–ª—ë–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥
    this.fetchConfig().then(cfg=>{
      if (!cfg.showUI) {
        const root = document.getElementById('global-stats-root');
        if (root) root.style.display = 'none';
      }
      // –≤–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞—Ö
      localStorage.setItem('ff_global_stats_send', cfg.sendEnabled ? '1' : '0');
      FeatureFlags.globalStatsSend = cfg.sendEnabled;

      const opened = this.toggleBtn.getAttribute('aria-expanded') === 'true';
      if (opened) this.fetchAndRender();
    }).catch(()=>{});

    if (open) this.fetchAndRender();
    this.flush(); // –ø–æ–ø—Ä–æ–±—É–µ–º –≤—ã–≥—Ä—É–∑–∏—Ç—å –æ—á–µ—Ä–µ–¥—å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  },

  enqueueEvent(ev) {
    try {
      if (!FeatureFlags.globalStatsSend) return;
      if (!GLOBAL_STATS_URL) return;
    const q = JSON.parse(localStorage.getItem(GS_Q_KEY) || '[]');
    if (!q.length) return;

    // –ù–û–í–û–ï: –æ—Ç–ø—Ä–∞–≤–∏–º —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏, –µ—Å–ª–∏ —Ñ–ª–∞–≥ –≤–∫–ª—é—á—ë–Ω —Å —Å–µ—Ä–≤–µ—Ä–∞
    try {
      const cfg = await this.fetchConfig();
      if (cfg.collectClientQueue) {
        fetch(`${GLOBAL_STATS_URL}/gs/client-queue`, {
          method: 'POST', mode: 'cors',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ q: q.length })
        }).catch(()=>{});
      }
    } catch(e){}

    this.sending = true;
    try {
      const payload = {
        deviceHash: getDeviceHash(),
        appVersion: VERSION,
        platform: navigator.userAgent,
        events: q
      };

  async flush() {
    if (!FeatureFlags.globalStatsSend) return;
    if (!GLOBAL_STATS_URL) return;
    if (this.sending) return;
    if (Date.now() < this._retryAt) return;

    // –¢—Ä–æ—Ç—Ç–ª–∏–Ω–≥: –Ω–µ —á–∞—â–µ –æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑ –≤ 8 —Å–µ–∫—É–Ω–¥
    this._lastSendAt = this._lastSendAt || 0;
    if (Date.now() - this._lastSendAt < 8000) return;

    const q = JSON.parse(localStorage.getItem(GS_Q_KEY) || '[]');
    if (!q.length) return;

    this.sending = true;
    try {
      const payload = {
        deviceHash: getDeviceHash(),
        appVersion: VERSION,
        platform: navigator.userAgent,
        events: q
      };

      // –ü–æ–ª—É—á–∞–µ–º –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π —Ç–æ–∫–µ–Ω Turnstile; –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
      const headers = { 'Content-Type': 'application/json' };
      try {
        const __tsToken = await getTurnstileToken('send_event');
        if (__tsToken) headers['CF-TURNSTILE-RESPONSE'] = __tsToken;
      } catch(e) { /* —Ç–∏—Ö–æ: —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏–º–µ—Ç, –µ—Å–ª–∏ requireTurnstile=false */ }

      const res = await fetch(`${GLOBAL_STATS_URL}/event`, {
        method: 'POST',
        headers,
        mode: 'cors',
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        throw new Error(`event_send_failed_${res.status}`);
      }

      localStorage.setItem(GS_Q_KEY, JSON.stringify([]));
      this._failCount = 0;
      this._retryAt = 0;
      this._lastSendAt = Date.now();
    } catch (e) {
      this._failCount = Math.min(this._failCount + 1, 10);
      const delay = Math.min(5 * 60 * 1000, Math.pow(2, this._failCount) * 1000);
      this._retryAt = Date.now() + delay;
      if (!this.errorOnce) {
        this.errorOnce = true;
        NotificationSystem.warning('–ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø–æ–≤—Ç–æ—Ä–∏–º –ø–æ–∑–∂–µ');
      }
    } finally {
      this.sending = false;
    }
  },

  async fetchAndRender(force=false) {
    if (!FeatureFlags.globalStatsUI) return;
    if (!this.root || this.body.hidden) return;
    const errEl = document.getElementById('gs-error');
    const topL = document.getElementById('gs-top-listens');
    const topT = document.getElementById('gs-top-time');
    const upd  = document.getElementById('gs-updated');

    if (!GLOBAL_STATS_URL) {
      if (errEl) { errEl.style.display = ''; errEl.textContent = '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å–µ—Ä–≤–µ—Ä –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.'; }
      if (topL) topL.innerHTML = '';
      if (topT) topT.innerHTML = '';
      if (upd)  upd.textContent = '‚Äî';
      return;
    }

    try {
      if (errEl) errEl.style.display = 'none';
      const res = await fetch(`${GLOBAL_STATS_URL}/top?period=${this.period}`, { mode: 'cors' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      this.renderLists(data);
    } catch (e) {
      if (errEl) errEl.style.display = '';
      if (!this.errorOnce) {
        this.errorOnce = true;
        NotificationSystem.warning('–ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
      }
    }
  },

  renderLists(data) {
    const topL = document.getElementById('gs-top-listens');
    const topT = document.getElementById('gs-top-time');
    const upd  = document.getElementById('gs-updated');
    const topC = document.getElementById('gs-top-cities');
    const topU = document.getElementById('gs-top-users');
    const barsH= document.getElementById('gs-hours-bars');
    const barsW= document.getElementById('gs-week-bars');
    if (!config) return;

    const toTitle = (idx)=> (config?.tracks?.[idx]?.title || `–¢—Ä–µ–∫ ${(idx+1)}`);

    const list1 = (data.top_listens||[]).slice(0,5).map(x=>(`<li><span>${toTitle(x.idx)}</span><span>${x.count||0}</span></li>`)).join('');
    const list2 = (data.top_time||[]).slice(0,5).map(x=>{
      const mins = Math.round((x.seconds||0)/60);
      return `<li><span>${toTitle(x.idx)}</span><span>${mins}</span></li>`;
    }).join('');

    if (topL) topL.innerHTML = list1 || '<li><span>‚Äî</span><span>0</span></li>';
    if (topT) topT.innerHTML = list2 || '<li><span>‚Äî</span><span>0</span></li>';
    if (upd)  upd.textContent = data.updatedAt ? new Date(data.updatedAt).toLocaleString() : '‚Äî';

    // –¢–æ–ø –≥–æ—Ä–æ–¥–æ–≤
    if (topC) {
      const arr = (data.top_cities||[]).slice(0,10);
      topC.innerHTML = arr.length ? arr.map(c=>{
        const flag = getFlagEmoji(c.cc);
        return `<li><span>${flag} ${escapeHtml(c.city)}</span><span>${c.users}</span></li>`;
      }).join('') : '<li><span>‚Äî</span><span>0</span></li>';
    }

    // –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    if (topU) {
      const arr = (data.top_users||[]).slice(0,10);
      topU.innerHTML = arr.length ? arr.map(u=>{
        const name = escapeHtml(u.name||`@user_${String(u.tgId).slice(-4)}`);
        const span = (typeof u.spanSec==='number') ? formatSpan(u.spanSec) : '‚Äî';
        return `<li><span>${name}</span><span>${u.count||0} ‚Ä¢ ${span}</span></li>`;
      }).join('') : '<li><span>‚Äî</span><span>0</span></li>';
    }

    // –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã
    if (barsH) {
      const max = Math.max(1, ...((data.by_hour||[])));
      barsH.innerHTML = (data.by_hour||[]).map((v,h)=>(
        `<div class="chart-row">
           <div class="label">${String(h).padStart(2,'0')}</div>
           <div class="bar"><div class="fill" style="width:${Math.round((v/max)*100)}%"></div></div>
           <div class="val">${v}</div>
         </div>`
      )).join('');
    }
    if (barsW) {
      const labels = ['–í—Å','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±']; // /top: 0..6 = –í—Å..–°–±
      const arr = data.by_weekday||[];
      const max = Math.max(1, ...arr);
      barsW.innerHTML = arr.map((v,d)=>(
        `<div class="chart-row">
           <div class="label">${labels[d]||d}</div>
           <div class="bar"><div class="fill" style="width:${Math.round((v/max)*100)}%"></div></div>
           <div class="val">${v}</div>
         </div>`
      )).join('');
    }
  }
};

// ==== Animated Noto Emoji (Lottie + WebP+PNG fallback) ====
const AnimatedEmoji = {
  base: 'assets/emoji/noto',
  disable: (localStorage.getItem('emoji_anim_disable') === '1')
           || window.matchMedia('(prefers-reduced-motion: reduce)').matches,

  map: {
    info:        { id: 'loudspeaker',       txt: 'üì¢' },
    success:     { id: 'white_check_mark',  txt: '‚úÖ' },
    error:       { id: 'cross_mark',        txt: '‚ùå' },
    warning:     { id: 'warning',           txt: '‚ö†Ô∏è' },
    offline:     { id: 'satellite_antenna', txt: 'üì°' },
    achievement: { id: 'trophy',            txt: 'üèÜ' },
    sparkles:    { id: 'sparkles',          txt: '‚ú®' }, // –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏ –≤ bubble
  },

  async ensureLottie() {
    if (this._lottie) return this._lottie;
    await new Promise((res, rej)=>{
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js';
      s.onload = res; s.onerror = rej; document.head.appendChild(s);
    });
    this._lottie = window.lottie;
    return this._lottie;
  },

  chooseKey(type, message) {
    if (type === 'success' && message && /^üèÜ/.test(message)) return 'achievement';
    return (type in this.map) ? type : 'info';
  },

  async mount(container, type, message, size=24, sid) {
    if (!container) return;
    const key = sid ? sid : this.chooseKey(type, message);
    const meta = this.map[key] || this.map.info;
    const id = meta.id;
    container.textContent = '';
    container.style.width = container.style.height = size + 'px';

    if (this.disable) {
      const img = document.createElement('img');
      img.alt = ''; img.width = img.height = size;
      img.src = `${this.base}/static/${id}.png`;
      img.onerror = () => { container.textContent = meta.txt; };
      container.appendChild(img);
      return;
    }

    try {
      await this.ensureLottie();
      const anim = window.lottie.loadAnimation({
        container,
        renderer: 'svg',
        loop: false,
        autoplay: true,
        path: `${this.base}/animated/${id}.json`
      });
      setTimeout(()=>{ try { anim.stop(); } catch(e){} }, 1200);
      return;
    } catch (e) {}

    // fallback
    const img = document.createElement('img');
    img.alt = ''; img.width = img.height = size;
    img.src = `${this.base}/fallback/${id}.webp`;
    img.onerror = () => {
      img.src = `${this.base}/fallback/${id}.png`;
      img.onerror = () => { container.textContent = meta.txt; };
    };
    container.appendChild(img);
  }
};
// ==== –ë—ç–∫–∞–ø: —ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç ====
async function backupExport(levelForName) {
  try {
    const payload = {
      appVersion: VERSION,
      buildDate: BUILD_DATE,
      exportedAt: new Date().toISOString(),
      deviceHash: getDeviceHash(),
      stats: StatsStore.s,
      statsInsights: MyStats && MyStats.insights ? MyStats.insights() : null
    };
    const checksum = await sha256String(JSON.stringify(payload));
    const file = { kind: 'vr_backup_v1', checksum, payload };
    const blob = new Blob([JSON.stringify(file, null, 2)], { type: 'application/json' });

    const date = new Date().toISOString().replace(/[:T]/g,'-').slice(0,19);
    const lvl = (typeof levelForName === 'number') ? `-lvl${levelForName}` : '';
    const fname = `vitrina-backup-${date}${lvl}.json`;

    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = fname;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      URL.revokeObjectURL(a.href);
      a.remove();
    }, 500);

    // —É—á—ë—Ç –∞—á–∏–≤–æ–∫ backup_*
    const dayKey = localDayKey(Date.now());
    if (!StatsStore.s.backups.dates.includes(dayKey)) {
      StatsStore.s.backups.dates.push(dayKey);
    }
    StatsStore.save();
    Ach.unlock('backup_first');
    if (StatsStore.s.backups.dates.length >= 3) Ach.unlock('backup_3_days');
    if (StatsStore.s.lastMajorAchAt && (Date.now() - StatsStore.s.lastMajorAchAt) <= 24*60*60*1000) {
      Ach.unlock('backup_after_major');
    }
    NotificationSystem.success('–ë—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
  } catch (e) {
    console.error(e);
    NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø');
  }
}
async function backupShare() {
  try {
    const payload = {
      appVersion: VERSION,
      buildDate: BUILD_DATE,
      exportedAt: new Date().toISOString(),
      deviceHash: getDeviceHash(),
      stats: StatsStore.s,
      statsInsights: MyStats && MyStats.insights ? MyStats.insights() : null
    };
    const checksum = await sha256String(JSON.stringify(payload));
    const file = { kind: 'vr_backup_v1', checksum, payload };
    const jsonText = JSON.stringify(file, null, 2);

    if (navigator.canShare && window.File && navigator.canShare({ files: [new File([""],"a.json")] })) {
      const blob = new Blob([jsonText], { type: 'application/json' });
      const fname = `vitrina-backup-${new Date().toISOString().replace(/[:T]/g,'-').slice(0,19)}.json`;
      const f = new File([blob], fname, { type: 'application/json' });
      await navigator.share({ title: '–ë—ç–∫–∞–ø –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π', text: '–ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –∞—á–∏–≤–∫–∏', files: [f] });
      NotificationSystem.success('–ë—ç–∫–∞–ø –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
    } else if (navigator.share) {
      await navigator.share({ title: '–ë—ç–∫–∞–ø –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π', text: jsonText });
      NotificationSystem.success('–ë—ç–∫–∞–ø –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–∞–∫ —Ç–µ–∫—Å—Ç');
    } else {
      await navigator.clipboard.writeText(jsonText);
      NotificationSystem.success('JSON –±—ç–∫–∞–ø–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä');
    }
  } catch(e) {
    NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –±—ç–∫–∞–ø');
  }
}
// === –û–±—â–∏–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä payload/—Ñ–∞–π–ª–∞ –¥–ª—è –±—ç–∫–∞–ø–∞ ===
async function buildBackupFile() {
  const u = Prize?.state?.user || {};
  const lsTgId = localStorage.getItem('tg_id');
  const lsTgUsername = localStorage.getItem('tg_username');
  const lsProfileName = localStorage.getItem('profile_name');

  // –ò–∑–≤–µ—Å—Ç–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–ª–æ–∫–∞–ª—å–Ω—ã–µ + –∏–∑ /me)
  const knownSet = new Set();
  try {
    const localKnown = JSON.parse(localStorage.getItem('known_devices') || '[]');
    localKnown.forEach(d => knownSet.add(String(d)));
  } catch(e){}
  try {
    const meDev = JSON.parse(localStorage.getItem('me_devices') || '[]');
    meDev.forEach(d => knownSet.add(String(d)));
  } catch(e){}
  knownSet.add(getDeviceHash());
  const knownDevices = Array.from(knownSet).slice(0, 50);

  // –ò–∑–±—Ä–∞–Ω–Ω—ã–µ
  const favorites = getLiked();

  // –û–±–∑–æ—Ä –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
  const ach = StatsStore.s?.achievements || {};
  const normalTotal = Object.keys(ACH_META).filter(id => !ACH_META[id]?.hidden).length;
  const normalDone  = Object.keys(ach).filter(id => !ACH_META[id]?.hidden).length;

  const secretTotal = Object.keys(ACH_META).filter(id => !!ACH_META[id]?.hidden).length;
  const secretStartAtStr = localStorage.getItem('secret_start_at');
  const secretStartAt = secretStartAtStr ? parseInt(secretStartAtStr, 10) : null;
  let secretDoneFromStart = 0;
  if (secretStartAt && Number.isFinite(secretStartAt)) {
    for (const [id, info] of Object.entries(ach)) {
      if (ACH_META[id]?.hidden) {
        const t = Number(info?.unlockedAt || 0);
        if (t && t >= secretStartAt) secretDoneFromStart++;
      }
    }
  }

  const payload = {
    appVersion: VERSION,
    buildDate: BUILD_DATE,
    exportedAt: new Date().toISOString(),
    deviceHash: getDeviceHash(),
    profile: {
      displayName: u?.display_name || lsProfileName || null,
      tgId: u?.tg_id || lsTgId || null,
      tgUsername: lsTgUsername || null
    },
    favorites,
    knownDevices,
    achOverview: {
      normalTotal,
      normalDone,
      secretTotal,
      secretDoneFromStart,
      secretStartAt: secretStartAt || null
    },
    stats: StatsStore.s,
    statsInsights: MyStats && MyStats.insights ? MyStats.insights() : null
  };

  const checksum = await sha256String(JSON.stringify(payload));
  const file = { kind: 'vr_backup_v1', checksum, payload };
  return file;
}
// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ–±–ª–∞–∫–æ (POST /backup)
async function backupSaveToCloud() {
  try {
    if (!GLOBAL_STATS_URL) {
      NotificationSystem.warning('–°–µ—Ä–≤–µ—Ä –æ–±–ª–∞—á–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
      return;
    }
    const file = await buildBackupFile();

    const res = await fetch(`${GLOBAL_STATS_URL}/backup`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Device-Hash': getDeviceHash()
      },
      mode: 'cors',
      body: JSON.stringify(file)
    });

    const data = await res.json().catch(()=> ({}));
    if (!res.ok || !data?.ok) {
      const err = data?.error || `HTTP_${res.status}`;
      NotificationSystem.error(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ: ${err}`);
      return;
    }

    // –í–ê–ñ–ù–û: —Å—Ç–∞–≤–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥ –∏ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π UI –∫–∞–∫ –ø—Ä–∏ –∞–≤—Ç–æ—Å–µ–π–≤–µ
    localStorage.setItem('CLOUD_SAVED_OK', '1');
    localStorage.setItem('CLOUD_SAVED_CRC', file.checksum);
    localStorage.setItem('CLOUD_SAVED_AT', String(Date.now()));
    setCloudSavedUI(true);
    try { Prize.updateLocalReadiness(); } catch(e){}

    NotificationSystem.success('–ë—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –æ–±–ª–∞–∫–µ');
  } catch (e) {
    console.error(e);
    NotificationSystem.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –æ–±–ª–∞–∫–æ');
  }
}

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –æ–±–ª–∞–∫–∞ (GET /backup/latest)
async function backupImportFromCloud() {
  try {
    if (!GLOBAL_STATS_URL) {
      NotificationSystem.warning('–°–µ—Ä–≤–µ—Ä –æ–±–ª–∞—á–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
      return;
    }
    const dev = getDeviceHash();
    const res = await fetch(`${GLOBAL_STATS_URL}/backup/latest?device=${encodeURIComponent(dev)}`, {
      method: 'GET',
      mode: 'cors'
    });
    const data = await res.json().catch(()=> ({}));
    if (!res.ok || !data?.ok || !data?.backup) {
      const err = data?.error || `HTTP_${res.status}`;
      if (res.status === 404 || err === 'not_found') {
        NotificationSystem.warning('–û–±–ª–∞—á–Ω—ã–π –±—ç–∫–∞–ø –Ω–µ –Ω–∞–π–¥–µ–Ω');
      } else {
        NotificationSystem.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ –æ–±–ª–∞–∫–∞: ${err}`);
      }
      return;
    }
    const serverFile = data.backup;
    if (serverFile?.kind !== 'vr_backup_v1' || !serverFile?.payload) {
      NotificationSystem.error('–§–æ—Ä–º–∞—Ç –æ–±–ª–∞—á–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω');
      return;
    }
    const calc = await sha256String(JSON.stringify(serverFile.payload));
    if (calc !== serverFile.checksum) {
      NotificationSystem.error('–û–±–ª–∞—á–Ω—ã–π —Ñ–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥—ë–Ω (checksum mismatch)');
      return;
    }
    if (serverFile.payload.deviceHash !== dev) {
      NotificationSystem.error('–û–±–ª–∞—á–Ω—ã–π –±—ç–∫–∞–ø –æ—Ç –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞');
      return;
    }

    const incoming = serverFile.payload;
    const currentDone = Object.keys(StatsStore.s.achievements||{}).length;
    const incomingDone = Object.keys(incoming.stats?.achievements||{}).length;
    if (incomingDone < currentDone) {
      if (!confirm('–í –æ–±–ª–∞—á–Ω–æ–º –±—ç–∫–∞–ø–µ –º–µ–Ω—å—à–µ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π, —á–µ–º —Å–µ–π—á–∞—Å. –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å?')) {
        return;
      }
    }

    StatsStore.s = incoming.stats;
    if (!StatsStore.s.backups) StatsStore.s.backups = { dates: [] };
    if (!StatsStore.s.socialsVisited) StatsStore.s.socialsVisited = {};
    if (typeof StatsStore.s.sleepTimerStops !== 'number') StatsStore.s.sleepTimerStops = 0;
    if (Array.isArray(StatsStore.s.perTrack)) {
      for (let i = 0; i < StatsStore.s.perTrack.length; i++) {
        const pt = StatsStore.s.perTrack[i] || {};
        if (!Array.isArray(pt.byHour)) pt.byHour = Array(24).fill(0);
        if (!Array.isArray(pt.byWeekday)) pt.byWeekday = Array(7).fill(0);
        StatsStore.s.perTrack[i] = pt;
      }
    }

    StatsStore.save();
    AchProgress.updateFromStats();
    localStorage.removeItem('tamper_detected');
    hideTamperBanner();

    NotificationSystem.success('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –æ–±–ª–∞–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ');
    try { Prize.updateLocalReadiness(); } catch(e){}
  } catch (e) {
    console.error(e);
    NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞');
  }
}

/**
 * –ù–µ–≤–∏–¥–∏–º—ã–π –∞–≤—Ç–æ—Å–µ–π–≤ —Å –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å—é (overwrite) –≤ –æ–±–ª–∞–∫–µ.
 * –¢—Ä–æ—Ç—Ç–ª–∏–Ω–≥: –Ω–µ —á–∞—â–µ 60 —Å–µ–∫; –¥—É–±–ª–∏ –ø–æ –æ–¥–Ω–æ–º—É –∏ —Ç–æ–º—É –∂–µ checksum –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è.
 * –£—Å–ø–µ—Ö => —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏, —É–∂–∏–º–∞–µ–º –±–ª–æ–∫, —Å—Ç–∞–≤–∏–º CLOUD_SAVED_OK=1.
 */
const CLOUD_SAVED_OK_KEY  = 'CLOUD_SAVED_OK';
const CLOUD_SAVED_CRC_KEY = 'CLOUD_SAVED_CRC';
const CLOUD_SAVED_AT_KEY  = 'CLOUD_SAVED_AT';

async function backupSaveToCloudOverwriteSilent() {
  try {
    if (!GLOBAL_STATS_URL) return;              // —Å–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
    if (localStorage.getItem('tamper_detected') === '1') return; // –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ tamper
    // —Ç—Ä–æ—Ç—Ç–ª–∏–Ω–≥ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
    const lastAt = parseInt(localStorage.getItem(CLOUD_SAVED_AT_KEY)||'0',10) || 0;
    if (Date.now() - lastAt < 60_000) return;

    const file = await buildBackupFile();
    const lastCrc = localStorage.getItem(CLOUD_SAVED_CRC_KEY);
    if (lastCrc && lastCrc === file.checksum) {
      // —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –º–µ–Ω—è–ª–æ—Å—å ‚Äî —Ç–æ–ª—å–∫–æ –æ—Ç–º–µ—Ç–∏–º UI, –µ—Å–ª–∏ —Ä–∞–Ω–µ–µ –±—ã–ª–æ –æ–∫
      if (localStorage.getItem(CLOUD_SAVED_OK_KEY) === '1') {
        setCloudSavedUI(true);
      }
      return;
    }

    const res = await fetch(`${GLOBAL_STATS_URL}/backup?overwrite=1`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Device-Hash': getDeviceHash(),
        'X-Backup-Mode': 'overwrite'  // –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
      },
      mode: 'cors',
      body: JSON.stringify(file)
    });

    const data = await res.json().catch(()=> ({}));
    if (res.ok && data?.ok) {
      localStorage.setItem(CLOUD_SAVED_OK_KEY, '1');
      localStorage.setItem(CLOUD_SAVED_CRC_KEY, file.checksum);
      localStorage.setItem(CLOUD_SAVED_AT_KEY, String(Date.now()));
      // –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π UI
      setCloudSavedUI(true);
      try { Prize.updateLocalReadiness(); } catch(e){}
    } else {
      // –Ω–µ —Å–±–∏–≤–∞–µ–º UI, –ø—Ä–æ—Å—Ç–æ –ø–æ–ø—Ä–æ–±—É–µ–º –ø–æ–∑–∂–µ
      localStorage.setItem(CLOUD_SAVED_AT_KEY, String(Date.now())); // —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å
    }
  } catch (e) {
    // –º–æ–ª—á–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º; –ø–æ–≤—Ç–æ—Ä–∏–º –ø–æ–∑–∂–µ
    localStorage.setItem(CLOUD_SAVED_AT_KEY, String(Date.now()));
  }
}
// –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º CLOU–î_SAVED_OK: –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –¥–µ–ª–∞–µ–º —Ç–∏—Ö–∏–π overwrite –∏ –∂–¥—ë–º –¥–æ timeoutMs
async function ensureCloudBackupReady(timeoutMs = 2000) {
  try {
    if (localStorage.getItem('CLOUD_SAVED_OK') === '1') return true;
    await backupSaveToCloudOverwriteSilent();
    const started = Date.now();
    while (Date.now() - started < timeoutMs) {
      if (localStorage.getItem('CLOUD_SAVED_OK') === '1') return true;
      await new Promise(r => setTimeout(r, 150));
    }
  } catch {}
  return localStorage.getItem('CLOUD_SAVED_OK') === '1';
}

/**
 * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è.
 * –ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å —É—Å–ª–æ–≤–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∞–≤—Ç–æ—Å–µ–π–≤ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ Tier>=3).
 */
function backupAutoSaveIfNeeded() {
  // –ü—Ä–∏–º–µ—Ä —É—Å–ª–æ–≤–∏—è: –ª—é–±—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
  backupSaveToCloudOverwriteSilent();
}

async function backupImportFromFile(file) {
  if (!file) return;
  try {
    const text = await file.text();
    const json = JSON.parse(text);
    if (json?.kind !== 'vr_backup_v1' || !json?.payload) {
      NotificationSystem.error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
      return;
    }
    const calc = await sha256String(JSON.stringify(json.payload));
    if (calc !== json.checksum) {
      NotificationSystem.error('–§–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥—ë–Ω (checksum mismatch)');
      return;
    }
    const incoming = json.payload;
    if (incoming.deviceHash !== getDeviceHash()) {
      NotificationSystem.error('–ë—ç–∫–∞–ø –æ—Ç –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞');
      return;
    }

    // –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç–∫–∞—Ç–∞
    const currentDone = Object.keys(StatsStore.s.achievements||{}).length;
    const incomingDone = Object.keys(incoming.stats?.achievements||{}).length;
    if (incomingDone < currentDone) {
      if (!confirm('–í –±—ç–∫–∞–ø–µ –º–µ–Ω—å—à–µ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π, —á–µ–º —Å–µ–π—á–∞—Å. –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å?')) {
        return;
      }
    }

    StatsStore.s = incoming.stats;
    // –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
    if (!StatsStore.s.backups) StatsStore.s.backups = { dates: [] };
    if (!StatsStore.s.socialsVisited) StatsStore.s.socialsVisited = {};
    if (typeof StatsStore.s.sleepTimerStops !== 'number') StatsStore.s.sleepTimerStops = 0;
        // –º–∏–≥—Ä–∞—Ü–∏—è: perTrack.byHour / byWeekday –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤
    if (Array.isArray(StatsStore.s.perTrack)) {
      for (let i = 0; i < StatsStore.s.perTrack.length; i++) {
        const pt = StatsStore.s.perTrack[i] || {};
        if (!Array.isArray(pt.byHour)) pt.byHour = Array(24).fill(0);
        if (!Array.isArray(pt.byWeekday)) pt.byWeekday = Array(7).fill(0);
        StatsStore.s.perTrack[i] = pt;
      }
    }

    StatsStore.save();
    AchProgress.updateFromStats();
    // –°–Ω—è—Ç–∏–µ —Ñ–ª–∞–≥–∞ tamper –∏ —Å–∫—Ä—ã—Ç–∏–µ –±–∞–Ω–Ω–µ—Ä–∞ –ø–æ—Å–ª–µ –≤–∞–ª–∏–¥–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞
    localStorage.removeItem('tamper_detected');
    hideTamperBanner();

    NotificationSystem.success('–ë—ç–∫–∞–ø –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω');
  } catch (e) {
    console.error(e);
    NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –±—ç–∫–∞–ø');
  }
}
function openResetModal(){ document.getElementById('reset-modal')?.classList.add('active'); }
function closeResetModal(){ document.getElementById('reset-modal')?.classList.remove('active'); }
document.getElementById('reset-modal').onclick = function(e){ if (e.target === this) closeResetModal(); };

function promptReset(kind) {
  const expect = kind==='all' ? '–°–±—Ä–æ—Å–∏—Ç—å-–í–°–Å' : (kind==='stats'?'–°–±—Ä–æ—Å–∏—Ç—å-–°–¢–ê–¢–´':'–°–±—Ä–æ—Å–∏—Ç—å-–ê–ß–ò–í–ö–ò');
  const code = prompt(`–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ: ${expect}`);
  if (code !== expect) {
    NotificationSystem.warning('–û—Ç–º–µ–Ω–µ–Ω–æ');
    return;
  }

  if (kind === 'stats' || kind === 'all') {
    const dev = getDeviceHash(); // device —Å–æ—Ö—Ä–∞–Ω—è–µ–º
    localStorage.removeItem(STATS_LS_KEY);
    StatsStore.init();
    StatsStore.s.deviceHash = dev;
    StatsStore.save();
  }
  if (kind === 'ach' || kind === 'all') {
    StatsStore.s.achievements = {};
    StatsStore.s.lastMajorAchAt = 0;
    StatsStore.save();
  }

  AchProgress.updateFromStats();
  NotificationSystem.success('–°–±—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω. –ú–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.');
}

// SHA-256 —Å—Ç—Ä–æ–∫–∏ (UTF-8)
async function sha256String(str) {
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
function openBackupPrompt() {
  const el = document.getElementById('modal-backup-prompt');
  if (!el) return;
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –ø–æ—Ä–æ–≥, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç
  try {
    const nextAtStr = localStorage.getItem('backup_prompt_next');
    const nextAt = nextAtStr ? parseInt(nextAtStr, 10) : null;
    const cur = getVisibleAchievementsCount();
    if (Number.isInteger(nextAt) && cur >= nextAt) {
      localStorage.removeItem('backup_prompt_next');
    }
  } catch {}
  el.classList.add('active');
}
function openBackupActions(){ document.getElementById('backup-actions-modal')?.classList.add('active'); }
function closeBackupActions(){ document.getElementById('backup-actions-modal')?.classList.remove('active'); }
document.getElementById('backup-actions-modal')?.addEventListener('click', (e)=>{
  if (e.target === e.currentTarget) closeBackupActions();
});

function closeBackupPrompt() {
  document.getElementById('modal-backup-prompt')?.classList.remove('active');
}
// –†–µ—à–µ–Ω–∏–µ: –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ –ø–æ–¥—Å–∫–∞–∑–∫—É –±—ç–∫–∞–ø–∞ –ø—Ä–∏ –¥–∞–Ω–Ω–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
function shouldShowBackupPrompt(doneVisible) {
  try {
    // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–µ–¥ –ø–æ—Å–ª–µ–¥–Ω–∏–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ–º (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
    const totalVisible = Object.keys(ACH_META).filter(id => !ACH_META[id]?.hidden).length;
    if (doneVisible === totalVisible - 1) return true;

    // –°—á–∏—Ç–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    const mode = localStorage.getItem('backup_prompt_mode'); // 'never' | null
    const nextAtStr = localStorage.getItem('backup_prompt_next'); // —á–∏—Å–ª–æ –≤ —Å—Ç—Ä–æ–∫–µ
    const nextAt = nextAtStr ? parseInt(nextAtStr, 10) : null;

    if (mode === 'never') return false;
    if (Number.isInteger(nextAt)) {
      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ø–æ—Ä–æ–≥ nextAt
      return doneVisible >= nextAt;
    }
    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º (–µ—Å–ª–∏ –¥—Ä—É–≥–∏–µ —É—Å–ª–æ–≤–∏—è Ach.unlock —Å—Ä–∞–±–æ—Ç–∞–ª–∏)
    return true;
  } catch {
    return true;
  }
}

// –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –≥–∞–ª–æ—á–µ–∫ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
function closeBackupPromptWithChoice() {
  try {
    const never = document.getElementById('backup-opt-never')?.checked;
    const plus5 = document.getElementById('backup-opt-5')?.checked;

    if (never) {
      localStorage.setItem('backup_prompt_mode', 'never');
      localStorage.removeItem('backup_prompt_next');
    } else if (plus5) {
      const cur = getVisibleAchievementsCount();
      localStorage.setItem('backup_prompt_next', String(cur + 5));
      localStorage.removeItem('backup_prompt_mode');
    } else {
      localStorage.removeItem('backup_prompt_mode');
      localStorage.removeItem('backup_prompt_next');
    }
  } catch {}
  closeBackupPrompt();
}

// === Anti‚Äëtamper banner helpers ===
function showTamperBanner() {
  const el = document.getElementById('tamper-banner');
  if (el) el.classList.remove('hidden');
}
function hideTamperBanner() {
  const el = document.getElementById('tamper-banner');
  if (el) el.classList.add('hidden');
}

// === Cloud autosave UI helpers ===
function setCloudSavedUI(saved) {
  const root = document.getElementById('ach-progress-root');
  if (!root) return;
  if (saved) {
    root.classList.add('cloud-saved');
  } else {
    root.classList.remove('cloud-saved');
  }
}
  
// –°–∫–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã—Ö –∞—á–∏–≤–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ (–±–µ–∑ —Å–∫—Ä—ã—Ç—ã—Ö)
function getVisibleAchievementsCount() {
  const ach = StatsStore.s?.achievements || {};
  return Object.keys(ach).filter(id => !ACH_META[id]?.hidden).length;
}

// –≠–∫—Å–ø–æ—Ä—Ç —Å —É—Ä–æ–≤–Ω–µ–º –≤ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
async function backupExportWithLevel() {
  closeBackupPrompt();
  const lvl = getVisibleAchievementsCount();
  await backupExport(lvl);
}

// ==================== –°–û–•–†–ê–ù–ï–ù–ò–ï –°–û–°–¢–û–Ø–ù–ò–Ø ====================
class PlayerState {
  static save() {
    const audio = document.getElementById('audio');
    const state = {
      trackIndex: currentTrack,
      position: audio ? audio.currentTime : 0,
      volume: audio ? audio.volume : 1,
      savedVolume: localStorage.getItem('playerVolume'),
      liked: getLiked(),
      timestamp: Date.now()
    };
    localStorage.setItem('playerState', JSON.stringify(state));
  }
  
  static restore() {
    try {
      const saved = localStorage.getItem('playerState');
      if (!saved) return null;
      
      const state = JSON.parse(saved);
      if (Date.now() - state.timestamp > 24 * 60 * 60 * 1000) {
        return null;
      }
      return state;
    } catch (e) {
      return null;
    }
  }
  
  static apply(state) {
    if (!state || !config) return;
    
    if (state.savedVolume) {
      localStorage.setItem('playerVolume', state.savedVolume);
    }
    
    if (state.trackIndex >= 0 && state.trackIndex < config.tracks.length) {
      showTrack(state.trackIndex, false);
      
      setTimeout(() => {
        const audio = document.getElementById('audio');
        if (audio && state.position > 0) {
          audio.currentTime = state.position;
          audio.volume = state.volume || 1;
        }
      }, 500);
    }
  }
}

// –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
setInterval(() => {
  const audio = document.getElementById('audio');
  if (audio && !audio.paused) {
    PlayerState.save();
  }
}, 5000);

window.addEventListener('beforeunload', () => {
  PlayerState.save();
});

// ==================== –ù–û–í–´–ô –ö–õ–ê–°–° –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–û–ó–ò–¶–ò–Ø–ú–ò ====================
class PositionManager {
  static save(trackId, position) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –¢–û–õ–¨–ö–û —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞
    localStorage.setItem('current_track_position', JSON.stringify({
      trackId,
      position,
      timestamp: Date.now()
    }));
  }
  
  static get(trackId) {
    const saved = localStorage.getItem('current_track_position');
    if (!saved) return null;
    
    try {
      const data = JSON.parse(saved);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —Ç–æ—Ç –∂–µ —Ç—Ä–µ–∫
      if (data.trackId !== trackId) {
        return null;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º TTL (1 —á–∞—Å = 3600000 –º—Å)
      const age = Date.now() - data.timestamp;
      if (age > 3600000) {
        localStorage.removeItem('current_track_position');
        return null;
      }
      
      return data.position;
    } catch (e) {
      return null;
    }
  }
  
  static clear() {
    localStorage.removeItem('current_track_position');
  }
  
  static clearAll() {
    // –û—á–∏—â–∞–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –ø–æ–∑–∏—Ü–∏–∏ (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    const keys = Object.keys(localStorage);
    keys.forEach(key => {
      if (key.startsWith('position_') || key === 'current_track_position') {
        localStorage.removeItem(key);
      }
    });
  }
}

// ==================== –ó–ê–ì–†–£–ó–ö–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò ====================
(async function loadAppConfigWithFallback() {
  const promoInp = document.getElementById('promo-inp');
  const promoBtn = document.getElementById('promo-btn');

  // –°—Ç—Ä–∞—Ö–æ–≤–∫–∞: –µ—Å–ª–∏ –∑–∞ 3 —Å–µ–∫. –Ω–µ –ø–æ–¥–≥—Ä—É–∑–∏—Ç—Å—è –∫–æ–Ω—Ñ–∏–≥ ‚Äî –≤–∫–ª—é—á–∞–µ–º —Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º
  let fallbackArmed = true;
  const safetyTimer = setTimeout(() => {
    if (!configLoaded && fallbackArmed) {
      console.warn('[config] safety fallback fired: enabling promo input');
      if (promoInp) promoInp.disabled = false;
      if (promoBtn) promoBtn.disabled = false;
      const err = document.getElementById('promo-error');
      if (err) err.textContent = '–ö–æ–Ω—Ñ–∏–≥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –í–∫–ª—é—á–µ–Ω —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Ä–µ–∂–∏–º –≤—Ö–æ–¥–∞.';
    }
  }, 3000);

  try {
    const resp = await fetch('./config.json', { cache: 'no-cache' });
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json();

    // –£—Å–ø–µ—Ö ‚Äî —Å–Ω–∏–º–∞–µ–º —Å—Ç—Ä–∞—Ö–æ–≤–∫—É
    clearTimeout(safetyTimer);
    fallbackArmed = false;

    config = data;
    configLoaded = true;

    if (promoInp) promoInp.disabled = false;
    if (promoBtn) promoBtn.disabled = false;

    if (localStorage.getItem('promoPassed') === '1') {
      promoPassed = true;
      document.getElementById('main-block').classList.remove('hidden');
      document.getElementById('promocode-block').classList.add('hidden');
      initializeMainUi();

      const savedState = PlayerState.restore();
      if (savedState) {
        PlayerState.apply(savedState);
      }
      parseDeepLink();
    }
  } catch (err) {
    // –û—à–∏–±–∫–∞ ‚Äî –≤–∫–ª—é—á–∞–µ–º fallback: –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª—è –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–ø–∞—Å–Ω–æ–π –ø—Ä–æ–º–æ–∫–æ–¥
    console.error('Failed to load config:', err);
    clearTimeout(safetyTimer);
    fallbackArmed = false;

    // –ë–∞–∑–æ–≤—ã–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥, —á—Ç–æ–±—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –ø–∞–¥–∞–ª–æ
    config = {
      albumName: '–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º',
      artist: '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
      albumYear: 2025,
      tracks: [],              // –ø—É—Å—Ç—ã–µ —Ç—Ä–µ–∫–∏, UI –≤—Å—ë —Ä–∞–≤–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø–æ–∑–∂–µ
      socials: [],
      promoCode: 'VITRINA2025',
      donateLink: '#'
    };
    configLoaded = false; // –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ ‚Äú—Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Ä–µ–∂–∏–º‚Äù

    if (promoInp) promoInp.disabled = false;
    if (promoBtn) promoBtn.disabled = false;

    const errBox = document.getElementById('promo-error');
    if (errBox) {
      errBox.textContent = '–ö–æ–Ω—Ñ–∏–≥ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –í–∫–ª—é—á–µ–Ω —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Ä–µ–∂–∏–º –≤—Ö–æ–¥–∞.';
      errBox.style.color = '#ffa';
    }
    NotificationSystem.warning('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ ‚Äî —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Ä–µ–∂–∏–º');
  }
})();

// ==================== –ü–†–û–ú–û–ö–û–î ====================
function checkPromo() {
  const inp = document.getElementById('promo-inp');
  const err = document.getElementById('promo-error');
  const val = (inp?.value || '').trim();

  // –†–∞–∑—Ä–µ—à–∞–µ–º –≤—Ö–æ–¥ –≤ –¥–≤—É—Ö —Ä–µ–∂–∏–º–∞—Ö:
  // 1) –û–±—ã—á–Ω—ã–π: configLoaded=true –∏ —Å–≤–µ—Ä—è–µ–º —Å config.promoCode
  // 2) –†–µ–∑–µ—Ä–≤–Ω—ã–π: configLoaded=false –∏ —Å–≤–µ—Ä—è–µ–º —Å fallback-–∫–æ–¥–æ–º (–∏–∑ config.promoCode, –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –≤ catch)
  if (!val) {
    if (err) err.innerText = "–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥";
    return;
  }

  const haveCfg = !!config && typeof config.promoCode === 'string';
  const expected = haveCfg ? String(config.promoCode) : 'VITRINA2025';

  if (val.toUpperCase() === expected.toUpperCase()) {
    promoPassed = true;
    localStorage.setItem('promoPassed', '1');
    document.getElementById('main-block').classList.remove('hidden');
    document.getElementById('promocode-block').classList.add('hidden');
    initializeMainUi();
    setOfflineUIState(offlineMode ? 'offline' : 'online');
    autoPlayEnabled = true;
  } else {
    if (err) err.innerText = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë!";
  }
}

document.getElementById('promo-inp').addEventListener('keydown', function(e) {
  if (e.key === "Enter") checkPromo();
});

// ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø UI ====================  
function initializeMainUi() {
  DOM.cover = document.getElementById('cover');
  DOM.trackList = document.getElementById('track-list');
  DOM.socialLinks = document.getElementById('social-links');
  
  setCoverImage(coverGalleryIdx);
  buildSocials();
  // ==== –≠—Ç–∞–ø 1: —Å—Ç–∞—Ä—Ç —Å—Ç–∞—Ç—ã –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å‚Äë–ø–∞–Ω–µ–ª–∏ ====
  StatsStore.init();
  AchProgress.init();
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö + –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–Ω–Ω–µ—Ä–∞
  Integrity.verifyOnBoot().then(ok => {
    if (!ok || localStorage.getItem('tamper_detected') === '1') {
      showTamperBanner();
    } else {
      hideTamperBanner();
    }
  });
  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∏–¥, –µ—Å–ª–∏ –∞–≤—Ç–æ—Å–µ–π–≤ —É–∂–µ –±—ã–ª –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω
  setCloudSavedUI(localStorage.getItem('CLOUD_SAVED_OK') === '1');

  // –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  MyStats.init();
  // –ü—Ä–∏–∑—ã
  Prize.init();
  // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  GlobalStats.init();
  // –û—Ç–∫—Ä—ã—Ç–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –ø–æ —Ç–∞–ø—É –Ω–∞ bubble
  const bubble = document.getElementById('ach-hint-bubble');
  if (bubble) {
    bubble.title = '–û—Ç–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π';
    bubble.addEventListener('click', () => openAchievementsModal('all'));
  }
  // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
  const achModalBg = document.getElementById('achievements-modal');
  if (achModalBg) {
    achModalBg.onclick = (e) => { if (e.target === achModalBg) closeAchievementsModal(); };
  }

  // –ü—Ä–∏–≤—è–∑–∫–∞ –∫–Ω–æ–ø–∫–∏ "–°–û–•–†–ê–ù–ò–¢–¨ –î–û–°–¢–ò–ñ–ï–ù–ò–Ø" (–º–µ–Ω—é –¥–µ–π—Å—Ç–≤–∏–π)
  document.getElementById('backup-export-btn')?.addEventListener('click', openBackupActions);
  const importInput = document.getElementById('backup-file-input');
  if (importInput) {
    importInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (file) backupImportFromFile(file);
      importInput.value = '';
    });
  }

  document.getElementById('support-link').href = config.donateLink;
  
  if (config.background) {
    document.body.style.background = `url(${config.background}) center/cover fixed #111`;
  }
  
  buildTrackList();
  updateAvailableTracks();
  
  // –ù–û–í–û–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à
  if (hasKeyboard()) {
    insertHotkeysButton();
  }
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–π
  restoreAnimationStates();
  
  document.getElementById('feedback-link').onclick = openFeedbackModal;
  document.getElementById('modal-feedback').onclick = function(e) {
    if (e.target === this) closeFeedbackModal();
  };
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Enter –≤ –ø–æ–ª–µ —á–∞—Ç–∞ + –∞–≤—Ç–æ‚Äë—Ñ–æ–∫—É—Å –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è
  const fbInp = document.getElementById('fb-input');
  if (fbInp) {
    fbInp.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (!fbInp.disabled) fbSend();
      }
    });
  }

  
  document.getElementById('cover-gallery-arrow-left').onclick = function() {
    setCoverImage(coverGalleryIdx - 1);
    startCoverAutoPlay();
  };
  
  document.getElementById('cover-gallery-arrow-right').onclick = function() {
    setCoverImage(coverGalleryIdx + 1);
    startCoverAutoPlay();
  };
  
  let startX = null;
  const el = document.getElementById('cover-wrap');
  
  el.addEventListener('touchstart', function(e) {
    startX = e.touches[0].clientX;
  });
  
  el.addEventListener('touchend', function(e) {
    if (startX === null) return;
    const dx = e.changedTouches[0].clientX - startX;
    if (Math.abs(dx) > 30) {
      if (dx > 0) {
        setCoverImage(coverGalleryIdx - 1);
      } else {
        setCoverImage(coverGalleryIdx + 1);
      }
      startCoverAutoPlay();
    }
    startX = null;
  });
  
  startCoverAutoPlay();
  initializeAlbumDownloadCheckboxes();
  detectIOSAndShowInstallGuide();
  setOfflineUIState(offlineMode ? 'offline' : 'online');
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ª–∏—Ä–∏–∫–∏
  restoreLyricsViewMode();
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω
  if (localStorage.getItem('favoritesFilter') === '1') {
    const liked = getLiked();
    if (liked.length > 0) {
      favoritesFilterActive = false;
      setTimeout(() => {
        toggleFavoritesFilter();
      }, 500);
    }
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ sleep —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
      checkSleepTimer();
    }
  });
  
  window.addEventListener('focus', checkSleepTimer);
}

// ==================== –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ê–ù–ò–ú–ê–¶–ò–ô ====================

// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–ª–∏—á–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
function hasKeyboard() {
  const isDesktop = !/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  const hasPointer = window.matchMedia('(pointer: fine)').matches;
  const canHover = window.matchMedia('(hover: hover)').matches;
  const noTouch = navigator.maxTouchPoints === 0;
  
  return (isDesktop && hasPointer) || (canHover && noTouch);
}

// –í—Å—Ç–∞–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à
function insertHotkeysButton() {
  const feedbackLink = document.getElementById('feedback-link');
  const downloadBtn = document.getElementById('download-album-main');
  
  if (feedbackLink && downloadBtn) {
    const hotkeysBtn = document.getElementById('hotkeys-btn');
    if (hotkeysBtn) {
      hotkeysBtn.style.display = 'block';
      // –í—Å—Ç–∞–≤–ª—è–µ–º –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–æ–π —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏ —Å—Å—ã–ª–∫–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
      downloadBtn.parentNode.insertBefore(hotkeysBtn, feedbackLink);
    }
  }
}

// –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à
function showHotkeysModal() {
  document.getElementById('hotkeys-modal').classList.add('active');
}

function closeHotkeysModal() {
  document.getElementById('hotkeys-modal').classList.remove('active');
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –ª–æ–≥–æ—Ç–∏–ø—É
function handleLogoClick() {
  if (!bitEnabled) return;
  
  // –¶–∏–∫–ª–∏—á–µ—Å–∫–∏ –º–µ–Ω—è–µ–º –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å
  if (bitIntensity === 100) {
    bitIntensity = 50;
  } else if (bitIntensity === 50) {
    bitIntensity = 15;
  } else {
    bitIntensity = 100;
  }
  
  localStorage.setItem('bitIntensity', bitIntensity.toString());
  NotificationSystem.info(`üíø –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –ø—É–ª—å—Å–∞—Ü–∏–∏: ${bitIntensity}%`);
}

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–π
function restoreAnimationStates() {
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –ª–∏—Ä–∏–∫–∏
  const savedAnimation = localStorage.getItem('animationEnabled');
  if (savedAnimation === '1') {
    animationEnabled = true;
  }
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—É–ª—å—Å–∞—Ü–∏–∏
  const savedBit = localStorage.getItem('bitEnabled');
  if (savedBit === '1') {
    bitEnabled = true;
  }
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å
  const savedIntensity = localStorage.getItem('bitIntensity');
  if (savedIntensity) {
    bitIntensity = parseInt(savedIntensity);
  }
}
// ==================== –§–£–ù–ö–¶–ò–ò –ê–ù–ò–ú–ê–¶–ò–ò ====================

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –ª–∏—Ä–∏–∫–∏
function toggleAnimation() {
  animationEnabled = !animationEnabled;
  
  const btn = document.getElementById('animation-btn');
  const animBg = document.querySelector('.lyrics-animated-bg');
  const lyricsWindow = document.getElementById('lyrics-window');
  
  if (animationEnabled) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∫–ª—é—á–µ–Ω–∏–∏
    if (!hasShownAnimationWarning) {
      hasShownAnimationWarning = true;
      localStorage.setItem('hasShownAnimationWarning', '1');
      
      if (confirm('–†–µ–∂–∏–º –∞–Ω–∏–º–∞—Ü–∏–∏ —Ñ–æ–Ω–∞ –ª–∏—Ä–∏–∫–∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥ –±–∞—Ç–∞—Ä–µ–∏. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤–∫–ª—é—á–µ–Ω–∏–µ
      } else {
        animationEnabled = false;
        return;
      }
    }
    
    if (btn) btn.classList.add('animation-active');
    if (animBg) animBg.classList.add('active');
    if (lyricsWindow) lyricsWindow.classList.add('animation-active');
    NotificationSystem.success('‚ú® –ê–Ω–∏–º–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏ –≤–∫–ª—é—á–µ–Ω–∞');
  } else {
    if (btn) btn.classList.remove('animation-active');
    if (animBg) animBg.classList.remove('active');
    if (lyricsWindow) lyricsWindow.classList.remove('animation-active');
    NotificationSystem.info('–ê–Ω–∏–º–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏ –≤—ã–∫–ª—é—á–µ–Ω–∞');
  }
  
  localStorage.setItem('animationEnabled', animationEnabled ? '1' : '0');
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—É–ª—å—Å–∞—Ü–∏–∏ –ª–æ–≥–æ—Ç–∏–ø–∞
function toggleBit() {
  bitEnabled = !bitEnabled;
  
  const btn = document.getElementById('bit-btn');
  const logo = document.getElementById('logo-bottom');
  
  if (bitEnabled) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∫–ª—é—á–µ–Ω–∏–∏
    if (!hasShownBitWarning) {
      hasShownBitWarning = true;
      localStorage.setItem('hasShownBitWarning', '1');
      
      if (confirm('–†–µ–∂–∏–º –ø—É–ª—å—Å–∞—Ü–∏–∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥ –±–∞—Ç–∞—Ä–µ–∏. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤–∫–ª—é—á–µ–Ω–∏–µ
      } else {
        bitEnabled = false;
        return;
      }
    }
    
    if (btn) btn.classList.add('bit-active');
    
    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    try {
      initAudioContext();
      startLogoPulsation();
      NotificationSystem.success('üéµ –ü—É–ª—å—Å–∞—Ü–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞ –≤–∫–ª—é—á–µ–Ω–∞');
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—É–ª—å—Å–∞—Ü–∏–∏:', e);
      bitEnabled = false;
      if (btn) btn.classList.remove('bit-active');
      NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –ø—É–ª—å—Å–∞—Ü–∏—é');
    }
  } else {
    if (btn) btn.classList.remove('bit-active');
    stopLogoPulsation();

    // –ú–Ø–ì–ö–û–ï –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤–µ—Å—å –∫–æ–Ω—Ç–µ–∫—Å—Ç (–Ω–∞ —á–∞—Å—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–æ–≤ —ç—Ç–æ —Å—Ç–æ–ø–æ—Ä–∏—Ç –ø–ª–µ–µ—Ä)
    try { if (audioSource) audioSource.disconnect(); } catch(e){}
    try { if (analyser) analyser.disconnect(); } catch(e){}
    analyser = null;
    audioSource = null;
    // audioContext –æ—Å—Ç–∞–≤–ª—è–µ–º –∂–∏—Ç—å ‚Äî –æ–Ω –±–æ–ª—å—à–µ –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω –∫ audio

    NotificationSystem.info('–ü—É–ª—å—Å–∞—Ü–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞');
  }
  
  localStorage.setItem('bitEnabled', bitEnabled ? '1' : '0');
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Web Audio API
function initAudioContext() {
  try {
    // –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º/–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º —É–∑–ª—ã
    if (!audioContext) {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      audioContext = new AudioContext();
    }
    
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 256;
    analyser.smoothingTimeConstant = 0.8;
    
    const audio = document.getElementById('audio');
    if (!audio) {
      console.warn('Audio —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return;
    }
    
    // –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫; –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–¥–∫–ª—é—á–∏–º –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∏ –≤—ã—Ö–æ–¥–∏–º
    try {
      if (!audioSource) {
        audioSource = audioContext.createMediaElementSource(audio);
        audioSource.connect(analyser);
        analyser.connect(audioContext.destination);
      } else {
        // –ò—Å—Ç–æ—á–Ω–∏–∫ —É–∂–µ —Å–æ–∑–¥–∞–Ω —Ä–∞–Ω—å—à–µ ‚Äî —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Ü–µ–ø–æ—á–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞
        try { audioSource.connect(analyser); } catch(e) {}
        try { analyser.connect(audioContext.destination); } catch(e) {}
      }
    } catch (e) {
      // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ ‚Äú–∏—Å—Ç–æ—á–Ω–∏–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç‚Äù ‚Äî –Ω–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º audio, –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
      console.warn('MediaElementSource —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ');
    }

    // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –µ—Å–ª–∏ –æ–Ω –±—ã–ª –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
    if (audioContext.state === 'suspended') {
      audioContext.resume();
    }
    
  } catch (e) {
    console.error('Web Audio API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è:', e);
    
    // –û—á–∏—â–∞–µ–º –≤—Å—ë –ø—Ä–∏ –æ—à–∏–±–∫–µ
    if (audioContext) {
      try {
        audioContext.close();
      } catch (closeError) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:', closeError);
      }
    }
    
    audioContext = null;
    audioSource = null;
    analyser = null;
    
    throw e; // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–∞–ª—å—à–µ
  }
}
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –∫ –Ω–æ–≤–æ–º—É audio —ç–ª–µ–º–µ–Ω—Ç—É
function reattachAudioEventListeners(audioEl) {
  if (!audioEl) return;

  audioEl.addEventListener('loadedmetadata', onAudioMetadataLoaded);
  audioEl.addEventListener('timeupdate', onAudioTimeUpdate);
  audioEl.addEventListener('seeking', onAudioSeeking);
  audioEl.addEventListener('seeked', onAudioSeeked);
  audioEl.addEventListener('ended', onAudioEnded);
  audioEl.addEventListener('volumechange', onVolumeChange);

  // –ù–£–ñ–ù–û: play + —É—á—ë—Ç —Å—Ç–∞—Ä—Ç–∞
  audioEl.addEventListener('play', () => {
    if (bitEnabled && audioContext && audioContext.state === 'suspended') {
      audioContext.resume();
    }
    // —Ñ–∏–∫—Å–∞—Ü–∏—è –Ω–∞—á–∞–ª–∞ –¥–ª—è —Å—Ç–∞—Ç—ã
    Stats.onStart(currentTrack);
    // —Ñ–∏–∫—Å–∞—Ü–∏—è –Ω–∞—á–∞–ª–∞ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∞—á–∏–≤–æ–∫ (—Å–µ–∫—Ä–µ—Ç–∫–∏ –∏ —Å–µ—Å—Å–∏–∏)
    Session.onStart({ trackIndex: currentTrack, ts: Date.now() });
    updatePlayPauseIcon();
  });

  // –û–î–ò–ù –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ pause
  audioEl.addEventListener('pause', () => {
    Stats.onPauseOrStop({ ended: false });
    updatePlayPauseIcon();
  });

  audioEl.addEventListener('canplay', () => {
    if (bitEnabled && !analyser) {
      initAudioContext();
      startLogoPulsation();
    }
  });
}

// –ó–∞–ø—É—Å–∫ –ø—É–ª—å—Å–∞—Ü–∏–∏ –ª–æ–≥–æ—Ç–∏–ø–∞
function startLogoPulsation() {
  if (!bitEnabled || !analyser) return;
  
  const logo = document.getElementById('logo-bottom');
  if (!logo) return;
  
  // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏
  logo.classList.add('logo-pulsing');
  
  const bufferLength = analyser.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLength);
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
  let lastScale = 1;
  
  function animate() {
    if (!bitEnabled) {
      if (lastScale !== 1) {
        logo.style.transform = 'scale3d(1, 1, 1)';
        lastScale = 1;
      }
      return;
    }
    
    animationFrame = requestAnimationFrame(animate);
    
    analyser.getByteFrequencyData(dataArray);
    
    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∏–∑–∫–∏–µ —á–∞—Å—Ç–æ—Ç—ã (–±–∞—Å—ã)
    let bass = 0;
    for (let i = 0; i < 8; i++) {
      bass += dataArray[i];
    }
    bass = bass / 8;
    
    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ä–µ–¥–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã
    let mid = 0;
    for (let i = 8; i < 32; i++) {
      mid += dataArray[i];
    }
    mid = mid / 24;
    
    // –ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º –¥–ª—è –æ–±—â–µ–π –ø—É–ª—å—Å–∞—Ü–∏–∏
    const amplitude = (bass * 0.7 + mid * 0.3) / 255;
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å
    const scaledAmplitude = amplitude * (bitIntensity / 100);
    
    // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –ª–æ–≥–æ—Ç–∏–ø (–æ—Ç 1 –¥–æ 1.3 –ø—Ä–∏ 100% –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏)
    const scale = 1 + (scaledAmplitude * 0.3);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
    if (Math.abs(scale - lastScale) > 0.01) {
      logo.style.transform = `scale3d(${scale}, ${scale}, 1)`;
      lastScale = scale;
    }
  }
  
  animate();
}

// –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—É–ª—å—Å–∞—Ü–∏–∏ –ª–æ–≥–æ—Ç–∏–ø–∞
function stopLogoPulsation() {
  const logo = document.getElementById('logo-bottom');
  if (logo) {
    logo.classList.remove('logo-pulsing');
    logo.style.transform = 'scale(1)';
  }
  
  if (animationFrame) {
    cancelAnimationFrame(animationFrame);
    animationFrame = null;
  }
  
  // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–¥–µ—Å—å, —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–ª–Ω–æ–º –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
}
  
// ==================== –ì–ê–õ–ï–†–ï–Ø –û–ë–õ–û–ñ–ï–ö ====================
function setCoverImage(idx) {
  coverGalleryIdx = (idx + coverGalleryArr.length) % coverGalleryArr.length;
  if (DOM.cover) {
    DOM.cover.src = coverGalleryArr[coverGalleryIdx];
  }
}

function startCoverAutoPlay() {
  if (coverAutoplay) clearInterval(coverAutoplay);
  coverAutoplay = setInterval(function() {
    setCoverImage(coverGalleryIdx + 1);
  }, 5000);
}

// ==================== –°–û–¶–ò–ê–õ–¨–ù–´–ï –°–ï–¢–ò ====================
function markSocialVisited(title) {
  StatsStore.s.socialsVisited[title] = true;
  StatsStore.save();
  try {
    const total = (config.socials || []).length;
    const visited = Object.keys(StatsStore.s.socialsVisited).length;
    if (total && visited >= total) {
      Ach.unlock('socials_all_visited');
    }
  } catch {}
}

function buildSocials() {
  if (!config || !config.socials) return;
  const links = config.socials.map(x => 
    `<a href="${x.url}" target="_blank" rel="noopener">${x.title}</a>`
  ).join(" ");
  if (DOM.socialLinks) {
    DOM.socialLinks.innerHTML = links;
  }
  // –£—á—ë—Ç –∫–ª–∏–∫–æ–≤ –ø–æ —Å–æ—Ü—Å—Å—ã–ª–∫–∞–º
  try {
    const anchors = DOM.socialLinks.querySelectorAll('a');
    anchors.forEach(a => {
      const title = a.textContent.trim();
      a.addEventListener('click', () => markSocialVisited(title), { once: true });
    });
  } catch {}
}

// ==================== –ò–ó–ë–†–ê–ù–ù–û–ï ====================
function getLiked() {
  try {
    return JSON.parse(localStorage.getItem('likedTracks') || "[]");
  } catch(e) {
    return [];
  }
}

function saveLiked(arr) {
  localStorage.setItem('likedTracks', JSON.stringify(arr));
}

function isLiked(idx) {
  const liked = getLiked();
  return liked.indexOf(idx) !== -1;
}

// –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
window.originalToggleLike = function(idx, e) {
  if (e) {
    e.stopPropagation();
  }
  
  let liked = getLiked();
  const wasLiked = liked.indexOf(idx) !== -1;
  
  if (wasLiked) {
    liked = liked.filter(i => i !== idx);
  } else {
    liked.push(idx);
  }
  
  saveLiked(liked);
  
  const star = e ? e.target : document.querySelector(`#trk${idx} .like-star`);
  if (star) {
    star.src = wasLiked ? 'img/star2.png' : 'img/star.png';
    star.title = wasLiked ? '–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è' : '–£–±—Ä–∞—Ç—å –∏–∑ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏—Ö—Å—è';
    
    star.classList.add('animating');
    setTimeout(() => {
      star.classList.remove('animating');
    }, 300);
  }
};

// –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è toggleLike —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ñ–∏–ª—å—Ç—Ä–æ–≤
function toggleLike(idx, e) {
  // –í—ã–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é (–≤–∏–∑—É–∞–ª, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)
  window.originalToggleLike(idx, e);

  // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω —Ñ–∏–ª—å—Ç—Ä ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∏ –∏–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ–º
  if (favoritesFilterActive) {
    updateFavoriteClasses();
    const trackList = document.getElementById('track-list');
    const visibleCount = trackList.querySelectorAll('.track.is-favorite').length;

    if (visibleCount === 0) {
      toggleFavoritesFilter();
      NotificationSystem.warning('–í—Å–µ —Ç—Ä–µ–∫–∏ —É–¥–∞–ª–µ–Ω—ã –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ, —Ñ–∏–ª—å—Ç—Ä –æ—Ç–∫–ª—é—á—ë–Ω');
    } else {
      const btn = document.getElementById('filter-favorites-btn');
      if (btn && btn.classList.contains('filtered')) {
        NotificationSystem.info(`‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤: ${visibleCount}`);
      }
    }
  }

  // –ï—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω —Ä–µ–∂–∏–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø–ª–µ–π–ª–∏—Å—Ç/–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
  if (favoritesOnlyMode) {
    updateAvailableTracks();
    if (!isLiked(currentTrack)) {
      const nextFavorite = getNextFavoriteTrack();
      if (nextFavorite !== -1) {
        NotificationSystem.info('–ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∏–∑–±—Ä–∞–Ω–Ω—ã–π —Ç—Ä–µ–∫');
        setTimeout(() => showTrack(nextFavorite, true), 500);
      } else {
        toggleFavoritesOnly();
        NotificationSystem.warning('–í—Å–µ —Ç—Ä–µ–∫–∏ —É–¥–∞–ª–µ–Ω—ã –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
      }
    }
    if (shuffleMode) {
      createShuffledPlaylist();
    }
  }

  // –í–ê–ñ–ù–û: –≤—Å–µ–≥–¥–∞ (–æ–¥–∏–Ω —Ä–∞–∑) –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞—á–∏–≤–∫–∏ –ø–æ –ª–∞–π–∫–∞–º
  const likedCountNow = getLiked().length;
  Stats.onLikedCountChanged(likedCountNow);
  Ach.evaluateFromLikes();
}

// ==================== –§–ò–õ–¨–¢–† –ò–ó–ë–†–ê–ù–ù–´–• –í –°–ü–ò–°–ö–ï (–ò–°–ü–†–ê–í–õ–ï–ù–û) ====================
function toggleFavoritesFilter() {
  const btn = document.getElementById('filter-favorites-btn');
  const trackList = document.getElementById('track-list');
  const liked = getLiked();
  
  favoritesFilterActive = !favoritesFilterActive;
  
  if (favoritesFilterActive) {
    if (liked.length === 0) {
      NotificationSystem.warning('–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤! –û—Ç–º–µ—Ç—å—Ç–µ —Ç—Ä–µ–∫–∏ –∑–≤—ë–∑–¥–æ—á–∫–æ–π ‚≠ê');
      favoritesFilterActive = false;
      return;
    }
    
    btn.textContent = '–ü–û–ö–ê–ó–ê–¢–¨ –í–°–ï –ü–ï–°–ù–ò';
    btn.classList.add('filtered');
    trackList.classList.add('filtered');
    
    updateFavoriteClasses();
    
    const visibleCount = trackList.querySelectorAll('.track.is-favorite').length;
    
    if (visibleCount === 0) {
      showNoFavoritesMessage();
    } else {
      NotificationSystem.success(`‚≠ê –ü–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ (${visibleCount} —Ç—Ä–µ–∫–æ–≤)`);
      
      setTimeout(() => {
        const firstFavorite = trackList.querySelector('.track.is-favorite');
        if (firstFavorite) {
          firstFavorite.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }, 100);
    }
    
    localStorage.setItem('favoritesFilter', '1');
    
    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö
    if (!favoritesOnlyMode) {
      favoritesOnlyMode = true;
      updateAvailableTracks();
      const btn = document.getElementById('favorites-btn');
      const icon = document.getElementById('favorites-btn-icon');
      if (btn) btn.classList.add('favorites-active');
      if (icon) icon.src = 'img/star.png';
      localStorage.setItem('favoritesOnlyMode', '1');
    }
    
  } else {
    btn.textContent = '–°–∫—Ä—ã—Ç—å –Ω–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ ‚≠ê –ø–µ—Å–Ω–∏';
    btn.classList.remove('filtered');
    trackList.classList.remove('filtered');
    
    const noFavMsg = document.getElementById('no-favorites-msg');
    if (noFavMsg) noFavMsg.remove();
    
    NotificationSystem.info('–ü–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ —Ç—Ä–µ–∫–∏');
    
    localStorage.removeItem('favoritesFilter');
    
    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö
    if (favoritesOnlyMode) {
      favoritesOnlyMode = false;
      updateAvailableTracks();
      const btn = document.getElementById('favorites-btn');
      const icon = document.getElementById('favorites-btn-icon');
      if (btn) btn.classList.remove('favorites-active');
      if (icon) icon.src = 'img/star2.png';
      localStorage.setItem('favoritesOnlyMode', '0');
    }
    
    if (currentTrack >= 0) {
      setTimeout(() => {
        document.getElementById(`trk${currentTrack}`)?.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'center' 
        });
      }, 100);
    }
  }
}

function updateFavoriteClasses() {
  const liked = getLiked();
  
  document.querySelectorAll('.track').forEach(track => {
    track.classList.remove('is-favorite');
  });
  
  liked.forEach(idx => {
    const trackEl = document.getElementById(`trk${idx}`);
    if (trackEl) {
      trackEl.classList.add('is-favorite');
    }
  });
}

function showNoFavoritesMessage() {
  const oldMsg = document.getElementById('no-favorites-msg');
  if (oldMsg) oldMsg.remove();
  
  const msg = document.createElement('div');
  msg.id = 'no-favorites-msg';
  msg.className = 'no-favorites-message';
  msg.innerHTML = `
    <div class="star-icon">‚≠ê</div>
    <div>–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤</div>
    <div style="font-size: 0.9em; margin-top: 10px; opacity: 0.7;">
      –û—Ç–º–µ—Ç—å—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è —Ç—Ä–µ–∫–∏ –∑–≤—ë–∑–¥–æ—á–∫–æ–π<br>
      —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∏—Ö –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
    </div>
  `;
  
  const trackList = document.getElementById('track-list');
  trackList.appendChild(msg);
}

// ==================== –°–ü–ò–°–û–ö –¢–†–ï–ö–û–í ====================
function buildTrackList() {
  const audio = document.getElementById('audio');
  let audioState = null;
  if (audio && currentTrack >= 0) {
    audioState = {
      currentTime: audio.currentTime,
      paused: audio.paused,
      volume: audio.volume
    };
  }
  
  let html = "";
  for (let i = 0; i < config.tracks.length; i++) {
    html += `<div class="track${i === currentTrack ? ' current' : ''}" id="trk${i}" onclick="pickAndPlayTrack(${i})">
      <span class="tnum">${(i + 1).toString().padStart(2, '0')}.</span>
      <span class="track-title">${config.tracks[i].title}</span>
      <img src="${isLiked(i) ? 'img/star.png' : 'img/star2.png'}" 
        class="like-star"
        alt="–∑–≤–µ–∑–¥–∞" 
        title="${isLiked(i) ? '–£–±—Ä–∞—Ç—å –∏–∑ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏—Ö—Å—è' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è'}"
        onclick="toggleLike(${i}, event)"/>
    </div>`;
    
    if (i === currentTrack) {
      html += `<div class="lyrics-player-block" id="lyricsplayerblock"></div>`;
    }
  }
  
  if (DOM.trackList) {
    DOM.trackList.innerHTML = html;
  }
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –µ—Å–ª–∏ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω
  if (favoritesFilterActive) {
    const trackList = document.getElementById('track-list');
    if (trackList) {
      trackList.classList.add('filtered');
      updateFavoriteClasses();
    }
  }
  
  if (currentTrack >= 0) {
    renderLyricsBlock();
    
    if (audioState) {
      setTimeout(() => {
        const newAudio = document.getElementById('audio');
        if (newAudio) {
          newAudio.currentTime = audioState.currentTime;
          newAudio.volume = audioState.volume;
          if (!audioState.paused) {
            newAudio.play().catch(e => console.log('Autoplay prevented:', e));
          }
        }
      }, 100);
    }
  }
}

// ==================== –ü–†–û–ò–ì–†–´–í–ê–¢–ï–õ–¨ ====================
function pickAndPlayTrack(n) {
  // –ò–°–ü–†–ê–í–õ–ï–ù–û: –û—á–∏—â–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–∏ —Ä—É—á–Ω–æ–º –≤—ã–±–æ—Ä–µ —Ç—Ä–µ–∫–∞
  PositionManager.clear();
  showTrack(n, true);
  autoPlayEnabled = true;
}

function showTrack(n, doPlay) {
  // –ò–°–ü–†–ê–í–õ–ï–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞
  if (currentTrack >= 0 && currentTrack !== n) {
    const audio = document.getElementById('audio');
    if (audio) {
      PositionManager.save(`track_${currentTrack}`, audio.currentTime);
    }
  }
  
  currentTrack = n;
  buildTrackList();
  
  // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ —Ç–æ—Ç –∂–µ —Ç—Ä–µ–∫
  if (!doPlay) {
    setTimeout(() => {
      checkAndRestorePosition();
    }, 100);
  }
  
  if (doPlay && document.getElementById("audio")) {
    setTimeout(() => {
      const audio = document.getElementById("audio");
      audio.currentTime = 0; // –ò–°–ü–†–ê–í–õ–ï–ù–û: –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ–º —Å –Ω–∞—á–∞–ª–∞ –ø—Ä–∏ —Ä—É—á–Ω–æ–º –≤—ã–±–æ—Ä–µ
      audio.play();
    }, 140);
  }
}

// –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏
function checkAndRestorePosition() {
  if (currentTrack < 0) return;
  
  const trackId = `track_${currentTrack}`;
  const savedPosition = PositionManager.get(trackId);
  
  if (savedPosition && savedPosition > 0) {
    const audio = document.getElementById('audio');
    if (audio) {
      audio.currentTime = savedPosition;
      NotificationSystem.info(`–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–æ —Å ${formatTime(savedPosition)}`);
    }
  }
}

// –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏
function saveCurrentPosition() {
  const audio = document.getElementById('audio');
  if (!audio || currentTrack < 0) return;
  
  const trackId = `track_${currentTrack}`;
  PositionManager.save(trackId, audio.currentTime);
}
// ==================== –ù–û–í–´–ô –ü–õ–ï–ï–† –° –ö–û–ù–¢–†–û–õ–ê–ú–ò (–ò–°–ü–†–ê–í–õ–ï–ù–û) ====================
function renderLyricsBlock() {
  const block = document.getElementById('lyricsplayerblock');
  if (!block) return;
  
  let lyricsDiv = `
    <div id="lyrics-window" class="lyrics-${lyricsViewMode}">
      <div class="lyrics-animated-bg${animationEnabled ? ' active' : ''}"></div>
      <div class="lyrics-scroll" id="lyrics"></div>
    </div>
    
    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä —Ç—Ä–µ–∫–∞ –ë–ï–ó –í–†–ï–ú–ï–ù–ò -->
    <div class="player-progress-wrapper">
      <div class="player-progress-bar" id="player-progress-bar">
        <div class="player-progress-fill" id="player-progress-fill">
          <div class="player-progress-handle"></div>
        </div>
      </div>
    </div>
    
    <div class="audio-wrapper">
      <audio id="audio" preload="metadata" aria-hidden="true" tabindex="-1"></audio>
    </div>
    
    <!-- –ù–û–í–ê–Ø –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å –≤—Ä–µ–º–µ–Ω–µ–º -->
    <div class="player-controls" role="group" aria-label="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º">
      <!-- –ü–µ—Ä–≤—ã–π —Ä—è–¥ —Å –≤—Ä–µ–º–µ–Ω–µ–º -->
      <div class="player-controls-row">
        <span class="time-in-controls" id="time-elapsed">00:00</span>
        
        <button class="player-control-btn" onclick="previousTrack()" 
                title="–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—Ä–µ–∫ (P)" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—Ä–µ–∫">
          <span class="tooltip">P</span>
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M11 5L4 12l7 7V5zm9 0v14l-7-7 7-7z"/>
          </svg>
        </button>
        
        <button class="player-control-btn main" onclick="togglePlayPause()" 
                title="–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ/–ü–∞—É–∑–∞ (K/–ü—Ä–æ–±–µ–ª)" aria-label="–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ/–ü–∞—É–∑–∞">
          <span class="tooltip">K</span>
          <svg id="play-pause-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8 5v14l11-7z"/>
          </svg>
        </button>
        
        <button class="player-control-btn" onclick="stopPlayback()" 
                title="–°—Ç–æ–ø (X)" aria-label="–°—Ç–æ–ø">
          <span class="tooltip">X</span>
          <svg viewBox="0 0 24 24" fill="currentColor">
            <rect x="6" y="6" width="12" height="12"/>
          </svg>
        </button>
        
        <button class="player-control-btn" onclick="nextTrack()" 
                title="–°–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫ (N)" aria-label="–°–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫">
          <span class="tooltip">N</span>
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M13 5l7 7-7 7V5zM4 5v14l7-7-7-7z"/>
          </svg>
        </button>
        
        <span class="time-in-controls" id="time-remaining">--:--</span>
      </div>
      
      <!-- –í—Ç–æ—Ä–æ–π —Ä—è–¥ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ -->
      <div class="player-controls-row">
        <button class="player-control-btn" id="mute-btn" onclick="toggleMute()" 
                title="–í—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫ (M)" aria-label="–í—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫">
          <span class="tooltip">M</span>
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
          </svg>
        </button>
        
        <button class="player-control-btn${shuffleMode ? ' active' : ''}" 
                id="shuffle-btn" onclick="toggleShuffle()" 
                title="–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ (U)" aria-label="–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫">
          <span class="tooltip">U</span>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 17h2.735a4 4 0 003.43-1.942l3.67-6.116A4 4 0 0116.265 7H21m0 0l-3-3m3 3l-3 3"/>
            <path d="M3 7h2.735a4 4 0 013.43 1.942l3.67 6.116A4 4 0 0016.265 17H21m0 0l-3 3m3-3l-3-3"/>
          </svg>
        </button>
        
        <button class="player-control-btn animation-btn${animationEnabled ? ' animation-active' : ''}" 
                id="animation-btn" onclick="toggleAnimation()" 
                title="–ê–Ω–∏–º–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏ (A)" aria-label="–ê–Ω–∏–º–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏">
          <span class="tooltip">A</span>
          A
        </button>
        
        <button class="player-control-btn bit-btn${bitEnabled ? ' bit-active' : ''}" 
                id="bit-btn" onclick="toggleBit()" 
                title="–ü—É–ª—å—Å–∞—Ü–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞ (B)" aria-label="–ü—É–ª—å—Å–∞—Ü–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞">
          <span class="tooltip">B</span>
          B
        </button>
        
        <button class="player-control-btn${repeatMode ? ' repeat-active' : ''}" 
                id="repeat-btn" onclick="toggleRepeat()" 
                title="–ü–æ–≤—Ç–æ—Ä —Ç—Ä–µ–∫–∞ (R)" aria-label="–ü–æ–≤—Ç–æ—Ä —Ç—Ä–µ–∫–∞">
          <span class="tooltip">R</span>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 2l4 4-4 4"/>
            <path d="M3 11V9a4 4 0 014-4h14"/>
            <path d="M7 22l-4-4 4-4"/>
            <path d="M21 13v2a4 4 0 01-4 4H3"/>
            <circle cx="12" cy="12" r="1" fill="currentColor" stroke="none"/>
          </svg>
        </button>
        
        <!-- Sleep —Ç–∞–π–º–µ—Ä -->
        <button class="sleep-timer-btn" id="sleep-timer-btn" onclick="toggleSleepMenu()"
                title="–¢–∞–π–º–µ—Ä —Å–Ω–∞ (T)" aria-label="–¢–∞–π–º–µ—Ä —Å–Ω–∞: –≤—ã–∫–ª—é—á–µ–Ω">
          <span class="tooltip">T</span>
          <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
            <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"/>
          </svg>
          <span class="sleep-timer-badge" id="sleep-timer-badge" style="display:none;">0</span>
          
          <!-- Sleep –º–µ–Ω—é -->
          <div class="sleep-menu" id="sleep-menu">
            <div class="sleep-menu-item" onclick="setSleepTimer('off')">–í—ã–∫–ª—é—á–∏—Ç—å</div>
            <div class="sleep-menu-item" onclick="setSleepTimer(15)">15 –º–∏–Ω—É—Ç</div>
            <div class="sleep-menu-item" onclick="setSleepTimer(30)">30 –º–∏–Ω—É—Ç</div>
            <div class="sleep-menu-item" onclick="setSleepTimer(60)">60 –º–∏–Ω—É—Ç</div>
            <div class="sleep-menu-item" onclick="showTimePickerForSleep()">–ö –≤—Ä–µ–º–µ–Ω–∏...</div>
          </div>
        </button>
        
        <button class="player-control-btn${favoritesOnlyMode ? ' favorites-active' : ''}" 
                id="favorites-btn" onclick="toggleFavoritesOnly()" 
                title="–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ (F)" aria-label="–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ">
          <span class="tooltip">F</span>
          <img src="img/${favoritesOnlyMode ? 'star.png' : 'star2.png'}" alt="‚òÖ" id="favorites-btn-icon"/>
        </button>
      </div>
    </div>
    
    <!-- –ö–æ–Ω—Ç—Ä–æ–ª—å –≥—Ä–æ–º–∫–æ—Å—Ç–∏ -->
    <div class="volume-control-wrapper">
      <div class="volume-header">
        <div class="volume-icon" onclick="toggleMute()">
          <svg id="volume-icon" viewBox="0 0 24 24">
            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
          </svg>
        </div>
        <span class="volume-percentage" id="volume-percentage">100%</span>
      </div>
      <div class="volume-slider-container">
        <div class="volume-track"></div>
        <div class="volume-fill" id="volume-fill"></div>
        <input type="range" class="volume-slider" id="volume-slider" 
               min="0" max="100" value="100" 
               aria-label="–ì—Ä–æ–º–∫–æ—Å—Ç—å"
               aria-valuemin="0" aria-valuemax="100" aria-valuenow="100">
      </div>
    </div>
    
    <div class="player-buttons-wrapper">
      <button class="lyrics-toggle-btn lyrics-${lyricsViewMode}" 
              onclick="toggleLyricsView()" 
              aria-label="${getLyricsButtonLabel()}"
              title="${getLyricsButtonLabel()} (Y)">
        <span class="lyrics-toggle-btn-visual">–¢</span>
      </button>
      <button class="karaoke-btn" onclick="copyLyrics()">–°–ö–û–ü–ò–†–û–í–ê–¢–¨ –¢–ï–ö–°–¢</button>
      <a class="player-download-btn" href="#" onclick="openDownloadModal(event)">–°–ö–ê–ß–ê–¢–¨ –ü–ï–°–ù–Æ</a>
    </div>`;
  
  block.innerHTML = lyricsDiv;
  
  const tr = config.tracks[currentTrack];
  const audioEl = document.getElementById('audio');
  audioEl.src = tr.audio;
  // Prefetch —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç—Ä–µ–∫–∞
  prefetchNextTrackAssets();

  loadLyrics(tr.lyrics);
  setupMediaSession();
  restorePlayerButtonsState();
  initializePlayerControls();
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∂–∏–º –ª–∏—Ä–∏–∫–∏
  initializeLyricsMode();
  applyLyricsViewMode();
  
  // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Web Audio API –ø—Ä–∏ –∫–∞–∂–¥–æ–π —Å–º–µ–Ω–µ —Ç—Ä–µ–∫–∞
  if (bitEnabled) {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—É—é –∞–Ω–∏–º–∞—Ü–∏—é
    stopLogoPulsation();
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç
    audioContext = null;
    audioSource = null;
    analyser = null;
    
    // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–∞–Ω–æ–≤–æ
    setTimeout(() => {
      initAudioContext();
      startLogoPulsation();
    }, 100);
  }
  
  // –°–æ–±—ã—Ç–∏—è –∞—É–¥–∏–æ
  audioEl.addEventListener('loadedmetadata', onAudioMetadataLoaded);
  audioEl.addEventListener('timeupdate', onAudioTimeUpdate);
  audioEl.addEventListener('seeking', onAudioSeeking);
  audioEl.addEventListener('seeked', onAudioSeeked);
  audioEl.addEventListener('ended', onAudioEnded);
  audioEl.addEventListener('volumechange', onVolumeChange);
  audioEl.addEventListener('play', () => {
    if (bitEnabled && audioContext && audioContext.state === 'suspended') {
      audioContext.resume();
    }
    Stats.onStart(currentTrack);
    Session.onStart({ trackIndex: currentTrack, ts: Date.now() });
    updatePlayPauseIcon();
  });
  audioEl.addEventListener('pause', () => {
    Stats.onPauseOrStop({ ended: false });
    updatePlayPauseIcon();
  });

  // –ù–û–í–û–ï: –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ–≥–æ —Ç—Ä–µ–∫–∞
  audioEl.addEventListener('canplay', () => {
    if (bitEnabled && !analyser) {
      initAudioContext();
      startLogoPulsation();
    }
  });
}

// ==================== –ö–ê–°–¢–û–ú–ù–´–ô –ü–õ–ï–ï–† ====================
let lastTimeUpdate = 0;
let isSeekingProgress = false;
let isMuted = false;
let sleepTimerInterval = null;
let sleepTimerTarget = null;
let sleepTimerMode = null;
let hasShownIOSVolumeNotice = false;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤ –ø–ª–µ–µ—Ä–∞
function initializePlayerControls() {
  // –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
  const progressBar = document.getElementById('player-progress-bar');
  if (progressBar) {
    progressBar.addEventListener('click', seekToPosition);
    progressBar.addEventListener('mousedown', startSeekDrag);
    progressBar.addEventListener('touchstart', startSeekDrag, { passive: false });
  }
  
  // –ì—Ä–æ–º–∫–æ—Å—Ç—å
  const volumeSlider = document.getElementById('volume-slider');
  if (volumeSlider) {
    volumeSlider.addEventListener('input', onVolumeSliderChange);
    volumeSlider.addEventListener('change', onVolumeSliderChange);
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é –≥—Ä–æ–º–∫–æ—Å—Ç—å
    const savedVolume = localStorage.getItem('playerVolume');
    if (savedVolume !== null) {
      const volume = parseFloat(savedVolume);
      volumeSlider.value = volume * 100;
      updateVolumeUI(volume);
      const audio = document.getElementById('audio');
      if (audio) audio.volume = volume;
    }
  }
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º sleep —Ç–∞–π–º–µ—Ä –µ—Å–ª–∏ –±—ã–ª
  restoreSleepTimer();
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–π
  if (animationEnabled) {
    const animBg = document.querySelector('.lyrics-animated-bg');
    const lyricsWindow = document.getElementById('lyrics-window');
    if (animBg) animBg.classList.add('active');
    if (lyricsWindow) lyricsWindow.classList.add('animation-active');
  }
} 
// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
function formatTime(seconds) {
  if (isNaN(seconds) || seconds < 0) return '--:--';
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// –°–æ–±—ã—Ç–∏—è –∞—É–¥–∏–æ
function onAudioMetadataLoaded() {
  const audio = document.getElementById('audio');
  const duration = audio.duration;
  
  const elapsedEl = document.getElementById('time-elapsed');
  const remainingEl = document.getElementById('time-remaining');
  
  if (elapsedEl) elapsedEl.textContent = '00:00';
  if (remainingEl) remainingEl.textContent = formatTime(duration);
  
  // –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
  audio.setAttribute('aria-label', `–¢—Ä–µ–∫ ${currentTrack + 1}, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ${formatTime(duration)}`);
  
  // –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ ‚Äî –º–æ–∂–Ω–æ –ø—Ä–µ—Ñ–µ—Ç—á–∏—Ç—å –∏ –∑–¥–µ—Å—å
  try { prefetchNextTrackAssets(); } catch(e){}
}

function onAudioTimeUpdate() {
  const audio = document.getElementById('audio');
  const currentTime = audio.currentTime;
  const duration = audio.duration;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä –í–°–ï–ì–î–ê –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
  if (!isSeekingProgress && duration > 0) {
    const progress = (currentTime / duration) * 100;
    const fillEl = document.getElementById('player-progress-fill');
    if (fillEl) fillEl.style.width = `${progress}%`;
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –ª–∏—Ä–∏–∫—É –í–°–ï–ì–î–ê –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
  renderLyricsEnhanced(currentTime);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è —Ç–æ–ª—å–∫–æ —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É
  const now = Date.now();
  if (now - lastTimeUpdate >= 1000) {
    lastTimeUpdate = now;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä—ã
    const elapsedEl = document.getElementById('time-elapsed');
    const remainingEl = document.getElementById('time-remaining');
    
    if (elapsedEl) elapsedEl.textContent = formatTime(currentTime);
    if (remainingEl) remainingEl.textContent = formatTime(duration - currentTime);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º sleep —Ç–∞–π–º–µ—Ä
    checkSleepTimer();
  }
  
  updatePlayPauseIcon();
}

function onAudioSeeking() {
  // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
}

function onAudioSeeked() {
  // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
}

// –ò–°–ü–†–ê–í–õ–ï–ù–û: –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫
function onAudioEnded() {
  // —É—á—ë—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è
  Stats.onPauseOrStop({ ended: true });
  const remainingEl = document.getElementById('time-remaining');
  if (remainingEl) remainingEl.textContent = '00:00';
  
  // –û—á–∏—â–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∑–∞–≤–µ—Ä—à–∏–≤—à–µ–≥–æ—Å—è —Ç—Ä–µ–∫–∞
  PositionManager.clear();
  
  if (repeatMode) {
    const audio = document.getElementById('audio');
    audio.currentTime = 0;
    audio.play();
  } else {
    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫
    nextTrack();
  }
}

// –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä - –ø–µ—Ä–µ–º–æ—Ç–∫–∞
function seekToPosition(e) {
  const audio = document.getElementById('audio');
  const progressBar = e.currentTarget;
  const rect = progressBar.getBoundingClientRect();
  const percent = (e.clientX - rect.left) / rect.width;
  const time = audio.duration * Math.max(0, Math.min(1, percent));
  
  audio.currentTime = time;
}

function startSeekDrag(e) {
  isSeekingProgress = true;
  
  const moveHandler = (e) => {
    const progressBar = document.getElementById('player-progress-bar');
    const rect = progressBar.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
    
    const fillEl = document.getElementById('player-progress-fill');
    if (fillEl) fillEl.style.width = `${percent * 100}%`;
  };
  
  const endHandler = (e) => {
    const progressBar = document.getElementById('player-progress-bar');
    const rect = progressBar.getBoundingClientRect();
    const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
    const percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
    
    const audio = document.getElementById('audio');
    audio.currentTime = audio.duration * percent;
    
    isSeekingProgress = false;
    
    document.removeEventListener('mousemove', moveHandler);
    document.removeEventListener('mouseup', endHandler);
    document.removeEventListener('touchmove', moveHandler);
    document.removeEventListener('touchend', endHandler);
  };
  
  document.addEventListener('mousemove', moveHandler);
  document.addEventListener('mouseup', endHandler);
  document.addEventListener('touchmove', moveHandler);
  document.addEventListener('touchend', endHandler);
  
  e.preventDefault();
}
// –ì—Ä–æ–º–∫–æ—Å—Ç—å
function onVolumeSliderChange(e) {
  const value = e.target.value / 100;
  const audio = document.getElementById('audio');
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º iOS
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  
  if (audio) {
    audio.volume = value;
    
    // –ù–∞ iOS –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–¥–∏–Ω —Ä–∞–∑
    if (isIOS && !hasShownIOSVolumeNotice && value !== audio.volume) {
      hasShownIOSVolumeNotice = true;
      showIOSVolumeNotice();
    }
  }
  
  updateVolumeUI(value);
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
  localStorage.setItem('playerVolume', value);
  PlayerState.save();
}

function onVolumeChange() {
  const audio = document.getElementById('audio');
  const volume = audio.volume;
  const slider = document.getElementById('volume-slider');
  
  if (slider) {
    slider.value = volume * 100;
  }
  
  updateVolumeUI(volume);
}

function updateVolumeUI(volume) {
  const percentage = Math.round(volume * 100);
  const percentEl = document.getElementById('volume-percentage');
  const fillEl = document.getElementById('volume-fill');
  
  if (percentEl) percentEl.textContent = `${percentage}%`;
  if (fillEl) fillEl.style.width = `${percentage}%`;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É
  const icon = document.getElementById('volume-icon');
  const muteBtn = document.getElementById('mute-btn');
  
  if (icon) {
    if (volume === 0 || isMuted) {
      icon.innerHTML = '<path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>';
      if (muteBtn) muteBtn.classList.add('active');
    } else if (volume < 0.5) {
      icon.innerHTML = '<path d="M7 9v6h4l5 5V4l-5 5H7z"/>';
      if (muteBtn) muteBtn.classList.remove('active');
    } else {
      icon.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>';
      if (muteBtn) muteBtn.classList.remove('active');
    }
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º aria
  const slider = document.getElementById('volume-slider');
  if (slider) {
    slider.setAttribute('aria-valuenow', percentage);
  }
}

function toggleMute() {
  const audio = document.getElementById('audio');
  if (!audio) return;
  
  if (isMuted) {
    audio.volume = parseFloat(localStorage.getItem('playerVolume') || 1);
    isMuted = false;
  } else {
    localStorage.setItem('playerVolume', audio.volume);
    audio.volume = 0;
    isMuted = true;
  }
  
  updateVolumeUI(audio.volume);
}

function showIOSVolumeNotice() {
  const notice = document.createElement('div');
  notice.className = 'ios-volume-notice';
  notice.textContent = '–ù–∞ iPhone –≥—Ä–æ–º–∫–æ—Å—Ç—å —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–Ω—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏';
  document.body.appendChild(notice);
  
  setTimeout(() => {
    notice.classList.add('show');
  }, 100);
  
  setTimeout(() => {
    notice.classList.remove('show');
    setTimeout(() => notice.remove(), 300);
  }, 3000);
}

// ==================== SLEEP –¢–ê–ô–ú–ï–† ====================
function toggleSleepMenu() {
  const menu = document.getElementById('sleep-menu');
  menu.classList.toggle('active');
  
  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–µ–Ω—é
  if (menu.classList.contains('active')) {
    setTimeout(() => {
      document.addEventListener('click', closeSleepMenu);
    }, 100);
  }
}

function closeSleepMenu(e) {
  if (e && e.target.closest('#sleep-timer-btn')) return;
  
  const menu = document.getElementById('sleep-menu');
  menu.classList.remove('active');
  document.removeEventListener('click', closeSleepMenu);
}

function setSleepTimer(minutes) {
  closeSleepMenu();
  
  if (minutes === 'off') {
    clearSleepTimer();
    return;
  }
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
  sleepTimerMode = minutes;
  sleepTimerTarget = Date.now() + (minutes * 60 * 1000);
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
  localStorage.setItem('sleepTimer', JSON.stringify({
    mode: sleepTimerMode,
    target: sleepTimerTarget,
    setAt: Date.now()
  }));
  
  // –û–±–Ω–æ–≤–ª—è–µ–º UI
  updateSleepTimerUI();
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
  NotificationSystem.info(`–¢–∞–π–º–µ—Ä —Å–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ ${minutes} –º–∏–Ω—É—Ç`);
  
  // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  if (sleepTimerInterval) clearInterval(sleepTimerInterval);
  sleepTimerInterval = setInterval(updateSleepTimerUI, 1000);
}

function showTimePickerForSleep() {
  closeSleepMenu();
  const now = new Date();
  const baseMin = now.getMinutes() + 30;
  const defHour = (now.getHours() + Math.floor(baseMin / 60)) % 24;
  const defMinute = baseMin % 60;

  const modal = document.createElement('div');
  modal.className = 'modal-bg active';
  modal.innerHTML = `
    <div class="modal-feedback" style="max-width: 300px;">
      <button class="bigclose" onclick="this.closest('.modal-bg').remove()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48">
          <line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          <line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
        </svg>
      </button>
      <h3>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä –¥–æ:</h3>
      <div style="display: flex; gap: 10px; justify-content: center; margin: 20px 0;">
        <input type="number" id="sleep-hour" min="0" max="23" value="${defHour}" 
               style="width: 60px; padding: 10px; text-align: center; background: rgba(255,255,255,0.1); 
                      border: 1px solid var(--border-color); border-radius: 8px; color: white;">
        <span style="font-size: 24px;">:</span>
        <input type="number" id="sleep-minute" min="0" max="59" value="${defMinute}" 
               style="width: 60px; padding: 10px; text-align: center; background: rgba(255,255,255,0.1);
                      border: 1px solid var(--border-color); border-radius: 8px; color: white;">
      </div>
      <button onclick="setSleepTimerToTime()" class="btn-primary" style="width: 100%;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    </div>
  `;
  document.body.appendChild(modal);
}

function setSleepTimerToTime() {
  const hour = parseInt(document.getElementById('sleep-hour').value);
  const minute = parseInt(document.getElementById('sleep-minute').value);
  
  const now = new Date();
  const target = new Date();
  target.setHours(hour, minute, 0, 0);
  
  // –ï—Å–ª–∏ –≤—Ä–µ–º—è —É–∂–µ –ø—Ä–æ—à–ª–æ —Å–µ–≥–æ–¥–Ω—è, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞ –∑–∞–≤—Ç—Ä–∞
  if (target <= now) {
    target.setDate(target.getDate() + 1);
  }
  
  sleepTimerMode = 'time';
  sleepTimerTarget = target.getTime();
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º
  localStorage.setItem('sleepTimer', JSON.stringify({
    mode: sleepTimerMode,
    target: sleepTimerTarget,
    setAt: Date.now()
  }));
  
  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
  document.querySelector('.modal-bg').remove();
  
  // –û–±–Ω–æ–≤–ª—è–µ–º UI
  updateSleepTimerUI();
  
  // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
  NotificationSystem.info(`–¢–∞–π–º–µ—Ä —Å–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ ${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
  
  // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª
  if (sleepTimerInterval) clearInterval(sleepTimerInterval);
  sleepTimerInterval = setInterval(updateSleepTimerUI, 1000);
}

function clearSleepTimer() {
  sleepTimerMode = null;
  sleepTimerTarget = null;
  
  if (sleepTimerInterval) {
    clearInterval(sleepTimerInterval);
    sleepTimerInterval = null;
  }
  
  localStorage.removeItem('sleepTimer');
  
  // –û–±–Ω–æ–≤–ª—è–µ–º UI
  const btn = document.getElementById('sleep-timer-btn');
  if (btn) {
    btn.classList.remove('active');
    btn.setAttribute('aria-label', '–¢–∞–π–º–µ—Ä —Å–Ω–∞: –≤—ã–∫–ª—é—á–µ–Ω');
  }
  
  const badge = document.getElementById('sleep-timer-badge');
  if (badge) badge.style.display = 'none';
  
  NotificationSystem.info('–¢–∞–π–º–µ—Ä —Å–Ω–∞ –æ—Ç–∫–ª—é—á—ë–Ω');
}

function updateSleepTimerUI() {
  if (!sleepTimerTarget) return;
  
  const now = Date.now();
  const remaining = sleepTimerTarget - now;
  
  if (remaining <= 0) {
    // –¢–∞–π–º–µ—Ä –∏—Å—Ç—ë–∫
    executeSleepTimer();
    return;
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂
  const minutes = Math.ceil(remaining / 60000);
  const badge = document.getElementById('sleep-timer-badge');
  if (badge) {
    badge.textContent = minutes;
    badge.style.display = 'block';
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º aria-label
  const btn = document.getElementById('sleep-timer-btn');
  if (btn) {
    btn.classList.add('active');
    btn.setAttribute('aria-label', `–¢–∞–π–º–µ—Ä —Å–Ω–∞: –æ—Å—Ç–∞–ª–æ—Å—å ${minutes} –º–∏–Ω—É—Ç`);
  }
}

function executeSleepTimer() {
  // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
  const audio = document.getElementById('audio');
  if (audio && !audio.paused) {
    audio.pause();
  }

  // –û—á–∏—â–∞–µ–º –º–µ–¥–∏–∞-—Å–µ—Å—Å–∏—é
  if ('mediaSession' in navigator) {
    navigator.mediaSession.metadata = null;
  }

  // –£—á—ë—Ç —Å–æ–±—ã—Ç–∏—è "—Ç–∞–π–º–µ—Ä —Å–Ω–∞ —Å—Ä–∞–±–æ—Ç–∞–ª"
  try {
    StatsStore.s.sleepTimerStops = (StatsStore.s.sleepTimerStops || 0) + 1;
    StatsStore.save();
    if (StatsStore.s.sleepTimerStops >= 5) {
      Ach.unlock('sleep_timer_5');
    }
  } catch {}

  // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä
  clearSleepTimer();

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π
  showSleepOverlay();
}

function showSleepOverlay() {
  const overlay = document.createElement('div');
  overlay.className = 'sleep-overlay active';
  overlay.innerHTML = `
    <div class="sleep-content">
      <div class="sleep-icon">üò¥</div>
      <h2 class="sleep-title">–¢–∞–π–º–µ—Ä —Å–Ω–∞ —Å—Ä–∞–±–æ—Ç–∞–ª</h2>
      <p class="sleep-message">–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</p>
      <div class="sleep-buttons">
        <button class="sleep-btn sleep-btn-primary" onclick="closeSleepOverlay()">–ì–æ—Ç–æ–≤–æ</button>
        <button class="sleep-btn sleep-btn-secondary" onclick="showCloseInstructions()">–ó–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
}

function closeSleepOverlay() {
  const overlay = document.querySelector('.sleep-overlay');
  if (overlay) {
    overlay.classList.remove('active');
    setTimeout(() => overlay.remove(), 300);
  }
}

function showCloseInstructions() {
  const content = document.querySelector('.sleep-content');
  if (content) {
    content.innerHTML = `
      <div class="sleep-icon">üì±</div>
      <h2 class="sleep-title">–ö–∞–∫ –∑–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h2>
      <p class="sleep-message">
        <strong>iOS:</strong> –°–≤–∞–π–ø –≤–≤–µ—Ä—Ö –æ—Ç –Ω–∏–∂–Ω–µ–≥–æ –∫—Ä–∞—è —ç–∫—Ä–∞–Ω–∞<br>
        <strong>Android:</strong> –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –∏–ª–∏ —Å–≤–∞–π–ø<br>
        <strong>PWA:</strong> –ó–∞–∫—Ä–æ–π—Ç–µ –æ–∫–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      </p>
      <button class="sleep-btn sleep-btn-primary" onclick="closeSleepOverlay()">–ü–æ–Ω—è—Ç–Ω–æ</button>
    `;
  }
}

function restoreSleepTimer() {
  const saved = localStorage.getItem('sleepTimer');
  if (!saved) return;

  try {
    const data = JSON.parse(saved);
    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Ç–∞–π–º–µ—Ä—ã (—Å—Ç–∞—Ä—à–µ 12 —á–∞—Å–æ–≤ —Å –º–æ–º–µ–Ω—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏)
    const tooOld = (Date.now() - (data.setAt||0)) > 12*60*60*1000;
    if (tooOld) {
      clearSleepTimer();
      return;
    }

    if (data.target > Date.now()) {
      sleepTimerMode = data.mode;
      sleepTimerTarget = data.target;
      updateSleepTimerUI();
      if (sleepTimerInterval) clearInterval(sleepTimerInterval);
      sleepTimerInterval = setInterval(updateSleepTimerUI, 1000);
    } else {
      // –ò—Å—Ç—ë–∫ –≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Äî –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–π—á–∞—Å, –ø—Ä–æ—Å—Ç–æ —Å–±—Ä–æ—Å–∏–º
      clearSleepTimer();
    }
  } catch (e) {
    console.error('Failed to restore sleep timer:', e);
    clearSleepTimer();
  }
}

function checkSleepTimer() {
  if (!sleepTimerTarget) return;
  
  if (Date.now() >= sleepTimerTarget) {
    executeSleepTimer();
  }
}

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏
window.addEventListener('beforeunload', saveCurrentPosition);
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    saveCurrentPosition();
  }
});

// –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ (–∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥)
setInterval(() => {
  const audio = document.getElementById('audio');
  if (audio && !audio.paused) {
    saveCurrentPosition();
  }
}, 10000);

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–∫–∏
function getLyricsButtonLabel() {
  const labels = {
    'normal': '–°–∫—Ä—ã—Ç—å –ª–∏—Ä–∏–∫—É',
    'hidden': '–ü–æ–∫–∞–∑–∞—Ç—å –ª–∏—Ä–∏–∫—É (—É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –≤–∏–¥)',
    'expanded': '–ü–æ–∫–∞–∑–∞—Ç—å –ª–∏—Ä–∏–∫—É (–æ–±—ã—á–Ω—ã–π —Ä–∞–∑–º–µ—Ä)'
  };
  return labels[lyricsViewMode] || '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏—Ä–∏–∫–æ–π';
}

// ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï–ú –õ–ò–†–ò–ö–ò ====================
let lyricsViewMode = 'normal'; // 'normal', 'hidden', 'expanded'
let lyricsUpdateInterval = null;

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ª–∏—Ä–∏–∫–∏
function restoreLyricsViewMode() {
  const saved = localStorage.getItem('lyricsViewMode');
  if (saved && ['normal', 'hidden', 'expanded'].includes(saved)) {
    lyricsViewMode = saved;
  }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ª–∏—Ä–∏–∫–∏
function saveLyricsViewMode() {
  localStorage.setItem('lyricsViewMode', lyricsViewMode);
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ª–∏—Ä–∏–∫–∏
function toggleLyricsView() {
  // –¶–∏–∫–ª: normal ‚Üí hidden ‚Üí expanded ‚Üí normal
  const modes = ['normal', 'hidden', 'expanded'];
  const currentIndex = modes.indexOf(lyricsViewMode);
  const nextIndex = (currentIndex + 1) % modes.length;
  lyricsViewMode = modes[nextIndex];
  
  applyLyricsViewMode();
  saveLyricsViewMode();
  
  // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  const messages = {
    'normal': 'üìù –û–±—ã—á–Ω—ã–π –≤–∏–¥ –ª–∏—Ä–∏–∫–∏',
    'hidden': 'üö´ –õ–∏—Ä–∏–∫–∞ —Å–∫—Ä—ã—Ç–∞',
    'expanded': 'üìñ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –≤–∏–¥ –ª–∏—Ä–∏–∫–∏'
  };
  
  NotificationSystem.info(messages[lyricsViewMode]);
  
  // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
  console.log(`Lyrics mode changed to: ${lyricsViewMode}`);
}

// –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
function applyLyricsViewMode() {
  const lyricsWindow = document.getElementById('lyrics-window');
  const toggleBtn = document.querySelector('.lyrics-toggle-btn');
  
  if (!lyricsWindow || !toggleBtn) return;
  
  // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã —Ä–µ–∂–∏–º–æ–≤
  lyricsWindow.classList.remove('lyrics-normal', 'lyrics-hidden', 'lyrics-expanded');
  toggleBtn.classList.remove('lyrics-normal', 'lyrics-hidden', 'lyrics-expanded');
  
  // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º
  lyricsWindow.classList.add(`lyrics-${lyricsViewMode}`);
  toggleBtn.classList.add(`lyrics-${lyricsViewMode}`);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º aria-label –∏ title
  const labels = {
    'normal': '–°–∫—Ä—ã—Ç—å –ª–∏—Ä–∏–∫—É',
    'hidden': '–ü–æ–∫–∞–∑–∞—Ç—å –ª–∏—Ä–∏–∫—É (—É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –≤–∏–¥)',
    'expanded': '–ü–æ–∫–∞–∑–∞—Ç—å –ª–∏—Ä–∏–∫—É (–æ–±—ã—á–Ω—ã–π —Ä–∞–∑–º–µ—Ä)'
  };
  
  toggleBtn.setAttribute('aria-label', labels[lyricsViewMode]);
  toggleBtn.setAttribute('title', labels[lyricsViewMode] + ' (Y)');
  
  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º –ª–∏—Ä–∏–∫–∏
  if (lyricsViewMode === 'hidden') {
    // –ü—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
    pauseLyricsRendering();
  } else {
    // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫
    resumeLyricsRendering();
    updateLyricsWindowSize();
  }
}
// –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –ª–∏—Ä–∏–∫–∏
function pauseLyricsRendering() {
  const lyricsDiv = document.getElementById('lyrics');
  if (lyricsDiv) {
    lyricsDiv.style.display = 'none';
  }
}

// –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –ª–∏—Ä–∏–∫–∏
function resumeLyricsRendering() {
  const lyricsDiv = document.getElementById('lyrics');
  if (lyricsDiv) {
    lyricsDiv.style.display = '';
    const audio = document.getElementById('audio');
    if (audio && !audio.paused) {
      renderLyrics(audio.currentTime);
    }
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ –ª–∏—Ä–∏–∫–∏
function updateLyricsWindowSize() {
  const windowSize = lyricsViewMode === 'expanded' ? 9 : 5;
  const centerLine = Math.floor(windowSize / 2);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
  window.lyricsWindowSize = windowSize;
  window.lyricsCenterLine = centerLine;
  
  // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ª–∏—Ä–∏–∫—É
  const audio = document.getElementById('audio');
  if (audio) {
    renderLyrics(audio.currentTime);
  }
}

// –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è renderLyrics –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ –æ–∫–Ω–∞
function renderLyricsEnhanced(time) {
  // –ò–°–ü–†–ê–í–õ–ï–ù–û: —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  if (lyricsViewMode === 'hidden') return;
  
  if (!currentLyrics || !currentLyrics.length) {
    const lyricsEl = document.getElementById('lyrics');
    if (lyricsEl) lyricsEl.innerHTML = "";
    return;
  }
  
  let active = 0;
  for (let i = 0; i < currentLyrics.length; i++) {
    if (time >= currentLyrics[i].time) active = i;
  }
  
  const windowSize = window.lyricsWindowSize || 5;
  const centerLine = window.lyricsCenterLine || 2;
  
  const start = Math.max(0, active - centerLine);
  const padTop = Math.max(0, centerLine - active);
  const rows = [];
  
  // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ —Å–≤–µ—Ä—Ö—É –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
  for (let p = 0; p < padTop; ++p) {
    rows.push('<div class="lyrics-window-line"></div>');
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Å —Ç–µ–∫—Å—Ç–æ–º
  for (let i = start; i < Math.min(currentLyrics.length, start + windowSize - padTop); i++) {
    const cls = (i === active) ? 'lyrics-window-line active' : 'lyrics-window-line';
    rows.push(`<div class="${cls}">${currentLyrics[i] ? currentLyrics[i].line : ""}</div>`);
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ —Å–Ω–∏–∑—É –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
  while (rows.length < windowSize) {
    rows.push('<div class="lyrics-window-line"></div>');
  }
  
  const lyricsEl = document.getElementById("lyrics");
  if (lyricsEl) lyricsEl.innerHTML = rows.join("");
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ –ª–∏—Ä–∏–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
function initializeLyricsMode() {
  restoreLyricsViewMode();
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
  window.lyricsWindowSize = lyricsViewMode === 'expanded' ? 9 : 5;
  window.lyricsCenterLine = Math.floor(window.lyricsWindowSize / 2);
}

// ==================== –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–õ–ï–ï–†–û–ú ====================
function togglePlayPause() {
  const audio = document.getElementById('audio');
  if (!audio) return;
  
  if (audio.paused) {
    audio.play();
  } else {
    audio.pause();
  }
}

function updatePlayPauseIcon() {
  const audio = document.getElementById('audio');
  const icon = document.getElementById('play-pause-icon');
  if (!audio || !icon) return;
  
  if (audio.paused) {
    icon.innerHTML = '<path d="M8 5v14l11-7z"/>';
  } else {
    icon.innerHTML = '<path d="M6 6h4v12H6zM14 6h4v12h-4z"/>';
  }
}

function stopPlayback() {
  const audio = document.getElementById('audio');
  if (!audio) return;
  
  audio.pause();
  audio.currentTime = 0;
  updatePlayPauseIcon();
  
  // –û—á–∏—â–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
  PositionManager.clear();
}

function toggleRepeat() {
  repeatMode = !repeatMode;
  const btn = document.getElementById('repeat-btn');
  
  if (repeatMode) {
    btn.classList.add('repeat-active');
    NotificationSystem.info('üîÅ –ü–æ–≤—Ç–æ—Ä —Ç—Ä–µ–∫–∞ –≤–∫–ª—é—á—ë–Ω');
  } else {
    btn.classList.remove('repeat-active');
    NotificationSystem.info('–ü–æ–≤—Ç–æ—Ä —Ç—Ä–µ–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω');
  }
  
  localStorage.setItem('repeatMode', repeatMode ? '1' : '0');
}

function toggleShuffle() {
  shuffleMode = !shuffleMode;
  const btn = document.getElementById('shuffle-btn');
  
  if (shuffleMode) {
    btn.classList.add('active');
    createShuffledPlaylist();
    
    if (favoritesOnlyMode) {
      const count = getLiked().length;
      NotificationSystem.info(`üîÄ –°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –≤–∫–ª—é—á—ë–Ω (${count} –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö)`);
    } else {
      NotificationSystem.info('üîÄ –°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –≤–∫–ª—é—á—ë–Ω');
    }
  } else {
    btn.classList.remove('active');
    NotificationSystem.info('–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ');
  }
  
  localStorage.setItem('shuffleMode', shuffleMode ? '1' : '0');
}

// –ò–°–ü–†–ê–í–õ–ï–ù–û: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Ñ–∏–ª—å—Ç—Ä–æ–º
function toggleFavoritesOnly() {
  const likedTracks = getLiked();
  
  if (likedTracks.length === 0) {
    NotificationSystem.warning('–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤! –û—Ç–º–µ—Ç—å—Ç–µ —Ç—Ä–µ–∫–∏ –∑–≤—ë–∑–¥–æ—á–∫–æ–π.');
    return;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –æ—Ç —Ñ–∏–ª—å—Ç—Ä–∞
  if (favoritesFilterActive && favoritesOnlyMode) {
    NotificationSystem.warning('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ –ü–û–ö–ê–ó–ê–¢–¨ –í–°–ï –ü–ï–°–ù–ò');
    return;
  }
  
  favoritesOnlyMode = !favoritesOnlyMode;
  const btn = document.getElementById('favorites-btn');
  const icon = document.getElementById('favorites-btn-icon');
  
  if (favoritesOnlyMode) {
    btn.classList.add('favorites-active');
    icon.src = 'img/star.png';
    updateAvailableTracks();
    NotificationSystem.success(`‚≠ê –ò–≥—Ä–∞—é—Ç —Ç–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ (${likedTracks.length} —Ç—Ä–µ–∫–æ–≤)`);
    
    if (!isLiked(currentTrack)) {
      const nextFavorite = getNextFavoriteTrack();
      if (nextFavorite !== -1) {
        showTrack(nextFavorite, true);
      }
    }
  } else {
    btn.classList.remove('favorites-active');
    icon.src = 'img/star2.png';
    updateAvailableTracks();
    NotificationSystem.info('–ò–≥—Ä–∞—é—Ç –≤—Å–µ —Ç—Ä–µ–∫–∏');
  }
  
  if (shuffleMode) {
    createShuffledPlaylist();
  }
  
  localStorage.setItem('favoritesOnlyMode', favoritesOnlyMode ? '1' : '0');
}

function updateAvailableTracks() {
  if (favoritesOnlyMode) {
    availableTracks = getLiked();
  } else {
    availableTracks = Array.from({length: config.tracks.length}, (_, i) => i);
  }
}

function getNextFavoriteTrack() {
  const liked = getLiked();
  if (liked.length === 0) return -1;
  
  const currentIndex = liked.indexOf(currentTrack);
  if (currentIndex !== -1 && currentIndex < liked.length - 1) {
    return liked[currentIndex + 1];
  }
  
  return liked[0];
}

function previousTrack() {
  if (repeatMode) {
    const audio = document.getElementById('audio');
    if (audio) {
      audio.currentTime = 0;
      audio.play();
    }
    return;
  }
  
  updateAvailableTracks();
  
  if (availableTracks.length === 0) {
    NotificationSystem.warning('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è');
    return;
  }
  
  // –û—á–∏—â–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
  PositionManager.clear();
  
  if (shuffleMode) {
    shuffleIndex = Math.max(0, shuffleIndex - 1);
    if (shuffleIndex < shuffledPlaylist.length) {
      showTrack(shuffledPlaylist[shuffleIndex], true);
    }
  } else if (favoritesOnlyMode) {
    const currentIdx = availableTracks.indexOf(currentTrack);
    const prevIdx = currentIdx > 0 ? currentIdx - 1 : availableTracks.length - 1;
    showTrack(availableTracks[prevIdx], true);
  } else {
    const prev = currentTrack > 0 ? currentTrack - 1 : config.tracks.length - 1;
    showTrack(prev, true);
  }
}

function nextTrack() {
  if (repeatMode) {
    const audio = document.getElementById('audio');
    if (audio) {
      audio.currentTime = 0;
      audio.play();
    }
    return;
  }
  
  updateAvailableTracks();
  
  if (availableTracks.length === 0) {
    NotificationSystem.warning('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è');
    return;
  }
  
  // –û—á–∏—â–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
  PositionManager.clear();
  
  if (shuffleMode) {
    shuffleIndex++;
    if (shuffleIndex >= shuffledPlaylist.length) {
      createShuffledPlaylist();
      shuffleIndex = 0;
    }
    showTrack(shuffledPlaylist[shuffleIndex], true);
  } else if (favoritesOnlyMode) {
    const currentIdx = availableTracks.indexOf(currentTrack);
    const nextIdx = (currentIdx + 1) % availableTracks.length;
    showTrack(availableTracks[nextIdx], true);
  } else {
    const next = (currentTrack + 1) % config.tracks.length;
    showTrack(next, true);
  }
}

function createShuffledPlaylist() {
  updateAvailableTracks();
  
  shuffledPlaylist = [...availableTracks];
  
  const currentIdx = shuffledPlaylist.indexOf(currentTrack);
  if (currentIdx !== -1) {
    shuffledPlaylist.splice(currentIdx, 1);
  }
  
  for (let i = shuffledPlaylist.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffledPlaylist[i], shuffledPlaylist[j]] = [shuffledPlaylist[j], shuffledPlaylist[i]];
  }
  
  if (availableTracks.includes(currentTrack)) {
    shuffledPlaylist.unshift(currentTrack);
  }
  
  shuffleIndex = 0;
}
// ==== Prefetch —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç—Ä–µ–∫–∞ ====
function computeNextTrackIndexCandidate() {
  // –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å —Ä–æ–≤–Ω–æ –∫–∞–∫ nextTrack()
  if (!config || !Array.isArray(config.tracks) || config.tracks.length === 0) return -1;

  updateAvailableTracks();

  if (shuffleMode) {
    // –ï—Å–ª–∏ –ø–ª–µ–π–ª–∏—Å—Ç–∞ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞–¥–∏–º
    if (!Array.isArray(shuffledPlaylist) || shuffledPlaylist.length === 0) {
      createShuffledPlaylist();
    }
    // –°–ª–µ–¥—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç –≤ —Ç–µ–∫—É—â–µ–º shuffledPlaylist
    const nextIdxInShuffled = Math.min(shuffleIndex + 1, Math.max(0, shuffledPlaylist.length - 1));
    const cand = shuffledPlaylist[nextIdxInShuffled];
    return (typeof cand === 'number') ? cand : -1;
  }

  if (favoritesOnlyMode) {
    if (!Array.isArray(availableTracks) || availableTracks.length === 0) return -1;
    const curPos = availableTracks.indexOf(currentTrack);
    if (curPos === -1) {
      // –µ—Å–ª–∏ —Ç–µ–∫—É—â–µ–≥–æ –Ω–µ—Ç (–º–æ–≥–ª–∏ —É–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ) ‚Äî –±–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π
      return availableTracks[0] ?? -1;
    }
    const nextPos = (curPos + 1) % availableTracks.length;
    return availableTracks[nextPos] ?? -1;
  }

  // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º ‚Äî –ø–æ –ø–æ—Ä—è–¥–∫—É
  return (currentTrack >= 0) ? ((currentTrack + 1) % config.tracks.length) : 0;
}

function prefetchAudioLink(url, asType='audio') {
  if (!url) return;
  try {
    // <link rel="prefetch">
    const link = document.createElement('link');
    link.rel = 'prefetch';
    link.as = asType;
    link.href = url;
    link.crossOrigin = 'anonymous';
    document.head.appendChild(link);
    // fallback: –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –¥–æ–≤–µ—Å—Ç–∏ –¥–æ SW-–∫—ç—à–∞
    fetch(url).catch(()=>{});
  } catch(e) {}
}

function prefetchNextTrackAssets() {
  const cand = computeNextTrackIndexCandidate();
  if (cand < 0 || !config?.tracks?.[cand]) return;
  const t = config.tracks[cand];
  // MP3
  prefetchAudioLink(t.audio, 'audio');
  // –õ–∏—Ä–∏–∫–∞ (json)
  if (t.lyrics) prefetchAudioLink(t.lyrics, 'fetch');
  // –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç (txt)
  if (t.fulltext) prefetchAudioLink(t.fulltext, 'fetch');
}
function restorePlayerButtonsState() {
  if (shuffleMode) {
    document.getElementById('shuffle-btn')?.classList.add('active');
  }
  
  if (repeatMode) {
    document.getElementById('repeat-btn')?.classList.add('repeat-active');
  }
  
  if (favoritesOnlyMode) {
    const btn = document.getElementById('favorites-btn');
    const icon = document.getElementById('favorites-btn-icon');
    if (btn) btn.classList.add('favorites-active');
    if (icon) icon.src = 'img/star.png';
  }
  
  if (animationEnabled) {
    document.getElementById('animation-btn')?.classList.add('animation-active');
  }
  
  if (bitEnabled) {
    document.getElementById('bit-btn')?.classList.add('bit-active');
  }
}

// ==================== MEDIA SESSION API ====================
function setupMediaSession() {
  if ('mediaSession' in navigator) {
    const track = config.tracks[currentTrack];
    
    navigator.mediaSession.metadata = new MediaMetadata({
      title: track.title,
      artist: config.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
      album: config.albumName || '–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º',
      artwork: [
        { src: 'Cover.png', sizes: '512x512', type: 'image/png' },
        { src: 'icons/icon-192.png', sizes: '192x192', type: 'image/png' },
        { src: 'icons/icon-512.png', sizes: '512x512', type: 'image/png' }
      ]
    });
    
    navigator.mediaSession.setActionHandler('play', () => {
      const audio = document.getElementById('audio');
      if (audio) audio.play();
      updatePlayPauseIcon();
    });
    
    navigator.mediaSession.setActionHandler('pause', () => {
      const audio = document.getElementById('audio');
      if (audio) audio.pause();
      updatePlayPauseIcon();
    });
    
    navigator.mediaSession.setActionHandler('stop', () => {
      stopPlayback();
    });
    
    navigator.mediaSession.setActionHandler('previoustrack', () => {
      previousTrack();
    });
    
    navigator.mediaSession.setActionHandler('nexttrack', () => {
      nextTrack();
    });
    
    navigator.mediaSession.setActionHandler('seekto', (details) => {
      const audio = document.getElementById('audio');
      if (audio) audio.currentTime = details.seekTime;
    });
    
    navigator.mediaSession.setActionHandler('seekbackward', () => {
      const audio = document.getElementById('audio');
      if (audio) audio.currentTime = Math.max(0, audio.currentTime - 10);
    });
    
    navigator.mediaSession.setActionHandler('seekforward', () => {
      const audio = document.getElementById('audio');
      if (audio) audio.currentTime = Math.min(audio.duration, audio.currentTime + 10);
    });
  }
}

// ==================== –ö–ê–†–ê–û–ö–ï ====================
function loadLyrics(file) {
  fetch(file)
    .then(r => r.json())
    .then(js => {
      currentLyrics = js;
      renderLyrics(0);
    })
    .catch(err => {
      console.error('Failed to load lyrics:', err);
      currentLyrics = [];
    });
}

function renderLyrics(time) {
  if (!currentLyrics || !currentLyrics.length) {
    const lyricsEl = document.getElementById('lyrics');
    if (lyricsEl) lyricsEl.innerHTML = "";
    return;
  }
  
  let active = 0;
  for (let i = 0; i < currentLyrics.length; i++) {
    if (time >= currentLyrics[i].time) active = i;
  }
  
  const windowSize = 5;
  const start = active < 2 ? 0 : active - 2;
  const padTop = active < 2 ? 2 - active : 0;
  const rows = [];
  
  for (let p = 0; p < padTop; ++p) {
    rows.push('<div class="lyrics-window-line"></div>');
  }
  
  for (let i = start; i < Math.min(currentLyrics.length, start + windowSize - padTop); i++) {
    const cls = (i === active) ? 'lyrics-window-line active' : 'lyrics-window-line';
    rows.push(`<div class="${cls}">${currentLyrics[i] ? currentLyrics[i].line : ""}</div>`);
  }
  
  while (rows.length < windowSize) {
    rows.push('<div class="lyrics-window-line"></div>');
  }
  
  const lyricsEl = document.getElementById("lyrics");
  if (lyricsEl) lyricsEl.innerHTML = rows.join("");
}

// –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
function copyLyrics() {
  if (!config || currentTrack < 0 || !config.tracks[currentTrack].fulltext) {
    NotificationSystem.warning("–§–∞–π–ª —Å —Ç–µ–∫—Å—Ç–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω!");
    return;
  }
  
  fetch(config.tracks[currentTrack].fulltext)
    .then(r => {
      if (!r.ok) throw new Error("–ù–µ –Ω–∞–π–¥–µ–Ω");
      return r.text();
    })
    .then(txt => {
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(txt).then(
          () => NotificationSystem.success("–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!"),
          () => NotificationSystem.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å")
        );
      } else {
        const textarea = document.createElement("textarea");
        textarea.value = txt;
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
          NotificationSystem.success("–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!");
        } catch(e) {
          NotificationSystem.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
        }
        document.body.removeChild(textarea);
      }
    })
    .catch(() => {
      NotificationSystem.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç!");
    });
}
// ==================== –ö–õ–ê–í–ò–ê–¢–£–†–ù–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø (–û–ë–ù–û–í–õ–ï–ù–û) ====================
window.addEventListener('keydown', function(e) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–æ–∫—É—Å –Ω–µ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
    return;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
  const hasActiveModal = document.querySelector('.modal-bg.active');
  
  // Esc –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
  if (e.key === 'Escape' && hasActiveModal) {
    e.preventDefault();
    document.querySelectorAll('.modal-bg.active').forEach(modal => {
      modal.classList.remove('active');
    });
    return;
  }
  
  // –û—Å—Ç–∞–ª—å–Ω—ã–µ –∫–ª–∞–≤–∏—à–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–Ω–∞—Ö
  if (hasActiveModal) return;
  
  const audio = document.getElementById('audio');
  
  switch(e.key.toUpperCase()) {
    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
    case ' ': // –ü—Ä–æ–±–µ–ª
    case 'K':
      e.preventDefault();
      togglePlayPause();
      break;
      
    case 'X':
      e.preventDefault();
      stopPlayback();
      break;
      
    case 'N':
      e.preventDefault();
      nextTrack();
      break;
      
    case 'P':
      e.preventDefault();
      previousTrack();
      break;
      
    case 'J':
      e.preventDefault();
      if (audio) audio.currentTime = Math.max(0, audio.currentTime - 10);
      break;
      
    case 'L':
      e.preventDefault();
      if (audio) audio.currentTime = Math.min(audio.duration, audio.currentTime + 10);
      break;
      
    // –ì—Ä–æ–º–∫–æ—Å—Ç—å
    case '+':
    case '=':
      e.preventDefault();
      const slider = document.getElementById('volume-slider');
      if (slider) {
        slider.value = Math.min(100, parseInt(slider.value) + 10);
        slider.dispatchEvent(new Event('input'));
      }
      break;
      
    case '-':
      e.preventDefault();
      const sliderMinus = document.getElementById('volume-slider');
      if (sliderMinus) {
        sliderMinus.value = Math.max(0, parseInt(sliderMinus.value) - 10);
        sliderMinus.dispatchEvent(new Event('input'));
      }
      break;
      
    case 'M':
      e.preventDefault();
      toggleMute();
      break;
      
    case '0':
      e.preventDefault();
      toggleMute();
      break;
      
    // –†–µ–∂–∏–º—ã
    case 'R':
      e.preventDefault();
      toggleRepeat();
      break;
      
    case 'U':
      e.preventDefault();
      toggleShuffle();
      break;
      
    case 'F':
      if (e.shiftKey) {
        e.preventDefault();
        toggleFavoritesFilter();
      } else {
        e.preventDefault();
        toggleFavoritesOnly();
      }
      break;
      
    case 'T':
      e.preventDefault();
      toggleSleepMenu();
      break;
      
    // –ê–Ω–∏–º–∞—Ü–∏–∏
    case 'A':
      e.preventDefault();
      toggleAnimation();
      break;
      
    case 'B':
      e.preventDefault();
      toggleBit();
      break;
      
    case '1':
      e.preventDefault();
      if (bitEnabled) {
        bitIntensity = 100;
        localStorage.setItem('bitIntensity', '100');
        NotificationSystem.info('üíø –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –ø—É–ª—å—Å–∞—Ü–∏–∏: 100%');
      }
      break;
      
    case '2':
      e.preventDefault();
      if (bitEnabled) {
        bitIntensity = 50;
        localStorage.setItem('bitIntensity', '50');
        NotificationSystem.info('üíø –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –ø—É–ª—å—Å–∞—Ü–∏–∏: 50%');
      }
      break;
      
    case '3':
      e.preventDefault();
      if (bitEnabled) {
        bitIntensity = 15;
        localStorage.setItem('bitIntensity', '15');
        NotificationSystem.info('üíø –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –ø—É–ª—å—Å–∞—Ü–∏–∏: 15%');
      }
      break;
      
    // –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    case 'Y':
      e.preventDefault();
      if (currentTrack >= 0) {
        toggleLyricsView();
      }
      break;
      
    case 'W':
      e.preventDefault();
      // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–ª–µ–π–ª–∏—Å—Ç—É
      document.getElementById('track-list')?.scrollIntoView({ behavior: 'smooth' });
      break;
      
    case 'D':
      e.preventDefault();
      if (currentTrack >= 0) {
        toggleLike(currentTrack);
      }
      break;
      
    case '/':
      e.preventDefault();
      // –§–æ–∫—É—Å –Ω–∞ –ø–æ–∏—Å–∫ (–µ—Å–ª–∏ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±—É–¥—É—â–µ–º)
      NotificationSystem.info('–ü–æ–∏—Å–∫ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
      break;
      
    case '?':
      e.preventDefault();
      showHotkeysModal();
      break;
      
    case 'V':
      if (e.shiftKey) {
        e.preventDefault();
        const volumeSlider = document.getElementById('volume-slider');
        if (volumeSlider) {
          volumeSlider.value = 50;
          volumeSlider.dispatchEvent(new Event('input'));
          NotificationSystem.info('–ì—Ä–æ–º–∫–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ 50%');
        }
      }
      break;
      
    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å–ø–∏—Å–∫–∞–º
    case ',':
      e.preventDefault();
      window.scrollBy(0, -100);
      break;
      
    case '.':
      e.preventDefault();
      window.scrollBy(0, 100);
      break;
      
    case '[':
      e.preventDefault();
      if (config && config.tracks.length > 0) {
        showTrack(0, true);
      }
      break;
      
    case ']':
      e.preventDefault();
      if (config && config.tracks.length > 0) {
        showTrack(config.tracks.length - 1, true);
      }
      break;
  }
  
  // –¶–∏—Ñ—Ä–æ–≤—ã–µ –∫–ª–∞–≤–∏—à–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞
  if (e.key >= '1' && e.key <= '9' && !e.shiftKey && !e.ctrlKey && !e.altKey) {
    const trackIndex = parseInt(e.key) - 1;
    if (trackIndex < config.tracks.length) {
      e.preventDefault();
      showTrack(trackIndex, true);
    }
  }
});

// ==================== DEEP LINKS ====================
function parseDeepLink() {
  const params = new URLSearchParams(window.location.search);
  
  const trackParam = params.get('track');
  if (trackParam) {
    const trackIndex = parseInt(trackParam, 10);
    if (trackIndex >= 0 && trackIndex < config.tracks.length) {
      showTrack(trackIndex, true);
      
      setTimeout(() => {
        document.getElementById(`trk${trackIndex}`)?.scrollIntoView({
          behavior: 'smooth',
          block: 'center'
        });
      }, 300);
    }
  }
  
  const timeParam = params.get('time');
  if (timeParam) {
    setTimeout(() => {
      const audio = document.getElementById('audio');
      if (audio) {
        audio.currentTime = parseInt(timeParam, 10);
      }
    }, 1000);
  }
  
  // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ shortcuts –∏–∑ manifest
  const viewParam = params.get('view');
  if (viewParam === 'favorites') {
    setTimeout(() => {
      if (getLiked().length > 0) {
        toggleFavoritesFilter();
      }
    }, 1000);
  }
  
  const shuffleParam = params.get('shuffle');
  if (shuffleParam === '1') {
    shuffleMode = true;
    localStorage.setItem('shuffleMode', '1');
  }
}

function getShareLink(trackIndex) {
  const baseUrl = window.location.origin + window.location.pathname;
  const audio = document.getElementById('audio');
  const time = audio ? Math.floor(audio.currentTime) : 0;
  
  return `${baseUrl}?track=${trackIndex}${time > 10 ? `&time=${time}` : ''}`;
}

// ==================== –°–ö–ê–ß–ò–í–ê–ù–ò–ï –¢–†–ï–ö–û–í ====================
function getTrackFileName(track, idx, artist) {
  return `${(idx + 1).toString().padStart(2, '0')} - ${track.title} - ${artist}.mp3`
    .replace(/[\\/:"*?<>|]+/g, '_');
}

function openDownloadModal(e) {
  if (e) e.preventDefault();
  
  const tr = config.tracks[currentTrack];
  const fileName = getTrackFileName(tr, currentTrack, config.artist);
  const filenameEl = document.getElementById('download-modal-filename');
  if (filenameEl) filenameEl.innerHTML = `<b>${fileName}</b>`;
  document.getElementById('download-modal').classList.add('active');
}

function closeDownloadModal() {
  document.getElementById('download-modal').classList.remove('active');
}

document.getElementById('download-modal').onclick = function(e) {
  if (e.target === this) closeDownloadModal();
};

function downloadCurrentTrack() {
  const tr = config.tracks[currentTrack];
  const fileName = getTrackFileName(tr, currentTrack, config.artist);
  const url = tr.audio;
  
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  window.setTimeout(() => {
    document.body.removeChild(a);
  }, 250);
  closeDownloadModal();
  NotificationSystem.success('–§–∞–π–ª –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω!');
}

async function shareCurrentTrack() {
  const track = config.tracks[currentTrack];
  const shareUrl = getShareLink(currentTrack);
  const shareText = `üéµ ${track.title} - ${config.artist}\nüéß –°–ª—É—à–∞–π –Ω–∞:`;
  
  if (navigator.share) {
    try {
      await navigator.share({
        title: track.title,
        text: shareText,
        url: shareUrl
      });
      NotificationSystem.success('–°—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
      closeDownloadModal();
    } catch (e) {
      // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª
    }
  } else {
    navigator.clipboard.writeText(`${shareText}\n${shareUrl}`);
    NotificationSystem.success('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
  }
}

async function openInAppCurrentTrack() {
  await shareCurrentTrack();
}

// –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–∏ –Ω–∞ MP3
function copyLinkCurrentTrack() {
  const track = config.tracks[currentTrack];
  const baseUrl = window.location.origin + window.location.pathname.replace('index.html', '');
  const directUrl = baseUrl + track.audio;
  
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(directUrl).then(
      () => NotificationSystem.success('–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ MP3 —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!'),
      () => NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É')
    );
  } else {
    const textarea = document.createElement("textarea");
    textarea.value = directUrl;
    document.body.appendChild(textarea);
    textarea.select();
    try {
      document.execCommand('copy');
      NotificationSystem.success('–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ MP3 —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
    } catch(e) {
      NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É');
    }
    document.body.removeChild(textarea);
  }
  closeDownloadModal();
}

// ==================== –°–ö–ê–ß–ò–í–ê–ù–ò–ï –ê–õ–¨–ë–û–ú–ê ====================
function loadJSZip() {
  if (window.JSZip) return Promise.resolve();
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

function initializeAlbumDownloadCheckboxes() {
  const onlyFavCheckbox = document.getElementById('onlyFavorites');
  const fullAlbumCheckbox = document.getElementById('fullAlbum');
  
  onlyFavCheckbox.addEventListener('change', function() {
    if (this.checked) {
      fullAlbumCheckbox.checked = false;
      const likedTracks = getLiked();
      if (likedTracks.length === 0) {
        this.checked = false;
        NotificationSystem.warning('–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è');
      }
    }
  });
  
  fullAlbumCheckbox.addEventListener('change', function() {
    if (this.checked) {
      onlyFavCheckbox.checked = false;
    }
  });
  
  checkFavoritesAvailable();
}

function checkFavoritesAvailable() {
  const favCheckbox = document.getElementById('onlyFavorites');
  const likedTracks = getLiked();
  
  if (likedTracks.length === 0) {
    favCheckbox.disabled = true;
    favCheckbox.parentElement.style.opacity = '0.5';
    favCheckbox.parentElement.title = '–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤';
  } else {
    favCheckbox.disabled = false;
    favCheckbox.parentElement.style.opacity = '1';
    favCheckbox.parentElement.title = `–ò–∑–±—Ä–∞–Ω–Ω—ã—Ö: ${likedTracks.length}`;
  }
}

function openAlbumDownloadModal() {
  closeDownloadModal();
  checkFavoritesAvailable();
  document.getElementById('albumDownloadModal').classList.add('active');
}

function closeAlbumDownloadModal() {
  document.getElementById('albumDownloadModal').classList.remove('active');
}

document.getElementById('albumDownloadModal').onclick = function(e) {
  if (e.target === this) closeAlbumDownloadModal();
};

// –§—É–Ω–∫—Ü–∏—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Ñ–∞–π–ª–æ–≤
async function prepareFilesList() {
  filesToDownload = [];
  const addedFiles = new Set();
  
  let trackIndices = [];
  const likedTracks = getLiked();
  
  if (downloadOptions.onlyFavorites && likedTracks.length > 0) {
    trackIndices = likedTracks;
  } else if (downloadOptions.fullAlbum) {
    trackIndices = config.tracks.map((_, i) => i);
  }
  
  for (let idx of trackIndices) {
    const track = config.tracks[idx];
    const num = String(idx + 1).padStart(2, '0');
    const mp3FileName = `${num} - ${track.title} - ${config.artist}.mp3`;
    
    if (!addedFiles.has(mp3FileName)) {
      addedFiles.add(mp3FileName);
      filesToDownload.push({
        url: track.audio,
        name: mp3FileName,
        type: 'audio'
      });
    }
    
    if (downloadOptions.includeLyrics && track.fulltext) {
      const lyricsName = `${num} - ${track.title} - ${config.artist}.txt`;
      
      if (!addedFiles.has(lyricsName)) {
        addedFiles.add(lyricsName);
        try {
          const response = await fetch(track.fulltext);
          const text = await response.text();
          filesToDownload.push({
            content: text,
            name: lyricsName,
            type: 'text'
          });
        } catch(e) {
          console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç –¥–ª—è', track.title);
        }
      }
    }
  }
  
  if (downloadOptions.includeCovers) {
    coverGalleryArr.forEach(cover => {
      const coverName = cover.split('/').pop();
      if (!addedFiles.has(coverName)) {
        addedFiles.add(coverName);
        filesToDownload.push({
          url: cover,
          name: coverName,
          type: 'image'
        });
      }
    });
  }
  
  if (!addedFiles.has('logo.png')) {
    filesToDownload.push({
      url: 'img/logo.png',
      name: 'logo.png',
      type: 'image'
    });
  }
  
  if (!addedFiles.has('social.txt')) {
    filesToDownload.push({
      content: generateSocialText(),
      name: 'social.txt',
      type: 'text'
    });
  }
  
  console.log(`–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ ${filesToDownload.length} —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∞—Ä—Ö–∏–≤–∞`);
}

function generateSocialText() {
  const socials = config.socials || [];
  let socialLinks = '';
  
  socials.forEach(social => {
    socialLinks += `${social.title}: ${social.url}\n`;
  });
  
  return `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       –í–ò–¢–†–ò–ù–ê –†–ê–ó–ë–ò–¢–ê - –ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ç–µ—Ä–µ—Å –∫ –Ω–∞—à–µ–º—É —Ç–≤–æ—Ä—á–µ—Å—Ç–≤—É!
–í–∞—à–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—á–µ–Ω—å –≤–∞–∂–Ω–∞ –¥–ª—è –Ω–∞—Å.

–ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ –Ω–∞—à–∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏:

${socialLinks}
–î–µ–ª–∏—Ç–µ—Å—å –º—É–∑—ã–∫–æ–π —Å –¥—Ä—É–∑—å—è–º–∏!
–° –ª—é–±–æ–≤—å—é, –≥—Ä—É–ø–ø–∞ "–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞"

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;
}
async function prepareDownload() {
  downloadOptions.includeCovers = document.getElementById('includeCovers').checked;
  downloadOptions.includeLyrics = document.getElementById('includeLyrics').checked;
  downloadOptions.onlyFavorites = document.getElementById('onlyFavorites').checked;
  downloadOptions.fullAlbum = document.getElementById('fullAlbum').checked;
  
  if (!downloadOptions.onlyFavorites && !downloadOptions.fullAlbum) {
    NotificationSystem.warning('–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–∫–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è');
    return;
  }
  
  if (downloadOptions.onlyFavorites && getLiked().length === 0) {
    NotificationSystem.warning('–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è');
    return;
  }
  
  await loadJSZip();
  await prepareFilesList();
  
  if (filesToDownload.length === 0) {
    NotificationSystem.error('–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä—Ö–∏–≤–∞');
    return;
  }
  
  const sizeMB = await calculateArchiveSize();
  
  document.getElementById('archiveSize').textContent = sizeMB + ' –ú–ë';
  document.getElementById('fileCount').textContent = filesToDownload.length;
  
  closeAlbumDownloadModal();
  document.getElementById('sizeConfirmModal').classList.add('active');
}

// –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á—ë—Ç–∞ —Ä–∞–∑–º–µ—Ä–∞ –∞—Ä—Ö–∏–≤–∞
async function calculateArchiveSize() {
  let totalSize = 0;
  const promises = [];
  
  for (let file of filesToDownload) {
    if (file.url) {
      const headPromise = fetch(file.url, { method: 'HEAD' })
        .then(response => {
          const size = response.headers.get('content-length');
          return size ? parseInt(size) : null;
        })
        .catch(() => null);
      
      const heuristicPromise = new Promise(resolve => {
        setTimeout(() => {
          if (file.type === 'audio') resolve(4.7 * 1024 * 1024);
          else if (file.type === 'image') resolve(500 * 1024);
          else if (file.type === 'text') resolve(5 * 1024);
          else resolve(100 * 1024);
        }, 500);
      });
      
      promises.push(
        Promise.race([headPromise, heuristicPromise]).then(size => {
          if (size) totalSize += size;
        })
      );
    } else if (file.content) {
      totalSize += new Blob([file.content]).size;
    }
  }
  
  await Promise.allSettled(promises);
  
  totalSize = Math.ceil(totalSize * 1.1);
  
  const sizeMB = (totalSize / 1024 / 1024).toFixed(1);
  
  if (sizeMB < 0.1) {
    return "~" + (filesToDownload.length * 0.5).toFixed(1);
  }
  if (sizeMB > 500) {
    return "~" + Math.min(sizeMB, 200).toFixed(1);
  }
  
  return sizeMB;
}

function closeSizeConfirmModal() {
  document.getElementById('sizeConfirmModal').classList.remove('active');
}

document.getElementById('sizeConfirmModal').onclick = function(e) {
  if (e.target === this) closeSizeConfirmModal();
};

function startDownload() {
  closeSizeConfirmModal();
  createAndDownloadZip();
}

function showProgressModal() {
  document.getElementById('downloadProgressModal').classList.add('active');
  document.getElementById('progressFill').style.width = '0%';
  document.getElementById('progressText').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤: 0/' + filesToDownload.length;
  document.getElementById('errorsList').style.display = 'none';
}

function updateProgress(completed, total) {
  const percent = Math.round((completed / total) * 100);
  document.getElementById('progressFill').style.width = percent + '%';
  document.getElementById('progressText').textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤: ${completed}/${total}`;
}

function showErrors(errors) {
  if (errors.length > 0) {
    document.getElementById('errorsList').style.display = 'block';
    document.getElementById('errorsListContent').innerHTML = errors.map(e => `<li>${e}</li>`).join('');
  }
}

// –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è ZIP –∞—Ä—Ö–∏–≤–∞
async function createAndDownloadZip() {
  if (!window.JSZip) {
    await loadJSZip();
  }
  
  const zip = new JSZip();
  const errors = [];
  let completed = 0;
  
  showProgressModal();
  
  // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º
  const BATCH_SIZE = 5;
  
  for (let i = 0; i < filesToDownload.length; i += BATCH_SIZE) {
    const batch = filesToDownload.slice(i, i + BATCH_SIZE);
    
    await Promise.allSettled(
      batch.map(async file => {
        try {
          if (file.url) {
            const response = await fetch(file.url);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const blob = await response.blob();
            zip.file(file.name, blob);
          } else if (file.content) {
            zip.file(file.name, file.content);
          }
          
          completed++;
          updateProgress(completed, filesToDownload.length);
          
        } catch (error) {
          errors.push(file.name);
          console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${file.name}:`, error);
          completed++;
          updateProgress(completed, filesToDownload.length);
        }
      })
    );
  }
  
  if (errors.length > 0) {
    showErrors(errors);
    await new Promise(resolve => setTimeout(resolve, 2000));
  }
  
  document.getElementById('progressText').textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞...';
  
  const content = await zip.generateAsync({
    type: "blob",
    compression: "DEFLATE",
    compressionOptions: { level: 6 },
    streamFiles: true
  }, function updateCallback(metadata) {
    const progress = metadata.percent.toFixed(0);
    document.getElementById('progressText').textContent = `–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞: ${progress}%`;
    document.getElementById('progressFill').style.width = progress + '%';
  });
  
  const link = document.createElement('a');
  link.href = URL.createObjectURL(content);
  
  const date = new Date().toISOString().split('T')[0];
  link.download = `vitrina-razbita-${date}.zip`;
  
  link.click();
  
  setTimeout(() => {
    document.getElementById('downloadProgressModal').classList.remove('active');
    NotificationSystem.success('–ê—Ä—Ö–∏–≤ —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω!');
    URL.revokeObjectURL(link.href);
  }, 1500);
}

// ==================== –û–§–õ–ê–ô–ù –†–ï–ñ–ò–ú ====================
function offlineUIClick() {
  if (offlineDownloading) return;
  
  if (!offlineMode) {
    document.getElementById('modal-offline').classList.add('active');
    document.getElementById('offline-step').innerHTML = `
      <div style="font-size:1.09em;font-weight:700;margin-bottom:10px;">–û—Ñ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º</div>
      <div style="margin-bottom:16px;">–î–ª—è —Ä–∞–±–æ—Ç—ã –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –Ω—É–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –º—É–∑—ã–∫—É –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.<br>
      –≠—Ç–æ –∑–∞–π–º—ë—Ç <b>–º–µ—Å—Ç–æ</b> –∏ –≤—Ä–µ–º—è.<br>
      <div style="color:#e80100;margin:5px 0 0 0;">
        ‚ö† –ù–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö (iOS Safari) —Ä–∞–∑–º–µ—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω (~50-150 –ú–ë).
      </div>
      <div style="margin:8px 0 0 0;opacity:.7;">
        –ü–æ—Å–ª–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤—ã —Å–º–æ–∂–µ—Ç–µ —Å–ª—É—à–∞—Ç—å OFFLINE-—Ñ–∞–π–ª—ã –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.
      </div>
      </div>
      <button class="offline-btn online" style="width:99%;margin-bottom:7px;" onclick="nextOfflineChoice()">–°–æ–≥–ª–∞—Å–µ–Ω</button>
      <button class="offline-btn" style="width:99%;" onclick="closeOfflineModal()">–û—Ç–º–µ–Ω–∞</button>`;
  } else {
    document.getElementById('modal-offline').classList.add('active');
    document.getElementById('offline-step').innerHTML = `
      <div style="font-size:1.10em;font-weight:700;margin-bottom:15px;">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ ONLINE?</div>
      <div style="margin-bottom:20px;">–í—Å–µ —Å–∫–∞—á–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.<br>
      –û—á–∏—â–∞–µ—Ç—Å—è –º–µ—Å—Ç–æ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.<br>
      –ü–µ—Å–Ω–∏ —Å–Ω–æ–≤–∞ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.
      </div>
      <button class="offline-btn online" style="width:99%;" onclick="confirmGoOnline()">–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª—ã –∏ –≤–æ–∑–≤—Ä–∞—Ç ONLINE</button>
      <button class="offline-btn" style="width:99%;margin-top:7px;" onclick="closeOfflineModal()">–û—Ç–º–µ–Ω–∞</button>`;
  }
}

function closeOfflineModal() {
  document.getElementById('modal-offline').classList.remove('active');
}

function nextOfflineChoice() {
  const d = getDownloadStats();
  document.getElementById('offline-step').innerHTML = `
    <div style="font-size:1.10em;font-weight:700;margin-bottom:13px;">–ß—Ç–æ —Å–∫–∞—á–∞—Ç—å?</div>
    <div style="text-align:left;">
      <label style="display:block;margin:8px 0;">
        <input type="radio" name="offline-mode" value="all" checked>
        –í–µ—Å—å –¥–∏—Å–∫ (${d.allCount} –ø–µ—Å–µ–Ω, ${d.allSizeMb} –ú–ë)
      </label>
      <label style="display:block;margin:8px 0;">
        <input type="radio" name="offline-mode" value="liked">
        –¢–æ–ª—å–∫–æ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è (${d.likedCount || 0} –ø–µ—Å–µ–Ω, ${d.likedSizeMb || 0} –ú–ë)
      </label>
    </div>
    <button class="offline-btn online" style="width:99%;margin-top:12px;" onclick="startOfflineDownload()">–°–∫–∞—á–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ</button>
    <button class="offline-btn" style="width:99%;margin-top:8px;" onclick="closeOfflineModal()">–û—Ç–º–µ–Ω–∞</button>`;
}

function getAudioSize(idx) {
  return config.tracks[idx].size || 4.7;
}

function getDownloadStats() {
  const liked = getLiked();
  const allCount = config.tracks.length;
  const likedCount = liked.length;
  
  let allMb = 0, likeMb = 0;
  for (let i = 0; i < allCount; ++i) {
    allMb += getAudioSize(i);
    if (liked.indexOf(i) !== -1) likeMb += getAudioSize(i);
  }
  
  return {
    allSizeMb: Math.round(allMb * 10) / 10,
    likedSizeMb: Math.round(likeMb * 10) / 10,
    likedCount,
    allCount
  };
}

function getAllAssetsForOffline(mode) {
  const all = ['index.html', 'config.json', 'img/logo.png', 'img/star.png', 'img/star2.png',
               'Cover.png', 'Cover01.png', 'Cover02.png', 'Cover03.png'];
  const liked = getLiked();
  
  for (let i = 0; i < config.tracks.length; ++i) {
    if (mode === 'all' || liked.indexOf(i) !== -1) {
      all.push(config.tracks[i].audio);
      all.push(config.tracks[i].lyrics);
      if (config.tracks[i].fulltext) all.push(config.tracks[i].fulltext);
    }
  }
  
  return [...new Set(all)];
}

function startOfflineDownload() {
  offlineDownloading = true;
  closeOfflineModal();
  setOfflineUIState('downloading');
  
  const mode = document.querySelector('input[name="offline-mode"]:checked').value;
  const files = getAllAssetsForOffline(mode);
  
  navigator.serviceWorker.ready.then(async sw => {
    sw.active.postMessage({
      type: 'CACHE_FILES',
      files,
      offlineMode: true
    });
    
    const stats = getDownloadStats();
    const needMb = (mode == 'all' ? stats.allSizeMb : stats.likedSizeMb);
    const max = files.length;
    
    const checkAll = setInterval(async () => {
      const cache = await caches.open('album-offline-v1');
      let ok = 0;
      
      for (let src of files) {
        const res = await cache.match(src);
        if (res) ok++;
      }
      
      setOfflineUIState('downloading', ok / max, needMb);
      
      if (ok >= max) {
        clearInterval(checkAll);
        offlineDownloading = false;
        offlineMode = true;
        localStorage.setItem('offlineMode', '1');
        setOfflineUIState('offline');
        offlineShowDone(needMb, mode);
        syncOfflineState();
      }
    }, 400);
  });
}

function setOfflineUIState(state, progress, needMb) {
  const btn = document.getElementById('offline-btn');
  
  if (state === 'downloading') {
    btn.disabled = true;
    btn.className = 'offline-btn offline';
    btn.innerHTML = 'OFFLINE';
    
    if (!document.getElementById('offline-progr-div')) {
      const div = document.createElement('div');
      div.id = 'offline-progr-div';
      div.innerHTML = `
        <div class="offline-progress">
          <div class="offline-progress-bar" id="offline-progress-bar" style="width:0%;"></div>
        </div>
        <div class="offline-desc" id="offline-desc"></div>`;
      btn.parentElement.insertBefore(div, btn.nextSibling);
    }
    
    document.getElementById('offline-progress-bar').style.width = Math.round((progress || 0) * 100) + '%';
    document.getElementById('offline-desc').innerText = "–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ " + (needMb || 0) + " –ú–ë ...";
  }
  
  if (state === 'offline') {
    btn.disabled = false;
    btn.className = 'offline-btn offline';
    btn.innerHTML = 'OFFLINE';
    const div = document.getElementById('offline-progr-div');
    if (div) div.remove();
  }
  
  if (state === 'online') {
    btn.disabled = false;
    btn.className = 'offline-btn online';
    btn.innerHTML = 'ONLINE';
    const div = document.getElementById('offline-progr-div');
    if (div) div.remove();
  }
}

function offlineShowDone(mb, mode) {
  document.getElementById('modal-offline').classList.add('active');
  document.getElementById('offline-step').innerHTML = `
    <div style="font-size:1.18em;font-weight:700;margin-bottom:12px;">–í—Å–µ —Ñ–∞–π–ª—ã —Å–∫–∞—á–∞–Ω—ã!</div>
    <div style="margin-bottom:13px;">
      <b>${mode == "all" ? "–í–µ—Å—å –¥–∏—Å–∫" : "–ü–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è —Ç—Ä–µ–∫–∏"}</b><br>
      –î–æ—Å—Ç—É–ø–Ω—ã –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞.<br>
      –ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–∏–º–µ—Ä–Ω–æ <b>${mb} –ú–ë</b>.<br>
      <div style="color:#888;font-size:.98em;margin:5px 0 0 0;">
        –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ: –µ—Å–ª–∏ –∫–µ—à –±—Ä–∞—É–∑–µ—Ä–∞<br>–±—É–¥–µ—Ç –æ—á–∏—â–µ–Ω ‚Äî –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —Å–∫–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ!
      </div>
    </div>
    <button class="offline-btn" style="width:99%;" onclick="closeOfflineModal()">OK</button>`;
}

function confirmGoOnline() {
  offlineMode = false;
  localStorage.removeItem('offlineMode');
  setOfflineUIState('online');
  closeOfflineModal();
  
  navigator.serviceWorker.ready.then(sw => {
    sw.active.postMessage({
      type: 'CLEAR_CACHE',
      offlineMode: false
    });
  });
}

// ==================== iOS –ü–û–î–î–ï–†–ñ–ö–ê –ò PWA ====================
function detectIOSAndShowInstallGuide() {
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
  const isInStandaloneMode = window.navigator.standalone === true;
  const isInPWA = window.matchMedia('(display-mode: standalone)').matches;
  
  if (isIOS && !isInStandaloneMode && !isInPWA) {
    if (!localStorage.getItem('ios-install-dismissed')) {
      setTimeout(showIOSInstallPrompt, 2000);
    }
  }
}

function showIOSInstallPrompt() {
  const prompt = document.createElement('div');
  prompt.className = 'ios-install-prompt';
  prompt.innerHTML = `
    <div class="ios-prompt-content">
      <button class="ios-prompt-close" onclick="dismissIOSPrompt()">√ó</button>
      <img src="img/logo.png" alt="Logo" class="ios-prompt-icon">
      <h3>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h3>
      <p>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —Å–≤–æ–π iPhone:</p>
      <ol style="text-align: left;">
        <li>–ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞</li>
        <li>–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ ¬´–ù–∞ —ç–∫—Ä–∞–Ω –î–æ–º–æ–π¬ª</li>
        <li>–ù–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å¬ª</li>
      </ol>
      <button onclick="dismissIOSPrompt()" class="ios-prompt-button">–ü–æ–Ω—è—Ç–Ω–æ</button>
    </div>
  `;
  document.body.appendChild(prompt);
  
  setTimeout(() => prompt.classList.add('show'), 100);
}

function dismissIOSPrompt() {
  const prompt = document.querySelector('.ios-install-prompt');
  if (prompt) {
    prompt.classList.remove('show');
    setTimeout(() => prompt.remove(), 300);
    localStorage.setItem('ios-install-dismissed', Date.now().toString());
  }
}

// PWA —É—Å—Ç–∞–Ω–æ–≤–∫–∞
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  const btn = document.getElementById('install-pwa-btn');
  if (btn) btn.style.display = '';
});

document.getElementById('install-pwa-btn').onclick = function() {
  document.getElementById('install-modal').classList.add('active');
  document.getElementById('install-modal-hash').style.display = 'none';
  document.getElementById('install-proceed-btn').disabled = false;
  document.getElementById('install-proceed-btn').innerText = '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
};

function closeInstallModal() {
  document.getElementById('install-modal').classList.remove('active');
}

document.getElementById('install-proceed-btn').onclick = async function() {
  const btn = this;
  btn.disabled = true;
  btn.innerText = '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞...';
  document.getElementById('install-modal-hash').style.display = '';
  document.getElementById('install-hash-progress').innerText = '';
  
  const hash = await hashManifest();
  document.getElementById('install-hash-progress').innerText = 'SHA-256: ' + hash;
  btn.innerText = '–£—Å—Ç–∞–Ω–æ–≤–∫–∞...';
  
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then((choiceResult) => {
      closeInstallModal();
      document.getElementById('install-pwa-btn').style.display = 'none';
      deferredPrompt = null;
    });
  } else {
    alert('–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫—É PWA.');
    closeInstallModal();
  }
};

async function hashManifest() {
  try {
    const resp = await fetch('manifest.json');
    const data = await resp.arrayBuffer();
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  } catch(e) {
    return '[–æ—à–∏–±–∫–∞ —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è]';
  }
}

document.getElementById('install-modal').onclick = function(e) {
  if (e.target === this) closeInstallModal();
};
// –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ (PWA)
window.addEventListener('appinstalled', () => {
  Ach.unlock('pwa_installed');
});
// ==================== –û–ë–†–ê–¢–ù–ê–Ø –°–í–Ø–ó–¨ (—á–∞—Ç) ====================
let fbPollTimer = null;

function openFeedbackModal(){
  const el = document.getElementById('modal-feedback');
  if (!el) return;
  el.classList.add('active');
  fbLoadHistory();
  // –∞–≤—Ç–æ‚Äë—Ñ–æ–∫—É—Å –Ω–∞ –∏–Ω–ø—É—Ç
  setTimeout(() => { try { document.getElementById('fb-input')?.focus(); } catch(e){} }, 30);
  if (fbPollTimer) clearInterval(fbPollTimer);
  fbPollTimer = setInterval(fbLoadHistory, 8000);
}

function closeFeedbackModal(){
  const el = document.getElementById('modal-feedback');
  if (el) el.classList.remove('active');
  if (fbPollTimer) { clearInterval(fbPollTimer); fbPollTimer=null; }
}

async function fbLoadHistory(){
  try{
    const dev = (typeof getDeviceHash === 'function') ? getDeviceHash() : '';
    if (!dev || !window.GLOBAL_STATS_URL) return;
    const res = await fetch(`${GLOBAL_STATS_URL}/feedback/history?device=${encodeURIComponent(dev)}`, { mode:'cors' });
    const data = await res.json().catch(()=> ({}));
    const list = document.getElementById('fb-list');
    const codeEl = document.getElementById('fb-code');
    if (!list || !codeEl) return;

    if (data?.ok){
      codeEl.textContent = data.code ? `–ö–æ–¥ –¥–∏–∞–ª–æ–≥–∞: #${data.code}` : '';
      const msgs = data.messages || [];
      list.innerHTML = msgs.map(m=>{
        const when = new Date(m.created_at).toLocaleString();
        const isAdmin = m.sender === 'admin';
        const align = isAdmin ? 'flex-end' : 'flex-start';
        const bg = isAdmin ? '#203020' : '#20283a';
        return `<div style="display:flex;justify-content:${align};margin:6px 0;">
          <div style="max-width:88%;background:${bg};padding:8px 10px;border-radius:10px;">
            ${escapeHtml(m.text)}
            <div style="color:#9aa8c4;font-size:.8em;margin-top:4px;">${when}</div>
          </div>
        </div>`;
      }).join('');
      list.scrollTop = list.scrollHeight;
    }
  }catch(e){
    // —Ç–∏—Ö–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å
  }
}

let fbSending = false;
async function fbSend(){
  if (fbSending) return;
  const inp = document.getElementById('fb-input');
  if (!inp) return;
  const text = (inp.value||'').trim();
  if (!text) return;
  fbSending = true;
  inp.disabled = true;
  const prev = inp.value;
  inp.value = '';
  try{
    const dev = (typeof getDeviceHash === 'function') ? getDeviceHash() : '';
    if (!dev || !window.GLOBAL_STATS_URL) throw new Error('not_configured');
    const res = await fetch(`${GLOBAL_STATS_URL}/feedback/send`, {
      method:'POST',
      headers:{'Content-Type':'application/json', ...apiAuthHeaders()},
      mode:'cors',
      body: JSON.stringify({ text, deviceHash: dev })
    });
    const data = await res.json().catch(()=> ({}));
    if (!res.ok || !data?.ok) {
      // –≤–µ—Ä–Ω–µ–º —Ç–µ–∫—Å—Ç –æ–±—Ä–∞—Ç–Ω–æ, –µ—Å–ª–∏ –æ—à–∏–±–∫–∞
      inp.value = prev;
      if (window.NotificationSystem?.error) NotificationSystem.error(`–ù–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${data?.error||res.status}`);
      else alert(`–ù–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${data?.error||res.status}`);
    } else {
      if (window.NotificationSystem?.success) NotificationSystem.success('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
      fbLoadHistory();
    }
  }catch(e){
    inp.value = prev;
    if (window.NotificationSystem?.error) NotificationSystem.error('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
    else alert('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
  } finally {
    fbSending = false;
    inp.disabled = false; inp.focus();
  }
}

function escapeHtml(s){
  return String(s||'')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}
function getFlagEmoji(cc) {
  // ISO-3166 alpha-2 -> —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
  if (!cc || cc.length !== 2) return 'üè≥Ô∏è';
  const codePoints = cc.toUpperCase().split('').map(c => 127397 + c.charCodeAt());
  try { return String.fromCodePoint(...codePoints); } catch { return 'üè≥Ô∏è'; }
}
function formatSpan(sec) {
  if (sec <= 0) return '‚Äî';
  const d = Math.floor(sec / 86400);
  const h = Math.floor((sec % 86400)/3600);
  const m = Math.floor((sec % 3600)/60);
  if (d>0) return `${d}–¥ ${h}—á`;
  if (h>0) return `${h}—á ${m}–º`;
  return `${m}–º`;
}
// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –±—ã–ª–æ: –Ω–∏–∂–µ –≤ initializeMainUi —É–∂–µ –µ—Å—Ç—å
// document.getElementById('modal-feedback').onclick = (e) => { if (e.target===this) closeFeedbackModal(); };

// ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ====================
document.addEventListener('DOMContentLoaded', function() {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É PWA
  if ('serviceWorker' in navigator && 'caches' in window) {
    console.log('PWA features supported');
  } else {
    console.warn('PWA features not fully supported');
  }
  
  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–ª–µ–µ—Ä–∞
  shuffleMode = localStorage.getItem('shuffleMode') === '1';
  repeatMode = localStorage.getItem('repeatMode') === '1';
  favoritesOnlyMode = localStorage.getItem('favoritesOnlyMode') === '1';
  offlineMode = localStorage.getItem('offlineMode') === '1';
  animationEnabled = localStorage.getItem('animationEnabled') === '1';
  bitEnabled = localStorage.getItem('bitEnabled') === '1';
  
  const savedIntensity = localStorage.getItem('bitIntensity');
  if (savedIntensity) {
    bitIntensity = parseInt(savedIntensity);
  }
  
  hasShownAnimationWarning = localStorage.getItem('hasShownAnimationWarning') === '1';
  hasShownBitWarning = localStorage.getItem('hasShownBitWarning') === '1';
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤
  if (config) {
    updateAvailableTracks();
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–º–Ω—É—é —Ç–µ–º—É —Å–∏—Å—Ç–µ–º—ã
  if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
    document.body.classList.add('dark-theme');
  }
  
  // –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ —Å–ø–∏—Å–∫–∞ —Ç—Ä–µ–∫–æ–≤
  setTimeout(() => {
    const trackList = document.getElementById('track-list');
    if (!trackList) return;
    
    const observer = new MutationObserver((mutations) => {
      if (favoritesFilterActive) {
        updateFavoriteClasses();
      }
    });
    
    observer.observe(trackList, {
      childList: true,
      subtree: true
    });
  }, 1000);
});

// ==================== –ú–û–ù–ò–¢–û–†–ò–ù–ì –°–ï–¢–ò ====================
window.addEventListener('online', () => {
  NotificationSystem.success('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
  try { GlobalStats.flush(); } catch(e) {}
});

window.addEventListener('offline', () => {
  NotificationSystem.offline('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º');
});

// ==================== PERFORMANCE MONITORING ====================
if (window.performance && performance.mark) {
  performance.mark('app-start');
  
  window.addEventListener('load', () => {
    performance.mark('app-loaded');
    performance.measure('App Load Time', 'app-start', 'app-loaded');
    
    const measure = performance.getEntriesByName('App Load Time')[0];
    console.log(`App loaded in ${measure.duration.toFixed(2)}ms`);
  });
}

// ==================== –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö ====================
window.addEventListener('error', (event) => {
  console.error('Global error:', event);
  if (event.message && !event.message.includes('ResizeObserver')) {
    console.error('Debug info at error:', debugInfo());
  }
});

window.addEventListener('unhandledrejection', (event) => {
  console.error('Unhandled promise rejection:', event);
});

// ==================== –û–¢–õ–ê–î–ö–ê ====================
window.debugInfo = function() {
  const info = {
    version: VERSION,
    buildDate: BUILD_DATE,
    userAgent: navigator.userAgent,
    online: navigator.onLine,
    serviceWorker: 'serviceWorker' in navigator,
    localStorage: {
      promoPassed: localStorage.getItem('promoPassed'),
      likedTracks: getLiked(),
      shuffleMode: localStorage.getItem('shuffleMode'),
      repeatMode: localStorage.getItem('repeatMode'),
      favoritesOnlyMode: localStorage.getItem('favoritesOnlyMode'),
      favoritesFilter: localStorage.getItem('favoritesFilter'),
      offlineMode: localStorage.getItem('offlineMode'),
      animationEnabled: localStorage.getItem('animationEnabled'),
      bitEnabled: localStorage.getItem('bitEnabled'),
      bitIntensity: localStorage.getItem('bitIntensity')
    },
    config: {
      loaded: configLoaded,
      tracks: config?.tracks?.length || 0,
      artist: config?.artist,
      albumYear: config?.albumYear
    },
    player: {
      currentTrack: currentTrack,
      shuffleMode: shuffleMode,
      repeatMode: repeatMode,
      favoritesOnlyMode: favoritesOnlyMode,
      lyricsViewMode: lyricsViewMode,
      autoPlay: autoPlayEnabled,
      animationEnabled: animationEnabled,
      bitEnabled: bitEnabled,
      bitIntensity: bitIntensity
    },
    cache: {
      caches: 'caches' in window
    }
  };
  
  console.table(info);
  return info;
};

console.log('Application initialized. Version:', VERSION);

</script>

<!-- –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ JSZip —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ -->
<script>
// JSZip –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∞–ª—å–±–æ–º–∞
</script>

</body>
</html>
