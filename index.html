<!-- ...строки до body не менялись... -->
<body>
  <div id="promocode-block">
    <div class="promo-inner">
      <img class="promo-cover" src="Cover.png" alt="Cover" draggable="false"/>
      <h2>Вход по промокоду</h2>
      <input id="promo-inp" type="text" placeholder="Введите промокод" autocomplete="off" autofocus />
      <button id="promo-btn" onclick="checkPromo()">Войти</button>
      <div id="promo-error"></div>
    </div>
  </div>
  <div id="main-block" class="hidden">
    <header>
      <div id="cover-wrap">
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-left">&#8592;</button>
        <img id="cover" src="Cover.png" alt="Cover album" draggable="false"/>
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-right">&#8594;</button>
      </div>
      <div id="social-links" class="socials-under-cover"></div>
    </header>
    <div class="track-list" id="track-list"></div>
    <div class="feedback-support-row">
      <span class="feedback-link" id="feedback-link">Обратная связь</span>
      <a class="support-link" id="support-link" href="#" target="_blank">Поддержать</a>
    </div>
    <img class="logo-bottom" src="img/logo.png" alt="Логотип"/>
  </div>
  <div class="modal-bg" id="modal-feedback">
    <div class="modal-feedback">
      <button class="bigclose" onclick="closeFeedbackModal()" title="Закрыть">
        <svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg>
      </button>
      <div id="feedback-step">
        <div class="fake-textarea" id="fake-textarea" onclick="showRealTextarea()">
          Опишите здесь проблему или своё пожелание для улучшения, <br>можете просто оставить свой отзыв...
        </div>
      </div>
      <div id="modal-feedback-error" class="err-msg"></div>
      <div id="modal-feedback-success" class="success-msg"></div>
      <button onclick="sendFeedbackMsg()" id="send-feedback-btn" style="margin-bottom:8px;">Отправить</button>
    </div>
  </div>
  <style>
  /* Весь CSS не влезет — вставлен только diff! Найдите .logo-bottom (убран filter!), увеличен size, margin-top меньше */
  .logo-bottom {
    display:block;
    margin:22px auto 0 auto !important;
    max-width: 130px; width: 27vw; min-width: 80px; height:auto;
  }
  .promo-cover {
    width:256px; height:256px; object-fit:cover; border-radius:12px; box-shadow:0 4px 24px #000c; margin-bottom: 19px; display:block; background:#181818; max-width:75vw; aspect-ratio:1/1;
  }
  .modal-feedback .bigclose {
    position:absolute; left:50%; top:0; transform:translate(-50%,-50%);
    background:none; border:none; cursor:pointer; width:58px; height:58px;
    color:#aaa; display:flex;align-items:center;justify-content:center;z-index:20; outline:none;
  }
  .modal-feedback .bigclose svg {width:56px;height:56px;}
  .modal-feedback .fake-textarea {
    width:100%; min-height:84px; max-height:175px; border-radius:9px; border:1.5px solid #aaaa;
    padding:16px 10px 12px 10px; font-size:1.04em; background:#18181b; color:#aaa;
    margin:28px 0 17px 0; resize:none; outline:none; display:block; box-sizing:border-box; transition:border .13s;
    font-weight:400; font-family:inherit; text-align:center; cursor: pointer; opacity:0.89;
  }
  .modal-feedback .real-textarea {
    width:100%; min-height:84px; max-height:175px; border-radius:9px; border:1.5px solid #aaa;
    padding:16px 10px 12px 10px; font-size:1.04em; background:#18181b; color:#fff;
    margin:28px 0 17px 0; resize:none; outline:none; display:block; box-sizing:border-box; transition:border .13s;
    font-weight:500; font-family:inherit; text-align:left;
  }
  </style>
  <script>
    let config = null, promoPassed = false, configLoaded = false;
    let coverGalleryArr = ['Cover.png', 'Cover01.png', 'Cover02.png', 'Cover03.png'];
    let coverGalleryIdx = 0, coverAutoplay = null;
    let currentTrack = -1, currentLyrics = [];
    let autoPlayEnabled = false;

    fetch('config.json').then(r => r.json()).then(data => {
      config = data;
      configLoaded = true;
      document.getElementById('promo-inp').disabled = false;
      document.getElementById('promo-btn').disabled = false;
    });

    function checkPromo() {
      const val = document.getElementById('promo-inp').value.trim();
      if (!configLoaded) {
        document.getElementById('promo-error').innerText = "Загрузка данных... Попробуйте через пару секунд.";
        return;
      }
      if (val && config && val.toUpperCase() === config.promoCode.toUpperCase()) {
        promoPassed = true;
        document.getElementById('main-block').classList.remove('hidden');
        document.getElementById('promocode-block').classList.add('hidden');
        initializeMainUi();
      } else {
        document.getElementById('promo-error').innerText = "Неверный промокод. Попробуйте ещё!";
      }
    }
    document.getElementById('promo-inp').addEventListener('keydown', function(e){
      if(e.key === "Enter") checkPromo();
    });

    function initializeMainUi() {
      setCoverImage(coverGalleryIdx);
      buildSocials();
      document.getElementById('support-link').href = config.donateLink;
      document.body.style.background = "url(" + config.background + ") center/cover fixed #111";
      buildTrackList();

      document.getElementById('cover-gallery-arrow-left').onclick = function(e){
        setCoverImage(coverGalleryIdx - 1);
        startCoverAutoPlay();
      };
      document.getElementById('cover-gallery-arrow-right').onclick = function(e){
        setCoverImage(coverGalleryIdx + 1);
        startCoverAutoPlay();
      };
      let startX = null;
      const el = document.getElementById('cover-wrap');
      el.addEventListener('touchstart', function(e) {
        startX = e.touches[0].clientX;
      });
      el.addEventListener('touchend', function(e) {
        if(startX===null) return;
        let dx = e.changedTouches[0].clientX - startX;
        if(Math.abs(dx) > 30) {
          if(dx > 0) setCoverImage(coverGalleryIdx - 1);
          else setCoverImage(coverGalleryIdx + 1);
          startCoverAutoPlay();
        }
        startX = null;
      });
      startCoverAutoPlay();

      document.getElementById('feedback-link').onclick = openFeedbackModal;
      document.getElementById('modal-feedback').onclick = function(e){
        if(e.target === this) closeFeedbackModal();
      };
    }
    function setCoverImage(idx) {
      coverGalleryIdx = (idx + coverGalleryArr.length) % coverGalleryArr.length;
      document.getElementById('cover').src = coverGalleryArr[coverGalleryIdx];
    }
    function startCoverAutoPlay() {
      if(coverAutoplay) clearInterval(coverAutoplay);
      coverAutoplay = setInterval(function(){
        setCoverImage(coverGalleryIdx + 1);
      }, 5000);
    }
    function buildSocials() {
      const s = config.socials.map(x =>
        `<a href="${x.url}" target="_blank">${x.title}</a>`
      ).join(" ");
      document.getElementById('social-links').innerHTML = s;
    }
    function buildTrackList() {
      let html = "";
      for (let i = 0; i < config.tracks.length; i++) {
        html += `<div class="track${i===currentTrack?' current':''}" id="trk${i}" onclick="pickAndPlayTrack(${i})">
          <span class="tnum">${(i+1).toString().padStart(2,'0')}.</span>${config.tracks[i].title}</div>`;
        if (i === currentTrack) html += `
    <div class="lyrics-player-block" id="lyricsplayerblock"></div>
        `;
      }
      document.getElementById('track-list').innerHTML = html;
      renderLyricsBlock();
    }
    function pickAndPlayTrack(n) {
      showTrack(n, true);  // true = автоплей
      autoPlayEnabled = true;
    }
    function showTrack(n, doPlay) {
      currentTrack = n;
      buildTrackList();
      if (doPlay && document.getElementById("audio")) {
        setTimeout(()=>{
          document.getElementById("audio").play();
        }, 160);
      }
    }
    function renderLyricsBlock() {
      const block = document.getElementById('lyricsplayerblock');
      if(!block) return;
      let lyricsDiv = `
<div id="lyrics-window"><div class="lyrics-scroll" id="lyrics"></div></div>
<audio id="audio" controls preload="metadata"></audio>
<div class="karaoke-controls">
  <a class="karaoke-btn" id="download-link" href="#" download>Скачать песню</a>
  <button class="karaoke-btn" onclick="copyLyrics()">Скопировать текст</button>
</div>`;
      block.innerHTML = lyricsDiv;
      const tr = config.tracks[currentTrack];
      document.getElementById('audio').src = tr.audio;
      document.getElementById('download-link').href = tr.audio;
      loadLyrics(tr.lyrics);
      document.getElementById('audio').ontimeupdate = function () {
        renderLyrics(this.currentTime);
      };
      document.getElementById('audio').onended = function () {
        if (autoPlayEnabled) {
          let next = (currentTrack + 1) % config.tracks.length;
          showTrack(next, true);
        }
      };
    }
    function loadLyrics(file) {
      fetch(file).then(r=>r.json()).then(js => {
        currentLyrics = js;
        renderLyrics(0);
      });
    }
    function renderLyrics(time) {
      if (!currentLyrics || !currentLyrics.length) {
        document.getElementById('lyrics').innerHTML = "";
        return;
      }
      let active = 0;
      for (let i = 0; i < currentLyrics.length; i++) {
        if (time >= currentLyrics[i].time) active = i;
      }
      let windowSize = 5;
      let start = active < 2 ? 0 : active - 2;
      let padTop = active < 2 ? 2-active : 0;
      let rows = [];
      for(let p=0; p<padTop; ++p) rows.push('<div class="lyrics-window-line"></div>');
      for(let i=start; i<Math.min(currentLyrics.length, start+windowSize-padTop); i++) {
        let cls = (i===active) ? 'lyrics-window-line active' : 'lyrics-window-line';
        rows.push(`<div class="${cls}">${currentLyrics[i]?currentLyrics[i].line:""}</div>`);
      }
      while(rows.length<windowSize) rows.push('<div class="lyrics-window-line"></div>');
      document.getElementById("lyrics").innerHTML = rows.join("");
    }
    function copyLyrics() {
      if(!currentLyrics || !currentLyrics.length) return;
      const text = currentLyrics.map(x=>x.line).join('\n');
      navigator.clipboard.writeText(text);
      alert('Текст скопирован!');
    }
    window.addEventListener('keydown', function(e){
      if(!promoPassed) return;
      if(e.key == 'ArrowRight') {showTrack(Math.min(currentTrack+1, config.tracks.length-1), true);}
      if(e.key == 'ArrowLeft') {showTrack(Math.max(currentTrack-1, 0), true);}
    });

    // --- FEEDBACK POPUP ---
    let isRealTextarea = false;
    function openFeedbackModal() {
      document.getElementById('modal-feedback').classList.add('active');
      isRealTextarea = false;
      document.getElementById('feedback-step').innerHTML = `
        <div class="fake-textarea" id="fake-textarea" onclick="showRealTextarea()">
          Опишите здесь проблему или своё пожелание для улучшения,<br>можете просто оставить свой отзыв...
        </div>
      `;
      document.getElementById('modal-feedback-error').innerText = "";
      document.getElementById('modal-feedback-success').innerText = "";
      document.getElementById('send-feedback-btn').disabled = false;
    }
    function closeFeedbackModal() {
      document.getElementById('modal-feedback').classList.remove('active');
    }
    function showRealTextarea() {
      if (isRealTextarea) return;
      isRealTextarea = true;
      document.getElementById('feedback-step').innerHTML =
        `<textarea class="real-textarea" id="feedback-text" maxlength="200" autofocus></textarea>`;
      setTimeout(() => {
        let ta = document.getElementById('feedback-text');
        ta.focus();
        ta.addEventListener('input', function(){
          if(this.value.length > 200) this.value = this.value.substr(0,200);
        });
      }, 20);
    }
    function sendFeedbackMsg() {
      let msg = "";
      if (isRealTextarea) {
        let ta = document.getElementById('feedback-text');
        msg = ta.value.trim();
      } else return;
      const errorDiv = document.getElementById('modal-feedback-error');
      const successDiv = document.getElementById('modal-feedback-success');
      errorDiv.innerText = ""; successDiv.innerText = "";
      if (msg.length < 5) {
        errorDiv.innerText = "Напишите хотя бы пару слов!";
        return;
      }
      document.getElementById('send-feedback-btn').disabled = true;
      successDiv.innerText = "Спасибо! (Отправка реализуется на сервере)";
      setTimeout(closeFeedbackModal, 2100);
      document.getElementById('send-feedback-btn').disabled = false;
    }
  </script>
</body>
</html>
