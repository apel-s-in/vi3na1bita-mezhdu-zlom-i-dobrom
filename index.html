<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Витрина Разбита</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    html, body {height: 100%;}
    body {
      min-height: 100vh;
      background: #181818;
      color: #f2f2f2;
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      display: flex; flex-direction: column;
      min-width: 100vw;
    }
    #promocode-block {
      position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
      display: flex; align-items: center; justify-content: center;
      background: #181818; z-index: 100;
    }
    .promo-inner {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: rgba(15,18,24, 0.98);
      border-radius: 16px;
      box-shadow: 0 6px 24px #0008;
      padding: 36px 26px 32px 26px;
      min-width: 260px;
      min-height: 170px;
    }
    .promo-cover {
      width: 256px; height: 256px; object-fit:cover; border-radius:12px;
      box-shadow:0 4px 24px #000c; margin-bottom: 19px;
      display:block;
      background: #181818;
      max-width: 75vw;
      aspect-ratio: 1/1;
    }
    #promocode-block h2 {
      margin-top: 0; margin-bottom: 19px;
      font-weight: 700;
      letter-spacing: 0.03em;
      font-size: 1.12em;
      text-align:center;
    }
    #promo-inp {
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 1.1em;
      border: 1px solid #888;
      outline: none;
      background: #20242b;
      color: #fff;
      margin-bottom: 12px;
      width: 180px;
      text-align:center;
      font-weight: 600;
      letter-spacing: 0.08em;
      transition: border 0.16s;
    }
    #promo-inp:focus {border-color:#4daaff;}
    #promo-btn {
      padding: 10px 22px;
      border-radius: 6px;
      border: none;
      background: #4daaff;
      color: #fff;
      font-size: 1.05em;
      font-weight: 700;
      cursor: pointer;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      margin-bottom: 5px;
      box-shadow:0 2px 8px #0047;
      transition: background .18s;
    }
    #promo-btn:active {background:#247ecf;}
    #promo-error {color:#ff4a4a; margin:10px; min-height:19px; font-size:1.07em;}
    #main-block {max-width:420px; margin:0 auto; flex:1 0 auto; display:flex; flex-direction:column; align-items:center;}
    .hidden {display:none!important;}
    header {width:100%; text-align:center; padding-bottom:0;margin:0 auto;}
    #cover-wrap {
      width: 100%; max-width: 400px; margin:24px auto 0 auto;
      aspect-ratio: 1/1; display:flex;align-items:center;justify-content:center;position:relative;
    }
    .cover-gallery-arrow {
      position: absolute; top: 50%; transform: translateY(-50%);
      font-size: 2.3em; color: #fff; background: rgba(0,0,0,0.22); border: none;
      border-radius: 50%; width: 44px; height: 44px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; z-index: 2; transition: background .16s;
    }
    .cover-gallery-arrow:hover {background: rgba(60,60,120,0.40);}
    #cover-gallery-arrow-left {left:7px;}
    #cover-gallery-arrow-right {right:7px;}
    #cover {
      width:100%; max-width:100%; border-radius:12px;
      aspect-ratio: 1/1; object-fit: cover; display:block; margin: 0;
      box-shadow:0 6px 32px #000a; background:#202020;
      pointer-events:none; user-drag:none;-webkit-user-drag:none;user-select:none;
    }
    .socials-under-cover {
      margin: 14px auto 0 auto; width:100%;
      max-width:398px; text-align:center; font-size:1.03em; display:flex;flex-wrap:wrap;justify-content:center;gap:12px;
    }
    .socials-under-cover a {
      color:#4daaff !important;
      text-decoration: underline !important;
      font-weight:500;font-size:1em;
    }
    .socials-under-cover a:hover {color:#fff !important;}
    .track-list {margin:0 auto;margin-bottom:0;max-width:400px; width:100%;font-size:1.05em;color:#eee;background:none; padding: 0;}
    .track {padding:10px 0 10px 24px;border-bottom:1px solid #394866;cursor:pointer;text-align:left;transition:background .15s;box-sizing: border-box;}
    .track.current {background:#252d39;}
    .track span.tnum {color:#8ab8fd;min-width:30px;display:inline-block;margin-right:7px;text-align:right; font-variant-numeric:tabular-nums;font-family:inherit;}
    .lyrics-player-block {width:100%;margin:8px 0 3px 0;}
    #lyrics-window {
      width: 100%; background:rgba(34,34,34,0.98);
      border-radius: 12px; box-shadow:0 8px 24px #0007;
      overflow:hidden; height:8.5em; position:relative;
      display:flex;flex-direction:column;align-items:stretch;
      justify-content:center;margin-bottom:7px;box-sizing:border-box;
    }
    .lyrics-scroll {width:100%; transition: transform 0.4s cubic-bezier(.71,.21,.43,.9); will-change:transform;word-break:break-word;}
    .lyrics-window-line {opacity:0.55;font-size:1.14em;transition:opacity 0.24s,color 0.24s;line-height:1.7em;text-align:center; min-height:1.7em;max-width:97%; margin:0 auto;font-weight:400;color:#eee;white-space:pre-line; user-select:none;letter-spacing:0.02em; word-break:break-word;}
    .lyrics-window-line.active {color:#E80100 !important;font-weight:bold;opacity:1;text-shadow:0 1px 7px #6e1818, 0 0 0 #fff;background:rgba(0,0,0,0.07);border-radius:8px;font-size:1.19em;z-index:2;}
    .karaoke-controls {
      text-align: center; margin-top: 8px; margin-bottom: 2px; display: flex;
      flex-direction: row; gap: 30px; justify-content: center; align-items: center;font-size: 1.08em; font-weight: bold;
    }
    .karaoke-btn {
      color:#4daaff !important;
      background: none; border: none; cursor: pointer;
      font-size:1.05em; text-transform: uppercase; font-weight:700; letter-spacing: .03em;
      text-decoration: underline; transition: color .18s;
      padding: 2px 7px;
    }
    .karaoke-btn:focus, .karaoke-btn:hover {color: #fff !important;}
    #audio {width:100%;margin:6px auto 2px auto;display:block;max-width:396px;}
    .feedback-support-row {max-width:420px; margin:30px auto 0 auto;display:flex;justify-content:space-between;gap:8px; font-size:1em; width:100%;}
    .feedback-link, .support-link {
      color:#4daaff !important; text-decoration:underline !important; font-weight:700; text-transform:uppercase;
      letter-spacing:.03em; cursor: pointer; transition: color .18s; font-size: 1em;
    }
    .feedback-link:hover, .support-link:hover {color: #fff !important;}
    .logo-bottom {
      display:block;
      margin: 33px auto 0px auto !important;
      max-width: 130px; width: 27vw; min-width: 80px; height:auto;
    }
    /* OFFLINE кнопка и прогрессбар */
    .offline-btn {
      min-width: 102px; height: 38px;
      font-size: 1.05em; font-weight: bold;
      border: none; border-radius: 9px; margin: 0 6px;
      cursor: pointer; letter-spacing: 0.07em;
      box-shadow:0 2px 8px #06000032; transition: background .2s, color .14s;
    }
    .offline-btn.online {background: #E80100; color: #fff;}
    .offline-btn.offline {background: #27b34c; color: #fff;}
    .offline-btn:active {opacity: 0.92}
    .offline-btn:disabled {opacity:.7;cursor:not-allowed;}
    .offline-progress {
      margin-top: 11px; width: 100%;
      height: 8px; background: #222; border-radius:6px;overflow:hidden;
      box-shadow: 0 1px 6px #222b;
    }
    .offline-progress-bar {
      height: 100%; background: #2fed54;
      transition:width .33s;
    }
    .offline-desc {text-align:center;font-size:0.99em;margin-top:7px;opacity:0.85;}
    .like-star {
      float: right;
      width: 25px;
      height: 25px;
      margin-left: 18px;
      margin-top: -2px;
      margin-bottom: -4px;
      cursor: pointer;
      user-select: none;
      vertical-align: middle;
      transition: filter .13s, opacity .14s;
      opacity: 0.93;
    }
    .like-star:hover {
      filter: brightness(1.15) drop-shadow(0 0 8px #e0c45090);
      opacity: 1;
    }
    @media (max-width:600px) {
      .like-star {width: 22px; height: 22px; margin-left: 9px;}
    }
    /* ... остальной ваш media ... */
    @media (max-width:430px) {
      .promo-cover {width:81vw;height:auto;}
      .modal-feedback {max-width:99vw;padding:23vw 3vw 8vw 3vw;}
      .modal-feedback .bigclose {width:15vw;height:15vw;}
      .modal-feedback .bigclose svg {width:15vw;height:15vw;}
      #cover-wrap, .socials-under-cover, .track-list, #lyrics-window {max-width:96vw;}
      #cover {border-radius:8px;}
      .logo-bottom {max-width:110px;}
      #promo-inp {width:62vw;}
      .lyrics-window-line {font-size:1em;}
      #audio {max-width:97vw;}
      .feedback-support-row {max-width:99vw;}
    }
  </style>
</head>
<body>
  <div id="promocode-block">
    <div class="promo-inner">
      <img class="promo-cover" src="Cover.png" alt="Обложка" draggable="false"/>
      <h2>Вход по промокоду</h2>
      <input id="promo-inp" type="text" placeholder="Введите промокод" autocomplete="off" autofocus />
      <button id="promo-btn" onclick="checkPromo()">Войти</button>
      <div id="promo-error"></div>
    </div>
  </div>
  <div id="main-block" class="hidden">
    <header>
      <div id="cover-wrap">
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-left" title="Назад">&#8592;</button>
        <img id="cover" src="Cover.png" alt="Cover album" draggable="false"/>
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-right" title="Вперёд">&#8594;</button>
      </div>
      <div id="social-links" class="socials-under-cover"></div>
    </header>
    <div class="track-list" id="track-list"></div>
    <div class="feedback-support-row">
      <span class="feedback-link" id="feedback-link">Обратная связь</span>
      <button class="offline-btn online" id="offline-btn" onclick="offlineUIClick()">
        ONLINE
      </button>
      <a class="support-link" id="support-link" href="#" target="_blank">Поддержать</a>
    </div>
    <img class="logo-bottom" src="img/logo.png" alt="Логотип"/>
  </div>
  <!-- Модальное окно обратной связи -->
  <div class="modal-bg" id="modal-feedback">
    <div class="modal-feedback">
      <button class="bigclose" onclick="closeFeedbackModal()" title="Закрыть">
        <svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg>
      </button>
      <div id="feedback-step">
        <div class="fake-textarea" id="fake-textarea" onclick="showRealTextarea()">
          Опишите здесь проблему или своё пожелание для улучшения, <br>можете просто оставить свой отзыв...
        </div>
      </div>
      <div id="modal-feedback-error" class="err-msg"></div>
      <div id="modal-feedback-success" class="success-msg"></div>
      <button onclick="sendFeedbackMsg()" id="send-feedback-btn" style="margin-bottom:8px;">Отправить</button>
    </div>
  </div>
  <!-- Модальное окно OFFLINE -->
  <div class="modal-bg" id="modal-offline">
    <div class="modal-feedback" style="max-width:400px;">
      <button class="bigclose" onclick="closeOfflineModal()" title="Закрыть">
        <svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg>
      </button>
      <div id="offline-step"></div>
    </div>
  </div>
  <script>
    // Service Worker регистрация:
    if('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }

    let config = null, promoPassed = false, configLoaded = false;
    let coverGalleryArr = ['Cover.png', 'Cover01.png', 'Cover02.png', 'Cover03.png'];
    let coverGalleryIdx = 0, coverAutoplay = null;
    let currentTrack = -1, currentLyrics = [];
    let autoPlayEnabled = false;
    let offlineMode = false;
    let offlineDownloading = false;
    let offlineProgress = 0;

    // --- PROMO LOGIC ---
    fetch('config.json').then(r => r.json()).then(data => {
      config = data;
      configLoaded = true;
      document.getElementById('promo-inp').disabled = false;
      document.getElementById('promo-btn').disabled = false;
    });

    function checkPromo() {
      const val = document.getElementById('promo-inp').value.trim();
      if (!configLoaded) {
        document.getElementById('promo-error').innerText = "Загрузка данных... Попробуйте через пару секунд.";
        return;
      }
      if (val && config && val.toUpperCase() === config.promoCode.toUpperCase()) {
        promoPassed = true;
        document.getElementById('main-block').classList.remove('hidden');
        document.getElementById('promocode-block').classList.add('hidden');
        initializeMainUi();
      } else {
        document.getElementById('promo-error').innerText = "Неверный промокод. Попробуйте ещё!";
      }
    }
    document.getElementById('promo-inp').addEventListener('keydown', function(e){
      if(e.key === "Enter") checkPromo();
    });

    function initializeMainUi() {
      setCoverImage(coverGalleryIdx);
      buildSocials();
      document.getElementById('support-link').href = config.donateLink;
      document.body.style.background = "url(" + config.background + ") center/cover fixed #111";
      buildTrackList();

      document.getElementById('cover-gallery-arrow-left').onclick = function(e){
        setCoverImage(coverGalleryIdx - 1);
        startCoverAutoPlay();
      };
      document.getElementById('cover-gallery-arrow-right').onclick = function(e){
        setCoverImage(coverGalleryIdx + 1);
        startCoverAutoPlay();
      };
      let startX = null;
      const el = document.getElementById('cover-wrap');
      el.addEventListener('touchstart', function(e) {
        startX = e.touches[0].clientX;
      });
      el.addEventListener('touchend', function(e) {
        if(startX===null) return;
        let dx = e.changedTouches[0].clientX - startX;
        if(Math.abs(dx) > 30) {
          if(dx > 0) setCoverImage(coverGalleryIdx - 1);
          else setCoverImage(coverGalleryIdx + 1);
          startCoverAutoPlay();
        }
        startX = null;
      });
      startCoverAutoPlay();

      document.getElementById('feedback-link').onclick = openFeedbackModal;
      document.getElementById('modal-feedback').onclick = function(e){
        if(e.target === this) closeFeedbackModal();
      };
    }
    function setCoverImage(idx) {
      coverGalleryIdx = (idx + coverGalleryArr.length) % coverGalleryArr.length;
      document.getElementById('cover').src = coverGalleryArr[coverGalleryIdx];
    }
    function startCoverAutoPlay() {
      if(coverAutoplay) clearInterval(coverAutoplay);
      coverAutoplay = setInterval(function(){
        setCoverImage(coverGalleryIdx + 1);
      }, 5000);
    }
    function buildSocials() {
      const s = config.socials.map(x =>
        `<a href="${x.url}" target="_blank">${x.title}</a>`
      ).join(" ");
      document.getElementById('social-links').innerHTML = s;
    }
    // ---- Звезды
    function getLiked() {
      try { return JSON.parse(localStorage.getItem('likedTracks')||"[]"); }
      catch(e){return [];}
    }
    function saveLiked(arr) {
      localStorage.setItem('likedTracks', JSON.stringify(arr));
    }
    function isLiked(idx) {
      let liked = getLiked(); 
      return liked.indexOf(idx) !== -1;
    }
    function toggleLike(idx) {
      let liked = getLiked();
      let i = liked.indexOf(idx);
      if(i === -1) liked.push(idx);
      else liked.splice(i,1);
      saveLiked(liked);
      buildTrackList();
    }
    function buildTrackList() {
      let html = "";
      for (let i = 0; i < config.tracks.length; i++) {
        html += `<div class="track${i===currentTrack?' current':''}" id="trk${i}" onclick="pickAndPlayTrack(${i})">
          <span class="tnum">${(i+1).toString().padStart(2,'0')}.</span>
          ${config.tracks[i].title}
          <img src="${isLiked(i)?'img/star.png':'img/star2.png'}"
            class="like-star"
            alt="звезда"
            title="${isLiked(i)?'Убрать из понравившихся':'Добавить в понравившиеся'}"
            onclick="event.stopPropagation();toggleLike(${i});"
          />
        </div>`;
        if (i === currentTrack) html += `
          <div class="lyrics-player-block" id="lyricsplayerblock"></div>
        `;
      }
      document.getElementById('track-list').innerHTML = html;
      renderLyricsBlock();
    }
    // --- ТРЕКСПИСОК + ПЛЕЕР + КАРАОКЕ ---
    function buildTrackListAndRestoreSong() {
      buildTrackList();
      // можно добавить восстановление трека тут
    }
    function pickAndPlayTrack(n) {
      showTrack(n, true);
      autoPlayEnabled = true;
    }
    function showTrack(n, doPlay) {
      currentTrack = n;
      buildTrackList();
      if (doPlay && document.getElementById("audio")) {
        setTimeout(()=>{
          document.getElementById("audio").play();
        }, 160);
      }
    }
    function renderLyricsBlock() {
      const block = document.getElementById('lyricsplayerblock');
      if(!block) return;
      let lyricsDiv = `
  <div id="lyrics-window"><div class="lyrics-scroll" id="lyrics"></div></div>
  <audio id="audio" controls preload="metadata"></audio>
  <div class="karaoke-controls">
    <a class="karaoke-btn" id="download-link" href="#" download>Скачать песню</a>
    <button class="karaoke-btn" onclick="copyLyrics()">Скопировать текст</button>
  </div>`;
      block.innerHTML = lyricsDiv;
      const tr = config.tracks[currentTrack];
      document.getElementById('audio').src = tr.audio;
      document.getElementById('download-link').href = tr.audio;
      loadLyrics(tr.lyrics);
      document.getElementById('audio').ontimeupdate = function () { renderLyrics(this.currentTime); };
      document.getElementById('audio').onended = function () {
        if (autoPlayEnabled) {
          let next = (currentTrack + 1) % config.tracks.length;
          showTrack(next, true);
        }
      };
    }
    function loadLyrics(file) {
      fetch(file).then(r=>r.json()).then(js => {
        currentLyrics = js;
        renderLyrics(0);
      });
    }
    function renderLyrics(time) {
      if (!currentLyrics || !currentLyrics.length) {
        document.getElementById('lyrics').innerHTML = "";
        return;
      }
      let active = 0;
      for (let i = 0; i < currentLyrics.length; i++) {
        if (time >= currentLyrics[i].time) active = i;
      }
      let windowSize = 5;
      let start = active < 2 ? 0 : active - 2;
      let padTop = active < 2 ? 2-active : 0;
      let rows = [];
      for(let p=0; p<padTop; ++p) rows.push('<div class="lyrics-window-line"></div>');
      for(let i=start; i<Math.min(currentLyrics.length, start+windowSize-padTop); i++) {
        let cls = (i===active) ? 'lyrics-window-line active' : 'lyrics-window-line';
        rows.push(`<div class="${cls}">${currentLyrics[i]?currentLyrics[i].line:""}</div>`);
      }
      while(rows.length<windowSize) rows.push('<div class="lyrics-window-line"></div>');
      document.getElementById("lyrics").innerHTML = rows.join("");
    }
    function copyLyrics() {
      if(!currentLyrics || !currentLyrics.length) return;
      const text = currentLyrics.map(x=>x.line).join('\n');
      navigator.clipboard.writeText(text);
      alert('Текст скопирован!');
    }
    window.addEventListener('keydown', function(e){
      if(!promoPassed) return;
      if(e.key == 'ArrowRight') {showTrack(Math.min(currentTrack+1, config.tracks.length-1), true);}
      if(e.key == 'ArrowLeft') {showTrack(Math.max(currentTrack-1, 0), true);}
    });

    // --- feedback modal ---
    let isRealTextarea = false;
    function openFeedbackModal() {
      document.getElementById('modal-feedback').classList.add('active');
      isRealTextarea = false;
      document.getElementById('feedback-step').innerHTML = `
        <div class="fake-textarea" id="fake-textarea" onclick="showRealTextarea()">
          Опишите здесь проблему или своё пожелание для улучшения,<br>можете просто оставить свой отзыв...
        </div>
      `;
      document.getElementById('modal-feedback-error').innerText = "";
      document.getElementById('modal-feedback-success').innerText = "";
      document.getElementById('send-feedback-btn').disabled = false;
    }
    function closeFeedbackModal() {
      document.getElementById('modal-feedback').classList.remove('active');
    }
    function showRealTextarea() {
      if (isRealTextarea) return;
      isRealTextarea = true;
      document.getElementById('feedback-step').innerHTML =
        `<textarea class="real-textarea" id="feedback-text" maxlength="200" autofocus></textarea>`;
      setTimeout(() => {
        let ta = document.getElementById('feedback-text');
        ta.focus();
        ta.addEventListener('input', function(){
          if(this.value.length > 200) this.value = this.value.substr(0,200);
        });
      }, 20);
    }
    function sendFeedbackMsg() {
      let msg = "";
      if (isRealTextarea) {
        let ta = document.getElementById('feedback-text');
        msg = ta.value.trim();
      } else return;
      const errorDiv = document.getElementById('modal-feedback-error');
      const successDiv = document.getElementById('modal-feedback-success');
      errorDiv.innerText = ""; successDiv.innerText = "";
      if (msg.length < 5) {
        errorDiv.innerText = "Напишите хотя бы пару слов!";
        return;
      }
      document.getElementById('send-feedback-btn').disabled = true;
      successDiv.innerText = "Спасибо! (Отправка реализуется на сервере)";
      setTimeout(closeFeedbackModal, 2100);
      document.getElementById('send-feedback-btn').disabled = false;
    }

    // ----- OFFLINE/ONLINE --- ШАГ 2
    function getAudioSize(idx) {
      // Используем значение из config.tracks[i].size, если нет — по дефолту 4.7 МБ
      return config.tracks[idx].size || 4.7;
    }
    function getDownloadStats() {
      let liked = getLiked();
      let allCount = config.tracks.length;
      let likedCount = liked.length;
      let allMb = 0, likeMb = 0;
      for(let i=0; i<allCount; ++i) {
        allMb += getAudioSize(i);
        if(liked.indexOf(i)!==-1) likeMb += getAudioSize(i);
      }
      return {
        allSizeMb: Math.round(allMb * 10) / 10,
        likedSizeMb: Math.round(likeMb * 10) / 10,
        likedCount, allCount
      };
    }

    function offlineUIClick() {
      if(offlineDownloading) return;
      if(!offlineMode) {
        document.getElementById('modal-offline').classList.add('active');
        document.getElementById('offline-step').innerHTML = `
          <div style="font-size:1.09em;font-weight:700;margin-bottom:10px;">Оффлайн-режим</div>
          <div style="margin-bottom:16px;">
            Для работы без интернета нужно скачать музыку на устройство.<br>
            Это займёт <b>место</b> и время.<br>
            <div style="color:#e80100;margin:5px 0 0 0;">
            ⚠ На некоторых устройствах (iOS Safari, старые телефоны) размер может быть ограничен (~50-150 МБ).
            </div>
            <div style="margin:8px 0 0 0;opacity:.7;">После скачивания вы сможете слушать только OFFLINE-файлы без интернет-соединения.</div>
          </div>
          <button class="offline-btn online" style="width:99%;margin-bottom:7px;" onclick="nextOfflineChoice()">Согласен</button>
          <button class="offline-btn" style="width:99%;" onclick="closeOfflineModal()">Отмена</button>
        `;
      } else {
        document.getElementById('modal-offline').classList.add('active');
        document.getElementById('offline-step').innerHTML = `
          <div style="font-size:1.10em;font-weight:700;margin-bottom:15px;">Вернуться в ONLINE?</div>
          <div style="margin-bottom:20px;">
            Все скачанные файлы будут удалены.<br>
            Очищается место на устройстве.<br>
            Песни снова будут доступны только через интернет.
          </div>
          <button class="offline-btn online" style="width:99%;" onclick="confirmGoOnline()">Удалить файлы и возврат ONLINE</button>
          <button class="offline-btn" style="width:99%;margin-top:7px;" onclick="closeOfflineModal()">Отмена</button>
        `;
      }
    }
    function closeOfflineModal() {
      document.getElementById('modal-offline').classList.remove('active');
    }
    function nextOfflineChoice() {
      let d = getDownloadStats();
      document.getElementById('offline-step').innerHTML = `
        <div style="font-size:1.10em;font-weight:700;margin-bottom:13px;">Что скачать?</div>
        <div style="text-align:left;">
          <label style="display:block;margin:8px 0;">
            <input type="radio" name="offline-mode" value="all" checked> 
            Весь диск (${d.allCount} песен, ${d.allSizeMb} МБ)
          </label>
          <label style="display:block;margin:8px 0;">
            <input type="radio" name="offline-mode" value="liked"> 
            Только понравившиеся 
            (${d.likedCount||0} песен, ${d.likedSizeMb||0} МБ)
          </label>
        </div>
        <button class="offline-btn online" style="width:99%;margin-top:12px;" onclick="startOfflineDownload()">Скачать выбранное</button>
        <button class="offline-btn" style="width:99%;margin-top:8px;" onclick="closeOfflineModal()">Отмена</button>
      `;
    }
    // ---- КЕШ
    function getAllAssetsForOffline(mode){
      let all = [];
      all.push('index.html','config.json','img/logo.png','img/star.png','img/star2.png','Cover.png','Cover01.png','Cover02.png','Cover03.png');
      let liked = getLiked();
      for(let i=0; i<config.tracks.length; ++i) {
        if(mode==='all' || liked.indexOf(i)!==-1) {
          all.push(config.tracks[i].audio);
          all.push(config.tracks[i].lyrics);
        }
      }
      return [...new Set(all)];
    }

    function startOfflineDownload() {
      offlineDownloading = true;
      closeOfflineModal();
      setOfflineUIState('downloading');
      let mode = document.querySelector('input[name="offline-mode"]:checked').value;
      let files = getAllAssetsForOffline(mode);
      navigator.serviceWorker.ready.then(sw => {
        sw.active.postMessage({type: 'CACHE_FILES', files});
        let stats = getDownloadStats();
        let needMb = (mode=='all'?stats.allSizeMb:stats.likedSizeMb);
        let max = 100;
        let progress = 0;
        let stepTime = Math.max(75, 220-needMb*2);
        let iv = setInterval(()=>{
          progress += Math.max(2, Math.round(needMb/12));
          if(progress>=max) {
            clearInterval(iv);
            offlineDownloading=false;
            offlineMode=true;
            setOfflineUIState('offline');
            offlineShowDone(needMb,mode);
          } else {
            setOfflineUIState('downloading',progress/max,needMb);
          }
        }, stepTime);
      });
    }
    function setOfflineUIState(state, progress, needMb) {
      let btn = document.getElementById('offline-btn');
      if(state==='downloading') {
        btn.disabled = true;
        btn.className = 'offline-btn offline';
        btn.innerHTML = 'OFFLINE';
        if(!document.getElementById('offline-progr-div')) {
          let div = document.createElement('div');
          div.id = 'offline-progr-div';
          div.innerHTML = `
            <div class="offline-progress">
              <div class="offline-progress-bar" id="offline-progress-bar" style="width:0%;"></div>
            </div>
            <div class="offline-desc" id="offline-desc"></div>
          `;
          btn.parentElement.insertBefore(div, btn.nextSibling);
        }
        document.getElementById('offline-progress-bar').style.width = Math.round((progress||0)*100)+'%';
        document.getElementById('offline-desc').innerText = "Загружается приблизительно "+(needMb||0)+" МБ ...";
      }
      if(state==='offline') {
        btn.disabled = false;
        btn.className = 'offline-btn offline';
        btn.innerHTML = 'OFFLINE';
        let div = document.getElementById('offline-progr-div');
        if(div) div.remove();
      }
      if(state==='online') {
        btn.disabled = false;
        btn.className = 'offline-btn online';
        btn.innerHTML = 'ONLINE';
        let div = document.getElementById('offline-progr-div');
        if(div) div.remove();
      }
    }
    function offlineShowDone(mb,mode) {
      document.getElementById('modal-offline').classList.add('active');
      document.getElementById('offline-step').innerHTML = `
        <div style="font-size:1.18em;font-weight:700;margin-bottom:12px;">Все файлы скачаны!</div>
        <div style="margin-bottom:13px;">
          <b>${mode=="all"?"Весь диск":"Понравившиеся треки"}</b><br>
          Доступны без интернета.<br>
          Загружено примерно <b>${mb} МБ</b>.<br>
          <div style="color:#888;font-size:.98em;margin:5px 0 0 0;">
          Обратите внимание: если кеш браузера<br>будет очищен — нужно будет скачать заново!
          </div>
        </div>
        <button class="offline-btn" style="width:99%;" onclick="closeOfflineModal()">OK</button>
      `;
    }
    function confirmGoOnline() {
      offlineMode = false;
      setOfflineUIState('online');
      closeOfflineModal();
      navigator.serviceWorker.ready.then(sw => {
        sw.active.postMessage({type: 'CLEAR_CACHE'});
      });
    }
  </script>
</body>
</html>
