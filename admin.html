<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>VR Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:#0f1218;color:#e8eefc;margin:0}
    header{padding:12px 16px;background:#171d29;border-bottom:1px solid #2b3955;display:flex;align-items:center;gap:10px}
    h1{font-size:16px;margin:0;color:#9fc3ff}
    .tabs{display:flex;gap:8px;margin-left:auto}
    .tab{border:1px solid #2b3955;background:#1a2131;color:#cfe3ff;padding:6px 10px;border-radius:999px;cursor:pointer}
    .tab.active{background:#4daaff;color:#fff;border-color:#4daaff}
    main{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px;align-items:start}
    .card{background:#171d29;border:1px solid #2b3955;border-radius:10px;padding:10px}
    .row{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.07)}
    .row:last-child{border-bottom:none}
    .muted{color:#9aa8c4}
    .btn{border:none;border-radius:8px;background:#2a3550;color:#e8eefc;padding:6px 10px;cursor:pointer}
    .btn.primary{background:#E80100}
    .btn.warn{background:#8a2a2a}
    .btn.ok{background:#27b34c}
    input,textarea,select{background:#111826;color:#e8eefc;border:1px solid #2b3955;border-radius:8px;padding:7px}
    .list{max-height:70vh;overflow:auto}
    .pill{font-size:.9em;border:1px solid #2b3955;background:#1e2638;border-radius:999px;padding:2px 8px;color:#cfe3ff}
    .pill.status-pending   { background:#3a2c14; border-color:#6b4b14; color:#ffb84d; }
    .pill.status-approved  { background:#1f3a29; border-color:#2f7a4e; color:#6df59a; }
    .pill.status-shipped   { background:#1f3a29; border-color:#2f7a4e; color:#6df59a; }
    .pill.status-delivered { background:#1f3a29; border-color:#2f7a4e; color:#6df59a; }
    .pill.status-rejected  { background:#3a1f1f; border-color:#7a2f2f; color:#ff9b9b; }
    .flex{display:flex;gap:8px;align-items:center}
    .w100{width:100%}
    .split{display:grid;grid-template-columns:300px 1fr;gap:12px}
    .msg{padding:8px 10px;border-radius:10px;margin:6px 0;max-width:88%}
    .msg.user{background:#20283a}
    .msg.admin{background:#203020;margin-left:auto}
    .login-modal{position:fixed;inset:0;background:#0008;display:flex;align-items:center;justify-content:center}
    .login-box{background:#171d29;border:1px solid #2b3955;border-radius:12px;padding:16px;min-width:280px}
    .footer{padding:10px;text-align:center;color:#9aa8c4}
    .search{display:flex;gap:8px;margin-bottom:8px}
    /* простые бары для графиков в статистике */
    .chart-row{display:grid;grid-template-columns:34px 1fr 40px;gap:8px;align-items:center;margin:2px 0}
    .chart-row .bar{background:#101522;border:1px solid #2b3955;border-radius:6px;height:10px;overflow:hidden}
    .chart-row .fill{background:#4daaff;height:100%}
  </style>
</head>
<body>
  <header>
    <h1>VR Admin</h1>
    <div class="tabs">
      <button class="tab active" id="tab-claims">Заявки</button>
      <button class="tab" id="tab-devices">Устройства</button>
      <button class="tab" id="tab-backups">Бэкапы</button>
      <button class="tab" id="tab-logs">Логи</button>
      <button class="tab" id="tab-stats">Статистика</button>
      <button class="tab" id="tab-fb">Обратная связь</button>
      <button class="tab" id="tab-prizes">Призы</button>
      <button class="tab" id="tab-logout" title="Выйти">Logout</button>
    </div>
  </header>

  <!-- Заявки -->
  <main id="view-claims">
    <div class="card">
      <div class="search" style="flex-wrap:wrap">
        <select id="claims-status" title="Статус">
          <option value="">Все статусы</option>
          <option value="pending">pending</option>
          <option value="approved">approved</option>
          <option value="rejected">rejected</option>
          <option value="shipped">shipped</option>
          <option value="delivered">delivered</option>
        </select>
        <label class="muted">с</label>
        <input type="date" id="claims-from" />
        <label class="muted">по</label>
        <input type="date" id="claims-to" />
        <button class="btn" onclick="resetPaging();loadClaims()">Применить</button>
        <button class="btn" onclick="exportClaimsCSV()">Экспорт CSV</button>
        <div style="margin-left:auto;display:flex;gap:6px;align-items:center;">
          <button class="btn" onclick="prevPage()">◀</button>
          <span class="muted" id="claims-page-label">1</span>
          <button class="btn" onclick="nextPage()">▶</button>
        </div>
      </div>
      <div class="list" id="claims-list"></div>
    </div>
    <div class="card">
      <div class="muted">Клик по заявке слева — для действий</div>
      <div id="claim-details" class="muted" style="margin-top:8px;">Ничего не выбрано</div>
      <div style="margin-top:10px;display:none" id="claim-actions">
        <div id="claim-meta" class="muted" style="margin-bottom:8px;"></div>

        <div class="flex"><label class="muted">Причина (для rejected):</label><input class="w100" id="claim-reason" placeholder="Причина..."></div>
        <div style="margin-top:8px;" class="flex">
          <button class="btn ok" onclick="updateClaim('approved')">Одобрить</button>
          <button class="btn warn" onclick="updateClaim('rejected')">Отклонить</button>
          <button class="btn" onclick="updateClaim('pending')">Вернуть в pending</button>
        </div>

        <hr style="border-color:#2b3955;margin:10px 0;">

        <div class="flex">
          <input class="w100" id="claim-tracking" placeholder="Трек‑номер (для shipped)">
          <button class="btn" onclick="setTracking()">Отправлено</button>
          <button class="btn" onclick="markDelivered()">Получено</button>
        </div>

        <hr style="border-color:#2b3955;margin:10px 0;">

        <div class="flex">
          <label class="muted" style="min-width:90px;">Цвет:</label>
          <select id="adm-color">
            <option value="">—</option>
            <option value="orange">оранжевый (ждёт)</option>
            <option value="green">зелёный (ок)</option>
            <option value="red">красный</option>
            <option value="violet">фиолетовый (напоминание)</option>
          </select>
        </div>
        <div class="flex" style="margin-top:6px;">
          <label class="muted" style="min-width:90px;">Метки:</label>
          <input class="w100" id="adm-tags" placeholder="через запятую">
        </div>
        <div class="flex" style="margin-top:6px;">
          <label class="muted" style="min-width:90px;">Напоминание:</label>
          <input type="datetime-local" id="adm-due">
        </div>
        <div class="flex" style="margin-top:6px;">
          <textarea id="adm-note" class="w100" placeholder="Заметка администратора"></textarea>
        </div>
        <div class="flex" style="margin-top:6px;">
          <button class="btn" onclick="saveClaimMeta()">Сохранить мета</button>
          <button class="btn warn" onclick="deleteClaim()">Удалить заявку</button>
        </div>

        <hr style="border-color:#2b3955;margin:10px 0;">

        <div class="muted">История</div>
        <div class="list" id="claim-events" style="max-height:240px;"></div>
      </div>
    </div>
  </main>

  <!-- Устройства -->
  <main id="view-devices" style="display:none">
    <div class="card">
      <div class="search">
        <input id="dev-q" placeholder="Поиск device_hash / имя / tg_id..." class="w100">
        <button class="btn" onclick="loadDevices()">Искать</button>
      </div>
      <div class="list" id="devices-list"></div>
    </div>
    <div class="card">
      <div class="muted">Клик по устройству слева — для копирования device_hash</div>
      <div id="devices-details" class="muted" style="margin-top:8px;">—</div>
    </div>
  </main>

  <!-- Бэкапы -->
  <main id="view-backups" style="display:none">
    <div class="card">
      <div class="search">
        <button class="btn" onclick="loadBackups()">Обновить</button>
      </div>
      <div class="list" id="backups-list"></div>
    </div>
    <div class="card">
      <div class="muted">Просмотр бэкапа (read‑only)</div>
      <pre id="backup-viewer" style="max-height:70vh; overflow:auto; background:#0f1218; border:1px solid #2b3955; border-radius:10px; padding:10px; color:#cfe3ff;"></pre>
    </div>
  </main>

  <!-- Логи -->
  <main id="view-logs" style="display:none">
    <div class="card">
      <div class="search" style="flex-wrap:wrap; gap:8px;">
        <select id="logs-type" title="Тип">
          <option value="">Все типы</option>
          <option value="claim_create">claim_create</option>
          <option value="claim_update">claim_update</option>
          <option value="claim_shipped">claim_shipped</option>
          <option value="claim_delivered">claim_delivered</option>
          <option value="claim_cancel">claim_cancel</option>
          <option value="feedback">feedback</option>
          <option value="tg_link">tg_link</option>
          <option value="backup_save">backup_save</option>
          <option value="backup_user_latest">backup_user_latest</option>
        </select>
        <label class="muted">с</label>
        <input type="datetime-local" id="logs-from">
        <label class="muted">по</label>
        <input type="datetime-local" id="logs-to">
        <input id="logs-pkey" placeholder="payload ключ (a.b.c)" style="min-width:180px;">
        <select id="logs-pop" title="Оператор">
          <option value="contains">contains</option>
          <option value="eq">=</option>
          <option value="ne">≠</option>
          <option value="gt">&gt;</option>
          <option value="lt">&lt;</option>
          <option value="ge">≥</option>
          <option value="le">≤</option>
        </select>
        <input id="logs-pval" placeholder="значение" style="min-width:140px;">
        <button class="btn" onclick="loadLogs()">Применить</button>
        <button class="btn" onclick="exportLogs('csv')">Экспорт CSV</button>
        <button class="btn" onclick="exportLogs('ndjson')">Экспорт NDJSON</button>
        <button class="btn warn" onclick="deleteSelectedLogs()">Удалить выбранные</button>
      </div>
      <div class="list" id="logs-list"></div>
    </div>
    <div class="card">
      <div class="muted">Детали лога</div>
      <pre id="log-details" style="max-height:70vh; overflow:auto; background:#0f1218; border:1px solid #2b3955; border-radius:10px; padding:10px; color:#cfe3ff;"></pre>
    </div>
  </main>

  <!-- Статистика -->
  <main id="view-stats" style="display:none">
    <div class="card">
      <div class="search">
        <button class="btn" onclick="loadMetrics()">Обновить</button>
      </div>
      <div id="metrics-box" class="list"></div>

      <div class="card" style="margin-top:8px;">
        <div style="font-weight:700;margin-bottom:8px;">Глобальная статистика — управление</div>
        <div class="row">
          <div>Общий выключатель</div>
          <div><label class="muted">masterEnabled</label> <input type="checkbox" id="gs-master"></div>
        </div>
        <div class="row">
          <div>Отправка с клиентов (/event)</div>
          <div><label class="muted">sendEnabled</label> <input type="checkbox" id="gs-send"></div>
        </div>
        <div class="row">
          <div>Показывать UI в приложении</div>
          <div><label class="muted">showUI</label> <input type="checkbox" id="gs-ui"></div>
        </div>
        <div class="row">
          <div>Требовать Turnstile</div>
          <div><label class="muted">requireTurnstile</label> <input type="checkbox" id="gs-ts"></div>
        </div>
        <div class="row">
          <div>Включить монитор в админке</div>
          <div><label class="muted">monitorEnabled</label> <input type="checkbox" id="gs-mon"></div>
        </div>
        <div class="row">
          <div>Собирать очередь клиентов</div>
          <div><label class="muted">collectClientQueue</label> <input type="checkbox" id="gs-cq"></div>
        </div>
        <div class="flex" style="margin-top:8px;">
          <button class="btn ok" onclick="saveGsConfig()">Сохранить</button>
          <button class="btn" onclick="loadGsConfig()">Обновить</button>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="muted">Дополнительно</div>
      <div class="muted">Здесь можно будет добавить графики/гео после подключения соответствующих источников.</div>
      <div class="card" style="margin-top:8px;">
        <div style="font-weight:700;margin-bottom:6px;">Распределение (по часам/по дням) — рендерится в приложении у пользователей; в админке пока только сводка по цифрам</div>
        <div id="stats-note" class="muted">Данные берутся из /top?period=all|today|week|month</div>
      </div>
    </div>
      <div class="card" id="gs-health-card" style="margin-top:8px; display:none;">
        <div style="font-weight:700;margin-bottom:8px;">Монитор /event (последние 5 минут)</div>
        <div class="row"><div>OK</div><div class="muted" id="m-ok">0</div></div>
        <div class="row"><div>403 (Turnstile)</div><div class="muted" id="m-403">0</div></div>
        <div class="row"><div>429 (Rate limit)</div><div class="muted" id="m-429">0</div></div>
        <div class="row"><div>Иные отказы</div><div class="muted" id="m-other">0</div></div>
        <div class="row"><div>Очередь клиентов (avg / max)</div><div class="muted"><span id="m-q-avg">0</span> / <span id="m-q-max">0</span></div></div>
        <div class="flex" style="margin-top:8px;">
          <button class="btn" onclick="loadGsHealth()">Обновить</button>
        </div>
      </div>
  </main>

  <!-- Обратная связь -->
  <main id="view-fb" style="display:none">
    <div class="card">
      <div class="search">
        <input id="fb-q" placeholder="Поиск кода/устройства..." class="w100">
        <button class="btn" onclick="loadThreads()">Искать</button>
      </div>
      <div class="list" id="thread-list"></div>
    </div>
    <div class="card">
      <div id="thread-head" class="muted">Выберите тред слева</div>
      <div class="list" id="msg-list" style="height:50vh;"></div>
      <div class="flex" style="margin-top:8px;">
        <input id="fb-reply" class="w100" placeholder="Ответить...">
        <button class="btn primary" onclick="sendReply()">Отправить</button>
      </div>
    </div>
  </main>

  <!-- Призы -->
  <main id="view-prizes" style="display:none">
    <div class="card">
      <div class="search">
        <button class="btn" onclick="loadPrizesAdmin()">Обновить</button>
      </div>
      <div class="list" id="adm-prizes-list"></div>
    </div>
    <div class="card">
      <div style="font-weight:700;margin-bottom:8px;">Редактор</div>
      <div class="flex" style="flex-direction:column;gap:6px;">
        <input id="adm-prize-id" placeholder="ID (пусто для нового)">
        <input id="adm-prize-title" placeholder="Название">
        <input id="adm-prize-short" placeholder="Коротко">
        <textarea id="adm-prize-long" class="w100" placeholder="Описание"></textarea>
        <input id="adm-prize-img" placeholder="URL картинки (img/...)">
        <div class="flex">
          <button class="btn ok" onclick="savePrize()">Сохранить</button>
          <button class="btn warn" onclick="deletePrize()">Удалить</button>
        </div>
      </div>
    </div>
  </main>

  <div class="footer">v1 • Basic Auth • Работает только по HTTPS</div>

  <div id="login" class="login-modal" style="display:none;">
    <div class="login-box">
      <div style="font-weight:700;margin-bottom:8px;">Вход администратора</div>
      <div class="flex" style="flex-direction:column;gap:6px;">
        <input id="adm-user" placeholder="Логин">
        <input id="adm-pass" placeholder="Пароль" type="password">
        <button class="btn primary" onclick="adminLogin()">Войти</button>
      </div>
      <div id="login-err" class="muted" style="margin-top:8px;color:#ffb3b3;"></div>
    </div>
  </div>

<script>
const API = 'https://vr-backend.apel-s-in.workers.dev';
const authKey = 'vr_admin_auth';

function authHeader() {
  const tok = sessionStorage.getItem(authKey);
  return tok ? { 'Authorization': tok } : {};
}

// Показываем/прячем интерфейс
function guardApp() {
  const authed = !!sessionStorage.getItem(authKey);
  document.querySelectorAll('header, main, .footer').forEach(el => {
    if (!el) return;
    el.style.display = authed ? '' : 'none';
  });
  const login = document.getElementById('login');
  if (login) login.style.display = authed ? 'none' : '';
  return authed;
}
function needLogin(show = true) {
  const has = !!sessionStorage.getItem(authKey);
  if (!has && show) guardApp();
  return !has;
}
function adminLogin() {
  const u = document.getElementById('adm-user').value.trim();
  const p = document.getElementById('adm-pass').value.trim();
  if (!u || !p) {
    document.getElementById('login-err').textContent = 'Введите логин и пароль';
    return;
  }
  const token = 'Basic ' + btoa(u + ':' + p);
  sessionStorage.setItem(authKey, token);
  if (guardApp()) loadClaims();
}
document.addEventListener('keydown', (e) => {
  const loginShown = document.getElementById('login')?.style.display !== 'none';
  if (!loginShown) return;
  if (e.key === 'Enter') adminLogin();
});

function switchTab(tab) {
  const tabs = ['claims','devices','backups','logs','stats','fb','prizes'];
  tabs.forEach(t => document.getElementById('tab-'+t)?.classList.toggle('active', tab===t));
  tabs.forEach(t => document.getElementById('view-'+t)?.style && (document.getElementById('view-'+t).style.display = (tab===t)?'':'none'));
  if (tab==='prizes') loadPrizesAdmin();
  if (tab==='devices') loadDevices();
  if (tab==='backups') loadBackups();
  if (tab==='logs') loadLogs();
  if (tab==='stats') { loadMetrics(); loadGsConfig(); }
}
document.getElementById('tab-claims').onclick = ()=>switchTab('claims');
document.getElementById('tab-devices').onclick = ()=>switchTab('devices');
document.getElementById('tab-backups').onclick = ()=>switchTab('backups');
document.getElementById('tab-logs').onclick = ()=>switchTab('logs');
document.getElementById('tab-stats').onclick = ()=>switchTab('stats');
document.getElementById('tab-fb').onclick = ()=>switchTab('fb');
document.getElementById('tab-prizes').onclick = ()=>switchTab('prizes');
document.getElementById('tab-logout').onclick = ()=>{ sessionStorage.removeItem(authKey); guardApp(); needLogin(true); };

// ===== Заявки =====
let currentClaim = null;
let pageSize = 50;
let currentOffset = 0;

function resetPaging() { currentOffset = 0; document.getElementById('claims-page-label').textContent = '1'; }
function nextPage() { currentOffset += pageSize; loadClaims(); }
function prevPage() {
  currentOffset = Math.max(0, currentOffset - pageSize);
  const curPage = Math.floor(currentOffset / pageSize) + 1;
  document.getElementById('claims-page-label').textContent = String(curPage);
  loadClaims();
}
function readDateInput(id) {
  const v = document.getElementById(id)?.value;
  if (!v) return null;
  try {
    const dt = new Date(v);
    if (id === 'claims-to') dt.setHours(23,59,59,999);
    return dt.toISOString();
  } catch { return null; }
}
async function loadClaims() {
  if (needLogin()) return;
  const st  = document.getElementById('claims-status').value;
  const from= readDateInput('claims-from');
  const to  = readDateInput('claims-to');

  const url = new URL(API + '/admin/claims');
  if (st) url.searchParams.set('status', st);
  if (from) url.searchParams.set('from', from);
  if (to) url.searchParams.set('to', to);
  url.searchParams.set('limit', String(pageSize));
  url.searchParams.set('offset', String(currentOffset));

  const res = await fetch(url, { headers: { ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const list = document.getElementById('claims-list');
  if (!data?.ok) { list.textContent = 'Ошибка загрузки'; return; }

  const items = data.items || [];
  const curPage = Math.floor(currentOffset / pageSize) + 1;
  document.getElementById('claims-page-label').textContent = String(curPage);

  list.innerHTML = items.map(c=>{
    const dt = new Date(c.created_at).toLocaleString();
    const stClass = `status-${c.status}`;
    const tg = c.tg_id ? ` · tg:${String(c.tg_id).slice(0,8)}…` : '';
    return `<div class="row" onclick="selectClaim('${c.id}')">
      <div>
        <div><span class="pill ${stClass}">${c.status}</span> <b>${escapeHtml(c.user_name||'Пользователь')}</b></div>
        <div class="muted">#${c.id.slice(0,8)} · dev:${(c.device_hash||'').slice(0,8)}${tg} · lvl:${c.level} · cyc:${c.cycle}</div>
      </div>
      <div class="muted">${dt}</div>
    </div>`;
  }).join('');

  if (items.length === 0 && currentOffset > 0) prevPage();

  document.getElementById('claim-details').textContent = 'Ничего не выбрано';
  document.getElementById('claim-actions').style.display = 'none';
  currentClaim = null;
}
async function selectClaim(id) {
  const el = document.getElementById('claim-details');
  el.innerHTML = `Заявка <b>#${id}</b><br><span class="muted">Статус меняется кнопками ниже</span>`;
  currentClaim = id;
  document.getElementById('claim-actions').style.display = '';
  loadClaimMeta();
  loadClaimEvents();
}
async function loadClaimMeta() {
  if (!currentClaim) return;
  const metaBox = document.getElementById('claim-meta');
  try {
    const url = new URL(API + '/admin/claim/meta/get');
    url.searchParams.set('id', currentClaim);
    const res = await fetch(url, { headers:{ ...authHeader() }});
    if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
    const data = await res.json().catch(()=> ({}));
    if (!res.ok || !data?.ok) { metaBox.textContent = 'Мета недоступна'; return; }
    const m = data.meta || {};
    document.getElementById('adm-color').value = m.color || '';
    document.getElementById('adm-tags').value = (Array.isArray(m.tags) ? m.tags.join(', ') : '');
    document.getElementById('adm-note').value = m.note || '';
    if (m.dueAt) {
      const dt = new Date(m.dueAt);
      const iso = dt.toISOString().slice(0,16);
      document.getElementById('adm-due').value = iso;
    } else document.getElementById('adm-due').value = '';
    metaBox.innerHTML = `dev/tg и прочие данные в списке слева · <span class="muted">модиф.: ${m.updatedAt?new Date(m.updatedAt).toLocaleString():'—'}</span>`;
  } catch {
    if (metaBox) metaBox.textContent = 'Ошибка загрузки мета';
  }
}
async function saveClaimMeta() {
  if (needLogin()) return;
  if (!currentClaim) return;
  const color = document.getElementById('adm-color').value;
  const tags = (document.getElementById('adm-tags').value || '').split(',').map(s=>s.trim()).filter(Boolean);
  const note = document.getElementById('adm-note').value || '';
  const dueStr = document.getElementById('adm-due').value;
  let dueAt = null; try { if (dueStr) dueAt = new Date(dueStr).getTime(); } catch(e){}
  const res = await fetch(API + '/admin/claim/meta/set', {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ id: currentClaim, color, tags, note, dueAt })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Мета не сохранена: '+(data?.error||res.status)); return; }
  alert('Мета сохранена'); loadClaimMeta();
}
async function loadClaimEvents() {
  if (!currentClaim) return;
  const box = document.getElementById('claim-events');
  try {
    const url = new URL(API + '/admin/claim/events');
    url.searchParams.set('id', currentClaim);
    const res = await fetch(url, { headers:{ ...authHeader() }});
    if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
    const data = await res.json().catch(()=> ({}));
    if (!res.ok || !data?.ok) { box.textContent = 'История недоступна'; return; }
    const items = data.items || [];
    if (!items.length) { box.textContent = 'Пусто'; return; }
    box.innerHTML = items.map(ev=>{
      const dt = new Date(ev.at).toLocaleString();
      return `<div class="row"><div><b>${ev.type}</b></div><div class="muted">${dt}</div></div>`;
    }).join('');
  } catch { box.textContent = 'Ошибка истории'; }
}
async function deleteClaim() {
  if (!currentClaim) return;
  if (!confirm('Удалить эту заявку без возможности восстановления?')) return;
  const res = await fetch(API + '/admin/claim/delete', {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() }, body: JSON.stringify({ id: currentClaim })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Не удалось удалить: '+(data?.error||res.status)); return; }
  alert('Удалено'); currentClaim = null; document.getElementById('claim-actions').style.display = 'none'; loadClaims();
}
async function updateClaim(next) {
  if (!currentClaim) return;
  const reason = document.getElementById('claim-reason').value.trim();
  const res = await fetch(API+'/admin/claim/update', {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ id: currentClaim, status: next, reason: (next==='rejected'?reason:null) })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Ошибка: '+(data?.error||res.status)); return; }
  alert('Готово: '+next); loadClaims();
}
async function setTracking() {
  if (!currentClaim) return;
  const tracking = document.getElementById('claim-tracking').value.trim();
  if (!tracking) { alert('Введите трек‑номер'); return; }
  const res = await fetch(API+'/admin/claim/tracking', {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ id: currentClaim, tracking })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Ошибка: '+(data?.error||res.status)); return; }
  alert('Статус: shipped, трек установлен'); loadClaims();
}
async function markDelivered() {
  if (!currentClaim) return;
  const res = await fetch(API+'/admin/claim/delivered', {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ id: currentClaim })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Ошибка: '+(data?.error||res.status)); return; }
  alert('Статус: delivered'); loadClaims();
}
async function exportClaimsCSV() {
  if (needLogin()) return;
  const st  = document.getElementById('claims-status').value;
  const from= readDateInput('claims-from');
  const to  = readDateInput('claims-to');

  const url = new URL(API + '/admin/claims/export');
  if (st) url.searchParams.set('status', st);
  if (from) url.searchParams.set('from', from);
  if (to) url.searchParams.set('to', to);

  const res = await fetch(url, { headers: { ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const blob = await res.blob();
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `claims-${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
}

// ===== Feedback =====
let currentThread = null;
async function loadThreads() {
  if (needLogin()) return;
  const q = document.getElementById('fb-q').value.trim();
  const url = new URL(API + '/admin/feedback/threads');
  if (q) url.searchParams.set('q', q);
  url.searchParams.set('limit','100');
  const res = await fetch(url, { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const list = document.getElementById('thread-list');
  if (!data?.ok) { list.textContent = 'Ошибка'; return; }
  list.innerHTML = (data.items||[]).map(t=>{
    const dt = new Date(t.last_message_at).toLocaleString();
    const st = t.status || 'open';
    return `<div class="row" onclick="openThread('${t.id}','${t.code}','${st}')">
      <div>
        <div><b>#${t.code}</b> · ${t.user_name||'Пользователь'} · <span class="pill">${st}</span></div>
        <div class="muted">dev:${(t.device_hash||'').slice(0,8)} · ${new Date(t.created_at).toLocaleDateString()}</div>
      </div>
      <div class="muted">${dt}</div>
    </div>`;
  }).join('');
  document.getElementById('thread-head').textContent = 'Выберите тред слева';
  document.getElementById('msg-list').innerHTML = '';
  currentThread = null;
}
async function openThread(id, code, status='open') {
  currentThread = { id, code, status };
  const head = document.getElementById('thread-head');
  head.innerHTML = `Диалог <b>#${code}</b> · <span class="pill">${status}</span>
    <button class="btn" style="margin-left:8px" onclick="toggleThreadStatus()">${status==='closed'?'Открыть':'Закрыть'}</button>`;
  await loadMessages();
}
async function toggleThreadStatus() {
  if (!currentThread) return;
  const next = currentThread.status === 'closed' ? 'open' : 'closed';
  const res = await fetch(API + '/admin/feedback/close', {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ threadId: currentThread.id, status: next })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Ошибка: '+(data?.error||res.status)); return; }
  currentThread.status = next; openThread(currentThread.id, currentThread.code, currentThread.status);
}
async function loadMessages() {
  if (!currentThread) return;
  const url = new URL(API + '/admin/feedback/messages');
  url.searchParams.set('thread', currentThread.id);
  const res = await fetch(url, { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const list = document.getElementById('msg-list');
  if (!data?.ok) { list.textContent = 'Ошибка'; return; }
  list.innerHTML = (data.items||[]).map(m=>{
    const dt = new Date(m.created_at).toLocaleString();
    const cls = m.sender==='admin'?'msg admin':'msg user';
    return `<div class="${cls}"><div>${escapeHtml(m.text)}</div><div class="muted" style="font-size:.8em;margin-top:4px">${dt}</div></div>`;
  }).join('');
  list.scrollTop = list.scrollHeight;
}
async function sendReply() {
  const inp = document.getElementById('fb-reply');
  const text = (inp.value||'').trim();
  if (!text || !currentThread) return;
  const res = await fetch(API+'/admin/feedback/reply', {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ threadId: currentThread.id, text })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Не отправлено: '+(data?.error||res.status)); return; }
  inp.value = ''; loadMessages();
}

// ===== Устройства =====
async function loadDevices() {
  if (needLogin()) return;
  const q = document.getElementById('dev-q').value.trim();
  const url = new URL(API + '/admin/devices');
  if (q) url.searchParams.set('q', q);
  url.searchParams.set('limit', '100');
  const res = await fetch(url, { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const list = document.getElementById('devices-list');
  if (!data?.ok) { list.textContent = 'Ошибка'; return; }
  list.innerHTML = (data.items||[]).map(d=>{
    const dt1 = new Date(d.first_seen).toLocaleString();
    const dt2 = new Date(d.last_seen).toLocaleString();
    const claimStat = `T:${d.claims_total||0} • p:${d.claims_pending||0} • a:${d.claims_approved||0} • s:${d.claims_shipped||0} • d:${d.claims_delivered||0} • r:${d.claims_rejected||0}`;
    const user = `${escapeHtml(d.user_name||'—')} ${d.tg_id?('· tg:'+String(d.tg_id)) : ''}`;
    return `<div class="row" onclick="copyDeviceHash('${d.device_hash}')">
      <div>
        <div><b>dev:${escapeHtml(d.device_hash.slice(0,12))}…</b> · ${user}</div>
        <div class="muted">${dt1} → ${dt2}</div>
      </div>
      <div class="muted">${claimStat}</div>
    </div>`;
  }).join('');
  document.getElementById('devices-details').textContent = '—';
}
function copyDeviceHash(hash) {
  navigator.clipboard?.writeText(hash);
  const box = document.getElementById('devices-details');
  if (box) box.textContent = `Скопировано: ${hash}`;
}

// ===== Бэкапы =====
async function loadBackups() {
  if (needLogin()) return;
  const res = await fetch(API + '/admin/backups/list', { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const list = document.getElementById('backups-list');
  if (!data?.ok) { list.textContent = 'Ошибка'; return; }
  list.innerHTML = (data.items||[]).map(b=>{
    const when = b.exportedAt ? new Date(b.exportedAt).toLocaleString() : '—';
    return `<div class="row">
      <div>
        <div><b>dev:${escapeHtml((b.device||'').slice(0,12))}…</b></div>
        <div class="muted">${when}</div>
      </div>
      <div class="flex">
        <div class="muted" style="max-width:220px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(b.checksum||'')}</div>
        <button class="btn" onclick="viewBackup('${b.device}')">Открыть</button>
      </div>
    </div>`;
  }).join('');
  document.getElementById('backup-viewer').textContent = '';
}
async function viewBackup(device) {
  if (needLogin()) return;
  const url = new URL(API + '/admin/backup/get');
  url.searchParams.set('device', device);
  const res = await fetch(url, { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const pre = document.getElementById('backup-viewer');
  if (!data?.ok) { pre.textContent = 'Ошибка'; return; }
  pre.textContent = JSON.stringify(data.backup, null, 2);
}

// ===== Логи =====
let __selectedLogKeys = new Set();
function readDTLocal(id) {
  const v = document.getElementById(id)?.value;
  if (!v) return null;
  try { return new Date(v).toISOString(); } catch { return null; }
}
async function loadLogs() {
  if (needLogin()) return;
  __selectedLogKeys = new Set();
  const type = document.getElementById('logs-type').value;
  const from = readDTLocal('logs-from');
  const to   = readDTLocal('logs-to');
  const pkey = document.getElementById('logs-pkey').value.trim();
  const pop  = document.getElementById('logs-pop').value;
  const pval = document.getElementById('logs-pval').value.trim();

  const url = new URL(API + '/admin/logs');
  if (type) url.searchParams.set('type', type);
  if (from) url.searchParams.set('from', from);
  if (to) url.searchParams.set('to', to);
  if (pkey) url.searchParams.set('pkey', pkey);
  if (pop)  url.searchParams.set('pop', pop);
  if (pval) url.searchParams.set('pval', pval);
  url.searchParams.set('limit', '100');

  const res = await fetch(url, { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const list = document.getElementById('logs-list');
  if (!data?.ok) { list.textContent = 'Ошибка'; return; }

  list.innerHTML = (data.items||[]).map(l=>{
    const when = l.ts ? new Date(l.ts).toLocaleString() : '—';
    const payloadShort = escapeHtml(JSON.stringify(l.payload||{})).slice(0,120);
    return `<div class="row">
      <div onclick="selectLog('${l.key}')">
        <div><span class="pill">${escapeHtml(l.type||'log')}</span> <b>${when}</b></div>
        <div class="muted">${payloadShort}</div>
      </div>
      <div>
        <input type="checkbox" onchange="toggleLogKey('${l.key}', this.checked)">
      </div>
    </div>`;
  }).join('');
  document.getElementById('log-details').textContent = '';
}
function toggleLogKey(key, checked) {
  if (checked) __selectedLogKeys.add(key); else __selectedLogKeys.delete(key);
}
async function selectLog(key) {
  if (needLogin()) return;
  // перезагрузим текущий список (фильтры те же) и найдём запись
  const type = document.getElementById('logs-type').value;
  const from = readDTLocal('logs-from');
  const to   = readDTLocal('logs-to');
  const pkey = document.getElementById('logs-pkey').value.trim();
  const pop  = document.getElementById('logs-pop').value;
  const pval = document.getElementById('logs-pval').value.trim();
  const url = new URL(API + '/admin/logs');
  if (type) url.searchParams.set('type', type);
  if (from) url.searchParams.set('from', from);
  if (to) url.searchParams.set('to', to);
  if (pkey) url.searchParams.set('pkey', pkey);
  if (pop)  url.searchParams.set('pop', pop);
  if (pval) url.searchParams.set('pval', pval);
  url.searchParams.set('limit', '100');
  const resp = await fetch(url, { headers:{ ...authHeader() }});
  const data = await resp.json().catch(()=> ({}));
  const it = (data.items||[]).find(x => x.key === key);
  document.getElementById('log-details').textContent = it ? JSON.stringify(it, null, 2) : 'Не найден';
}
async function deleteSelectedLogs() {
  if (!__selectedLogKeys.size) { alert('Не выбрано ни одного лога'); return; }
  if (!confirm(`Удалить ${__selectedLogKeys.size} логов?`)) return;
  const res = await fetch(API + '/admin/logs/delete', {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ keys: Array.from(__selectedLogKeys) })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Ошибка удаления: ' + (data?.error||res.status)); return; }
  alert('Удалено'); loadLogs();
}
async function exportLogs(fmt) {
  if (needLogin()) return;
  const type = document.getElementById('logs-type').value;
  const from = readDTLocal('logs-from');
  const to   = readDTLocal('logs-to');
  const pkey = document.getElementById('logs-pkey').value.trim();
  const pop  = document.getElementById('logs-pop').value;
  const pval = document.getElementById('logs-pval').value.trim();

  const url = new URL(API + '/admin/logs/export');
  url.searchParams.set('format', fmt || 'csv');
  if (type) url.searchParams.set('type', type);
  if (from) url.searchParams.set('from', from);
  if (to)   url.searchParams.set('to', to);
  if (pkey) url.searchParams.set('pkey', pkey);
  if (pop)  url.searchParams.set('pop', pop);
  if (pval) url.searchParams.set('pval', pval);
  url.searchParams.set('limit', '20000');

  const res = await fetch(url, { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const blob = await res.blob();
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `logs-${new Date().toISOString().slice(0,19).replace(/[T:]/g,'-')}.${fmt==='ndjson'?'ndjson':'csv'}`;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
}

// ===== Сводная статистика =====
async function loadMetrics() {
  if (needLogin()) return;
  const res = await fetch(API + '/admin/metrics/summary', { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const box = document.getElementById('metrics-box');
  if (!data?.ok) { box.textContent = 'Ошибка'; return; }
  const byStatus = (data.claimsByStatus||[]).map(s=> `<div class="row"><div>${s.status}</div><div class="muted">${s.c}</div></div>`).join('');
  box.innerHTML = `
    <div class="row"><div>Пользователей</div><div class="muted">${data.users}</div></div>
    <div class="row"><div>Устройств</div><div class="muted">${data.devices}</div></div>
    <div class="row"><div>Заявок</div><div class="muted">${data.claims}</div></div>
    <div class="row"><div>Диалогов обратной связи</div><div class="muted">${data.feedback_threads}</div></div>
    <div class="row"><div>Сообщений</div><div class="muted">${data.feedback_messages}</div></div>
    <div class="row"><div><b>Заявки по статусам</b></div><div></div></div>
    ${byStatus || '<div class="muted">—</div>'}
  `;
}

// ===== GS Config (управление глобальной статистикой) =====
async function loadGsConfig() {
  if (needLogin()) return;
  const res = await fetch(API + '/admin/gs/config', { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Ошибка конфигурации'); return; }
  const c = data.config || {};
  document.getElementById('gs-master').checked = !!c.masterEnabled;
  document.getElementById('gs-send').checked = !!c.sendEnabled;
  document.getElementById('gs-ui').checked = !!c.showUI;
  document.getElementById('gs-ts').checked = !!c.requireTurnstile;
  document.getElementById('gs-mon').checked = !!c.monitorEnabled;
  document.getElementById('gs-cq').checked = !!c.collectClientQueue;

  // Показ/скрытие монитора
  const monCard = document.getElementById('gs-health-card');
  if (monCard) monCard.style.display = c.monitorEnabled ? '' : 'none';
  if (c.monitorEnabled) loadGsHealth();
}
async function saveGsConfig() {
  if (needLogin()) return;
  const body = {
    masterEnabled: document.getElementById('gs-master').checked,
    sendEnabled: document.getElementById('gs-send').checked,
    showUI: document.getElementById('gs-ui').checked,
    requireTurnstile: document.getElementById('gs-ts').checked,
    monitorEnabled: document.getElementById('gs-mon').checked,
    collectClientQueue: document.getElementById('gs-cq').checked
  };
  const res = await fetch(API + '/admin/gs/config', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify(body)
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Не сохранено'); return; }
  alert('Сохранено');
  loadGsConfig();
}
async function loadGsHealth() {
  if (needLogin()) return;
  const res = await fetch(API + '/admin/gs/health', { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const d = await res.json().catch(()=> ({}));
  if (!res.ok || !d?.ok) { alert('Монитор недоступен'); return; }
  document.getElementById('m-ok').textContent    = d.okCount || 0;
  document.getElementById('m-403').textContent   = d.denied403 || 0;
  document.getElementById('m-429').textContent   = d.rateLimited || 0;
  document.getElementById('m-other').textContent = d.otherDenied || 0;
  document.getElementById('m-q-avg').textContent = (d.queue?.avg ?? 0);
  document.getElementById('m-q-max').textContent = (d.queue?.max ?? 0);
}

function escapeHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

window.addEventListener('load', () => {
  if (needLogin(true)) return;
  guardApp();
  loadClaims();
});
</script>
</body>
</html>
