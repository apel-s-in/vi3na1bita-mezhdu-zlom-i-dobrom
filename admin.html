<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>VR Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:#0f1218;color:#e8eefc;margin:0}
    header{padding:12px 16px;background:#171d29;border-bottom:1px solid #2b3955;display:flex;align-items:center;gap:10px}
    h1{font-size:16px;margin:0;color:#9fc3ff}
    .tabs{display:flex;gap:8px;margin-left:auto}
    .tab{border:1px solid #2b3955;background:#1a2131;color:#cfe3ff;padding:6px 10px;border-radius:999px;cursor:pointer}
    .tab.active{background:#4daaff;color:#fff;border-color:#4daaff}
    main{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px;align-items:start}
    .card{background:#171d29;border:1px solid #2b3955;border-radius:10px;padding:10px}
    .row{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.07)}
    .row:last-child{border-bottom:none}
    .muted{color:#9aa8c4}
    .btn{border:none;border-radius:8px;background:#2a3550;color:#e8eefc;padding:6px 10px;cursor:pointer}
    .btn.primary{background:#E80100}
    .btn.warn{background:#8a2a2a}
    .btn.ok{background:#27b34c}
    input,textarea,select{background:#111826;color:#e8eefc;border:1px solid #2b3955;border-radius:8px;padding:7px}
    .list{max-height:70vh;overflow:auto}
    .pill{font-size:.9em;border:1px solid #2b3955;background:#1e2638;border-radius:999px;padding:2px 8px;color:#cfe3ff}
    .pill.status-pending   { background:#3a2c14; border-color:#6b4b14; color:#ffb84d; }
    .pill.status-approved  { background:#1f3a29; border-color:#2f7a4e; color:#6df59a; }
    .pill.status-shipped   { background:#1f3a29; border-color:#2f7a4e; color:#6df59a; }
    .pill.status-delivered { background:#1f3a29; border-color:#2f7a4e; color:#6df59a; }
    .pill.status-rejected  { background:#3a1f1f; border-color:#7a2f2f; color:#ff9b9b; }
    .flex{display:flex;gap:8px;align-items:center}
    .w100{width:100%}
    .split{display:grid;grid-template-columns:300px 1fr;gap:12px}
    .msg{padding:8px 10px;border-radius:10px;margin:6px 0;max-width:88%}
    .msg.user{background:#20283a}
    .msg.admin{background:#203020;margin-left:auto}
    .login-modal{position:fixed;inset:0;background:#0008;display:flex;align-items:center;justify-content:center}
    .login-box{background:#171d29;border:1px solid #2b3955;border-radius:12px;padding:16px;min-width:280px}
    .footer{padding:10px;text-align:center;color:#9aa8c4}
    .search{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}

    /* простые бары для графиков в статистике */
    .chart-row{display:grid;grid-template-columns:34px 1fr 40px;gap:8px;align-items:center;margin:2px 0}
    .chart-row .bar{background:#101522;border:1px solid #2b3955;border-radius:6px;height:10px;overflow:hidden}
    .chart-row .fill{background:#4daaff;height:100%}

    /* чекбоксы для DEMO */
    .checkbox-container{display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none}
    .checkbox-container input[type="checkbox"]{width:16px;height:16px}

    /* DEMO: таблица ачивок */
    .ach-grid{display:grid;grid-template-columns:1fr;gap:6px}
    .ach-head{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-bottom:6px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#1e2638;border:1px solid #2b3955;color:#cfe3ff;font-size:.85em}
    .badge.ok{background:#203020;border-color:#2f7a4e;color:#6df59a}
    .badge.err{background:#3a1f1f;border-color:#7a2f2f;color:#ff9b9b}
    .group-title{font-weight:800;letter-spacing:.04em;color:#9fc3ff;font-size:.9em;margin:8px 0 6px 0;text-transform:uppercase}
    .ach-row{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.07)}
    .ach-row:last-child{border-bottom:none}
    .ach-id{color:#9aa8c4;font-size:.9em;margin-left:8px}
    .right-col{background:#141a25;border:1px solid #2b3955;border-radius:10px;padding:10px}
    .kbd{display:inline-block;background:#222d3f;border:1px solid #2b3955;border-radius:6px;padding:2px 6px;font-family:monospace;font-size:.86em;color:#cfe3ff}
    .hint{color:#9aa8c4;font-size:.95em;line-height:1.5}
    .hr{height:1px;background:#2b3955;margin:8px 0}
  </style>
</head>
<body>
  <header>
    <h1>VR Admin</h1>
    <div class="tabs">
      <button class="tab active" id="tab-claims">Заявки</button>
      <button class="tab" id="tab-devices">Устройства</button>
      <button class="tab" id="tab-backups">Бэкапы</button>
      <button class="tab" id="tab-logs">Логи</button>
      <button class="tab" id="tab-stats">Статистика</button>
      <button class="tab" id="tab-ach">Достижения</button>
      <button class="tab" id="tab-demo">DEMO</button>
      <button class="tab" id="tab-fb">Обратная связь</button>
      <button class="tab" id="tab-prizes">Призы</button>
      <button class="tab" id="tab-logout" title="Выйти">Logout</button>
    </div>
  </header>

  <!-- Заявки -->
  <main id="view-claims">
    <div class="card">
      <div class="search">
        <select id="claims-status" title="Статус">
          <option value="">Все статусы</option>
          <option value="pending">pending</option>
          <option value="approved">approved</option>
          <option value="rejected">rejected</option>
          <option value="shipped">shipped</option>
          <option value="delivered">delivered</option>
        </select>
        <label class="muted">с</label>
        <input type="date" id="claims-from" />
        <label class="muted">по</label>
        <input type="date" id="claims-to" />
        <button class="btn" onclick="resetPaging();loadClaims()">Применить</button>
        <button class="btn" onclick="exportClaimsCSV()">Экспорт CSV</button>
        <div style="margin-left:auto;display:flex;gap:6px;align-items:center;">
          <button class="btn" onclick="prevPage()">◀</button>
          <span class="muted" id="claims-page-label">1</span>
          <button class="btn" onclick="nextPage()">▶</button>
        </div>
      </div>
      <div class="list" id="claims-list"></div>
    </div>
    <div class="card">
      <div class="muted">Клик по заявке слева — для действий</div>
      <div id="claim-details" class="muted" style="margin-top:8px;">Ничего не выбрано</div>
      <div style="margin-top:10px;display:none" id="claim-actions">
        <div id="claim-meta" class="muted" style="margin-bottom:8px;"></div>

        <div class="flex"><label class="muted">Причина (для rejected):</label><input class="w100" id="claim-reason" placeholder="Причина..."></div>
        <div style="margin-top:8px;" class="flex">
          <button class="btn ok" onclick="updateClaim('approved')">Одобрить</button>
          <button class="btn warn" onclick="updateClaim('rejected')">Отклонить</button>
          <button class="btn" onclick="updateClaim('pending')">Вернуть в pending</button>
        </div>

        <hr style="border-color:#2b3955;margin:10px 0;">

        <div class="flex">
          <input class="w100" id="claim-tracking" placeholder="Трек‑номер (для shipped)">
          <button class="btn" onclick="setTracking()">Отправлено</button>
          <button class="btn" onclick="markDelivered()">Получено</button>
        </div>

        <hr style="border-color:#2b3955;margin:10px 0;">

        <div class="flex">
          <label class="muted" style="min-width:90px;">Цвет:</label>
          <select id="adm-color">
            <option value="">—</option>
            <option value="orange">оранжевый (ждёт)</option>
            <option value="green">зелёный (ок)</option>
            <option value="red">красный</option>
            <option value="violet">фиолетовый (напоминание)</option>
          </select>
        </div>
        <div class="flex" style="margin-top:6px;">
          <label class="muted" style="min-width:90px;">Метки:</label>
          <input class="w100" id="adm-tags" placeholder="через запятую">
        </div>
        <div class="flex" style="margin-top:6px;">
          <label class="muted" style="min-width:90px;">Напоминание:</label>
          <input type="datetime-local" id="adm-due">
        </div>
        <div class="flex" style="margin-top:6px;">
          <textarea id="adm-note" class="w100" placeholder="Заметка администратора"></textarea>
        </div>
        <div class="flex" style="margin-top:6px;">
          <button class="btn" onclick="saveClaimMeta()">Сохранить мета</button>
          <button class="btn warn" onclick="deleteClaim()">Удалить заявку</button>
        </div>

        <hr style="border-color:#2b3955;margin:10px 0;">

        <div class="muted">История</div>
        <div class="list" id="claim-events" style="max-height:240px;"></div>
      </div>
    </div>
  </main>

  <!-- Устройства -->
  <main id="view-devices" style="display:none">
    <div class="card">
      <div class="search">
        <input id="dev-q" placeholder="Поиск device_hash / имя / tg_id..." class="w100">
        <button class="btn" onclick="loadDevices()">Искать</button>
      </div>
      <div class="list" id="devices-list"></div>
    </div>
    <div class="card">
      <div class="muted">Клик по устройству слева — для копирования device_hash</div>
      <div id="devices-details" class="muted" style="margin-top:8px;">—</div>
    </div>
  </main>

  <!-- Бэкапы -->
  <main id="view-backups" style="display:none">
    <div class="card">
      <div class="search">
        <button class="btn" onclick="loadBackups()">Обновить</button>
      </div>
      <div class="list" id="backups-list"></div>
    </div>
    <div class="card">
      <div class="muted">Просмотр бэкапа (read‑only)</div>
      <pre id="backup-viewer" style="max-height:70vh; overflow:auto; background:#0f1218; border:1px solid #2b3955; border-radius:10px; padding:10px; color:#cfe3ff;"></pre>
    </div>
  </main>

  <!-- Логи -->
  <main id="view-logs" style="display:none">
    <div class="card">
      <div class="search" style="gap:8px;">
        <select id="logs-type" title="Тип">
          <option value="">Все типы</option>
          <option value="claim_create">claim_create</option>
          <option value="claim_update">claim_update</option>
          <option value="claim_shipped">claim_shipped</option>
          <option value="claim_delivered">claim_delivered</option>
          <option value="claim_cancel">claim_cancel</option>
          <option value="feedback">feedback</option>
          <option value="tg_link">tg_link</option>
          <option value="backup_save">backup_save</option>
          <option value="backup_user_latest">backup_user_latest</option>
          <option value="event_ingest">event_ingest</option>
          <option value="event_denied">event_denied</option>
        </select>
        <label class="muted">с</label>
        <input type="datetime-local" id="logs-from">
        <label class="muted">по</label>
        <input type="datetime-local" id="logs-to">
        <input id="logs-pkey" placeholder="payload ключ (a.b.c)" style="min-width:180px;">
        <select id="logs-pop" title="Оператор">
          <option value="contains">contains</option>
          <option value="eq">=</option>
          <option value="ne">≠</option>
          <option value="gt">&gt;</option>
          <option value="lt">&lt;</option>
          <option value="ge">≥</option>
          <option value="le">≤</option>
        </select>
        <input id="logs-pval" placeholder="значение" style="min-width:140px;">
        <button class="btn" onclick="loadLogs()">Применить</button>
        <button class="btn" onclick="exportLogs('csv')">Экспорт CSV</button>
        <button class="btn" onclick="exportLogs('ndjson')">Экспорт NDJSON</button>
        <button class="btn warn" onclick="deleteSelectedLogs()">Удалить выбранные</button>
      </div>
      <div class="list" id="logs-list"></div>
    </div>
    <div class="card">
      <div class="muted">Детали лога</div>
      <pre id="log-details" style="max-height:70vh; overflow:auto; background:#0f1218; border:1px solid #2b3955; border-radius:10px; padding:10px; color:#cfe3ff;"></pre>
    </div>
  </main>

  <!-- Статистика -->
  <main id="view-stats" style="display:none">
    <div class="card">
      <div class="search">
        <button class="btn" onclick="loadMetrics()">Обновить</button>
      </div>
      <div id="metrics-box" class="list"></div>

      <div class="card" style="margin-top:8px;">
        <div style="font-weight:700;margin-bottom:8px;">Глобальная статистика — управление</div>
        <div class="row">
          <div>Общий выключатель</div>
          <div><label class="muted">masterEnabled</label> <input type="checkbox" id="gs-master"></div>
        </div>
        <div class="row">
          <div>Отправка с клиентов (/event)</div>
          <div><label class="muted">sendEnabled</label> <input type="checkbox" id="gs-send"></div>
        </div>
        <div class="row">
          <div>Показывать UI в приложении</div>
          <div><label class="muted">showUI</label> <input type="checkbox" id="gs-ui"></div>
        </div>
        <div class="row">
          <div>Требовать Turnstile</div>
          <div><label class="muted">requireTurnstile</label> <input type="checkbox" id="gs-ts"></div>
        </div>
        <div class="row">
          <div>Включить монитор в админке</div>
          <div><label class="muted">monitorEnabled</label> <input type="checkbox" id="gs-mon"></div>
        </div>
        <div class="row">
          <div>Собирать очередь клиентов</div>
          <div><label class="muted">collectClientQueue</label> <input type="checkbox" id="gs-cq"></div>
        </div>
        <div class="flex" style="margin-top:8px;">
          <button class="btn ok" onclick="saveGsConfig()">Сохранить</button>
          <button class="btn" onclick="loadGsConfig()">Обновить</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="muted">Дополнительно</div>
      <div class="muted">Здесь можно будет добавить графики/гео после подключения соответствующих источников.</div>
      <div class="card" style="margin-top:8px;">
        <div style="font-weight:700;margin-bottom:6px;">Распределение (по часам/по дням) — рендерится в приложении у пользователей; в админке пока только сводка по цифрам</div>
        <div id="stats-note" class="muted">Данные берутся из /top?period=all|today|week|month</div>
      </div>
    </div>

    <div class="card" id="gs-health-card" style="margin-top:8px; display:none;">
      <div style="font-weight:700;margin-bottom:8px;">Монитор /event (последние 5 минут)</div>
      <div class="row"><div>OK</div><div class="muted" id="m-ok">0</div></div>
      <div class="row"><div>403 (Turnstile)</div><div class="muted" id="m-403">0</div></div>
      <div class="row"><div>429 (Rate limit)</div><div class="muted" id="m-429">0</div></div>
      <div class="row"><div>Иные отказы</div><div class="muted" id="m-other">0</div></div>
      <div class="row"><div>Очередь клиентов (avg / max)</div><div class="muted"><span id="m-q-avg">0</span> / <span id="m-q-max">0</span></div></div>
      <div class="flex" style="margin-top:8px;">
        <button class="btn" onclick="loadGsHealth()">Обновить</button>
      </div>
    </div>
  </main>

  <!-- Достижения -->
  <main id="view-ach" style="display:none">
    <div class="card">
      <div class="search" style="gap:8px;">
        <button class="btn" onclick="loadAchList()">Обновить</button>
        <button class="btn" onclick="newAchItem()">Новый</button>
        <button class="btn warn" onclick="deleteAch()">Удалить</button>
        <button class="btn" onclick="copyAch()">Копировать</button>
      </div>
      <div class="list" id="ach-list"></div>
    </div>
    <div class="card">
      <div style="font-weight:700;margin-bottom:8px;">Редактор оверрайда</div>
      <div class="flex" style="flex-direction:column;gap:6px;">
        <input id="ach-id" placeholder="ID достижения (например, play_25_total)">
        <div class="flex"><label class="muted" style="min-width:120px;">Скрытое</label><input type="checkbox" id="ach-hidden"></div>
        <div class="flex"><label class="muted" style="min-width:120px;">Core</label><input type="checkbox" id="ach-core"></div>
        <div class="flex"><label class="muted" style="min-width:120px;">Tier</label><input id="ach-tier" placeholder="число"></div>
        <input id="ach-title" placeholder="Заголовок (title)">
        <input id="ach-short" placeholder="Коротко (short)">
        <textarea id="ach-desc" class="w100" placeholder="Описание (desc)"></textarea>
        <textarea id="ach-how" class="w100" placeholder="Как выполнить (howTo)"></textarea>
        <div class="muted">Порог (thresholds) — для конкретных ID. Пример JSON: {"play_25_total":20,"time_listened_1h":3000}</div>
        <textarea id="ach-thresholds" class="w100" placeholder='{"play_25_total":20,"time_listened_1h":3000}'></textarea>
        <div class="flex">
          <button class="btn ok" onclick="saveAch()">Сохранить</button>
          <button class="btn" onclick="loadAchList()">Сбросить</button>
        </div>
      </div>
    </div>
  </main>

  <!-- DEMO -->
  <main id="view-demo" style="display:none">
    <!-- Левая колонка: настройки и чек‑лист -->
    <div class="card">
      <div class="search" style="gap:8px;">
        <input id="demo-tg" placeholder="tg_id" value="118759359" style="min-width:160px;">
        <button class="btn" onclick="loadDemoPanel()">Загрузить</button>
      </div>

      <div class="row">
        <div>Режим</div>
        <div><label class="muted">DEMO</label> <input type="checkbox" id="demo-mode"></div>
      </div>

      <div class="row">
        <div>Имя в DEMO<br><span class="muted">(видно пользователю)</span></div>
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="demo-dn" placeholder="VR Admin" style="min-width:160px;">
          <span class="badge" id="demo-level-pill" title="Текущий уровень демо-аккаунта">Уровень: —</span>
        </div>
      </div>

      <div class="flex" style="margin-top:8px;flex-wrap:wrap;gap:8px;">
        <button class="btn ok" onclick="saveDemoMode()">Сохранить режим</button>
        <button class="btn" onclick="buildAndSaveDemoBackup()">Сохранить DEMO‑бэкап</button>
        <button class="btn warn" onclick="resetDemoClaims()">Очистить DEMO‑заявки</button>
      </div>

      <div class="card" style="margin-top:8px;">
        <div class="ach-head">
          <div class="badge">Всего достижений: <b id="demo-total">—</b></div>
          <div class="badge ok">Отмечено: <b id="demo-checked">—</b></div>
          <div class="badge" id="demo-visible-badge">Видимых: —</div>
          <div class="badge" id="demo-secret-badge">Секретных: —</div>
        </div>

        <div class="flex" style="flex-wrap:wrap;gap:6px;margin-bottom:8px;">
          <button class="btn" onclick="markAllVisible(true)">Отметить видимые</button>
          <button class="btn" onclick="markAllSecret(true)">Отметить секретные</button>
          <button class="btn" onclick="markAll(true)">Отметить все 34</button>
          <button class="btn warn" onclick="markAll(false)">Снять всё</button>
        </div>

        <div class="flex" style="flex-wrap:wrap;gap:6px;margin-bottom:8px;">
          <button class="btn" onclick="preset5()">Пресет: 5 уровней</button>
          <button class="btn" onclick="presetFirstPrize()">Пресет: для 1‑го приза</button>
          <button class="btn" onclick="presetSecondPrize()">Пресет: для 2‑го приза</button>
        </div>

        <div id="demo-hint" class="muted" style="margin-bottom:8px;">—</div>

        <div id="demo-ach-box" class="list" style="max-height:60vh; padding-right:6px;">
          <!-- сюда подставится чек‑лист всех 34 -->
        </div>
      </div>
    </div>

    <!-- Отдельная карточка: DEMO‑заявки -->
    <div class="card">
      <div style="font-weight:700;margin-bottom:8px;">DEMO‑заявки</div>
      <div class="flex" style="gap:8px; flex-wrap:wrap; margin-bottom:8px;">
        <input id="demo-device" placeholder="device_hash (опц.)" style="min-width:220px;">
        <button class="btn" onclick="demoLoadClaims()">Обновить</button>
      </div>
      <div id="demo-claims-list" class="list" style="max-height:40vh;"></div>
      <div class="flex" style="gap:6px; margin-top:8px; flex-wrap:wrap;">
        <input id="demo-claim-id" placeholder="claim_id" style="min-width:220px;">
        <input id="demo-tracking" placeholder="трек-номер (для shipped)" style="min-width:220px;">
      </div>
      <div class="flex" style="gap:6px; margin-top:8px; flex-wrap:wrap;">
        <button class="btn" onclick="demoSetShipped()">Отправлено (трек)</button>
        <button class="btn ok" onclick="demoSetDelivered()">Доставлено</button>
        <button class="btn warn" onclick="resetDemoClaims()">Очистить DEMO‑заявки</button>
      </div>
    </div>

    <!-- Правая колонка: краткая инструкция -->
    <div class="right-col">
      <div style="font-weight:700;margin-bottom:8px;">Как пользоваться DEMO</div>
      <div class="hint">
        <p><b>Режим DEMO</b> позволяет эмулировать прогресс выбранного tg_id, не влияя на реальные данные и общую статистику.</p>
        <div class="hr"></div>
        <p><b>Шаги:</b></p>
        <ol>
          <li>Укажите <span class="kbd">tg_id</span> и нажмите <span class="kbd">Загрузить</span>.</li>
          <li>Включите тумблер <span class="kbd">DEMO</span> и задайте «Имя в DEMO» (по умолчанию “VR Admin”). Нажмите <span class="kbd">Сохранить режим</span>.</li>
          <li>Выберите нужные достижения галочками или используйте пресеты:
            <ul>
              <li><b>5 уровней</b> — достаточно, чтобы в приложении появилось предложение создать имя.</li>
              <li><b>Для 1‑го приза</b> — отмечает все видимые достижения. В приложении можно сразу подавать заявку.</li>
              <li><b>Для 2‑го приза</b> — отмечает видимые и секретные достижения. Чтобы появилась кнопка “ПОЛУЧИТЬ ЕЩЁ ПРИЗЫ”, нужна доставленная DEMO‑заявка (см. ниже).</li>
            </ul>
          </li>
          <li>Нажмите <span class="kbd">Сохранить DEMO‑бэкап</span>. Откройте приложение под этим tg_id — прогресс загрузится автоматически.</li>
        </ol>
        <div class="hr"></div>
        <p><b>Заявки в DEMO:</b> создавайте их в приложении как обычно. В DEMO события /event не портят глобальные счётчики, заявка сохраняется в песочнице.</p>
        <p>Чтобы “ПОЛУЧИТЬ ЕЩЁ ПРИЗЫ” стало активно, сделайте заявку и отметьте её как <i>доставленную</i> (нужны DEMO‑методы на бэкенде: /admin/demo/claim/tracking → shipped и /admin/demo/claim/delivered → delivered).</p>
        <div class="hr"></div>
        <p><b>Индикатор уровня</b> справа от имени показывает текущий прогресс: X / 34 (по демо‑бэкапу, если он уже сохранён; иначе — по отмеченным галочкам).</p>
      </div>
    </div>
  </main>

  <!-- Обратная связь -->
  <main id="view-fb" style="display:none">
    <div class="card">
      <div class="search">
        <input id="fb-q" placeholder="Поиск кода/устройства..." class="w100">
        <button class="btn" onclick="loadThreads()">Искать</button>
      </div>
      <div class="list" id="thread-list"></div>
    </div>
    <div class="card">
      <div id="thread-head" class="muted">Выберите тред слева</div>
      <div class="list" id="msg-list" style="height:50vh;"></div>
      <div class="flex" style="margin-top:8px;">
        <input id="fb-reply" class="w100" placeholder="Ответить...">
        <button class="btn primary" onclick="sendReply()">Отправить</button>
      </div>
    </div>
  </main>

  <!-- Призы -->
  <main id="view-prizes" style="display:none">
    <div class="card">
      <div class="search">
        <button class="btn" onclick="loadPrizesAdmin()">Обновить</button>
      </div>
      <div class="list" id="adm-prizes-list"></div>
    </div>
    <div class="card">
      <div style="font-weight:700;margin-bottom:8px;">Редактор</div>
      <div class="flex" style="flex-direction:column;gap:6px;">
        <input id="adm-prize-id" placeholder="ID (пусто для нового)">
        <input id="adm-prize-title" placeholder="Название">
        <input id="adm-prize-short" placeholder="Коротко">
        <textarea id="adm-prize-long" class="w100" placeholder="Описание"></textarea>
        <input id="adm-prize-img" placeholder="URL картинки (img/...)">
        <div class="flex">
          <button class="btn ok" onclick="savePrize()">Сохранить</button>
          <button class="btn warn" onclick="deletePrize()">Удалить</button>
        </div>
      </div>
    </div>
  </main>

  <div class="footer">v1 • Basic Auth • Работает только по HTTPS</div>

  <div id="login" class="login-modal" style="display:none;">
    <div class="login-box">
      <div style="font-weight:700;margin-bottom:8px;">Вход администратора</div>
      <div class="flex" style="flex-direction:column;gap:6px;">
        <input id="adm-user" placeholder="Логин">
        <input id="adm-pass" placeholder="Пароль" type="password">
        <button class="btn primary" onclick="adminLogin()">Войти</button>
      </div>
      <div id="login-err" class="muted" style="margin-top:8px;color:#ffb3b3;"></div>
    </div>
  </div>

<script>
const API = 'https://vr-backend.apel-s-in.workers.dev';
const authKey = 'vr_admin_auth';

function authHeader() {
  const tok = sessionStorage.getItem(authKey);
  return tok ? { 'Authorization': tok } : {};
}

// Показываем/прячем интерфейс
function guardApp() {
  const authed = !!sessionStorage.getItem(authKey);
  document.querySelectorAll('header, main, .footer').forEach(el => {
    if (!el) return;
    el.style.display = authed ? '' : 'none';
  });
  const login = document.getElementById('login');
  if (login) login.style.display = authed ? 'none' : '';
  return authed;
}
function needLogin(show = true) {
  const has = !!sessionStorage.getItem(authKey);
  if (!has && show) guardApp();
  return !has;
}
function adminLogin() {
  const u = document.getElementById('adm-user').value.trim();
  const p = document.getElementById('adm-pass').value.trim();
  if (!u || !p) {
    document.getElementById('login-err').textContent = 'Введите логин и пароль';
    return;
  }
  const token = 'Basic ' + btoa(u + ':' + p);
  sessionStorage.setItem(authKey, token);
  if (guardApp()) loadClaims();
}
document.addEventListener('keydown', (e) => {
  const loginShown = document.getElementById('login')?.style.display !== 'none';
  if (!loginShown) return;
  if (e.key === 'Enter') adminLogin();
});

function switchTab(tab) {
  const tabs = ['claims','devices','backups','logs','stats','ach','demo','fb','prizes'];
  tabs.forEach(t => document.getElementById('tab-'+t)?.classList.toggle('active', tab===t));
  tabs.forEach(t => document.getElementById('view-'+t)?.style && (document.getElementById('view-'+t).style.display = (tab===t)?'':'none'));
  if (tab==='prizes') loadPrizesAdmin();
  if (tab==='devices') loadDevices();
  if (tab==='backups') loadBackups();
  if (tab==='logs') loadLogs();
  if (tab==='stats') { loadMetrics(); loadGsConfig(); }
  if (tab==='ach') loadAchList();
  if (tab==='demo') loadDemoPanel();
}
document.getElementById('tab-claims').onclick = ()=>switchTab('claims');
document.getElementById('tab-devices').onclick = ()=>switchTab('devices');
document.getElementById('tab-backups').onclick = ()=>switchTab('backups');
document.getElementById('tab-logs').onclick = ()=>switchTab('logs');
document.getElementById('tab-stats').onclick = ()=>switchTab('stats');
document.getElementById('tab-ach').onclick = ()=>switchTab('ach');
document.getElementById('tab-demo').onclick = ()=>switchTab('demo');
document.getElementById('tab-fb').onclick = ()=>switchTab('fb');
document.getElementById('tab-prizes').onclick = ()=>switchTab('prizes');
document.getElementById('tab-logout').onclick = ()=>{ sessionStorage.removeItem(authKey); guardApp(); needLogin(true); };

// ===== Заявки =====
let currentClaim = null;
let pageSize = 50;
let currentOffset = 0;

function resetPaging() { currentOffset = 0; document.getElementById('claims-page-label').textContent = '1'; }
function nextPage() { currentOffset += pageSize; loadClaims(); }
function prevPage() {
  currentOffset = Math.max(0, currentOffset - pageSize);
  const curPage = Math.floor(currentOffset / pageSize) + 1;
  document.getElementById('claims-page-label').textContent = String(curPage);
  loadClaims();
}
function readDateInput(id) {
  const v = document.getElementById(id)?.value;
  if (!v) return null;
  try {
    const dt = new Date(v);
    if (id === 'claims-to') dt.setHours(23,59,59,999);
    return dt.toISOString();
  } catch { return null; }
}
async function loadClaims() {
  if (needLogin()) return;
  const st  = document.getElementById('claims-status').value;
  const from= readDateInput('claims-from');
  const to  = readDateInput('claims-to');

  const url = new URL(API + '/admin/claims');
  if (st) url.searchParams.set('status', st);
  if (from) url.searchParams.set('from', from);
  if (to) url.searchParams.set('to', to);
  url.searchParams.set('limit', String(pageSize));
  url.searchParams.set('offset', String(currentOffset));

  const res = await fetch(url, { headers: { ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const list = document.getElementById('claims-list');
  if (!data?.ok) { list.textContent = 'Ошибка загрузки'; return; }

  const items = data.items || [];
  const curPage = Math.floor(currentOffset / pageSize) + 1;
  document.getElementById('claims-page-label').textContent = String(curPage);

  list.innerHTML = items.map(c=>{
    const dt = new Date(c.created_at).toLocaleString();
    const stClass = `status-${c.status}`;
    const tg = c.tg_id ? ` · tg:${String(c.tg_id).slice(0,8)}…` : '';
    return `<div class="row" onclick="selectClaim('${c.id}')">
      <div>
        <div><span class="pill ${stClass}">${c.status}</span> <b>${escapeHtml(c.user_name||'Пользователь')}</b></div>
        <div class="muted">#${c.id.slice(0,8)} · dev:${(c.device_hash||'').slice(0,8)}${tg} · lvl:${c.level} · cyc:${c.cycle}</div>
      </div>
      <div class="muted">${dt}</div>
    </div>`;
  }).join('');

  if (items.length === 0 && currentOffset > 0) prevPage();

  document.getElementById('claim-details').textContent = 'Ничего не выбрано';
  document.getElementById('claim-actions').style.display = 'none';
  currentClaim = null;
}
async function selectClaim(id) {
  const el = document.getElementById('claim-details');
  el.innerHTML = `Заявка <b>#${id}</b><br><span class="muted">Статус меняется кнопками ниже</span>`;
  currentClaim = id;
  document.getElementById('claim-actions').style.display = '';
  loadClaimMeta();
  loadClaimEvents();
}
async function loadClaimMeta() {
  if (!currentClaim) return;
  const metaBox = document.getElementById('claim-meta');
  try {
    const url = new URL(API + '/admin/claim/meta/get');
    url.searchParams.set('id', currentClaim);
    const res = await fetch(url, { headers:{ ...authHeader() }});
    if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
    const data = await res.json().catch(()=> ({}));
    if (!res.ok || !data?.ok) { metaBox.textContent = 'Мета недоступна'; return; }
    const m = data.meta || {};
    document.getElementById('adm-color').value = m.color || '';
    document.getElementById('adm-tags').value = (Array.isArray(m.tags) ? m.tags.join(', ') : '');
    document.getElementById('adm-note').value = m.note || '';
    if (m.dueAt) {
      const dt = new Date(m.dueAt);
      const iso = dt.toISOString().slice(0,16);
      document.getElementById('adm-due').value = iso;
    } else document.getElementById('adm-due').value = '';
    metaBox.innerHTML = `dev/tg и прочие данные в списке слева · <span class="muted">модиф.: ${m.updatedAt?new Date(m.updatedAt).toLocaleString():'—'}</span>`;
  } catch {
    if (metaBox) metaBox.textContent = 'Ошибка загрузки мета';
  }
}
async function saveClaimMeta() {
  if (needLogin()) return;
  if (!currentClaim) return;
  const color = document.getElementById('adm-color').value;
  const tags = (document.getElementById('adm-tags').value || '').split(',').map(s=>s.trim()).filter(Boolean);
  const note = document.getElementById('adm-note').value || '';
  const dueStr = document.getElementById('adm-due').value;
  let dueAt = null; try { if (dueStr) dueAt = new Date(dueStr).getTime(); } catch(e){}
  const res = await fetch(API + '/admin/claim/meta/set', {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ id: currentClaim, color, tags, note, dueAt })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Мета не сохранена: '+(data?.error||res.status)); return; }
  alert('Мета сохранена'); loadClaimMeta();
}
async function loadClaimEvents() {
  if (!currentClaim) return;
  const box = document.getElementById('claim-events');
  try {
    const url = new URL(API + '/admin/claim/events');
    url.searchParams.set('id', currentClaim);
    const res = await fetch(url, { headers:{ ...authHeader() }});
    if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
    const data = await res.json().catch(()=> ({}));
    if (!res.ok || !data?.ok) { box.textContent = 'История недоступна'; return; }
    const items = data.items || [];
    if (!items.length) { box.textContent = 'Пусто'; return; }
    box.innerHTML = items.map(ev=>{
      const dt = new Date(ev.at).toLocaleString();
      return `<div class="row"><div><b>${ev.type}</b></div><div class="muted">${dt}</div></div>`;
    }).join('');
  } catch { box.textContent = 'Ошибка истории'; }
}
async function deleteClaim() {
  if (!currentClaim) return;
  if (!confirm('Удалить эту заявку без возможности восстановления?')) return;
  const res = await fetch(API + '/admin/claim/delete', {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() }, body: JSON.stringify({ id: currentClaim })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Не удалось удалить: '+(data?.error||res.status)); return; }
  alert('Удалено'); currentClaim = null; document.getElementById('claim-actions').style.display = 'none'; loadClaims();
}
async function updateClaim(next) {
  if (!currentClaim) return;
  const reason = document.getElementById('claim-reason').value.trim();
  const res = await fetch(API+'/admin/claim/update', {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ id: currentClaim, status: next, reason: (next==='rejected'?reason:null) })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Ошибка: '+(data?.error||res.status)); return; }
  alert('Готово: '+next); loadClaims();
}
async function setTracking() {
  if (!currentClaim) return;
  const tracking = document.getElementById('claim-tracking').value.trim();
  if (!tracking) { alert('Введите трек‑номер'); return; }
  const res = await fetch(API+'/admin/claim/tracking', {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ id: currentClaim, tracking })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Ошибка: '+(data?.error||res.status)); return; }
  alert('Статус: shipped, трек установлен'); loadClaims();
}
async function markDelivered() {
  if (!currentClaim) return;
  const res = await fetch(API+'/admin/claim/delivered', {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ id: currentClaim })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Ошибка: '+(data?.error||res.status)); return; }
  alert('Статус: delivered'); loadClaims();
}
async function exportClaimsCSV() {
  if (needLogin()) return;
  const st  = document.getElementById('claims-status').value;
  const from= readDateInput('claims-from');
  const to  = readDateInput('claims-to');

  const url = new URL(API + '/admin/claims/export');
  if (st) url.searchParams.set('status', st);
  if (from) url.searchParams.set('from', from);
  if (to) url.searchParams.set('to', to);

  const res = await fetch(url, { headers: { ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const blob = await res.blob();
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `claims-${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
}

// ===== Feedback =====
let currentThread = null;
async function loadThreads() {
  if (needLogin()) return;
  const q = document.getElementById('fb-q').value.trim();
  const url = new URL(API + '/admin/feedback/threads');
  if (q) url.searchParams.set('q', q);
  url.searchParams.set('limit','100');
  const res = await fetch(url, { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const list = document.getElementById('thread-list');
  if (!data?.ok) { list.textContent = 'Ошибка'; return; }
  list.innerHTML = (data.items||[]).map(t=>{
    const dt = new Date(t.last_message_at).toLocaleString();
    const st = t.status || 'open';
    return `<div class="row" onclick="openThread('${t.id}','${t.code}','${st}')">
      <div>
        <div><b>#${t.code}</b> · ${t.user_name||'Пользователь'} · <span class="pill">${st}</span></div>
        <div class="muted">dev:${(t.device_hash||'').slice(0,8)} · ${new Date(t.created_at).toLocaleDateString()}</div>
      </div>
      <div class="muted">${dt}</div>
    </div>`;
  }).join('');
  document.getElementById('thread-head').textContent = 'Выберите тред слева';
  document.getElementById('msg-list').innerHTML = '';
  currentThread = null;
}
async function openThread(id, code, status='open') {
  currentThread = { id, code, status };
  const head = document.getElementById('thread-head');
  head.innerHTML = `Диалог <b>#${code}</b> · <span class="pill">${status}</span>
    <button class="btn" style="margin-left:8px" onclick="toggleThreadStatus()">${status==='closed'?'Открыть':'Закрыть'}</button>`;
  await loadMessages();
}
async function toggleThreadStatus() {
  if (!currentThread) return;
  const next = currentThread.status === 'closed' ? 'open' : 'closed';
  const res = await fetch(API + '/admin/feedback/close', {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ threadId: currentThread.id, status: next })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Ошибка: '+(data?.error||res.status)); return; }
  currentThread.status = next; openThread(currentThread.id, currentThread.code, currentThread.status);
}
async function loadMessages() {
  if (!currentThread) return;
  const url = new URL(API + '/admin/feedback/messages');
  url.searchParams.set('thread', currentThread.id);
  const res = await fetch(url, { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const list = document.getElementById('msg-list');
  if (!data?.ok) { list.textContent = 'Ошибка'; return; }
  list.innerHTML = (data.items||[]).map(m=>{
    const dt = new Date(m.created_at).toLocaleString();
    const cls = m.sender==='admin'?'msg admin':'msg user';
    return `<div class="${cls}"><div>${escapeHtml(m.text)}</div><div class="muted" style="font-size:.8em;margin-top:4px">${dt}</div></div>`;
  }).join('');
  list.scrollTop = list.scrollHeight;
}
async function sendReply() {
  const inp = document.getElementById('fb-reply');
  const text = (inp.value||'').trim();
  if (!text || !currentThread) return;
  const res = await fetch(API+'/admin/feedback/reply', {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ threadId: currentThread.id, text })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Не отправлено: '+(data?.error||res.status)); return; }
  inp.value = ''; loadMessages();
}

// ===== Устройства =====
async function loadDevices() {
  if (needLogin()) return;
  const q = document.getElementById('dev-q').value.trim();
  const url = new URL(API + '/admin/devices');
  if (q) url.searchParams.set('q', q);
  url.searchParams.set('limit', '100');
  const res = await fetch(url, { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const list = document.getElementById('devices-list');
  if (!data?.ok) { list.textContent = 'Ошибка'; return; }
  list.innerHTML = (data.items||[]).map(d=>{
    const dt1 = new Date(d.first_seen).toLocaleString();
    const dt2 = new Date(d.last_seen).toLocaleString();
    const claimStat = `T:${d.claims_total||0} • p:${d.claims_pending||0} • a:${d.claims_approved||0} • s:${d.claims_shipped||0} • d:${d.claims_delivered||0} • r:${d.claims_rejected||0}`;
    const user = `${escapeHtml(d.user_name||'—')} ${d.tg_id?('· tg:'+String(d.tg_id)) : ''}`;
    return `<div class="row" onclick="copyDeviceHash('${d.device_hash}')">
      <div>
        <div><b>dev:${escapeHtml(d.device_hash.slice(0,12))}…</b> · ${user}</div>
        <div class="muted">${dt1} → ${dt2}</div>
      </div>
      <div class="muted">${claimStat}</div>
    </div>`;
  }).join('');
  document.getElementById('devices-details').textContent = '—';
}
function copyDeviceHash(hash) {
  navigator.clipboard?.writeText(hash);
  const box = document.getElementById('devices-details');
  if (box) box.textContent = `Скопировано: ${hash}`;
}

// ===== Бэкапы =====
async function loadBackups() {
  if (needLogin()) return;
  const res = await fetch(API + '/admin/backups/list', { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const list = document.getElementById('backups-list');
  if (!data?.ok) { list.textContent = 'Ошибка'; return; }
  list.innerHTML = (data.items||[]).map(b=>{
    const when = b.exportedAt ? new Date(b.exportedAt).toLocaleString() : '—';
    return `<div class="row">
      <div>
        <div><b>dev:${escapeHtml((b.device||'').slice(0,12))}…</b></div>
        <div class="muted">${when}</div>
      </div>
      <div class="flex">
        <div class="muted" style="max-width:220px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(b.checksum||'')}</div>
        <button class="btn" onclick="viewBackup('${b.device}')">Открыть</button>
      </div>
    </div>`;
  }).join('');
  document.getElementById('backup-viewer').textContent = '';
}
async function viewBackup(device) {
  if (needLogin()) return;
  const url = new URL(API + '/admin/backup/get');
  url.searchParams.set('device', device);
  const res = await fetch(url, { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const pre = document.getElementById('backup-viewer');
  if (!data?.ok) { pre.textContent = 'Ошибка'; return; }
  pre.textContent = JSON.stringify(data.backup, null, 2);
}

// ===== Логи =====
let __selectedLogKeys = new Set();
function readDTLocal(id) {
  const v = document.getElementById(id)?.value;
  if (!v) return null;
  try { return new Date(v).toISOString(); } catch { return null; }
}
async function loadLogs() {
  if (needLogin()) return;
  __selectedLogKeys = new Set();
  const type = document.getElementById('logs-type').value;
  const from = readDTLocal('logs-from');
  const to   = readDTLocal('logs-to');
  const pkey = document.getElementById('logs-pkey').value.trim();
  const pop  = document.getElementById('logs-pop').value;
  const pval = document.getElementById('logs-pval').value.trim();

  const url = new URL(API + '/admin/logs');
  if (type) url.searchParams.set('type', type);
  if (from) url.searchParams.set('from', from);
  if (to) url.searchParams.set('to', to);
  if (pkey) url.searchParams.set('pkey', pkey);
  if (pop)  url.searchParams.set('pop', pop);
  if (pval) url.searchParams.set('pval', pval);
  url.searchParams.set('limit', '100');

  const res = await fetch(url, { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const list = document.getElementById('logs-list');
  if (!data?.ok) { list.textContent = 'Ошибка'; return; }

  list.innerHTML = (data.items||[]).map(l=>{
    const when = l.ts ? new Date(l.ts).toLocaleString() : '—';
    const payloadShort = escapeHtml(JSON.stringify(l.payload||{})).slice(0,120);
    return `<div class="row">
      <div onclick="selectLog('${l.key}')">
        <div><span class="pill">${escapeHtml(l.type||'log')}</span> <b>${when}</b></div>
        <div class="muted">${payloadShort}</div>
      </div>
      <div>
        <input type="checkbox" onchange="toggleLogKey('${l.key}', this.checked)">
      </div>
    </div>`;
  }).join('');
  document.getElementById('log-details').textContent = '';
}
function toggleLogKey(key, checked) {
  if (checked) __selectedLogKeys.add(key); else __selectedLogKeys.delete(key);
}
async function selectLog(key) {
  if (needLogin()) return;
  const type = document.getElementById('logs-type').value;
  const from = readDTLocal('logs-from');
  const to   = readDTLocal('logs-to');
  const pkey = document.getElementById('logs-pkey').value.trim();
  const pop  = document.getElementById('logs-pop').value;
  const pval = document.getElementById('logs-pval').value.trim();
  const url = new URL(API + '/admin/logs');
  if (type) url.searchParams.set('type', type);
  if (from) url.searchParams.set('from', from);
  if (to) url.searchParams.set('to', to);
  if (pkey) url.searchParams.set('pkey', pkey);
  if (pop)  url.searchParams.set('pop', pop);
  if (pval) url.searchParams.set('pval', pval);
  url.searchParams.set('limit', '100');
  const resp = await fetch(url, { headers:{ ...authHeader() }});
  const data = await resp.json().catch(()=> ({}));
  const it = (data.items||[]).find(x => x.key === key);
  document.getElementById('log-details').textContent = it ? JSON.stringify(it, null, 2) : 'Не найден';
}
async function deleteSelectedLogs() {
  if (!__selectedLogKeys.size) { alert('Не выбрано ни одного лога'); return; }
  if (!confirm(`Удалить ${__selectedLogKeys.size} логов?`)) return;
  const res = await fetch(API + '/admin/logs/delete', {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ keys: Array.from(__selectedLogKeys) })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Ошибка удаления: ' + (data?.error||res.status)); return; }
  alert('Удалено'); loadLogs();
}
async function exportLogs(fmt) {
  if (needLogin()) return;
  const type = document.getElementById('logs-type').value;
  const from = readDTLocal('logs-from');
  const to   = readDTLocal('logs-to');
  const pkey = document.getElementById('logs-pkey').value.trim();
  const pop  = document.getElementById('logs-pop').value;
  const pval = document.getElementById('logs-pval').value.trim();

  const url = new URL(API + '/admin/logs/export');
  url.searchParams.set('format', fmt || 'csv');
  if (type) url.searchParams.set('type', type);
  if (from) url.searchParams.set('from', from);
  if (to)   url.searchParams.set('to', to);
  if (pkey) url.searchParams.set('pkey', pkey);
  if (pop)  url.searchParams.set('pop', pop);
  if (pval) url.searchParams.set('pval', pval);
  url.searchParams.set('limit', '20000');

  const res = await fetch(url, { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const blob = await res.blob();
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `logs-${new Date().toISOString().slice(0,19).replace(/[T:]/g,'-')}.${fmt==='ndjson'?'ndjson':'csv'}`;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
}

// ===== Сводная статистика =====
async function loadMetrics() {
  if (needLogin()) return;
  const res = await fetch(API + '/admin/metrics/summary', { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const box = document.getElementById('metrics-box');
  if (!data?.ok) { box.textContent = 'Ошибка'; return; }
  const byStatus = (data.claimsByStatus||[]).map(s=> `<div class="row"><div>${s.status}</div><div class="muted">${s.c}</div></div>`).join('');
  box.innerHTML = `
    <div class="row"><div>Пользователей</div><div class="muted">${data.users}</div></div>
    <div class="row"><div>Устройств</div><div class="muted">${data.devices}</div></div>
    <div class="row"><div>Заявок</div><div class="muted">${data.claims}</div></div>
    <div class="row"><div>Диалогов обратной связи</div><div class="muted">${data.feedback_threads}</div></div>
    <div class="row"><div>Сообщений</div><div class="muted">${data.feedback_messages}</div></div>
    <div class="row"><div><b>Заявки по статусам</b></div><div></div></div>
    ${byStatus || '<div class="muted">—</div>'}
  `;
}

// ===== GS Config (управление глобальной статистикой) =====
async function loadGsConfig() {
  if (needLogin()) return;
  const res = await fetch(API + '/admin/gs/config', { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Ошибка конфигурации'); return; }
  const c = data.config || {};
  document.getElementById('gs-master').checked = !!c.masterEnabled;
  document.getElementById('gs-send').checked = !!c.sendEnabled;
  document.getElementById('gs-ui').checked = !!c.showUI;
  document.getElementById('gs-ts').checked = !!c.requireTurnstile;
  document.getElementById('gs-mon').checked = !!c.monitorEnabled;
  document.getElementById('gs-cq').checked = !!c.collectClientQueue;

  const monCard = document.getElementById('gs-health-card');
  if (monCard) monCard.style.display = c.monitorEnabled ? '' : 'none';
  if (c.monitorEnabled) loadGsHealth();
}
async function saveGsConfig() {
  if (needLogin()) return;
  const body = {
    masterEnabled: document.getElementById('gs-master').checked,
    sendEnabled: document.getElementById('gs-send').checked,
    showUI: document.getElementById('gs-ui').checked,
    requireTurnstile: document.getElementById('gs-ts').checked,
    monitorEnabled: document.getElementById('gs-mon').checked,
    collectClientQueue: document.getElementById('gs-cq').checked
  };
  const res = await fetch(API + '/admin/gs/config', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify(body)
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Не сохранено'); return; }
  alert('Сохранено');
  loadGsConfig();
}
async function loadGsHealth() {
  if (needLogin()) return;
  const res = await fetch(API + '/admin/gs/health', { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const d = await res.json().catch(()=> ({}));
  if (!res.ok || !d?.ok) { alert('Монитор недоступен'); return; }
  document.getElementById('m-ok').textContent    = d.okCount || 0;
  document.getElementById('m-403').textContent   = d.denied403 || 0;
  document.getElementById('m-429').textContent   = d.rateLimited || 0;
  document.getElementById('m-other').textContent = d.otherDenied || 0;
  document.getElementById('m-q-avg').textContent = (d.queue?.avg ?? 0);
  document.getElementById('m-q-max').textContent = (d.queue?.max ?? 0);
}

// ===== Admin: Achievements overrides =====
let __achItems = [];
let __achSelectedId = null;

async function loadAchList() {
  if (needLogin()) return;
  const list = document.getElementById('ach-list');
  list.innerHTML = 'Загрузка...';

  const [baseRes, ovRes] = await Promise.all([
    fetch(API + '/admin/ach/base', { headers:{ ...authHeader() } }),
    fetch(API + '/admin/achievements', { headers:{ ...authHeader() } })
  ]);
  if (baseRes.status === 401 || ovRes.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const base = await baseRes.json().catch(()=> ({}));
  const data = await ovRes.json().catch(()=> ({}));
  if (!base?.ok || !data?.ok) {
    list.textContent = 'Ошибка загрузки';
    return;
  }

  const baseItems = (base.items || []).map(x => ({ ...x, _kind: 'base' }));
  __achItems = (data.items || []).map(x => ({ ...x, _kind: 'override' }));

  // индекс оверрайдов по id
  const ovById = new Map(__achItems.map(x => [x.id, x]));

  // оверрайды — сверху
  const overHtml = __achItems.map(it => {
    const id = String(it.id || '');
    const t = escapeHtml(it.title || '');
    const th = it.thresholds ? escapeHtml(JSON.stringify(it.thresholds)) : '';
    const meta = [
      it.hidden ? 'hidden' : '',
      (typeof it.tier === 'number') ? ('tier:' + it.tier) : '',
      it.core ? 'core' : ''
    ].filter(Boolean).join(' · ');
    return `<div class="row" onclick="editAch('${escapeHtml(id)}')">
      <div><b>${escapeHtml(id)}</b> ${meta ? ('· ' + escapeHtml(meta)) : ''}<div class="muted">${t}</div></div>
      <div class="muted" style="max-width:240px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">${th}</div>
    </div>`;
  }).join('');

  // база — серым, только те, по которым ещё нет оверрайда
  const baseHtml = baseItems
    .filter(b => !ovById.has(b.id))
    .map(b => {
      const meta = [
        b.hidden ? 'hidden' : '',
        (typeof b.tier === 'number') ? ('tier:' + b.tier) : '',
        b.core ? 'core' : ''
      ].filter(Boolean).join(' · ');
      return `<div class="row" onclick="prefillFromBase('${escapeHtml(String(b.id))}')">
        <div><span class="muted">${escapeHtml(String(b.id))}</span> ${meta ? ('· <span class="muted">' + escapeHtml(meta) + '</span>') : ''}
          <div class="muted">${escapeHtml(b.title || '')}</div>
        </div>
        <div class="muted">нет оверрайда</div>
      </div>`;
    }).join('');

  list.innerHTML = `
    <div class="muted" style="margin:6px 0 4px 0;">Оверрайды</div>
    ${overHtml || '<div class="muted">— пока нет сохранённых оверрайдов</div>'}
    <div class="muted" style="margin:10px 0 4px 0;">База (кликните, чтобы предзаполнить редактор)</div>
    ${baseHtml || '<div class="muted">—</div>'}
  `;

  clearAchEditor();
}

function prefillFromBase(id) {
  // Предзаполняем редактор из базового элемента (id/title/tier/core/hidden)
  fetch(API + '/admin/ach/base', { headers: { ...authHeader() } })
    .then(r => r.json())
    .then(d => {
      const base = (d.items || []).find(x => String(x.id) === String(id));
      if (!base) return;
      __achSelectedId = id;
      document.getElementById('ach-id').value = base.id || '';
      document.getElementById('ach-hidden').checked = !!base.hidden;
      document.getElementById('ach-core').checked = !!base.core;
      document.getElementById('ach-tier').value = (typeof base.tier === 'number') ? String(base.tier) : '';
      document.getElementById('ach-title').value = base.title || '';
      document.getElementById('ach-short').value = '';
      document.getElementById('ach-desc').value = '';
      document.getElementById('ach-how').value = '';
      document.getElementById('ach-thresholds').value = '';
    }).catch(() => { /* ignore */ });
}

function clearAchEditor() {
  __achSelectedId = null;
  document.getElementById('ach-id').value = '';
  document.getElementById('ach-hidden').checked = false;
  document.getElementById('ach-core').checked = false;
  document.getElementById('ach-tier').value = '';
  document.getElementById('ach-title').value = '';
  document.getElementById('ach-short').value = '';
  document.getElementById('ach-desc').value = '';
  document.getElementById('ach-how').value = '';
  document.getElementById('ach-thresholds').value = '';
}

function newAchItem() {
  clearAchEditor();
  document.getElementById('ach-id').focus();
}

function editAch(id) {
  const it = __achItems.find(x => String(x.id) === String(id));
  if (!it) return;
  __achSelectedId = id;
  document.getElementById('ach-id').value = it.id || '';
  document.getElementById('ach-hidden').checked = !!it.hidden;
  document.getElementById('ach-core').checked = !!it.core;
  document.getElementById('ach-tier').value = (typeof it.tier === 'number') ? String(it.tier) : '';
  document.getElementById('ach-title').value = it.title || '';
  document.getElementById('ach-short').value = it.short || '';
  document.getElementById('ach-desc').value = it.desc || '';
  document.getElementById('ach-how').value = it.howTo || '';
  document.getElementById('ach-thresholds').value = it.thresholds ? JSON.stringify(it.thresholds, null, 2) : '';
}

async function saveAch() {
  if (needLogin()) return;
  const id = document.getElementById('ach-id').value.trim();
  if (!id) { alert('Укажите ID'); return; }

  let thresholds = null;
  const t = document.getElementById('ach-thresholds').value.trim();
  if (t) {
    try { thresholds = JSON.parse(t); }
    catch { alert('thresholds: некорректный JSON'); return; }
  }

  const body = {
    id,
    hidden: document.getElementById('ach-hidden').checked,
    core: document.getElementById('ach-core').checked,
    tier: Number(document.getElementById('ach-tier').value || ''),
    title: document.getElementById('ach-title').value,
    short: document.getElementById('ach-short').value,
    desc: document.getElementById('ach-desc').value,
    howTo: document.getElementById('ach-how').value,
    thresholds
  };

  const res = await fetch(API + '/admin/achievement/upsert', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...authHeader() },
    body: JSON.stringify(body)
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(() => ({}));
  if (!res.ok || !data?.ok) { alert('Не сохранено'); return; }
  alert('Сохранено');
  loadAchList();
}

async function deleteAch() {
  if (needLogin()) return;
  const id = (document.getElementById('ach-id').value || '').trim();
  if (!id) { alert('Сначала выберите элемент'); return; }
  if (!confirm(`Удалить оверрайд "${id}"?`)) return;

  const res = await fetch(API + '/admin/achievement/delete', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...authHeader() },
    body: JSON.stringify({ id })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(() => ({}));
  if (!res.ok || !data?.ok) { alert('Не удалено'); return; }
  alert('Удалено');
  loadAchList();
}

async function copyAch() {
  if (needLogin()) return;
  const fromId = (document.getElementById('ach-id').value || '').trim();
  if (!fromId) { alert('Выберите, что копировать'); return; }
  const toId = prompt('Новый ID (копия из ' + fromId + ')');
  if (!toId) return;

  const res = await fetch(API + '/admin/achievement/copy', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...authHeader() },
    body: JSON.stringify({ fromId, toId })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(() => ({}));
  if (!res.ok || !data?.ok) { alert('Не скопировано'); return; }
  alert('Скопировано');
  loadAchList();
}

// ===== Admin: DEMO helpers and panel =====

// Рендер всех достижений (видимые + секретные) в виде чек-листа
function renderDemoAchList(items) {
  const box = document.getElementById('demo-ach-box');
  if (!box) return;

  const sorted = [...items].sort((a, b) => {
    if (!!a.hidden !== !!b.hidden) return a.hidden ? 1 : -1; // видимые первыми
    if ((a.tier || 0) !== (b.tier || 0)) return (a.tier || 0) - (b.tier || 0);
    return String(a.title || a.id).localeCompare(String(b.title || b.id), 'ru');
  });

  const visible = sorted.filter(x => !x.hidden);
  const secret = sorted.filter(x => x.hidden);

  const rows = (arr) => arr.map(a => `
    <div class="ach-row">
      <label class="checkbox-container">
        <input type="checkbox" data-ach="${escapeHtml(String(a.id))}" onchange="updateDemoCountsAndLevel()">
        <span>${escapeHtml(a.title || a.id)} <span class="ach-id">(${escapeHtml(String(a.id))})</span></span>
      </label>
      <span class="muted">${a.tier ? 'tier:'+a.tier : ''}</span>
    </div>
  `).join('');

  box.innerHTML = `
    <div class="group-title">Видимые</div>
    ${rows(visible) || '<div class="muted">—</div>'}
    <div class="group-title">Секретные</div>
    ${rows(secret) || '<div class="muted">—</div>'}
  `;

  // обновим бейджи "всего/видимых/секретных"
  document.getElementById('demo-total').textContent = String(items.length);
  document.getElementById('demo-visible-badge').textContent = `Видимых: ${visible.length}`;
  document.getElementById('demo-secret-badge').textContent = `Секретных: ${secret.length}`;

  updateDemoCountsAndLevel();
}

function getCheckedIds() {
  return Array.from(document.querySelectorAll('#demo-ach-box input[type="checkbox"][data-ach]'))
    .filter(c => c.checked)
    .map(c => c.getAttribute('data-ach'));
}

function markAll(mark) {
  const boxes = document.querySelectorAll('#demo-ach-box input[type="checkbox"][data-ach]');
  boxes.forEach(b => { b.checked = !!mark; });
  updateDemoCountsAndLevel();
}

let __demoHiddenById = new Map();
function setDemoHiddenMap(items) {
  __demoHiddenById = new Map(items.map(x => [String(x.id), !!x.hidden]));
}
function markAllVisible(mark) {
  const boxes = document.querySelectorAll('#demo-ach-box input[type="checkbox"][data-ach]');
  boxes.forEach(b => {
    const id = b.getAttribute('data-ach');
    const isHidden = __demoHiddenById.get(String(id));
    if (!isHidden) b.checked = !!mark;
  });
  updateDemoCountsAndLevel();
}
function markAllSecret(mark) {
  const boxes = document.querySelectorAll('#demo-ach-box input[type="checkbox"][data-ach]');
  boxes.forEach(b => {
    const id = b.getAttribute('data-ach');
    const isHidden = __demoHiddenById.get(String(id));
    if (isHidden) b.checked = !!mark;
  });
  updateDemoCountsAndLevel();
}

function preset5() {
  // отметить первые 5 видимых
  const ids = [];
  const boxes = Array.from(document.querySelectorAll('#demo-ach-box input[type="checkbox"][data-ach]'));
  for (const b of boxes) {
    const id = b.getAttribute('data-ach');
    const isHidden = __demoHiddenById.get(String(id));
    if (!isHidden) ids.push(b);
    if (ids.length >= 5) break;
  }
  markAll(false);
  ids.forEach(b => b.checked = true);
  updateDemoCountsAndLevel();
}

function presetFirstPrize() {
  // все видимые (без секретных)
  markAll(false);
  markAllVisible(true);
}

function presetSecondPrize() {
  // все видимые + все секретные
  markAll(true);
}

function updateDemoCountsAndLevel() {
  const boxes = Array.from(document.querySelectorAll('#demo-ach-box input[type="checkbox"][data-ach]'));
  const checked = boxes.filter(b => b.checked);
  const checkedIds = checked.map(b => b.getAttribute('data-ach'));

  const total = boxes.length;
  const visibleTotal = Array.from(__demoHiddenById.values()).filter(v => !v).length;
  const secretTotal = total - visibleTotal;

  let visibleDone = 0, secretDone = 0;
  checkedIds.forEach(id => {
    if (__demoHiddenById.get(String(id))) secretDone++;
    else visibleDone++;
  });

  document.getElementById('demo-checked').textContent = String(checked.length);

  // Индикатор уровня = выполнено видимых
  const pill = document.getElementById('demo-level-pill');
  if (pill) pill.textContent = `Уровень: ${visibleDone} / ${visibleTotal}`;

  // подсказка: если все видимые отмечены — можно брать 1-й приз
  const hint = document.getElementById('demo-hint');
  if (visibleDone >= visibleTotal) {
    if (secretDone > 0) {
      hint.textContent = 'Готово для 1-го приза. Секретные отмечены: ' + secretDone + ' / ' + secretTotal;
    } else {
      hint.textContent = 'Готово для 1-го приза (видимые: все).';
    }
  } else {
    hint.textContent = 'Отметьте видимые достижения для 1-го приза или используйте пресет.';
  }
}

async function loadDemoPanel() {
  if (needLogin()) return;
  const tg = document.getElementById('demo-tg').value.trim();
  if (!tg) return alert('Введите tg_id');

  // Получаем настройки тестера
  const res = await fetch(`${API}/admin/demo/tester?tg=${encodeURIComponent(tg)}`, { headers: { ...authHeader() } });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const d = await res.json().catch(() => ({}));
  if (!res.ok || !d?.ok) { alert('Не удалось загрузить'); return; }

  document.getElementById('demo-mode').checked = (d.tester?.mode === 'demo');
  document.getElementById('demo-dn').value = d.tester?.displayNameDemo || 'VR Admin';
  document.getElementById('demo-hint').textContent = d.hasDemo ? 'Демо-бэкап сохранён' : 'Демо-бэкап не настроен';

  // База достижений
  const base = await fetch(API + '/admin/ach/base', { headers: { ...authHeader() } }).then(r => r.json()).catch(() => ({}));
  const items = (base.items || []);
  setDemoHiddenMap(items);
  renderDemoAchList(items);

  // Автозагрузка списка DEMO‑заявок для наглядности
  try { await demoLoadClaims(); } catch(e){}
}

async function saveDemoMode() {
  if (needLogin()) return;
  const tg = document.getElementById('demo-tg').value.trim();
  const mode = document.getElementById('demo-mode').checked ? 'demo' : 'live';
  const displayNameDemo = document.getElementById('demo-dn').value.trim() || 'VR Admin';
  const res = await fetch(API + '/admin/demo/tester', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...authHeader() },
    body: JSON.stringify({ tg, mode, displayNameDemo })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const d = await res.json().catch(() => ({}));
  if (!res.ok || !d?.ok) return alert('Не сохранено');
  alert('Сохранено');
}

async function buildAndSaveDemoBackup() {
  if (needLogin()) return;
  const tg = document.getElementById('demo-tg').value.trim();
  if (!tg) return alert('Введите tg_id');

  const now = Date.now();
  const checkedIds = getCheckedIds();

  // Статистика/ачивки
  const stats = {
    schema: 2,
    deviceHash: 'demo_device',
    createdAt: now,
    totals: { totalSeconds: 0, totalValidPlays: 0, totalFullPlays: 0 },
    perTrack: Array.from({ length: 16 }, () => ({
      validPlays: 0, fullPlays: 0, totalSeconds: 0, lastPlayedAt: 0,
      byHour: Array(24).fill(0), byWeekday: Array(7).fill(0)
    })),
    uniqueTracksPlayed: [],
    byDay: {},
    streak: { current: 0, max: 0, lastDay: null },
    likedCount: 0,
    achievements: {},
    lastMajorAchAt: 0,
    backups: { dates: [] },
    socialsVisited: {},
    sleepTimerStops: 0
  };
  checkedIds.forEach(id => { stats.achievements[id] = { unlockedAt: now, tier: 1 }; });

  // Подсчёты видимых/секретных из карты
  const allIds = Array.from(__demoHiddenById.keys());
  const visibleTotal = allIds.filter(id => !__demoHiddenById.get(id)).length;
  const secretTotal = allIds.length - visibleTotal;
  const visibleDone = checkedIds.filter(id => !__demoHiddenById.get(id)).length;
  const secretDone = checkedIds.filter(id => __demoHiddenById.get(id)).length;

  const payload = {
    appVersion: 'demo',
    buildDate: new Date().toISOString().slice(0, 10),
    exportedAt: new Date().toISOString(),
    deviceHash: 'demo_device',
    profile: { displayName: document.getElementById('demo-dn').value.trim() || 'VR Admin', tgId: tg, tgUsername: null },
    favorites: [],
    knownDevices: ['demo_device'],
    achOverview: {
      normalTotal: visibleTotal,
      normalDone: visibleDone,
      secretTotal: secretTotal,
      secretDoneFromStart: secretDone,
      secretStartAt: secretDone ? now : null
    },
    stats,
    statsInsights: null
  };

  // checksum
  const checksum = await (async (s) => {
    const enc = new TextEncoder().encode(JSON.stringify(s));
    const h = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(h)).map(b => b.toString(16).padStart(2, '0')).join('');
  })(payload);

  const file = { kind: 'vr_backup_v1', checksum, payload };

  const res = await fetch(API + '/admin/demo/backup', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...authHeader() },
    body: JSON.stringify({ tg, file })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const d = await res.json().catch(() => ({}));
  if (!res.ok || !d?.ok) return alert('Демо-бэкап не сохранён');

  document.getElementById('demo-hint').textContent = 'Демо-бэкап сохранён';
  updateDemoCountsAndLevel();
  alert('Демо‑бэкап сохранён. Откройте приложение под этим tg_id — прогресс загрузится автоматически.');
}
async function demoLoadClaims() {
  if (needLogin()) return;
  const tg = document.getElementById('demo-tg').value.trim();
  const device = document.getElementById('demo-device').value.trim();
  if (!tg) return alert('Введите tg_id');
  const url = new URL(`${API}/admin/demo/claims`);
  url.searchParams.set('tg', tg);
  if (device) url.searchParams.set('device', device);
  const res = await fetch(url, { headers:{ ...authHeader() } });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const d = await res.json().catch(()=> ({}));
  const box = document.getElementById('demo-claims-list');
  if (!res.ok || !d?.ok) { box.textContent = 'Ошибка'; return; }
  const items = d.items || [];
  if (!items.length) { box.textContent = 'Заявок нет'; return; }
  box.innerHTML = items.map(c=>{
    const when = c.created_at ? new Date(c.created_at).toLocaleString() : '—';
    const devShort = (c.device_hash||'').slice(0,8);
    return `<div class="row" onclick="(function(){document.getElementById('demo-claim-id').value='${c.id}';document.getElementById('demo-device').value='${c.device_hash||''}';})()">
      <div>
        <div><b>#${c.id.slice(0,8)}</b> · dev:${devShort} · <span class="pill">${c.status}</span></div>
        <div class="muted">${when} · ${escapeHtml(c.prize_title||'')}</div>
      </div>
      <div class="muted">${c.tracking_code?('trk:'+escapeHtml(c.tracking_code)):'—'}</div>
    </div>`;
  }).join('');
}

async function demoSetShipped() {
  if (needLogin()) return;
  const tg = document.getElementById('demo-tg').value.trim();
  let device = document.getElementById('demo-device').value.trim();
  const id = document.getElementById('demo-claim-id').value.trim();
  const tracking = document.getElementById('demo-tracking').value.trim();
  if (!tg || !id || !tracking) return alert('tg/claim/tracking');

  // если device пуст — попытаемся найти его по id
  if (!device) {
    try {
      const url = new URL(`${API}/admin/demo/claims`);
      url.searchParams.set('tg', tg);
      const resList = await fetch(url, { headers:{ ...authHeader() } });
      const data = await resList.json().catch(()=> ({}));
      const it = (data.items||[]).find(x => x.id === id);
      if (it?.device_hash) device = it.device_hash;
    } catch(e){}
  }
  if (!device) return alert('Не удалось определить device_hash для этой заявки');

  const res = await fetch(`${API}/admin/demo/claim/tracking`, {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ tg, device, id, tracking })
  });
  const d = await res.json().catch(()=> ({}));
  if (!res.ok || !d?.ok) return alert('Не удалось: '+(d?.error||res.status));
  alert('Статус: shipped');
  demoLoadClaims();
}

async function demoSetDelivered() {
  if (needLogin()) return;
  const tg = document.getElementById('demo-tg').value.trim();
  let device = document.getElementById('demo-device').value.trim();
  const id = document.getElementById('demo-claim-id').value.trim();
  if (!tg || !id) return alert('tg/claim');

  if (!device) {
    try {
      const url = new URL(`${API}/admin/demo/claims`);
      url.searchParams.set('tg', tg);
      const resList = await fetch(url, { headers:{ ...authHeader() } });
      const data = await resList.json().catch(()=> ({}));
      const it = (data.items||[]).find(x => x.id === id);
      if (it?.device_hash) device = it.device_hash;
    } catch(e){}
  }
  if (!device) return alert('Не удалось определить device_hash для этой заявки');

  const res = await fetch(`${API}/admin/demo/claim/delivered`, {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ tg, device, id })
  });
  const d = await res.json().catch(()=> ({}));
  if (!res.ok || !d?.ok) return alert('Не удалось: '+(d?.error||res.status));
  alert('Статус: delivered');
  demoLoadClaims();
}

async function resetDemoClaims() {
  if (needLogin()) return;
  const tg = document.getElementById('demo-tg').value.trim();
  if (!tg) return;
  if (!confirm('Очистить DEMO‑заявки для этого tg_id?')) return;
  const res = await fetch(API + '/admin/demo/claims/reset', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...authHeader() },
    body: JSON.stringify({ tg })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const d = await res.json().catch(() => ({}));
  if (!res.ok || !d?.ok) return alert('Не очищено');
  alert('DEMO‑заявки очищены');
}

// ===== utils =====
function escapeHtml(s) { return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

// Автологин-проверка
window.addEventListener('load', () => {
  if (needLogin(true)) return;
  guardApp();
  loadClaims();

  // Авто-открытие нужной вкладки и подстановка tg из URL
  try {
    const u = new URL(window.location.href);
    const tab = (u.searchParams.get('tab') || '').trim();
    const tg  = (u.searchParams.get('tg') || '').trim();
    if (tg) {
      const inp = document.getElementById('demo-tg');
      if (inp) inp.value = tg;
    }
    if (tab && document.getElementById('tab-' + tab)) {
      switchTab(tab);
      if (tab === 'demo') {
        // подгрузим панель DEMO сразу
        loadDemoPanel();
      }
      if (tab === 'ach') {
        loadAchList();
      }
    }
  } catch (e) {}
});
</script>
</body>
</html>
