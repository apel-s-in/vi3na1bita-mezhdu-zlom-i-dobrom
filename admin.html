<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>VR Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:#0f1218;color:#e8eefc;margin:0}
    header{padding:12px 16px;background:#171d29;border-bottom:1px solid #2b3955;display:flex;align-items:center;gap:10px}
    h1{font-size:16px;margin:0;color:#9fc3ff}
    .tabs{display:flex;gap:8px;margin-left:auto}
    .tab{border:1px solid #2b3955;background:#1a2131;color:#cfe3ff;padding:6px 10px;border-radius:999px;cursor:pointer}
    .tab.active{background:#4daaff;color:#fff;border-color:#4daaff}
    main{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px;align-items:start}
    .card{background:#171d29;border:1px solid #2b3955;border-radius:10px;padding:10px}
    .row{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.07)}
    .row:last-child{border-bottom:none}
    .muted{color:#9aa8c4}
    .btn{border:none;border-radius:8px;background:#2a3550;color:#e8eefc;padding:6px 10px;cursor:pointer}
    .btn.primary{background:#E80100}
    .btn.warn{background:#8a2a2a}
    .btn.ok{background:#27b34c}
    input,textarea,select{background:#111826;color:#e8eefc;border:1px solid #2b3955;border-radius:8px;padding:7px}
    .list{max-height:70vh;overflow:auto}
    .pill{font-size:.9em;border:1px solid #2b3955;background:#1e2638;border-radius:999px;padding:2px 8px;color:#cfe3ff}
    .pill.status-pending   { background:#3a2c14; border-color:#6b4b14; color:#ffb84d; }
    .pill.status-approved  { background:#1f3a29; border-color:#2f7a4e; color:#6df59a; }
    .pill.status-shipped   { background:#1f3a29; border-color:#2f7a4e; color:#6df59a; }
    .pill.status-delivered { background:#1f3a29; border-color:#2f7a4e; color:#6df59a; }
    .pill.status-rejected  { background:#3a1f1f; border-color:#7a2f2f; color:#ff9b9b; }
    .flex{display:flex;gap:8px;align-items:center}
    .w100{width:100%}
    .split{display:grid;grid-template-columns:300px 1fr;gap:12px}
    .msg{padding:8px 10px;border-radius:10px;margin:6px 0;max-width:88%}
    .msg.user{background:#20283a}
    .msg.admin{background:#203020;margin-left:auto}
    .login-modal{position:fixed;inset:0;background:#0008;display:flex;align-items:center;justify-content:center}
    .login-box{background:#171d29;border:1px solid #2b3955;border-radius:12px;padding:16px;min-width:280px}
    .footer{padding:10px;text-align:center;color:#9aa8c4}
    .search{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}

    /* –ø—Ä–æ—Å—Ç—ã–µ –±–∞—Ä—ã –¥–ª—è  –≥—Ä–∞—Ñ–∏–∫–æ–≤ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ */
    .chart-row{display:grid;grid-template-columns:34px 1fr 40px;gap:8px;align-items:center;margin:2px 0}
    .chart-row .bar{background:#101522;border:1px solid #2b3955;border-radius:6px;height:10px;overflow:hidden}
    .chart-row .fill{background:#4daaff;height:100%}

    /* —á–µ–∫–±–æ–∫—Å—ã –¥–ª—è DEMO */
    .checkbox-container{display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none}
    .checkbox-container input[type="checkbox"]{width:16px;height:16px}

    /* DEMO: —Ç–∞–±–ª–∏—Ü–∞ –∞—á–∏–≤–æ–∫ */
    .ach-grid{display:grid;grid-template-columns:1fr;gap:6px}
    .ach-head{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-bottom:6px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#1e2638;border:1px solid #2b3955;color:#cfe3ff;font-size:.85em}
    .badge.ok{background:#203020;border-color:#2f7a4e;color:#6df59a}
    .badge.err{background:#3a1f1f;border-color:#7a2f2f;color:#ff9b9b}
    .group-title{font-weight:800;letter-spacing:.04em;color:#9fc3ff;font-size:.9em;margin:8px 0 6px 0;text-transform:uppercase}
    .ach-row{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.07)}
    .ach-row:last-child{border-bottom:none}
    .ach-id{color:#9aa8c4;font-size:.9em;margin-left:8px}
    .right-col{background:#141a25;border:1px solid #2b3955;border-radius:10px;padding:10px}
    .kbd{display:inline-block;background:#222d3f;border:1px solid #2b3955;border-radius:6px;padding:2px 6px;font-family:monospace;font-size:.86em;color:#cfe3ff}
    .hint{color:#9aa8c4;font-size:.95em;line-height:1.5}
    .hr{height:1px;background:#2b3955;margin:8px 0}
  </style>
</head>
<body>
  <header>
    <h1>VR Admin</h1>
    <div class="tabs">
      <button class="tab active" id="tab-claims">–ó–∞—è–≤–∫–∏</button>
      <button class="tab" id="tab-devices">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</button>
      <button class="tab" id="tab-backups">–ë—ç–∫–∞–ø—ã</button>
      <button class="tab" id="tab-logs">–õ–æ–≥–∏</button>
      <button class="tab" id="tab-stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
      <button class="tab" id="tab-ach">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</button>
      <button class="tab" id="tab-demo">DEMO</button>
      <button class="tab" id="tab-fb">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</button>
      <button class="tab" id="tab-prizes">–ü—Ä–∏–∑—ã</button>
      <button class="tab" id="tab-logout" title="–í—ã–π—Ç–∏">Logout</button>
    </div>
  </header>

  <!-- –ó–∞—è–≤–∫–∏ -->
  <main id="view-claims">
    <div class="card">
      <div class="search">
        <select id="claims-status" title="–°—Ç–∞—Ç—É—Å">
          <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
          <option value="pending">pending</option>
          <option value="approved">approved</option>
          <option value="rejected">rejected</option>
          <option value="shipped">shipped</option>
          <option value="delivered">delivered</option>
        </select>
        <label class="muted">—Å</label>
        <input type="date" id="claims-from" />
        <label class="muted">–ø–æ</label>
        <input type="date" id="claims-to" />
        <button class="btn" onclick="resetPaging();loadClaims()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <button class="btn" onclick="exportClaimsCSV()">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
        <div style="margin-left:auto;display:flex;gap:6px;align-items:center;">
          <button class="btn" onclick="prevPage()">‚óÄ</button>
          <span class="muted" id="claims-page-label">1</span>
          <button class="btn" onclick="nextPage()">‚ñ∂</button>
        </div>
      </div>
      <div class="list" id="claims-list"></div>
    </div>
    <div class="card">
      <div class="muted">–ö–ª–∏–∫ –ø–æ –∑–∞—è–≤–∫–µ —Å–ª–µ–≤–∞ ‚Äî –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π</div>
      <div id="claim-details" class="muted" style="margin-top:8px;">–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ</div>
      <div style="margin-top:10px;display:none" id="claim-actions">
        <div id="claim-meta" class="muted" style="margin-bottom:8px;"></div>

        <div class="flex"><label class="muted">–ü—Ä–∏—á–∏–Ω–∞ (–¥–ª—è rejected):</label><input class="w100" id="claim-reason" placeholder="–ü—Ä–∏—á–∏–Ω–∞..."></div>
        <div style="margin-top:8px;" class="flex">
          <button class="btn ok" onclick="updateClaim('approved')">–û–¥–æ–±—Ä–∏—Ç—å</button>
          <button class="btn warn" onclick="updateClaim('rejected')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
          <button class="btn" onclick="updateClaim('pending')">–í–µ—Ä–Ω—É—Ç—å –≤ pending</button>
        </div>

        <hr style="border-color:#2b3955;margin:10px 0;">

        <div class="flex">
          <input class="w100" id="claim-tracking" placeholder="–¢—Ä–µ–∫‚Äë–Ω–æ–º–µ—Ä (–¥–ª—è shipped)">
          <button class="btn" onclick="setTracking()">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</button>
          <button class="btn" onclick="markDelivered()">–ü–æ–ª—É—á–µ–Ω–æ</button>
        </div>

        <hr style="border-color:#2b3955;margin:10px 0;">

        <div class="flex">
          <label class="muted" style="min-width:90px;">–¶–≤–µ—Ç:</label>
          <select id="adm-color">
            <option value="">‚Äî</option>
            <option value="orange">–æ—Ä–∞–Ω–∂–µ–≤—ã–π (–∂–¥—ë—Ç)</option>
            <option value="green">–∑–µ–ª—ë–Ω—ã–π (–æ–∫)</option>
            <option value="red">–∫—Ä–∞—Å–Ω—ã–π</option>
            <option value="violet">—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π (–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ)</option>
          </select>
        </div>
        <div class="flex" style="margin-top:6px;">
          <label class="muted" style="min-width:90px;">–ú–µ—Ç–∫–∏:</label>
          <input class="w100" id="adm-tags" placeholder="—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é">
        </div>
        <div class="flex" style="margin-top:6px;">
          <label class="muted" style="min-width:90px;">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ:</label>
          <input type="datetime-local" id="adm-due">
        </div>
        <div class="flex" style="margin-top:6px;">
          <textarea id="adm-note" class="w100" placeholder="–ó–∞–º–µ—Ç–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"></textarea>
        </div>
        <div class="flex" style="margin-top:6px;">
          <button class="btn" onclick="saveClaimMeta()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Ç–∞</button>
          <button class="btn warn" onclick="deleteClaim()">–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É</button>
        </div>

        <hr style="border-color:#2b3955;margin:10px 0;">

        <div class="muted">–ò—Å—Ç–æ—Ä–∏—è</div>
        <div class="list" id="claim-events" style="max-height:240px;"></div>

        <hr style="border-color:#2b3955;margin:10px 0;">

        <div style="font-weight:700; margin-bottom:6px;">VIP ‚Äî –∫–æ—à–µ–ª—ë–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
        <div class="flex" style="flex-wrap:wrap; gap:6px;">
          <input id="vip-tg" placeholder="tg_id (–æ–ø—Ü.)" style="min-width:160px;">
          <input id="vip-user-id" placeholder="user_id (–æ–ø—Ü.)" style="min-width:260px;">
        </div>
        <div class="flex" style="margin-top:6px; flex-wrap:wrap; gap:6px;">
          <input id="vip-delta" placeholder="Œî –∫–æ–∏–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, 100 –∏–ª–∏ -50)" style="min-width:180px;">
          <input id="vip-reason" placeholder="–ü—Ä–∏—á–∏–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, bonus|penalty)" style="min-width:220px;">
        </div>
        <div class="flex" style="margin-top:6px; flex-wrap:wrap; gap:6px;">
          <button class="btn ok" onclick="adminVipAdjust(1)">–ù–∞—á–∏—Å–ª–∏—Ç—å</button>
          <button class="btn warn" onclick="adminVipAdjust(-1)">–°–ø–∏—Å–∞—Ç—å</button>
          <button class="btn" onclick="quickVipBonus(100)">+100</button>
          <button class="btn" onclick="quickVipBonus(500)">+500</button>
        </div>
        <div class="muted" id="vip-tx-msg" style="margin-top:6px;"></div>
      </div>
    </div>
  </main>

  <!-- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ -->
  <main id="view-devices" style="display:none">
    <div class="card">
      <div class="search">
        <input id="dev-q" placeholder="–ü–æ–∏—Å–∫ device_hash / –∏–º—è / tg_id..." class="w100">
        <button class="btn" onclick="loadDevices()">–ò—Å–∫–∞—Ç—å</button>
      </div>
      <div class="list" id="devices-list"></div>
    </div>
    <div class="card">
      <div class="muted">–ö–ª–∏–∫ –ø–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É —Å–ª–µ–≤–∞ ‚Äî –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è device_hash</div>
      <div id="devices-details" class="muted" style="margin-top:8px;">‚Äî</div>
    </div>
  </main>

  <!-- –ë—ç–∫–∞–ø—ã -->
  <main id="view-backups" style="display:none">
    <div class="card">
      <div class="search">
        <button class="btn" onclick="loadBackups()">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div class="list" id="backups-list"></div>
    </div>
    <div class="card">
      <div class="muted">–ü—Ä–æ—Å–º–æ—Ç—Ä –±—ç–∫–∞–ø–∞ (read‚Äëonly)</div>
      <pre id="backup-viewer" style="max-height:70vh; overflow:auto; background:#0f1218; border:1px solid #2b3955; border-radius:10px; padding:10px; color:#cfe3ff;"></pre>
    </div>
  </main>

  <!-- –õ–æ–≥–∏ -->
  <main id="view-logs" style="display:none">
    <div class="card">
      <div class="search" style="gap:8px;">
        <select id="logs-type" title="–¢–∏–ø">
          <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
          <option value="claim_create">claim_create</option>
          <option value="claim_update">claim_update</option>
          <option value="claim_shipped">claim_shipped</option>
          <option value="claim_delivered">claim_delivered</option>
          <option value="claim_cancel">claim_cancel</option>
          <option value="feedback">feedback</option>
          <option value="tg_link">tg_link</option>
          <option value="backup_save">backup_save</option>
          <option value="backup_user_latest">backup_user_latest</option>
          <option value="event_ingest">event_ingest</option>
          <option value="event_denied">event_denied</option>
        </select>
        <label class="muted">—Å</label>
        <input type="datetime-local" id="logs-from">
        <label class="muted">–ø–æ</label>
        <input type="datetime-local" id="logs-to">
        <input id="logs-pkey" placeholder="payload –∫–ª—é—á (a.b.c)" style="min-width:180px;">
        <select id="logs-pop" title="–û–ø–µ—Ä–∞—Ç–æ—Ä">
          <option value="contains">contains</option>
          <option value="eq">=</option>
          <option value="ne">‚â†</option>
          <option value="gt">&gt;</option>
          <option value="lt">&lt;</option>
          <option value="ge">‚â•</option>
          <option value="le">‚â§</option>
        </select>
        <input id="logs-pval" placeholder="–∑–Ω–∞—á–µ–Ω–∏–µ" style="min-width:140px;">
        <button class="btn" onclick="loadLogs()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <button class="btn" onclick="exportLogs('csv')">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
        <button class="btn" onclick="exportLogs('ndjson')">–≠–∫—Å–ø–æ—Ä—Ç NDJSON</button>
        <button class="btn warn" onclick="deleteSelectedLogs()">–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
      </div>
      <div class="list" id="logs-list"></div>
    </div>
    <div class="card">
      <div class="muted">–î–µ—Ç–∞–ª–∏ –ª–æ–≥–∞</div>
      <pre id="log-details" style="max-height:70vh; overflow:auto; background:#0f1218; border:1px solid #2b3955; border-radius:10px; padding:10px; color:#cfe3ff;"></pre>
    </div>
  </main>

  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <main id="view-stats" style="display:none">
    <div class="card">
      <div class="search">
        <button class="btn" onclick="loadMetrics()">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div id="metrics-box" class="list"></div>

      <div class="card" style="margin-top:8px;">
        <div style="font-weight:700;margin-bottom:8px;">–ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
        <div class="row">
          <div>–û–±—â–∏–π –≤—ã–∫–ª—é—á–∞—Ç–µ–ª—å</div>
          <div><label class="muted">masterEnabled</label> <input type="checkbox" id="gs-master"></div>
        </div>
        <div class="row">
          <div>–û—Ç–ø—Ä–∞–≤–∫–∞ —Å –∫–ª–∏–µ–Ω—Ç–æ–≤ (/event)</div>
          <div><label class="muted">sendEnabled</label> <input type="checkbox" id="gs-send"></div>
        </div>
        <div class="row">
          <div>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å UI –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</div>
          <div><label class="muted">showUI</label> <input type="checkbox" id="gs-ui"></div>
        </div>
        <div class="row">
          <div>–¢—Ä–µ–±–æ–≤–∞—Ç—å Turnstile</div>
          <div><label class="muted">requireTurnstile</label> <input type="checkbox" id="gs-ts"></div>
        </div>
        <div class="row">
          <div>–í–∫–ª—é—á–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä –≤ –∞–¥–º–∏–Ω–∫–µ</div>
          <div><label class="muted">monitorEnabled</label> <input type="checkbox" id="gs-mon"></div>
        </div>
        <div class="row">
          <div>–°–æ–±–∏—Ä–∞—Ç—å –æ—á–µ—Ä–µ–¥—å –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
          <div><label class="muted">collectClientQueue</label> <input type="checkbox" id="gs-cq"></div>
        </div>
        <div class="flex" style="margin-top:8px;">
          <button class="btn ok" onclick="saveGsConfig()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn" onclick="loadGsConfig()">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="muted">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</div>
      <div class="muted">–ó–¥–µ—Å—å –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏/–≥–µ–æ –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.</div>
      <div class="card" style="margin-top:8px;">
        <div style="font-weight:700;margin-bottom:6px;">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ (–ø–æ —á–∞—Å–∞–º/–ø–æ –¥–Ω—è–º) ‚Äî —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π; –≤ –∞–¥–º–∏–Ω–∫–µ –ø–æ–∫–∞ —Ç–æ–ª—å–∫–æ —Å–≤–æ–¥–∫–∞ –ø–æ —Ü–∏—Ñ—Ä–∞–º</div>
        <div id="stats-note" class="muted">–î–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ /top?period=all|today|week|month</div>
      </div>
    </div>

    <div class="card" id="gs-health-card" style="margin-top:8px; display:none;">
      <div style="font-weight:700;margin-bottom:8px;">–ú–æ–Ω–∏—Ç–æ—Ä /event (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç)</div>
      <div class="row"><div>OK</div><div class="muted" id="m-ok">0</div></div>
      <div class="row"><div>403 (Turnstile)</div><div class="muted" id="m-403">0</div></div>
      <div class="row"><div>429 (Rate limit)</div><div class="muted" id="m-429">0</div></div>
      <div class="row"><div>–ò–Ω—ã–µ –æ—Ç–∫–∞–∑—ã</div><div class="muted" id="m-other">0</div></div>
      <div class="row"><div>–û—á–µ—Ä–µ–¥—å –∫–ª–∏–µ–Ω—Ç–æ–≤ (avg / max)</div><div class="muted"><span id="m-q-avg">0</span> / <span id="m-q-max">0</span></div></div>
      <div class="flex" style="margin-top:8px;">
        <button class="btn" onclick="loadGsHealth()">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
    </div>
  </main>

  <!-- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è -->
  <main id="view-ach" style="display:none">
    <div class="card">
      <div class="search" style="gap:8px;">
        <button class="btn" onclick="loadAchList()">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn" onclick="newAchItem()">–ù–æ–≤—ã–π</button>
        <button class="btn warn" onclick="deleteAch()">–£–¥–∞–ª–∏—Ç—å</button>
        <button class="btn" onclick="copyAch()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
      <div class="list" id="ach-list"></div>
    </div>
    <div class="card">
      <div style="font-weight:700;margin-bottom:8px;">–†–µ–¥–∞–∫—Ç–æ—Ä –æ–≤–µ—Ä—Ä–∞–π–¥–∞</div>
      <div class="flex" style="flex-direction:column;gap:6px;">
        <input id="ach-id" placeholder="ID –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, play_25_total)">
        <div class="flex"><label class="muted" style="min-width:120px;">–°–∫—Ä—ã—Ç–æ–µ</label><input type="checkbox" id="ach-hidden"></div>
        <div class="flex"><label class="muted" style="min-width:120px;">Core</label><input type="checkbox" id="ach-core"></div>
        <div class="flex"><label class="muted" style="min-width:120px;">Tier</label><input id="ach-tier" placeholder="—á–∏—Å–ª–æ"></div>
        <input id="ach-title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ (title)">
        <input id="ach-short" placeholder="–ö–æ—Ä–æ—Ç–∫–æ (short)">
        <textarea id="ach-desc" class="w100" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (desc)"></textarea>
        <textarea id="ach-how" class="w100" placeholder="–ö–∞–∫ –≤—ã–ø–æ–ª–Ω–∏—Ç—å (howTo)"></textarea>
        <div class="muted">–ü–æ—Ä–æ–≥ (thresholds) ‚Äî –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö ID. –ü—Ä–∏–º–µ—Ä JSON: {"play_25_total":20,"time_listened_1h":3000}</div>
        <textarea id="ach-thresholds" class="w100" placeholder='{"play_25_total":20,"time_listened_1h":3000}'></textarea>
        <div class="flex">
          <button class="btn ok" onclick="saveAch()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn" onclick="loadAchList()">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </main>

  <!-- DEMO -->
  <main id="view-demo" style="display:none">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —á–µ–∫‚Äë–ª–∏—Å—Ç -->
    <div class="card">
      <div class="search" style="gap:8px;">
        <input id="demo-tg" placeholder="tg_id" value="118759359" style="min-width:160px;">
        <button class="btn" onclick="loadDemoPanel()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      </div>

      <div class="row">
        <div>–†–µ–∂–∏–º</div>
        <div><label class="muted">DEMO</label> <input type="checkbox" id="demo-mode"></div>
      </div>

      <div class="row">
        <div>–ò–º—è –≤ DEMO<br><span class="muted">(–≤–∏–¥–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)</span></div>
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="demo-dn" placeholder="VR Admin" style="min-width:160px;">
          <span class="badge" id="demo-level-pill" title="–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –¥–µ–º–æ-–∞–∫–∫–∞—É–Ω—Ç–∞">–£—Ä–æ–≤–µ–Ω—å: ‚Äî</span>
        </div>
      </div>

      <div class="flex" style="margin-top:8px;flex-wrap:wrap;gap:8px;">
        <button class="btn ok" onclick="saveDemoMode()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∂–∏–º</button>
        <button class="btn" onclick="buildAndSaveDemoBackup()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å DEMO‚Äë–±—ç–∫–∞–ø</button>
        <button class="btn warn" onclick="resetDemoClaims()">–û—á–∏—Å—Ç–∏—Ç—å DEMO‚Äë–∑–∞—è–≤–∫–∏</button>
      </div>

      <div class="card" style="margin-top:8px;">
        <div class="ach-head">
          <div class="badge">–í—Å–µ–≥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π: <b id="demo-total">‚Äî</b></div>
          <div class="badge ok">–û—Ç–º–µ—á–µ–Ω–æ: <b id="demo-checked">‚Äî</b></div>
          <div class="badge" id="demo-visible-badge">–í–∏–¥–∏–º—ã—Ö: ‚Äî</div>
          <div class="badge" id="demo-secret-badge">–°–µ–∫—Ä–µ—Ç–Ω—ã—Ö: ‚Äî</div>
        </div>

        <div class="flex" style="flex-wrap:wrap;gap:6px;margin-bottom:8px;">
          <button class="btn" onclick="markAllVisible(true)">–û—Ç–º–µ—Ç–∏—Ç—å –≤–∏–¥–∏–º—ã–µ</button>
          <button class="btn" onclick="markAllSecret(true)">–û—Ç–º–µ—Ç–∏—Ç—å —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ</button>
          <button class="btn" onclick="markAll(true)">–û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ 34</button>
          <button class="btn warn" onclick="markAll(false)">–°–Ω—è—Ç—å –≤—Å—ë</button>
        </div>

        <div class="flex" style="flex-wrap:wrap;gap:6px;margin-bottom:8px;">
          <button class="btn" onclick="preset5()">–ü—Ä–µ—Å–µ—Ç: 5 —É—Ä–æ–≤–Ω–µ–π</button>
          <button class="btn" onclick="presetFirstPrize()">–ü—Ä–µ—Å–µ—Ç: –¥–ª—è 1‚Äë–≥–æ –ø—Ä–∏–∑–∞</button>
          <button class="btn" onclick="presetSecondPrize()">–ü—Ä–µ—Å–µ—Ç: –¥–ª—è 2‚Äë–≥–æ –ø—Ä–∏–∑–∞</button>
        </div>

        <div id="demo-hint" class="muted" style="margin-bottom:8px;">‚Äî</div>

        <div id="demo-ach-box" class="list" style="max-height:60vh; padding-right:6px;">
          <!-- —Å—é–¥–∞ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è —á–µ–∫‚Äë–ª–∏—Å—Ç –≤—Å–µ—Ö 34 -->
        </div>
      </div>
    </div>

    <!-- –û—Ç–¥–µ–ª—å–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞: DEMO‚Äë–∑–∞—è–≤–∫–∏ -->
    <div class="card">
      <div style="font-weight:700;margin-bottom:8px;">DEMO‚Äë–∑–∞—è–≤–∫–∏</div>
      <div class="flex" style="gap:8px; flex-wrap:wrap; margin-bottom:8px;">
        <input id="demo-device" placeholder="device_hash (–æ–ø—Ü.)" style="min-width:220px;">
        <button class="btn" onclick="demoLoadClaims()">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div id="demo-claims-list" class="list" style="max-height:40vh;"></div>
      <div class="flex" style="gap:6px; margin-top:8px; flex-wrap:wrap;">
        <input id="demo-claim-id" placeholder="claim_id" style="min-width:220px;">
        <input id="demo-tracking" placeholder="—Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä (–¥–ª—è shipped)" style="min-width:220px;">
      </div>
      <div class="flex" style="gap:6px; margin-top:8px; flex-wrap:wrap;">
        <button class="btn" onclick="demoSetShipped()">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (—Ç—Ä–µ–∫)</button>
        <button class="btn ok" onclick="demoSetDelivered()">–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</button>
        <button class="btn warn" onclick="resetDemoClaims()">–û—á–∏—Å—Ç–∏—Ç—å DEMO‚Äë–∑–∞—è–≤–∫–∏</button>
      <div class="card" style="margin-top:8px;">
        <div style="font-weight:700;margin-bottom:8px;">üé¨ –ê–≤—Ç–æ—Å—Ü–µ–Ω–∞—Ä–∏–π</div>
        
        <div class="row">
          <div>–°—Ç–∞—Ç—É—Å</div>
          <div id="scenario-status" class="badge">–Ω–µ –∑–∞–ø—É—â–µ–Ω</div>
        </div>
        
        <div class="row">
          <div>–¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø</div>
          <div id="scenario-stage" class="muted">‚Äî</div>
        </div>
        
        <div class="row">
          <div>–í—ã–ø–æ–ª–Ω–µ–Ω–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</div>
          <div id="scenario-achievements" class="muted">0</div>
        </div>
        
        <div class="flex" style="margin-top:8px; flex-wrap:wrap; gap:6px;">
          <label>–°–∫–æ—Ä–æ—Å—Ç—å:</label>
          <select id="scenario-speed">
            <option value="1">1x</option>
            <option value="2">2x</option>
            <option value="5">5x</option>
            <option value="10">10x</option>
            <option value="0">–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ</option>
          </select>
          
          <label class="checkbox-container">
            <input type="checkbox" id="scenario-auto-prizes">
            <span>–ê–≤—Ç–æ-–≤—ã–±–æ—Ä –ø—Ä–∏–∑–æ–≤</span>
          </label>
        </div>
        
        <div class="flex" style="margin-top:8px; flex-wrap:wrap; gap:6px;">
          <button class="btn ok" onclick="startScenario()">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
          <button class="btn" onclick="pauseScenario()">‚è∏ –ü–∞—É–∑–∞</button>
          <button class="btn warn" onclick="resetScenario()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
          <button class="btn" onclick="refreshScenarioStatus()">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
        </div>
        
        <div class="muted" id="scenario-hint" style="margin-top:8px;">
          –ê–≤—Ç–æ—Å—Ü–µ–Ω–∞—Ä–∏–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤—Å–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é.
          –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –≤–∏–¥–∏–º—ã—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–±–æ—Ä –ø—Ä–∏–∑–∞.
        </div>
      </div>
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –∫—Ä–∞—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
    <div class="right-col">
      <div style="font-weight:700;margin-bottom:8px;">–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è DEMO</div>
      <div class="hint">
        <p><b>–†–µ–∂–∏–º DEMO</b> –ø–æ–∑–≤–æ–ª—è–µ—Ç —ç–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ tg_id, –Ω–µ –≤–ª–∏—è—è –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.</p>
        <div class="hr"></div>
        <p><b>–®–∞–≥–∏:</b></p>
        <ol>
          <li>–£–∫–∞–∂–∏—Ç–µ <span class="kbd">tg_id</span> –∏ –Ω–∞–∂–º–∏—Ç–µ <span class="kbd">–ó–∞–≥—Ä—É–∑–∏—Ç—å</span>.</li>
          <li>–í–∫–ª—é—á–∏—Ç–µ —Ç—É–º–±–ª–µ—Ä <span class="kbd">DEMO</span> –∏ –∑–∞–¥–∞–π—Ç–µ ¬´–ò–º—è –≤ DEMO¬ª (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚ÄúVR Admin‚Äù). –ù–∞–∂–º–∏—Ç–µ <span class="kbd">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∂–∏–º</span>.</li>
          <li>–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≥–∞–ª–æ—á–∫–∞–º–∏ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–µ—Å–µ—Ç—ã:
            <ul>
              <li><b>5 —É—Ä–æ–≤–Ω–µ–π</b> ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —á—Ç–æ–±—ã –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –ø–æ—è–≤–∏–ª–æ—Å—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞—Ç—å –∏–º—è.</li>
              <li><b>–î–ª—è 1‚Äë–≥–æ –ø—Ä–∏–∑–∞</b> ‚Äî –æ—Ç–º–µ—á–∞–µ—Ç –≤—Å–µ –≤–∏–¥–∏–º—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è. –í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –ø–æ–¥–∞–≤–∞—Ç—å –∑–∞—è–≤–∫—É.</li>
              <li><b>–î–ª—è 2‚Äë–≥–æ –ø—Ä–∏–∑–∞</b> ‚Äî –æ—Ç–º–µ—á–∞–µ—Ç –≤–∏–¥–∏–º—ã–µ –∏ —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è. –ß—Ç–æ–±—ã –ø–æ—è–≤–∏–ª–∞—Å—å –∫–Ω–æ–ø–∫–∞ ‚Äú–ü–û–õ–£–ß–ò–¢–¨ –ï–©–Å –ü–†–ò–ó–´‚Äù, –Ω—É–∂–Ω–∞ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–∞—è DEMO‚Äë–∑–∞—è–≤–∫–∞ (—Å–º. –Ω–∏–∂–µ).</li>
            </ul>
          </li>
          <li>–ù–∞–∂–º–∏—Ç–µ <span class="kbd">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å DEMO‚Äë–±—ç–∫–∞–ø</span>. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥ —ç—Ç–∏–º tg_id ‚Äî –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</li>
        </ol>
        <div class="hr"></div>
        <p><b>–ó–∞—è–≤–∫–∏ –≤ DEMO:</b> —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –∏—Ö –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∫–∞–∫ –æ–±—ã—á–Ω–æ. –í DEMO —Å–æ–±—ã—Ç–∏—è /event –Ω–µ –ø–æ—Ä—Ç—è—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—á—ë—Ç—á–∏–∫–∏, –∑–∞—è–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ø–µ—Å–æ—á–Ω–∏—Ü–µ.</p>
        <p>–ß—Ç–æ–±—ã ‚Äú–ü–û–õ–£–ß–ò–¢–¨ –ï–©–Å –ü–†–ò–ó–´‚Äù —Å—Ç–∞–ª–æ –∞–∫—Ç–∏–≤–Ω–æ, —Å–¥–µ–ª–∞–π—Ç–µ –∑–∞—è–≤–∫—É –∏ –æ—Ç–º–µ—Ç—å—Ç–µ –µ—ë –∫–∞–∫ <i>–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é</i> (–Ω—É–∂–Ω—ã DEMO‚Äë–º–µ—Ç–æ–¥—ã –Ω–∞ –±—ç–∫–µ–Ω–¥–µ: /admin/demo/claim/tracking ‚Üí shipped –∏ /admin/demo/claim/delivered ‚Üí delivered).</p>
        <div class="hr"></div>
        <p><b>–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —É—Ä–æ–≤–Ω—è</b> —Å–ø—Ä–∞–≤–∞ –æ—Ç –∏–º–µ–Ω–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å: X / 34 (–ø–æ –¥–µ–º–æ‚Äë–±—ç–∫–∞–ø—É, –µ—Å–ª–∏ –æ–Ω —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω; –∏–Ω–∞—á–µ ‚Äî –ø–æ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–º –≥–∞–ª–æ—á–∫–∞–º).</p>
      </div>
    </div>
  </main>

  <!-- –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å -->
  <main id="view-fb" style="display:none">
    <div class="card">
      <div class="search">
        <input id="fb-q" placeholder="–ü–æ–∏—Å–∫ –∫–æ–¥–∞/—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞..." class="w100">
        <button class="btn" onclick="loadThreads()">–ò—Å–∫–∞—Ç—å</button>
      </div>
      <div class="list" id="thread-list"></div>
    </div>
    <div class="card">
      <div id="thread-head" class="muted">–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–¥ —Å–ª–µ–≤–∞</div>
      <div class="list" id="msg-list" style="height:50vh;"></div>
      <div class="flex" style="margin-top:8px;">
        <input id="fb-reply" class="w100" placeholder="–û—Ç–≤–µ—Ç–∏—Ç—å...">
        <button class="btn primary" onclick="sendReply()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </main>

  <!-- –ü—Ä–∏–∑—ã -->
  <main id="view-prizes" style="display:none">
    <div class="card">
      <div class="search">
        <button class="btn" onclick="loadPrizesAdmin()">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div class="list" id="adm-prizes-list"></div>
    </div>
    <div class="card">
      <div style="font-weight:700;margin-bottom:8px;">–†–µ–¥–∞–∫—Ç–æ—Ä</div>
      <div class="flex" style="flex-direction:column;gap:6px;">
        <input id="adm-prize-id" placeholder="ID (–ø—É—Å—Ç–æ –¥–ª—è –Ω–æ–≤–æ–≥–æ)">
        <input id="adm-prize-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        <input id="adm-prize-short" placeholder="–ö–æ—Ä–æ—Ç–∫–æ">
        <textarea id="adm-prize-long" class="w100" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
        <input id="adm-prize-img" placeholder="URL –∫–∞—Ä—Ç–∏–Ω–∫–∏ (img/...)">
        <div class="flex">
          <button class="btn ok" onclick="savePrize()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn warn" onclick="deletePrize()">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </main>

  <div class="footer">v1 ‚Ä¢ Basic Auth ‚Ä¢ –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ HTTPS</div>

  <div id="login" class="login-modal" style="display:none;">
    <div class="login-box">
      <div style="font-weight:700;margin-bottom:8px;">–í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>
      <div class="flex" style="flex-direction:column;gap:6px;">
        <input id="adm-user" placeholder="–õ–æ–≥–∏–Ω">
        <input id="adm-pass" placeholder="–ü–∞—Ä–æ–ª—å" type="password">
        <button class="btn primary" onclick="adminLogin()">–í–æ–π—Ç–∏</button>
      </div>
      <div id="login-err" class="muted" style="margin-top:8px;color:#ffb3b3;"></div>
    </div>
  </div>

<script>
const API = 'https://vr-backend.apel-s-in.workers.dev';
const authKey = 'vr_admin_auth';

function authHeader() {
  const tok = sessionStorage.getItem(authKey);
  return tok ? { 'Authorization': tok } : {};
}

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/–ø—Ä—è—á–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
function guardApp() {
  const authed = !!sessionStorage.getItem(authKey);
  document.querySelectorAll('header, main, .footer').forEach(el => {
    if (!el) return;
    el.style.display = authed ? '' : 'none';
  });
  const login = document.getElementById('login');
  if (login) login.style.display = authed ? 'none' : '';
  return authed;
}
function needLogin(show = true) {
  const has = !!sessionStorage.getItem(authKey);
  if (!has && show) guardApp();
  return !has;
}
function adminLogin() {
  const u = document.getElementById('adm-user').value.trim();
  const p = document.getElementById('adm-pass').value.trim();
  if (!u || !p) {
    document.getElementById('login-err').textContent = '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å';
    return;
  }
  const token = 'Basic ' + btoa(u + ':' + p);
  sessionStorage.setItem(authKey, token);
  if (guardApp()) loadClaims();
}
document.addEventListener('keydown', (e) => {
  const loginShown = document.getElementById('login')?.style.display !== 'none';
  if (!loginShown) return;
  if (e.key === 'Enter') adminLogin();
});

function switchTab(tab) {
  const tabs = ['claims','devices','backups','logs','stats','ach','demo','fb','prizes'];
  tabs.forEach(t => document.getElementById('tab-'+t)?.classList.toggle('active', tab===t));
  tabs.forEach(t => document.getElementById('view-'+t)?.style && (document.getElementById('view-'+t).style.display = (tab===t)?'':'none'));
  if (tab==='prizes') loadPrizesAdmin();
  if (tab==='devices') loadDevices();
  if (tab==='backups') loadBackups();
  if (tab==='logs') loadLogs();
  if (tab==='stats') { loadMetrics(); loadGsConfig(); }
  if (tab==='ach') loadAchList();
  if (tab==='demo') loadDemoPanel();
}
document.getElementById('tab-claims').onclick = ()=>switchTab('claims');
document.getElementById('tab-devices').onclick = ()=>switchTab('devices');
document.getElementById('tab-backups').onclick = ()=>switchTab('backups');
document.getElementById('tab-logs').onclick = ()=>switchTab('logs');
document.getElementById('tab-stats').onclick = ()=>switchTab('stats');
document.getElementById('tab-ach').onclick = ()=>switchTab('ach');
document.getElementById('tab-demo').onclick = ()=>switchTab('demo');
document.getElementById('tab-fb').onclick = ()=>switchTab('fb');
document.getElementById('tab-prizes').onclick = ()=>switchTab('prizes');
document.getElementById('tab-logout').onclick = ()=>{ sessionStorage.removeItem(authKey); guardApp(); needLogin(true); };

// ===== –ó–∞—è–≤–∫–∏ =====
let currentClaim = null;
let currentClaimUserId = null; // –ù–û–í–û–ï: user_id –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∑–∞—è–≤–∫–∏
let currentClaimTgId = null;   // –ù–û–í–û–ï: tg_id –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∑–∞—è–≤–∫–∏
let pageSize = 50;
let currentOffset = 0;

function resetPaging() { currentOffset = 0; document.getElementById('claims-page-label').textContent = '1'; }
function nextPage() { currentOffset += pageSize; loadClaims(); }
function prevPage() {
  currentOffset = Math.max(0, currentOffset - pageSize);
  const curPage = Math.floor(currentOffset / pageSize) + 1;
  document.getElementById('claims-page-label').textContent = String(curPage);
  loadClaims();
}
function readDateInput(id) {
  const v = document.getElementById(id)?.value;
  if (!v) return null;
  try {
    const dt = new Date(v);
    if (id === 'claims-to') dt.setHours(23,59,59,999);
    return dt.toISOString();
  } catch { return null; }
}
async function loadClaims() {
  if (needLogin()) return;
  const st  = document.getElementById('claims-status').value;
  const from= readDateInput('claims-from');
  const to  = readDateInput('claims-to');

  const url = new URL(API + '/admin/claims');
  if (st) url.searchParams.set('status', st);
  if (from) url.searchParams.set('from', from);
  if (to) url.searchParams.set('to', to);
  url.searchParams.set('limit', String(pageSize));
  url.searchParams.set('offset', String(currentOffset));

  const res = await fetch(url, { headers: { ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const list = document.getElementById('claims-list');
  if (!data?.ok) { list.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'; return; }

  const items = data.items || [];
  const curPage = Math.floor(currentOffset / pageSize) + 1;
  document.getElementById('claims-page-label').textContent = String(curPage);

  list.innerHTML = items.map(c=>{
    const dt = new Date(c.created_at).toLocaleString();
    const stClass = `status-${c.status}`;
    const tgShort = c.tg_id ? ` ¬∑ tg:${String(c.tg_id).slice(0,8)}‚Ä¶` : '';
    const attrs = `data-user="${escapeHtml(c.user_id||'')}" data-tg="${escapeHtml(c.tg_id||'')}"`;
    return `<div class="row" ${attrs} onclick="selectClaim('${c.id}', this)">
      <div>
        <div><span class="pill ${stClass}">${c.status}</span> <b>${escapeHtml(c.user_name||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')}</b></div>
        <div class="muted">#${c.id.slice(0,8)} ¬∑ dev:${(c.device_hash||'').slice(0,8)}${tgShort} ¬∑ lvl:${c.level} ¬∑ cyc:${c.cycle}</div>
      </div>
      <div class="muted">${dt}</div>
    </div>`;
  }).join('');

  if (items.length === 0 && currentOffset > 0) prevPage();

  document.getElementById('claim-details').textContent = '–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ';
  document.getElementById('claim-actions').style.display = 'none';
  currentClaim = null;
}
async function selectClaim(id, rowEl) {
  const el = document.getElementById('claim-details');
  el.innerHTML = `–ó–∞—è–≤–∫–∞ <b>#${id}</b><br><span class="muted">–°—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞–º–∏ –Ω–∏–∂–µ</span>`;
  currentClaim = id;

  // –ù–û–í–û–ï: —Å–æ—Ö—Ä–∞–Ω–∏–º user_id –∏ tg_id –¥–ª—è VIP-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
  try {
    currentClaimUserId = rowEl?.getAttribute('data-user') || null;
    currentClaimTgId = rowEl?.getAttribute('data-tg') || null;
    // –∞–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–≤–∏–º –≤ –ø–æ–ª—è —Ñ–æ—Ä–º—ã VIP
    const fTg = document.getElementById('vip-tg'); if (fTg && currentClaimTgId) fTg.value = currentClaimTgId;
    const fUid = document.getElementById('vip-user-id'); if (fUid && currentClaimUserId) fUid.value = currentClaimUserId;
  } catch(e){}

  document.getElementById('claim-actions').style.display = '';
  loadClaimMeta();
  loadClaimEvents();
}

async function loadClaimMeta() {
  if (!currentClaim) return;
  const metaBox = document.getElementById('claim-meta');
  try {
    const url = new URL(API + '/admin/claim/meta/get');
    url.searchParams.set('id', currentClaim);
    const res = await fetch(url, { headers:{ ...authHeader() }});
    if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
    const data = await res.json().catch(()=> ({}));
    if (!res.ok || !data?.ok) { metaBox.textContent = '–ú–µ—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'; return; }
    const m = data.meta || {};
    document.getElementById('adm-color').value = m.color || '';
    document.getElementById('adm-tags').value = (Array.isArray(m.tags) ? m.tags.join(', ') : '');
    document.getElementById('adm-note').value = m.note || '';
    if (m.dueAt) {
      const dt = new Date(m.dueAt);
      const iso = dt.toISOString().slice(0,16);
      document.getElementById('adm-due').value = iso;
    } else document.getElementById('adm-due').value = '';
    metaBox.innerHTML = `dev/tg –∏ –ø—Ä–æ—á–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å–ø–∏—Å–∫–µ —Å–ª–µ–≤–∞ ¬∑ <span class="muted">–º–æ–¥–∏—Ñ.: ${m.updatedAt?new Date(m.updatedAt).toLocaleString():'‚Äî'}</span>`;
  } catch {
    if (metaBox) metaBox.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç–∞';
  }
}
async function saveClaimMeta() {
  if (needLogin()) return;
  if (!currentClaim) return;
  const color = document.getElementById('adm-color').value;
  const tags = (document.getElementById('adm-tags').value || '').split(',').map(s=>s.trim()).filter(Boolean);
  const note = document.getElementById('adm-note').value || '';
  const dueStr = document.getElementById('adm-due').value;
  let dueAt = null; try { if (dueStr) dueAt = new Date(dueStr).getTime(); } catch(e){}
  const res = await fetch(API + '/admin/claim/meta/set', {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ id: currentClaim, color, tags, note, dueAt })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('–ú–µ—Ç–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: '+(data?.error||res.status)); return; }
  alert('–ú–µ—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞'); loadClaimMeta();
}
async function loadClaimEvents() {
  if (!currentClaim) return;
  const box = document.getElementById('claim-events');
  try {
    const url = new URL(API + '/admin/claim/events');
    url.searchParams.set('id', currentClaim);
    const res = await fetch(url, { headers:{ ...authHeader() }});
    if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
    const data = await res.json().catch(()=> ({}));
    if (!res.ok || !data?.ok) { box.textContent = '–ò—Å—Ç–æ—Ä–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'; return; }
    const items = data.items || [];
    if (!items.length) { box.textContent = '–ü—É—Å—Ç–æ'; return; }
    box.innerHTML = items.map(ev=>{
      const dt = new Date(ev.at).toLocaleString();
      return `<div class="row"><div><b>${ev.type}</b></div><div class="muted">${dt}</div></div>`;
    }).join('');
  } catch { box.textContent = '–û—à–∏–±–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏'; }
}
async function deleteClaim() {
  if (!currentClaim) return;
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è?')) return;
  const res = await fetch(API + '/admin/claim/delete', {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() }, body: JSON.stringify({ id: currentClaim })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å: '+(data?.error||res.status)); return; }
  alert('–£–¥–∞–ª–µ–Ω–æ'); currentClaim = null; document.getElementById('claim-actions').style.display = 'none'; loadClaims();
}
async function updateClaim(next) {
  if (!currentClaim) return;
  const reason = document.getElementById('claim-reason').value.trim();
  const res = await fetch(API+'/admin/claim/update', {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ id: currentClaim, status: next, reason: (next==='rejected'?reason:null) })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('–û—à–∏–±–∫–∞: '+(data?.error||res.status)); return; }
  alert('–ì–æ—Ç–æ–≤–æ: '+next); loadClaims();
}
async function setTracking() {
  if (!currentClaim) return;
  const tracking = document.getElementById('claim-tracking').value.trim();
  if (!tracking) { alert('–í–≤–µ–¥–∏—Ç–µ —Ç—Ä–µ–∫‚Äë–Ω–æ–º–µ—Ä'); return; }
  const res = await fetch(API+'/admin/claim/tracking', {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ id: currentClaim, tracking })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('–û—à–∏–±–∫–∞: '+(data?.error||res.status)); return; }
  alert('–°—Ç–∞—Ç—É—Å: shipped, —Ç—Ä–µ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'); loadClaims();
}
async function markDelivered() {
  if (!currentClaim) return;
  const res = await fetch(API+'/admin/claim/delivered', {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ id: currentClaim })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('–û—à–∏–±–∫–∞: '+(data?.error||res.status)); return; }
  alert('–°—Ç–∞—Ç—É—Å: delivered'); loadClaims();
}
async function exportClaimsCSV() {
  if (needLogin()) return;
  const st  = document.getElementById('claims-status').value;
  const from= readDateInput('claims-from');
  const to  = readDateInput('claims-to');

  const url = new URL(API + '/admin/claims/export');
  if (st) url.searchParams.set('status', st);
  if (from) url.searchParams.set('from', from);
  if (to) url.searchParams.set('to', to);

  const res = await fetch(url, { headers: { ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const blob = await res.blob();
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `claims-${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
}

// ===== Admin VIP wallet ops =====
async function adminVipAdjust(sign = 1) {
  if (needLogin()) return;
  const tg = (document.getElementById('vip-tg')?.value || '').trim();
  const userId = (document.getElementById('vip-user-id')?.value || '').trim();
  const deltaStr = (document.getElementById('vip-delta')?.value || '').trim();
  const reason = (document.getElementById('vip-reason')?.value || '').trim() || (sign>0?'bonus':'penalty');
  const msg = document.getElementById('vip-tx-msg');

  let delta = Number(deltaStr);
  if (!Number.isFinite(delta) || delta === 0) {
    if (msg) msg.textContent = '–£–∫–∞–∂–∏—Ç–µ –Ω–µ–Ω—É–ª–µ–≤–æ–µ —á–∏—Å–ª–æ –¥–ª—è Œî –∫–æ–∏–Ω—ã';
    return;
  }
  delta = Math.abs(delta) * (sign >= 0 ? 1 : -1);

  if (!tg && !userId) {
    if (msg) msg.textContent = '–£–∫–∞–∂–∏—Ç–µ tg_id –∏–ª–∏ user_id';
    return;
  }

  try {
    const body = { delta, reason };
    if (userId) body.userId = userId;
    else body.tgId = tg;

    const res = await fetch(API + '/admin/vip/tx', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', ...authHeader() },
      body: JSON.stringify(body)
    });
    const d = await res.json().catch(()=> ({}));
    if (!res.ok || !d?.ok) {
      if (msg) msg.textContent = '–û—à–∏–±–∫–∞: ' + (d?.error || res.status);
      return;
    }
    if (msg) msg.textContent = `–ì–æ—Ç–æ–≤–æ. –ë–∞–ª–∞–Ω—Å: ${d.balance}`;
    alert('–û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞. –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: ' + d.balance);
  } catch (e) {
    if (msg) msg.textContent = '–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
  }
}
function quickVipBonus(val) {
  const inp = document.getElementById('vip-delta');
  if (inp) inp.value = String(val);
  adminVipAdjust(1);
}

// ===== Feedback =====
let currentThread = null;
async function loadThreads() {
  if (needLogin()) return;
  const q = document.getElementById('fb-q').value.trim();
  const url = new URL(API + '/admin/feedback/threads');
  if (q) url.searchParams.set('q', q);
  url.searchParams.set('limit','100');
  const res = await fetch(url, { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const list = document.getElementById('thread-list');
  if (!data?.ok) { list.textContent = '–û—à–∏–±–∫–∞'; return; }
  list.innerHTML = (data.items||[]).map(t=>{
    const dt = new Date(t.last_message_at).toLocaleString();
    const st = t.status || 'open';
    return `<div class="row" onclick="openThread('${t.id}','${t.code}','${st}')">
      <div>
        <div><b>#${t.code}</b> ¬∑ ${t.user_name||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} ¬∑ <span class="pill">${st}</span></div>
        <div class="muted">dev:${(t.device_hash||'').slice(0,8)} ¬∑ ${new Date(t.created_at).toLocaleDateString()}</div>
      </div>
      <div class="muted">${dt}</div>
    </div>`;
  }).join('');
  document.getElementById('thread-head').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–¥ —Å–ª–µ–≤–∞';
  document.getElementById('msg-list').innerHTML = '';
  currentThread = null;
}
async function openThread(id, code, status='open') {
  currentThread = { id, code, status };
  const head = document.getElementById('thread-head');
  head.innerHTML = `–î–∏–∞–ª–æ–≥ <b>#${code}</b> ¬∑ <span class="pill">${status}</span>
    <button class="btn" style="margin-left:8px" onclick="toggleThreadStatus()">${status==='closed'?'–û—Ç–∫—Ä—ã—Ç—å':'–ó–∞–∫—Ä—ã—Ç—å'}</button>`;
  await loadMessages();
}
async function toggleThreadStatus() {
  if (!currentThread) return;
  const next = currentThread.status === 'closed' ? 'open' : 'closed';
  const res = await fetch(API + '/admin/feedback/close', {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ threadId: currentThread.id, status: next })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('–û—à–∏–±–∫–∞: '+(data?.error||res.status)); return; }
  currentThread.status = next; openThread(currentThread.id, currentThread.code, currentThread.status);
}
async function loadMessages() {
  if (!currentThread) return;
  const url = new URL(API + '/admin/feedback/messages');
  url.searchParams.set('thread', currentThread.id);
  const res = await fetch(url, { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const list = document.getElementById('msg-list');
  if (!data?.ok) { list.textContent = '–û—à–∏–±–∫–∞'; return; }
  list.innerHTML = (data.items||[]).map(m=>{
    const dt = new Date(m.created_at).toLocaleString();
    const cls = m.sender==='admin'?'msg admin':'msg user';
    return `<div class="${cls}"><div>${escapeHtml(m.text)}</div><div class="muted" style="font-size:.8em;margin-top:4px">${dt}</div></div>`;
  }).join('');
  list.scrollTop = list.scrollHeight;
}
async function sendReply() {
  const inp = document.getElementById('fb-reply');
  const text = (inp.value||'').trim();
  if (!text || !currentThread) return;
  const res = await fetch(API+'/admin/feedback/reply', {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ threadId: currentThread.id, text })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('–ù–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: '+(data?.error||res.status)); return; }
  inp.value = ''; loadMessages();
}

// ===== –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ =====
async function loadDevices() {
  if (needLogin()) return;
  const q = document.getElementById('dev-q').value.trim();
  const url = new URL(API + '/admin/devices');
  if (q) url.searchParams.set('q', q);
  url.searchParams.set('limit', '100');
  const res = await fetch(url, { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const list = document.getElementById('devices-list');
  if (!data?.ok) { list.textContent = '–û—à–∏–±–∫–∞'; return; }
  list.innerHTML = (data.items||[]).map(d=>{
    const dt1 = new Date(d.first_seen).toLocaleString();
    const dt2 = new Date(d.last_seen).toLocaleString();
    const claimStat = `T:${d.claims_total||0} ‚Ä¢ p:${d.claims_pending||0} ‚Ä¢ a:${d.claims_approved||0} ‚Ä¢ s:${d.claims_shipped||0} ‚Ä¢ d:${d.claims_delivered||0} ‚Ä¢ r:${d.claims_rejected||0}`;
    const user = `${escapeHtml(d.user_name||'‚Äî')} ${d.tg_id?('¬∑ tg:'+String(d.tg_id)) : ''}`;
    return `<div class="row" onclick="copyDeviceHash('${d.device_hash}')">
      <div>
        <div><b>dev:${escapeHtml(d.device_hash.slice(0,12))}‚Ä¶</b> ¬∑ ${user}</div>
        <div class="muted">${dt1} ‚Üí ${dt2}</div>
      </div>
      <div class="muted">${claimStat}</div>
    </div>`;
  }).join('');
  document.getElementById('devices-details').textContent = '‚Äî';
}
function copyDeviceHash(hash) {
  navigator.clipboard?.writeText(hash);
  const box = document.getElementById('devices-details');
  if (box) box.textContent = `–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: ${hash}`;
}

// ===== –ë—ç–∫–∞–ø—ã =====
async function loadBackups() {
  if (needLogin()) return;
  const res = await fetch(API + '/admin/backups/list', { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const list = document.getElementById('backups-list');
  if (!data?.ok) { list.textContent = '–û—à–∏–±–∫–∞'; return; }
  list.innerHTML = (data.items||[]).map(b=>{
    const when = b.exportedAt ? new Date(b.exportedAt).toLocaleString() : '‚Äî';
    return `<div class="row">
      <div>
        <div><b>dev:${escapeHtml((b.device||'').slice(0,12))}‚Ä¶</b></div>
        <div class="muted">${when}</div>
      </div>
      <div class="flex">
        <div class="muted" style="max-width:220px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(b.checksum||'')}</div>
        <button class="btn" onclick="viewBackup('${b.device}')">–û—Ç–∫—Ä—ã—Ç—å</button>
      </div>
    </div>`;
  }).join('');
  document.getElementById('backup-viewer').textContent = '';
}
async function viewBackup(device) {
  if (needLogin()) return;
  const url = new URL(API + '/admin/backup/get');
  url.searchParams.set('device', device);
  const res = await fetch(url, { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const pre = document.getElementById('backup-viewer');
  if (!data?.ok) { pre.textContent = '–û—à–∏–±–∫–∞'; return; }
  pre.textContent = JSON.stringify(data.backup, null, 2);
}

// ===== –õ–æ–≥–∏ =====
let __selectedLogKeys = new Set();
function readDTLocal(id) {
  const v = document.getElementById(id)?.value;
  if (!v) return null;
  try { return new Date(v).toISOString(); } catch { return null; }
}
async function loadLogs() {
  if (needLogin()) return;
  __selectedLogKeys = new Set();
  const type = document.getElementById('logs-type').value;
  const from = readDTLocal('logs-from');
  const to   = readDTLocal('logs-to');
  const pkey = document.getElementById('logs-pkey').value.trim();
  const pop  = document.getElementById('logs-pop').value;
  const pval = document.getElementById('logs-pval').value.trim();

  const url = new URL(API + '/admin/logs');
  if (type) url.searchParams.set('type', type);
  if (from) url.searchParams.set('from', from);
  if (to) url.searchParams.set('to', to);
  if (pkey) url.searchParams.set('pkey', pkey);
  if (pop)  url.searchParams.set('pop', pop);
  if (pval) url.searchParams.set('pval', pval);
  url.searchParams.set('limit', '100');

  const res = await fetch(url, { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const list = document.getElementById('logs-list');
  if (!data?.ok) { list.textContent = '–û—à–∏–±–∫–∞'; return; }

  list.innerHTML = (data.items||[]).map(l=>{
    const when = l.ts ? new Date(l.ts).toLocaleString() : '‚Äî';
    const payloadShort = escapeHtml(JSON.stringify(l.payload||{})).slice(0,120);
    return `<div class="row">
      <div onclick="selectLog('${l.key}')">
        <div><span class="pill">${escapeHtml(l.type||'log')}</span> <b>${when}</b></div>
        <div class="muted">${payloadShort}</div>
      </div>
      <div>
        <input type="checkbox" onchange="toggleLogKey('${l.key}', this.checked)">
      </div>
    </div>`;
  }).join('');
  document.getElementById('log-details').textContent = '';
}
function toggleLogKey(key, checked) {
  if (checked) __selectedLogKeys.add(key); else __selectedLogKeys.delete(key);
}
async function selectLog(key) {
  if (needLogin()) return;
  const type = document.getElementById('logs-type').value;
  const from = readDTLocal('logs-from');
  const to   = readDTLocal('logs-to');
  const pkey = document.getElementById('logs-pkey').value.trim();
  const pop  = document.getElementById('logs-pop').value;
  const pval = document.getElementById('logs-pval').value.trim();
  const url = new URL(API + '/admin/logs');
  if (type) url.searchParams.set('type', type);
  if (from) url.searchParams.set('from', from);
  if (to) url.searchParams.set('to', to);
  if (pkey) url.searchParams.set('pkey', pkey);
  if (pop)  url.searchParams.set('pop', pop);
  if (pval) url.searchParams.set('pval', pval);
  url.searchParams.set('limit', '100');
  const resp = await fetch(url, { headers:{ ...authHeader() }});
  const data = await resp.json().catch(()=> ({}));
  const it = (data.items||[]).find(x => x.key === key);
  document.getElementById('log-details').textContent = it ? JSON.stringify(it, null, 2) : '–ù–µ –Ω–∞–π–¥–µ–Ω';
}
async function deleteSelectedLogs() {
  if (!__selectedLogKeys.size) { alert('–ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –ª–æ–≥–∞'); return; }
  if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${__selectedLogKeys.size} –ª–æ–≥–æ–≤?`)) return;
  const res = await fetch(API + '/admin/logs/delete', {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ keys: Array.from(__selectedLogKeys) })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (data?.error||res.status)); return; }
  alert('–£–¥–∞–ª–µ–Ω–æ'); loadLogs();
}
async function exportLogs(fmt) {
  if (needLogin()) return;
  const type = document.getElementById('logs-type').value;
  const from = readDTLocal('logs-from');
  const to   = readDTLocal('logs-to');
  const pkey = document.getElementById('logs-pkey').value.trim();
  const pop  = document.getElementById('logs-pop').value;
  const pval = document.getElementById('logs-pval').value.trim();

  const url = new URL(API + '/admin/logs/export');
  url.searchParams.set('format', fmt || 'csv');
  if (type) url.searchParams.set('type', type);
  if (from) url.searchParams.set('from', from);
  if (to)   url.searchParams.set('to', to);
  if (pkey) url.searchParams.set('pkey', pkey);
  if (pop)  url.searchParams.set('pop', pop);
  if (pval) url.searchParams.set('pval', pval);
  url.searchParams.set('limit', '20000');

  const res = await fetch(url, { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const blob = await res.blob();
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `logs-${new Date().toISOString().slice(0,19).replace(/[T:]/g,'-')}.${fmt==='ndjson'?'ndjson':'csv'}`;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
}

// ===== –°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ =====
async function loadMetrics() {
  if (needLogin()) return;
  const res = await fetch(API + '/admin/metrics/summary', { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const box = document.getElementById('metrics-box');
  if (!data?.ok) { box.textContent = '–û—à–∏–±–∫–∞'; return; }
  const byStatus = (data.claimsByStatus||[]).map(s=> `<div class="row"><div>${s.status}</div><div class="muted">${s.c}</div></div>`).join('');
  box.innerHTML = `
    <div class="row"><div>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div><div class="muted">${data.users}</div></div>
    <div class="row"><div>–£—Å—Ç—Ä–æ–π—Å—Ç–≤</div><div class="muted">${data.devices}</div></div>
    <div class="row"><div>–ó–∞—è–≤–æ–∫</div><div class="muted">${data.claims}</div></div>
    <div class="row"><div>–î–∏–∞–ª–æ–≥–æ–≤ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏</div><div class="muted">${data.feedback_threads}</div></div>
    <div class="row"><div>–°–æ–æ–±—â–µ–Ω–∏–π</div><div class="muted">${data.feedback_messages}</div></div>
    <div class="row"><div><b>–ó–∞—è–≤–∫–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</b></div><div></div></div>
    ${byStatus || '<div class="muted">‚Äî</div>'}
  `;
}

// ===== GS Config (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π) =====
async function loadGsConfig() {
  if (needLogin()) return;
  const res = await fetch(API + '/admin/gs/config', { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('–û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏'); return; }
  const c = data.config || {};
  document.getElementById('gs-master').checked = !!c.masterEnabled;
  document.getElementById('gs-send').checked = !!c.sendEnabled;
  document.getElementById('gs-ui').checked = !!c.showUI;
  document.getElementById('gs-ts').checked = !!c.requireTurnstile;
  document.getElementById('gs-mon').checked = !!c.monitorEnabled;
  document.getElementById('gs-cq').checked = !!c.collectClientQueue;

  const monCard = document.getElementById('gs-health-card');
  if (monCard) monCard.style.display = c.monitorEnabled ? '' : 'none';
  if (c.monitorEnabled) loadGsHealth();
}
async function saveGsConfig() {
  if (needLogin()) return;
  const body = {
    masterEnabled: document.getElementById('gs-master').checked,
    sendEnabled: document.getElementById('gs-send').checked,
    showUI: document.getElementById('gs-ui').checked,
    requireTurnstile: document.getElementById('gs-ts').checked,
    monitorEnabled: document.getElementById('gs-mon').checked,
    collectClientQueue: document.getElementById('gs-cq').checked
  };
  const res = await fetch(API + '/admin/gs/config', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify(body)
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('–ù–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); return; }
  alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
  loadGsConfig();
}
async function loadGsHealth() {
  if (needLogin()) return;
  const res = await fetch(API + '/admin/gs/health', { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const d = await res.json().catch(()=> ({}));
  if (!res.ok || !d?.ok) { alert('–ú–æ–Ω–∏—Ç–æ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'); return; }
  document.getElementById('m-ok').textContent    = d.okCount || 0;
  document.getElementById('m-403').textContent   = d.denied403 || 0;
  document.getElementById('m-429').textContent   = d.rateLimited || 0;
  document.getElementById('m-other').textContent = d.otherDenied || 0;
  document.getElementById('m-q-avg').textContent = (d.queue?.avg ?? 0);
  document.getElementById('m-q-max').textContent = (d.queue?.max ?? 0);
}

// ===== Admin: Achievements overrides =====
let __achItems = [];
let __achSelectedId = null;

async function loadAchList() {
  if (needLogin()) return;
  const list = document.getElementById('ach-list');
  list.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';

  const [baseRes, ovRes] = await Promise.all([
    fetch(API + '/admin/ach/base', { headers:{ ...authHeader() } }),
    fetch(API + '/admin/achievements', { headers:{ ...authHeader() } })
  ]);
  if (baseRes.status === 401 || ovRes.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const base = await baseRes.json().catch(()=> ({}));
  const data = await ovRes.json().catch(()=> ({}));
  if (!base?.ok || !data?.ok) {
    list.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
    return;
  }

  const baseItems = (base.items || []).map(x => ({ ...x, _kind: 'base' }));
  __achItems = (data.items || []).map(x => ({ ...x, _kind: 'override' }));

  // –∏–Ω–¥–µ–∫—Å –æ–≤–µ—Ä—Ä–∞–π–¥–æ–≤ –ø–æ id
  const ovById = new Map(__achItems.map(x => [x.id, x]));

  // –æ–≤–µ—Ä—Ä–∞–π–¥—ã ‚Äî —Å–≤–µ—Ä—Ö—É
  const overHtml = __achItems.map(it => {
    const id = String(it.id || '');
    const t = escapeHtml(it.title || '');
    const th = it.thresholds ? escapeHtml(JSON.stringify(it.thresholds)) : '';
    const meta = [
      it.hidden ? 'hidden' : '',
      (typeof it.tier === 'number') ? ('tier:' + it.tier) : '',
      it.core ? 'core' : ''
    ].filter(Boolean).join(' ¬∑ ');
    return `<div class="row" onclick="editAch('${escapeHtml(id)}')">
      <div><b>${escapeHtml(id)}</b> ${meta ? ('¬∑ ' + escapeHtml(meta)) : ''}<div class="muted">${t}</div></div>
      <div class="muted" style="max-width:240px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">${th}</div>
    </div>`;
  }).join('');

  // –±–∞–∑–∞ ‚Äî —Å–µ—Ä—ã–º, —Ç–æ–ª—å–∫–æ —Ç–µ, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –µ—â—ë –Ω–µ—Ç –æ–≤–µ—Ä—Ä–∞–π–¥–∞
  const baseHtml = baseItems
    .filter(b => !ovById.has(b.id))
    .map(b => {
      const meta = [
        b.hidden ? 'hidden' : '',
        (typeof b.tier === 'number') ? ('tier:' + b.tier) : '',
        b.core ? 'core' : ''
      ].filter(Boolean).join(' ¬∑ ');
      return `<div class="row" onclick="prefillFromBase('${escapeHtml(String(b.id))}')">
        <div><span class="muted">${escapeHtml(String(b.id))}</span> ${meta ? ('¬∑ <span class="muted">' + escapeHtml(meta) + '</span>') : ''}
          <div class="muted">${escapeHtml(b.title || '')}</div>
        </div>
        <div class="muted">–Ω–µ—Ç –æ–≤–µ—Ä—Ä–∞–π–¥–∞</div>
      </div>`;
    }).join('');

  list.innerHTML = `
    <div class="muted" style="margin:6px 0 4px 0;">–û–≤–µ—Ä—Ä–∞–π–¥—ã</div>
    ${overHtml || '<div class="muted">‚Äî –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –æ–≤–µ—Ä—Ä–∞–π–¥–æ–≤</div>'}
    <div class="muted" style="margin:10px 0 4px 0;">–ë–∞–∑–∞ (–∫–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä)</div>
    ${baseHtml || '<div class="muted">‚Äî</div>'}
  `;

  clearAchEditor();
}

function prefillFromBase(id) {
  // –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏–∑ –±–∞–∑–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ (id/title/tier/core/hidden)
  fetch(API + '/admin/ach/base', { headers: { ...authHeader() } })
    .then(r => r.json())
    .then(d => {
      const base = (d.items || []).find(x => String(x.id) === String(id));
      if (!base) return;
      __achSelectedId = id;
      document.getElementById('ach-id').value = base.id || '';
      document.getElementById('ach-hidden').checked = !!base.hidden;
      document.getElementById('ach-core').checked = !!base.core;
      document.getElementById('ach-tier').value = (typeof base.tier === 'number') ? String(base.tier) : '';
      document.getElementById('ach-title').value = base.title || '';
      document.getElementById('ach-short').value = '';
      document.getElementById('ach-desc').value = '';
      document.getElementById('ach-how').value = '';
      document.getElementById('ach-thresholds').value = '';
    }).catch(() => { /* ignore */ });
}

function clearAchEditor() {
  __achSelectedId = null;
  document.getElementById('ach-id').value = '';
  document.getElementById('ach-hidden').checked = false;
  document.getElementById('ach-core').checked = false;
  document.getElementById('ach-tier').value = '';
  document.getElementById('ach-title').value = '';
  document.getElementById('ach-short').value = '';
  document.getElementById('ach-desc').value = '';
  document.getElementById('ach-how').value = '';
  document.getElementById('ach-thresholds').value = '';
}

function newAchItem() {
  clearAchEditor();
  document.getElementById('ach-id').focus();
}

function editAch(id) {
  const it = __achItems.find(x => String(x.id) === String(id));
  if (!it) return;
  __achSelectedId = id;
  document.getElementById('ach-id').value = it.id || '';
  document.getElementById('ach-hidden').checked = !!it.hidden;
  document.getElementById('ach-core').checked = !!it.core;
  document.getElementById('ach-tier').value = (typeof it.tier === 'number') ? String(it.tier) : '';
  document.getElementById('ach-title').value = it.title || '';
  document.getElementById('ach-short').value = it.short || '';
  document.getElementById('ach-desc').value = it.desc || '';
  document.getElementById('ach-how').value = it.howTo || '';
  document.getElementById('ach-thresholds').value = it.thresholds ? JSON.stringify(it.thresholds, null, 2) : '';
}

async function saveAch() {
  if (needLogin()) return;
  const id = document.getElementById('ach-id').value.trim();
  if (!id) { alert('–£–∫–∞–∂–∏—Ç–µ ID'); return; }

  let thresholds = null;
  const t = document.getElementById('ach-thresholds').value.trim();
  if (t) {
    try { thresholds = JSON.parse(t); }
    catch { alert('thresholds: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON'); return; }
  }

  // –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ tier: –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ ‚Äî –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–∏—Å–ª–æ
  const tierStr = (document.getElementById('ach-tier').value || '').trim();
  const tierVal = tierStr === '' ? undefined : Number(tierStr);
  if (tierVal !== undefined && !Number.isFinite(tierVal)) {
    alert('Tier: —É–∫–∞–∂–∏—Ç–µ —á–∏—Å–ª–æ'); return;
  }

  const body = {
    id,
    hidden: document.getElementById('ach-hidden').checked,
    core: document.getElementById('ach-core').checked,
    title: document.getElementById('ach-title').value,
    short: document.getElementById('ach-short').value,
    desc: document.getElementById('ach-desc').value,
    howTo: document.getElementById('ach-how').value,
    thresholds
  };
  if (tierVal !== undefined) body.tier = tierVal;

  const res = await fetch(API + '/admin/achievement/upsert', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...authHeader() },
    body: JSON.stringify(body)
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(() => ({}));
  if (!res.ok || !data?.ok) { alert('–ù–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); return; }
  alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
  loadAchList();
}

async function deleteAch() {
  if (needLogin()) return;
  const id = (document.getElementById('ach-id').value || '').trim();
  if (!id) { alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç'); return; }
  if (!confirm(`–£–¥–∞–ª–∏—Ç—å –æ–≤–µ—Ä—Ä–∞–π–¥ "${id}"?`)) return;

  const res = await fetch(API + '/admin/achievement/delete', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...authHeader() },
    body: JSON.stringify({ id })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(() => ({}));
  if (!res.ok || !data?.ok) { alert('–ù–µ —É–¥–∞–ª–µ–Ω–æ'); return; }
  alert('–£–¥–∞–ª–µ–Ω–æ');
  loadAchList();
}

async function copyAch() {
  if (needLogin()) return;
  const fromId = (document.getElementById('ach-id').value || '').trim();
  if (!fromId) { alert('–í—ã–±–µ—Ä–∏—Ç–µ, —á—Ç–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'); return; }
  const toId = prompt('–ù–æ–≤—ã–π ID (–∫–æ–ø–∏—è –∏–∑ ' + fromId + ')');
  if (!toId) return;

  const res = await fetch(API + '/admin/achievement/copy', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...authHeader() },
    body: JSON.stringify({ fromId, toId })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(() => ({}));
  if (!res.ok || !data?.ok) { alert('–ù–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'); return; }
  alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ');
  loadAchList();
}

// ===== Admin: DEMO helpers and panel =====

// –†–µ–Ω–¥–µ—Ä –≤—Å–µ—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π (–≤–∏–¥–∏–º—ã–µ + —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ) –≤ –≤–∏–¥–µ —á–µ–∫-–ª–∏—Å—Ç–∞
function renderDemoAchList(items) {
  const box = document.getElementById('demo-ach-box');
  if (!box) return;

  const sorted = [...items].sort((a, b) => {
    if (!!a.hidden !== !!b.hidden) return a.hidden ? 1 : -1; // –≤–∏–¥–∏–º—ã–µ –ø–µ—Ä–≤—ã–º–∏
    if ((a.tier || 0) !== (b.tier || 0)) return (a.tier || 0) - (b.tier || 0);
    return String(a.title || a.id).localeCompare(String(b.title || b.id), 'ru');
  });

  const visible = sorted.filter(x => !x.hidden);
  const secret = sorted.filter(x => x.hidden);

  const rows = (arr) => arr.map(a => `
    <div class="ach-row">
      <label class="checkbox-container">
        <input type="checkbox" data-ach="${escapeHtml(String(a.id))}" onchange="updateDemoCountsAndLevel()">
        <span>${escapeHtml(a.title || a.id)} <span class="ach-id">(${escapeHtml(String(a.id))})</span></span>
      </label>
      <span class="muted">${a.tier ? 'tier:'+a.tier : ''}</span>
    </div>
  `).join('');

  box.innerHTML = `
    <div class="group-title">–í–∏–¥–∏–º—ã–µ</div>
    ${rows(visible) || '<div class="muted">‚Äî</div>'}
    <div class="group-title">–°–µ–∫—Ä–µ—Ç–Ω—ã–µ</div>
    ${rows(secret) || '<div class="muted">‚Äî</div>'}
  `;

  // –æ–±–Ω–æ–≤–∏–º –±–µ–π–¥–∂–∏ "–≤—Å–µ–≥–æ/–≤–∏–¥–∏–º—ã—Ö/—Å–µ–∫—Ä–µ—Ç–Ω—ã—Ö"
  document.getElementById('demo-total').textContent = String(items.length);
  document.getElementById('demo-visible-badge').textContent = `–í–∏–¥–∏–º—ã—Ö: ${visible.length}`;
  document.getElementById('demo-secret-badge').textContent = `–°–µ–∫—Ä–µ—Ç–Ω—ã—Ö: ${secret.length}`;

  updateDemoCountsAndLevel();
}

function getCheckedIds() {
  return Array.from(document.querySelectorAll('#demo-ach-box input[type="checkbox"][data-ach]'))
    .filter(c => c.checked)
    .map(c => c.getAttribute('data-ach'));
}

function markAll(mark) {
  const boxes = document.querySelectorAll('#demo-ach-box input[type="checkbox"][data-ach]');
  boxes.forEach(b => { b.checked = !!mark; });
  updateDemoCountsAndLevel();
}

let __demoHiddenById = new Map();
function setDemoHiddenMap(items) {
  __demoHiddenById = new Map(items.map(x => [String(x.id), !!x.hidden]));
}
function markAllVisible(mark) {
  const boxes = document.querySelectorAll('#demo-ach-box input[type="checkbox"][data-ach]');
  boxes.forEach(b => {
    const id = b.getAttribute('data-ach');
    const isHidden = __demoHiddenById.get(String(id));
    if (!isHidden) b.checked = !!mark;
  });
  updateDemoCountsAndLevel();
}
function markAllSecret(mark) {
  const boxes = document.querySelectorAll('#demo-ach-box input[type="checkbox"][data-ach]');
  boxes.forEach(b => {
    const id = b.getAttribute('data-ach');
    const isHidden = __demoHiddenById.get(String(id));
    if (isHidden) b.checked = !!mark;
  });
  updateDemoCountsAndLevel();
}

function preset5() {
  // –æ—Ç–º–µ—Ç–∏—Ç—å –ø–µ—Ä–≤—ã–µ 5 –≤–∏–¥–∏–º—ã—Ö
  const ids = [];
  const boxes = Array.from(document.querySelectorAll('#demo-ach-box input[type="checkbox"][data-ach]'));
  for (const b of boxes) {
    const id = b.getAttribute('data-ach');
    const isHidden = __demoHiddenById.get(String(id));
    if (!isHidden) ids.push(b);
    if (ids.length >= 5) break;
  }
  markAll(false);
  ids.forEach(b => b.checked = true);
  updateDemoCountsAndLevel();
}

function presetFirstPrize() {
  // –≤—Å–µ –≤–∏–¥–∏–º—ã–µ (–±–µ–∑ —Å–µ–∫—Ä–µ—Ç–Ω—ã—Ö)
  markAll(false);
  markAllVisible(true);
}

function presetSecondPrize() {
  // –≤—Å–µ –≤–∏–¥–∏–º—ã–µ + –≤—Å–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ
  markAll(true);
}

function updateDemoCountsAndLevel() {
  const boxes = Array.from(document.querySelectorAll('#demo-ach-box input[type="checkbox"][data-ach]'));
  const checked = boxes.filter(b => b.checked);
  const checkedIds = checked.map(b => b.getAttribute('data-ach'));

  const total = boxes.length;
  const visibleTotal = Array.from(__demoHiddenById.values()).filter(v => !v).length;
  const secretTotal = total - visibleTotal;

  let visibleDone = 0, secretDone = 0;
  checkedIds.forEach(id => {
    if (__demoHiddenById.get(String(id))) secretDone++;
    else visibleDone++;
  });

  document.getElementById('demo-checked').textContent = String(checked.length);

  // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —É—Ä–æ–≤–Ω—è = –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –≤–∏–¥–∏–º—ã—Ö
  const pill = document.getElementById('demo-level-pill');
  if (pill) pill.textContent = `–£—Ä–æ–≤–µ–Ω—å: ${visibleDone} / ${visibleTotal}`;

  // –ø–æ–¥—Å–∫–∞–∑–∫–∞: –µ—Å–ª–∏ –≤—Å–µ –≤–∏–¥–∏–º—ã–µ –æ—Ç–º–µ—á–µ–Ω—ã ‚Äî –º–æ–∂–Ω–æ –±—Ä–∞—Ç—å 1-–π –ø—Ä–∏–∑
  const hint = document.getElementById('demo-hint');
  if (visibleDone >= visibleTotal) {
    if (secretDone > 0) {
      hint.textContent = '–ì–æ—Ç–æ–≤–æ –¥–ª—è 1-–≥–æ –ø—Ä–∏–∑–∞. –°–µ–∫—Ä–µ—Ç–Ω—ã–µ –æ—Ç–º–µ—á–µ–Ω—ã: ' + secretDone + ' / ' + secretTotal;
    } else {
      hint.textContent = '–ì–æ—Ç–æ–≤–æ –¥–ª—è 1-–≥–æ –ø—Ä–∏–∑–∞ (–≤–∏–¥–∏–º—ã–µ: –≤—Å–µ).';
    }
  } else {
    hint.textContent = '–û—Ç–º–µ—Ç—å—Ç–µ –≤–∏–¥–∏–º—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –¥–ª—è 1-–≥–æ –ø—Ä–∏–∑–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–µ—Å–µ—Ç.';
  }
}

async function loadDemoPanel() {
  if (needLogin()) return;
  const tg = document.getElementById('demo-tg').value.trim();
  if (!tg) return alert('–í–≤–µ–¥–∏—Ç–µ tg_id');

  // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ—Å—Ç–µ—Ä–∞
  const res = await fetch(`${API}/admin/demo/tester?tg=${encodeURIComponent(tg)}`, { headers: { ...authHeader() } });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const d = await res.json().catch(() => ({}));
  if (!res.ok || !d?.ok) { alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å'); return; }

  document.getElementById('demo-mode').checked = (d.tester?.mode === 'demo');
  document.getElementById('demo-dn').value = d.tester?.displayNameDemo || 'VR Admin';
  document.getElementById('demo-hint').textContent = d.hasDemo ? '–î–µ–º–æ-–±—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω—ë–Ω' : '–î–µ–º–æ-–±—ç–∫–∞–ø –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω';

  // –ë–∞–∑–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
  const base = await fetch(API + '/admin/ach/base', { headers: { ...authHeader() } }).then(r => r.json()).catch(() => ({}));
  const items = (base.items || []);
  setDemoHiddenMap(items);
  renderDemoAchList(items);

  // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ DEMO‚Äë–∑–∞—è–≤–æ–∫ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
  try { await demoLoadClaims(); } catch(e){}
}

async function saveDemoMode() {
  if (needLogin()) return;
  const tg = document.getElementById('demo-tg').value.trim();
  const mode = document.getElementById('demo-mode').checked ? 'demo' : 'live';
  const displayNameDemo = document.getElementById('demo-dn').value.trim() || 'VR Admin';
  const res = await fetch(API + '/admin/demo/tester', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...authHeader() },
    body: JSON.stringify({ tg, mode, displayNameDemo })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const d = await res.json().catch(() => ({}));
  if (!res.ok || !d?.ok) return alert('–ù–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
  alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
}

async function buildAndSaveDemoBackup() {
  if (needLogin()) return;
  const tg = document.getElementById('demo-tg').value.trim();
  if (!tg) return alert('–í–≤–µ–¥–∏—Ç–µ tg_id');

  const now = Date.now();
  const checkedIds = getCheckedIds();

  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞/–∞—á–∏–≤–∫–∏
  const stats = {
    schema: 2,
    deviceHash: 'demo_device',
    createdAt: now,
    totals: { totalSeconds: 0, totalValidPlays: 0, totalFullPlays: 0 },
    perTrack: Array.from({ length: 16 }, () => ({
      validPlays: 0, fullPlays: 0, totalSeconds: 0, lastPlayedAt: 0,
      byHour: Array(24).fill(0), byWeekday: Array(7).fill(0)
    })),
    uniqueTracksPlayed: [],
    byDay: {},
    streak: { current: 0, max: 0, lastDay: null },
    likedCount: 0,
    achievements: {},
    lastMajorAchAt: 0,
    backups: { dates: [] },
    socialsVisited: {},
    sleepTimerStops: 0
  };
  checkedIds.forEach(id => { stats.achievements[id] = { unlockedAt: now, tier: 1 }; });

  // –ü–æ–¥—Å—á—ë—Ç—ã –≤–∏–¥–∏–º—ã—Ö/—Å–µ–∫—Ä–µ—Ç–Ω—ã—Ö –∏–∑ –∫–∞—Ä—Ç—ã
  const allIds = Array.from(__demoHiddenById.keys());
  const visibleTotal = allIds.filter(id => !__demoHiddenById.get(id)).length;
  const secretTotal = allIds.length - visibleTotal;
  const visibleDone = checkedIds.filter(id => !__demoHiddenById.get(id)).length;
  const secretDone = checkedIds.filter(id => __demoHiddenById.get(id)).length;

  const payload = {
    appVersion: 'demo',
    buildDate: new Date().toISOString().slice(0, 10),
    exportedAt: new Date().toISOString(),
    deviceHash: 'demo_device',
    profile: { displayName: document.getElementById('demo-dn').value.trim() || 'VR Admin', tgId: tg, tgUsername: null },
    favorites: [],
    knownDevices: ['demo_device'],
    achOverview: {
      normalTotal: visibleTotal,
      normalDone: visibleDone,
      secretTotal: secretTotal,
      secretDoneFromStart: secretDone,
      secretStartAt: secretDone ? now : null
    },
    stats,
    statsInsights: null
  };

  // checksum
  const checksum = await (async (s) => {
    const enc = new TextEncoder().encode(JSON.stringify(s));
    const h = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(h)).map(b => b.toString(16).padStart(2, '0')).join('');
  })(payload);

  const file = { kind: 'vr_backup_v1', checksum, payload };

  const res = await fetch(API + '/admin/demo/backup', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...authHeader() },
    body: JSON.stringify({ tg, file })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const d = await res.json().catch(() => ({}));
  if (!res.ok || !d?.ok) return alert('–î–µ–º–æ-–±—ç–∫–∞–ø –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω');

  document.getElementById('demo-hint').textContent = '–î–µ–º–æ-–±—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω—ë–Ω';
  updateDemoCountsAndLevel();
  alert('–î–µ–º–æ‚Äë–±—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥ —ç—Ç–∏–º tg_id ‚Äî –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.');
}
async function demoLoadClaims() {
  if (needLogin()) return;
  const tg = document.getElementById('demo-tg').value.trim();
  const device = document.getElementById('demo-device').value.trim();
  if (!tg) return alert('–í–≤–µ–¥–∏—Ç–µ tg_id');
  const url = new URL(`${API}/admin/demo/claims`);
  url.searchParams.set('tg', tg);
  if (device) url.searchParams.set('device', device);
  const res = await fetch(url, { headers:{ ...authHeader() } });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const d = await res.json().catch(()=> ({}));
  const box = document.getElementById('demo-claims-list');
  if (!res.ok || !d?.ok) { box.textContent = '–û—à–∏–±–∫–∞'; return; }
  const items = d.items || [];
  if (!items.length) { box.textContent = '–ó–∞—è–≤–æ–∫ –Ω–µ—Ç'; return; }
  box.innerHTML = items.map(c=>{
    const when = c.created_at ? new Date(c.created_at).toLocaleString() : '‚Äî';
    const devShort = (c.device_hash||'').slice(0,8);
    return `<div class="row" onclick="(function(){document.getElementById('demo-claim-id').value='${c.id}';document.getElementById('demo-device').value='${c.device_hash||''}';})()">
      <div>
        <div><b>#${c.id.slice(0,8)}</b> ¬∑ dev:${devShort} ¬∑ <span class="pill">${c.status}</span></div>
        <div class="muted">${when} ¬∑ ${escapeHtml(c.prize_title||'')}</div>
      </div>
      <div class="muted">${c.tracking_code?('trk:'+escapeHtml(c.tracking_code)):'‚Äî'}</div>
    </div>`;
  }).join('');
}

async function demoSetShipped() {
  if (needLogin()) return;
  const tg = document.getElementById('demo-tg').value.trim();
  let device = document.getElementById('demo-device').value.trim();
  const id = document.getElementById('demo-claim-id').value.trim();
  const tracking = document.getElementById('demo-tracking').value.trim();
  if (!tg || !id || !tracking) return alert('tg/claim/tracking');

  // –µ—Å–ª–∏ device –ø—É—Å—Ç ‚Äî –ø–æ–ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –µ–≥–æ –ø–æ id
  if (!device) {
    try {
      const url = new URL(`${API}/admin/demo/claims`);
      url.searchParams.set('tg', tg);
      const resList = await fetch(url, { headers:{ ...authHeader() } });
      const data = await resList.json().catch(()=> ({}));
      const it = (data.items||[]).find(x => x.id === id);
      if (it?.device_hash) device = it.device_hash;
    } catch(e){}
  }
  if (!device) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å device_hash –¥–ª—è —ç—Ç–æ–π –∑–∞—è–≤–∫–∏');

  const res = await fetch(`${API}/admin/demo/claim/tracking`, {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ tg, device, id, tracking })
  });
  const d = await res.json().catch(()=> ({}));
  if (!res.ok || !d?.ok) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å: '+(d?.error||res.status));
  alert('–°—Ç–∞—Ç—É—Å: shipped');
  demoLoadClaims();
}

async function demoSetDelivered() {
  if (needLogin()) return;
  const tg = document.getElementById('demo-tg').value.trim();
  let device = document.getElementById('demo-device').value.trim();
  const id = document.getElementById('demo-claim-id').value.trim();
  if (!tg || !id) return alert('tg/claim');

  if (!device) {
    try {
      const url = new URL(`${API}/admin/demo/claims`);
      url.searchParams.set('tg', tg);
      const resList = await fetch(url, { headers:{ ...authHeader() } });
      const data = await resList.json().catch(()=> ({}));
      const it = (data.items||[]).find(x => x.id === id);
      if (it?.device_hash) device = it.device_hash;
    } catch(e){}
  }
  if (!device) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å device_hash –¥–ª—è —ç—Ç–æ–π –∑–∞—è–≤–∫–∏');

  const res = await fetch(`${API}/admin/demo/claim/delivered`, {
    method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ tg, device, id })
  });
  const d = await res.json().catch(()=> ({}));
  if (!res.ok || !d?.ok) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å: '+(d?.error||res.status));
  alert('–°—Ç–∞—Ç—É—Å: delivered');
  demoLoadClaims();
}

async function resetDemoClaims() {
  if (needLogin()) return;
  const tg = document.getElementById('demo-tg').value.trim();
  if (!tg) return;
  if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å DEMO‚Äë–∑–∞—è–≤–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ tg_id?')) return;
  const res = await fetch(API + '/admin/demo/claims/reset', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...authHeader() },
    body: JSON.stringify({ tg })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const d = await res.json().catch(() => ({}));
  if (!res.ok || !d?.ok) return alert('–ù–µ –æ—á–∏—â–µ–Ω–æ');
  alert('DEMO‚Äë–∑–∞—è–≤–∫–∏ –æ—á–∏—â–µ–Ω—ã');
}

// ===== utils =====
function escapeHtml(s) { return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

// –ê–≤—Ç–æ–ª–æ–≥–∏–Ω-–ø—Ä–æ–≤–µ—Ä–∫–∞
window.addEventListener('load', () => {
  if (needLogin(true)) return;
  guardApp();
  loadClaims();

  // –ê–≤—Ç–æ-–æ—Ç–∫—Ä—ã—Ç–∏–µ –Ω—É–∂–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏ –∏ –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ tg –∏–∑ URL
  try {
    const u = new URL(window.location.href);
    const tab = (u.searchParams.get('tab') || '').trim();
    const tg  = (u.searchParams.get('tg') || '').trim();
    if (tg) {
      const inp = document.getElementById('demo-tg');
      if (inp) inp.value = tg;
    }
    if (tab && document.getElementById('tab-' + tab)) {
      switchTab(tab);
      if (tab === 'demo') {
        // –ø–æ–¥–≥—Ä—É–∑–∏–º –ø–∞–Ω–µ–ª—å DEMO —Å—Ä–∞–∑—É
        loadDemoPanel();
      }
      if (tab === 'ach') {
        loadAchList();
      }
    }
  } catch (e) {}
});
// ===== –ê–≤—Ç–æ—Å—Ü–µ–Ω–∞—Ä–∏–π DEMO =====
let scenarioInterval = null;

async function startScenario() {
  if (needLogin()) return;
  const tg = document.getElementById('demo-tg').value.trim();
  if (!tg) return alert('–í–≤–µ–¥–∏—Ç–µ tg_id');
  
  const speed = document.getElementById('scenario-speed').value;
  const autoClaimPrizes = document.getElementById('scenario-auto-prizes').checked;
  
  const res = await fetch(`${API}/admin/demo/scenario/start`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...authHeader() },
    body: JSON.stringify({ tgId: tg, speed, autoClaimPrizes })
  });
  
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const d = await res.json().catch(() => ({}));
  if (!res.ok || !d?.ok) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å: ' + (d?.error || res.status));
  
  alert('–ê–≤—Ç–æ—Å—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–ø—É—â–µ–Ω! –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.');
  refreshScenarioStatus();
  
  // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
  if (scenarioInterval) clearInterval(scenarioInterval);
  scenarioInterval = setInterval(refreshScenarioStatus, 2000);
}

async function pauseScenario() {
  if (needLogin()) return;
  const tg = document.getElementById('demo-tg').value.trim();
  if (!tg) return alert('–í–≤–µ–¥–∏—Ç–µ tg_id');
  
  const res = await fetch(`${API}/admin/demo/scenario/settings`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...authHeader() },
    body: JSON.stringify({ tgId: tg, paused: true })
  });
  
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const d = await res.json().catch(() => ({}));
  if (!res.ok || !d?.ok) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –ø–∞—É–∑—É');
  
  alert('–°—Ü–µ–Ω–∞—Ä–∏–π –ø–æ—Å—Ç–∞–≤–ª–µ–Ω –Ω–∞ –ø–∞—É–∑—É');
  refreshScenarioStatus();
}

async function resetScenario() {
  if (needLogin()) return;
  const tg = document.getElementById('demo-tg').value.trim();
  if (!tg) return alert('–í–≤–µ–¥–∏—Ç–µ tg_id');
  
  if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –∞–≤—Ç–æ—Å—Ü–µ–Ω–∞—Ä–∏–π –∏ –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å?')) return;
  
  const res = await fetch(`${API}/admin/demo/scenario/reset`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...authHeader() },
    body: JSON.stringify({ tgId: tg })
  });
  
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const d = await res.json().catch(() => ({}));
  if (!res.ok || !d?.ok) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å');
  
  // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
  if (scenarioInterval) {
    clearInterval(scenarioInterval);
    scenarioInterval = null;
  }
  
  alert('–°—Ü–µ–Ω–∞—Ä–∏–π —Å–±—Ä–æ—à–µ–Ω');
  refreshScenarioStatus();
  
  // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–∞–Ω–µ–ª—å
  loadDemoPanel();
}

async function refreshScenarioStatus() {
  if (needLogin()) return;
  const tg = document.getElementById('demo-tg').value.trim();
  if (!tg) return;
  
  const res = await fetch(`${API}/admin/demo/scenario/status?tgId=${encodeURIComponent(tg)}`, {
    headers: { ...authHeader() }
  });
  
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const d = await res.json().catch(() => ({}));
  
  if (!res.ok || !d?.ok) return;
  
  const statusEl = document.getElementById('scenario-status');
  const stageEl = document.getElementById('scenario-stage');
  const achEl = document.getElementById('scenario-achievements');
  const hintEl = document.getElementById('scenario-hint');
  
  if (d.hasScenario && d.hasProgress) {
    statusEl.textContent = d.paused ? '–Ω–∞ –ø–∞—É–∑–µ' : '–∑–∞–ø—É—â–µ–Ω';
    statusEl.className = d.paused ? 'badge' : 'badge ok';
    
    if (d.currentStage) {
      stageEl.textContent = `${d.currentStage} (${d.currentStageIndex + 1}/${d.totalStages})`;
    } else {
      stageEl.textContent = '–∑–∞–≤–µ—Ä—à—ë–Ω';
    }
    
    achEl.textContent = `${d.completedAchievements.length}`;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏
    if (d.settings?.speed !== undefined) {
      document.getElementById('scenario-speed').value = String(d.settings.speed);
    }
    if (d.settings?.autoClaimPrizes !== undefined) {
      document.getElementById('scenario-auto-prizes').checked = d.settings.autoClaimPrizes;
    }
    
    // –ü–æ–¥—Å–∫–∞–∑–∫–∞
    if (d.currentStage === 'stage2_claim_first' || d.currentStage === 'stage4_claim_second') {
      hintEl.textContent = '‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–µ–π—Å—Ç–≤–∏–µ: –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–∑ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏';
      hintEl.style.color = '#ffb84d';
    } else if (d.currentStageIndex >= d.totalStages) {
      hintEl.textContent = '‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–≤–µ—Ä—à—ë–Ω. –ú–æ–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è.';
      hintEl.style.color = '#6df59a';
    } else {
      hintEl.textContent = '–ê–≤—Ç–æ—Å—Ü–µ–Ω–∞—Ä–∏–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤—Å–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é.';
      hintEl.style.color = '';
    }
  } else {
    statusEl.textContent = '–Ω–µ –∑–∞–ø—É—â–µ–Ω';
    statusEl.className = 'badge';
    stageEl.textContent = '‚Äî';
    achEl.textContent = '0';
    hintEl.textContent = '–ê–≤—Ç–æ—Å—Ü–µ–Ω–∞—Ä–∏–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤—Å–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é.';
    hintEl.style.color = '';
  }
}

// –û–±–Ω–æ–≤–∏–º —Ñ—É–Ω–∫—Ü–∏—é loadDemoPanel, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∂–∞—Ç—å —Å—Ç–∞—Ç—É—Å —Å—Ü–µ–Ω–∞—Ä–∏—è
const originalLoadDemoPanel = loadDemoPanel;
loadDemoPanel = async function() {
  await originalLoadDemoPanel();
  await refreshScenarioStatus();
};

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫
const originalSwitchTab = switchTab;
switchTab = function(tab) {
  // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–∏ —É—Ö–æ–¥–µ —Å –≤–∫–ª–∞–¥–∫–∏ DEMO
  if (scenarioInterval) {
    clearInterval(scenarioInterval);
    scenarioInterval = null;
  }
  originalSwitchTab(tab);
};
</script>
<script type="module" src="admin/prizes-admin.js"></script>
</body>
</html>
