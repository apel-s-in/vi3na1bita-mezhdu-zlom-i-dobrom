<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>VR Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:#0f1218;color:#e8eefc;margin:0}
    header{padding:12px 16px;background:#171d29;border-bottom:1px solid #2b3955;display:flex;align-items:center;gap:10px}
    h1{font-size:16px;margin:0;color:#9fc3ff}
    .tabs{display:flex;gap:8px;margin-left:auto}
    .tab{border:1px solid #2b3955;background:#1a2131;color:#cfe3ff;padding:6px 10px;border-radius:999px;cursor:pointer}
    .tab.active{background:#4daaff;color:#fff;border-color:#4daaff}
    main{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px;align-items:start}
    .card{background:#171d29;border:1px solid #2b3955;border-radius:10px;padding:10px}
    .row{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.07)}
    .row:last-child{border-bottom:none}
    .muted{color:#9aa8c4}
    .btn{border:none;border-radius:8px;background:#2a3550;color:#e8eefc;padding:6px 10px;cursor:pointer}
    .btn.primary{background:#E80100}
    .btn.warn{background:#8a2a2a}
    .btn.ok{background:#27b34c}
    input,textarea,select{background:#111826;color:#e8eefc;border:1px solid #2b3955;border-radius:8px;padding:7px}
    .list{max-height:70vh;overflow:auto}
    .pill{font-size:.9em;border:1px solid #2b3955;background:#1e2638;border-radius:999px;padding:2px 8px;color:#cfe3ff}
    .flex{display:flex;gap:8px;align-items:center}
    .w100{width:100%}
    .split{display:grid;grid-template-columns:300px 1fr;gap:12px}
    .msg{padding:8px 10px;border-radius:10px;margin:6px 0;max-width:88%}
    .msg.user{background:#20283a}
    .msg.admin{background:#203020;margin-left:auto}
    .login-modal{position:fixed;inset:0;background:#0008;display:flex;align-items:center;justify-content:center}
    .login-box{background:#171d29;border:1px solid #2b3955;border-radius:12px;padding:16px;min-width:280px}
    .footer{padding:10px;text-align:center;color:#9aa8c4}
    .search{display:flex;gap:8px;margin-bottom:8px}
  </style>
</head>
<body>
  <header>
    <h1>VR Admin</h1>
    <div class="tabs">
      <button class="tab active" id="tab-claims">Заявки</button>
      <button class="tab" id="tab-fb">Обратная связь</button>
      <button class="tab" id="tab-prizes">Призы</button>
      <button class="tab" id="tab-logout" title="Выйти">Logout</button>
    </div>
  </header>

  <main id="view-claims">
    <div class="card">
      <div class="search" style="flex-wrap:wrap">
        <select id="claims-status" title="Статус">
          <option value="">Все статусы</option>
          <option value="pending">pending</option>
          <option value="approved">approved</option>
          <option value="rejected">rejected</option>
          <option value="shipped">shipped</option>
        </select>
        <label class="muted">с</label>
        <input type="date" id="claims-from" />
        <label class="muted">по</label>
        <input type="date" id="claims-to" />
        <button class="btn" onclick="resetPaging();loadClaims()">Применить</button>
        <button class="btn" onclick="exportClaimsCSV()">Экспорт CSV</button>
        <div style="margin-left:auto;display:flex;gap:6px;align-items:center;">
          <button class="btn" onclick="prevPage()">◀</button>
          <span class="muted" id="claims-page-label">1</span>
          <button class="btn" onclick="nextPage()">▶</button>
        </div>
      </div>
      <div class="list" id="claims-list"></div>
    </div>
    <div class="card">
      <div class="muted">Клик по заявке слева — для действий</div>
      <div id="claim-details" class="muted" style="margin-top:8px;">Ничего не выбрано</div>
      <div style="margin-top:10px;display:none" id="claim-actions">
        <div class="flex"><label class="muted">Причина (для rejected):</label><input class="w100" id="claim-reason" placeholder="Причина..."></div>
        <div style="margin-top:8px;" class="flex">
          <button class="btn ok" onclick="updateClaim('approved')">Одобрить</button>
          <button class="btn warn" onclick="updateClaim('rejected')">Отклонить</button>
          <button class="btn" onclick="updateClaim('pending')">Вернуть в pending</button>
        </div>
        <hr style="border-color:#2b3955;margin:10px 0;">
        <div class="flex">
          <input class="w100" id="claim-tracking" placeholder="Трек‑номер (для shipped)">
          <button class="btn" onclick="setTracking()">Отправлено</button>
        </div>
        <div class="flex" style="margin-top:6px;">
          <button class="btn" onclick="markDelivered()">Получено</button>
        </div>
      </div>
    </div>
  </main>

  <main id="view-fb" style="display:none">
    <div class="card">
      <div class="search">
        <input id="fb-q" placeholder="Поиск кода/устройства..." class="w100">
        <button class="btn" onclick="loadThreads()">Искать</button>
      </div>
      <div class="list" id="thread-list"></div>
    </div>
    <div class="card">
      <div id="thread-head" class="muted">Выберите тред слева</div>
      <div class="list" id="msg-list" style="height:50vh;"></div>
      <div class="flex" style="margin-top:8px;">
        <input id="fb-reply" class="w100" placeholder="Ответить...">
        <button class="btn primary" onclick="sendReply()">Отправить</button>
      </div>
    </div>
  </main>
  <main id="view-prizes" style="display:none">
    <div class="card">
      <div class="search">
        <button class="btn" onclick="loadPrizesAdmin()">Обновить</button>
      </div>
      <div class="list" id="adm-prizes-list"></div>
    </div>
    <div class="card">
      <div style="font-weight:700;margin-bottom:8px;">Редактор</div>
      <div class="flex" style="flex-direction:column;gap:6px;">
        <input id="adm-prize-id" placeholder="ID (пусто для нового)">
        <input id="adm-prize-title" placeholder="Название">
        <input id="adm-prize-short" placeholder="Коротко">
        <textarea id="adm-prize-long" class="w100" placeholder="Описание"></textarea>
        <input id="adm-prize-img" placeholder="URL картинки (img/...)">
        <div class="flex">
          <button class="btn ok" onclick="savePrize()">Сохранить</button>
          <button class="btn warn" onclick="deletePrize()">Удалить</button>
        </div>
      </div>
    </div>
  </main>
  <div class="footer">v1 • Basic Auth • Работает только по HTTPS</div>

  <div id="login" class="login-modal" style="display:none;">
    <div class="login-box">
      <div style="font-weight:700;margin-bottom:8px;">Вход администратора</div>
      <div class="flex" style="flex-direction:column;gap:6px;">
        <input id="adm-user" placeholder="Логин">
        <input id="adm-pass" placeholder="Пароль" type="password">
        <button class="btn primary" onclick="adminLogin()">Войти</button>
      </div>
      <div id="login-err" class="muted" style="margin-top:8px;color:#ffb3b3;"></div>
    </div>
  </div>

<script>
async function loadPrizesAdmin() {
  if (needLogin()) return;
  const res = await fetch(API+'/admin/prizes', { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const list = document.getElementById('adm-prizes-list');
  if (!data?.ok) { list.textContent='Ошибка'; return; }
  list.innerHTML = (data.items||[]).map(p => `
    <div class="row" onclick="fillPrizeForm('${p.id}')">
      <div>
        <div><b>${escapeHtml(p.title||p.id)}</b></div>
        <div class="muted">${escapeHtml(p.short||'')}</div>
      </div>
      <div class="muted" style="max-width:240px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(p.img||'')}</div>
    </div>
  `).join('');
  window.__admPrizes = data.items || [];
}

function fillPrizeForm(id) {
  const p = (window.__admPrizes||[]).find(x=>x.id===id);
  if (!p) return;
  document.getElementById('adm-prize-id').value = p.id;
  document.getElementById('adm-prize-title').value = p.title||'';
  document.getElementById('adm-prize-short').value = p.short||'';
  document.getElementById('adm-prize-long').value = p.long||'';
  document.getElementById('adm-prize-img').value = p.img||'';
}

async function savePrize() {
  if (needLogin()) return;
  const id    = document.getElementById('adm-prize-id').value.trim();
  const title = document.getElementById('adm-prize-title').value.trim();
  const short = document.getElementById('adm-prize-short').value.trim();
  const long  = document.getElementById('adm-prize-long').value.trim();
  const img   = document.getElementById('adm-prize-img').value.trim();
  if (!title || !img) { alert('Заполните название и картинку'); return; }
  const res = await fetch(API+'/admin/prize/upsert', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ id:id||undefined, title, short, long, img })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Ошибка: '+(data?.error||res.status)); return; }
  alert('Сохранено'); loadPrizesAdmin();
}

async function deletePrize() {
  if (needLogin()) return;
  const id = document.getElementById('adm-prize-id').value.trim();
  if (!id) { alert('Укажите ID'); return; }
  if (!confirm('Удалить приз?')) return;
  const res = await fetch(API+'/admin/prize/delete', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ id })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Ошибка: '+(data?.error||res.status)); return; }
  alert('Удалено'); loadPrizesAdmin();
}

const API = 'https://vr-backend.apel-s-in.workers.dev';
const authKey = 'vr_admin_auth';

function authHeader() {
  const tok = sessionStorage.getItem(authKey);
  return tok ? { 'Authorization': tok } : {};
}

// Показываем/прячем весь интерфейс админки в зависимости от наличия токена
function guardApp() {
  const authed = !!sessionStorage.getItem(authKey);
  // Прячем/показываем шапку, оба main и футер
  document.querySelectorAll('header, main, .footer').forEach(el => {
    if (!el) return;
    el.style.display = authed ? '' : 'none';
  });
  const login = document.getElementById('login');
  if (login) login.style.display = authed ? 'none' : '';
  return authed;
}

function needLogin(show = true) {
  const has = !!sessionStorage.getItem(authKey);
  if (!has && show) {
    // сразу прячем приложение и открываем модалку
    guardApp();
  }
  return !has;
}

function adminLogin() {
  const u = document.getElementById('adm-user').value.trim();
  const p = document.getElementById('adm-pass').value.trim();
  if (!u || !p) {
    document.getElementById('login-err').textContent = 'Введите логин и пароль';
    return;
  }
  const token = 'Basic ' + btoa(u + ':' + p);
  sessionStorage.setItem(authKey, token);
  // Показать интерфейс и загрузить данные
  if (guardApp()) {
    loadClaims();
  }
}

// Вход по Enter в полях
document.addEventListener('keydown', (e) => {
  const loginShown = document.getElementById('login')?.style.display !== 'none';
  if (!loginShown) return;
  if (e.key === 'Enter') {
    adminLogin();
  }
});

function switchTab(tab) {
  document.getElementById('tab-claims').classList.toggle('active', tab==='claims');
  document.getElementById('tab-fb').classList.toggle('active', tab==='fb');
  document.getElementById('tab-prizes').classList.toggle('active', tab==='prizes');
  document.getElementById('view-claims').style.display = (tab==='claims') ? '' : 'none';
  document.getElementById('view-fb').style.display = (tab==='fb') ? '' : 'none';
  document.getElementById('view-prizes').style.display = (tab==='prizes') ? '' : 'none';
  if (tab==='prizes') loadPrizesAdmin();
}
document.getElementById('tab-claims').onclick = ()=>switchTab('claims');
document.getElementById('tab-fb').onclick = ()=>switchTab('fb');
document.getElementById('tab-prizes').onclick = ()=>switchTab('prizes');
document.getElementById('tab-logout').onclick = ()=>{ sessionStorage.removeItem(authKey); guardApp(); needLogin(true); };

// Claims
let currentClaim = null;
let pageSize = 50;
let currentOffset = 0;

function resetPaging() {
  currentOffset = 0;
  document.getElementById('claims-page-label').textContent = '1';
}
function nextPage() {
  currentOffset += pageSize;
  loadClaims();
}
function prevPage() {
  currentOffset = Math.max(0, currentOffset - pageSize);
  const curPage = Math.floor(currentOffset / pageSize) + 1;
  document.getElementById('claims-page-label').textContent = String(curPage);
  loadClaims();
}

function readDateInput(id) {
  const v = document.getElementById(id)?.value;
  if (!v) return null;
  try {
    // to 00:00/23:59 диапазон: для "to" добавим 23:59:59.999
    const dt = new Date(v);
    if (id === 'claims-to') dt.setHours(23,59,59,999);
    return dt.toISOString();
  } catch { return null; }
}

async function loadClaims() {
  if (needLogin()) return;
  const st  = document.getElementById('claims-status').value;
  const from= readDateInput('claims-from');
  const to  = readDateInput('claims-to');

  const url = new URL(API + '/admin/claims');
  if (st) url.searchParams.set('status', st);
  if (from) url.searchParams.set('from', from);
  if (to) url.searchParams.set('to', to);
  url.searchParams.set('limit', String(pageSize));
  url.searchParams.set('offset', String(currentOffset));

  const res = await fetch(url, { headers: { ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const list = document.getElementById('claims-list');
  if (!data?.ok) { list.textContent = 'Ошибка загрузки'; return; }

  const items = data.items || [];
  const curPage = Math.floor(currentOffset / pageSize) + 1;
  document.getElementById('claims-page-label').textContent = String(curPage);

  list.innerHTML = items.map(c=>{
    const dt = new Date(c.created_at).toLocaleString();
    return `<div class="row" onclick="selectClaim('${c.id}')">
      <div>
        <div><span class="pill">${c.status}</span> <b>${c.user_name||'Пользователь'}</b></div>
        <div class="muted">#${c.id.slice(0,8)} · dev:${(c.device_hash||'').slice(0,8)} · lvl:${c.level} · cyc:${c.cycle}</div>
      </div>
      <div class="muted">${dt}</div>
    </div>`;
  }).join('');

  if (items.length === 0 && currentOffset > 0) {
    // вернемся на страницу назад если вышли за предел
    prevPage();
  }

  document.getElementById('claim-details').textContent = 'Ничего не выбрано';
  document.getElementById('claim-actions').style.display = 'none';
  currentClaim = null;
}

async function selectClaim(id) {
  const el = document.getElementById('claim-details');
  el.innerHTML = `Заявка <b>#${id}</b><br><span class="muted">Статус меняется кнопками ниже</span>`;
  currentClaim = id;
  document.getElementById('claim-actions').style.display = '';
}

async function updateClaim(next) {
  if (!currentClaim) return;
  const reason = document.getElementById('claim-reason').value.trim();
  const res = await fetch(API+'/admin/claim/update', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ id: currentClaim, status: next, reason: (next==='rejected'?reason:null) })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Ошибка: '+(data?.error||res.status)); return; }
  alert('Готово: '+next);
  loadClaims();
}
async function setTracking() {
  if (!currentClaim) return;
  const tracking = document.getElementById('claim-tracking').value.trim();
  if (!tracking) { alert('Введите трек‑номер'); return; }
  const res = await fetch(API+'/admin/claim/tracking', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ id: currentClaim, tracking })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Ошибка: '+(data?.error||res.status)); return; }
  alert('Статус: shipped, трек установлен');
  loadClaims();
}

async function markDelivered() {
  if (!currentClaim) return;
  const res = await fetch(API+'/admin/claim/delivered', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ id: currentClaim })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Ошибка: '+(data?.error||res.status)); return; }
  alert('Статус: delivered');
  loadClaims();
}
async function exportClaimsCSV() {
  if (needLogin()) return;
  const st  = document.getElementById('claims-status').value;
  const from= readDateInput('claims-from');
  const to  = readDateInput('claims-to');

  const url = new URL(API + '/admin/claims/export');
  if (st) url.searchParams.set('status', st);
  if (from) url.searchParams.set('from', from);
  if (to) url.searchParams.set('to', to);

  const res = await fetch(url, { headers: { ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const blob = await res.blob();
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `claims-${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
}

// Feedback
let currentThread = null;

async function loadThreads() {
  if (needLogin()) return;
  const q = document.getElementById('fb-q').value.trim();
  const url = new URL(API + '/admin/feedback/threads');
  if (q) url.searchParams.set('q', q);
  url.searchParams.set('limit','100');
  const res = await fetch(url, { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const list = document.getElementById('thread-list');
  if (!data?.ok) { list.textContent = 'Ошибка'; return; }
  list.innerHTML = (data.items||[]).map(t=>{
    const dt = new Date(t.last_message_at).toLocaleString();
    const st = t.status || 'open';
    return `<div class="row" onclick="openThread('${t.id}','${t.code}','${st}')">
      <div>
        <div><b>#${t.code}</b> · ${t.user_name||'Пользователь'} · <span class="pill">${st}</span></div>
        <div class="muted">dev:${(t.device_hash||'').slice(0,8)} · ${new Date(t.created_at).toLocaleDateString()}</div>
      </div>
      <div class="muted">${dt}</div>
    </div>`;
  }).join('');
  document.getElementById('thread-head').textContent = 'Выберите тред слева';
  document.getElementById('msg-list').innerHTML = '';
  currentThread = null;
}

async function openThread(id, code, status='open') {
  currentThread = { id, code, status };
  const head = document.getElementById('thread-head');
  head.innerHTML = `Диалог <b>#${code}</b> · <span class="pill">${status}</span>
    <button class="btn" style="margin-left:8px" onclick="toggleThreadStatus()">
      ${status==='closed'?'Открыть':'Закрыть'}
    </button>`;
  await loadMessages();
}

async function toggleThreadStatus() {
  if (!currentThread) return;
  const next = currentThread.status === 'closed' ? 'open' : 'closed';
  const res = await fetch(API + '/admin/feedback/close', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ threadId: currentThread.id, status: next })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Ошибка: '+(data?.error||res.status)); return; }
  currentThread.status = next;
  openThread(currentThread.id, currentThread.code, currentThread.status);
}

async function loadMessages() {
  if (!currentThread) return;
  const url = new URL(API + '/admin/feedback/messages');
  url.searchParams.set('thread', currentThread.id);
  const res = await fetch(url, { headers:{ ...authHeader() }});
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  const list = document.getElementById('msg-list');
  if (!data?.ok) { list.textContent = 'Ошибка'; return; }
  list.innerHTML = (data.items||[]).map(m=>{
    const dt = new Date(m.created_at).toLocaleString();
    const cls = m.sender==='admin'?'msg admin':'msg user';
    return `<div class="${cls}">
      <div>${escapeHtml(m.text)}</div>
      <div class="muted" style="font-size:.8em;margin-top:4px">${dt}</div>
    </div>`;
  }).join('');
  list.scrollTop = list.scrollHeight;
}

async function sendReply() {
  const inp = document.getElementById('fb-reply');
  const text = (inp.value||'').trim();
  if (!text || !currentThread) return;
  const res = await fetch(API+'/admin/feedback/reply', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', ...authHeader() },
    body: JSON.stringify({ threadId: currentThread.id, text })
  });
  if (res.status === 401) { sessionStorage.removeItem(authKey); return needLogin(); }
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data?.ok) { alert('Не отправлено: '+(data?.error||res.status)); return; }
  inp.value = '';
  loadMessages();
}
function escapeHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
window.addEventListener('load', () => {
  // Если нет токена — прячем интерфейс, показываем модалку
  if (needLogin(true)) {
    return; // ждём ввода логина/пароля
  }
  // Если токен уже есть (например, из этой вкладки) — показать интерфейс и загрузить данные
  guardApp();
  loadClaims();
});
</script>
</body>
</html>
